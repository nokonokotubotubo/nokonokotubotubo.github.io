<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fuku„Å™„Å≥ - Â§©Ê∞ó‰∫àÂ†±„Ç¢„Éó„É™</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3385ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Fuku„Å™„Å≥">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #e6f2ff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }
    body, #app {
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      background: #fff;
    }
    .title-header {
      background: linear-gradient(135deg, #66a3ff 0%, #3385ff 50%, #0059b3 100%);
      border-radius: 0 0 10px 10px;
      padding: 8px 0 8px 0;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0, 89, 179, 0.10);
      flex: 0 0 31px;
      display: flex;
      align-items: center;
    }
    .title-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 100%;
      width: 100%;
    }
    .title-icon {
      font-size: 1.4em;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .title-text {
      color: #fff;
      font-size: 1.1em;
      font-weight: bold;
      letter-spacing: 2px;
      line-height: 1.2;
    }
    .date-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0 6px 2vw;
      flex: 0 0 36px;
      flex-wrap: wrap;
    }
    .location-address {
      width: 90px;
      font-size: 0.9em;
      color: #0059b3;
      background-color: #f0f8ff;
      padding: 4px 8px;
      border-radius: 3px;
      border: 1px solid #cce0ff;
      margin-right: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .refresh-btn {
      margin-left: auto;
      margin-right: 10px;
      padding: 7px 12px;
      border: 1.2px solid #66a3ff;
      border-radius: 5px;
      background-color: #cce0ff;
      color: #003366;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      font-weight: 600;
      user-select: none;
    }
    .refresh-btn:hover {
      background-color: #99c2ff;
      border-color: #3385ff;
      transform: translateY(-1px);
    }
    .memory-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 10px;
    }
    .memory-group-icon {
      font-size: 1.1em;
      color: #0059b3;
    }
    .memory-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .memory-btn {
      padding: 7px 12px;
      border: 1.2px solid #66a3ff;
      border-radius: 5px;
      background-color: #cce0ff;
      color: #003366;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 70px;
      text-align: center;
      position: relative;
      user-select: none;
      font-weight: 600;
      white-space: pre-line;
      line-height: 1.1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 36px;
    }
    .memory-btn:hover {
      background-color: #99c2ff;
      border-color: #3385ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(51, 133, 255, 0.2);
    }
    .memory-btn.saved {
      background-color: #3385ff;
      color: white;
      border-color: #0059b3;
      box-shadow: 0 2px 8px rgba(51,133,255,0.22);
    }
    .memory-btn.saved:hover {
      background-color: #0059b3;
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(51, 133, 255, 0.3);
    }
    .memory-btn-long-press {
      background-color: #ff6b6b !important;
      color: white !important;
      transform: scale(0.95);
    }

    /* „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
    .context-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.3);
      z-index: 999998;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }

    .context-menu {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 
        0 8px 32px rgba(0,0,0,0.3),
        0 2px 8px rgba(0,0,0,0.1);
      min-width: 180px;
      overflow: hidden;
      border: 1px solid rgba(51, 133, 255, 0.2);
      transform: scale(1);
      animation: contextMenuFadeIn 0.2s ease-out;
    }

    @keyframes contextMenuFadeIn {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .context-menu-header {
      background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
      color: #0059b3;
      font-weight: bold;
      font-size: 0.9em;
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #e0e9ff;
    }

    .context-menu-item {
      padding: 14px 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      user-select: none;
      border-bottom: 1px solid #f0f0f0;
    }

    .context-menu-item:last-child {
      border-bottom: none;
    }

    .context-menu-item i {
      font-size: 1.1em;
      width: 16px;
      text-align: center;
    }

    .register-item {
      color: #0059b3;
    }

    .register-item:hover {
      background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
      color: #003d80;
    }

    .delete-item {
      color: #dc2626;
    }

    .delete-item:hover {
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      color: #b91c1c;
    }

    .date-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 15px;
    }
    .date-group-icon {
      font-size: 1.32em;
      color: #0059b3;
      margin-right: 4px;
    }
    .date-buttons {
      display: flex;
      gap: 5px;
    }
    .date-button {
      flex: 0 0 auto;
      padding: 7px 12px;
      border: 1.2px solid #66a3ff;
      border-radius: 5px;
      background-color: #cce0ff;
      color: #003366;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      font-size: 0.95em;
      transition: all 0.2s ease;
      white-space: normal;
      text-align: center;
      line-height: 1.2;
      min-width: 70px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .date-button:hover {
      background-color: #99c2ff;
      border-color: #3385ff;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(51, 133, 255, 0.2);
    }
    .date-button.active {
      background-color: #3385ff;
      border-color: #0059b3;
      color: white;
      box-shadow: 0 2px 8px rgba(51,133,255,0.22);
      transform: translateY(-1px);
    }
    .date-button.active:hover {
      background-color: #0059b3;
      box-shadow: 0 3px 10px rgba(51, 133, 255, 0.3);
    }
    .date-button-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.85em;
      line-height: 1.1;
      width: 100%;
    }
    .date-label {
      font-weight: bold;
      margin-bottom: 2px;
      text-align: center;
      width: 100%;
    }
    .date-detail {
      font-size: 1.2em;
      font-weight: 600;
      width: 100%;
      font-family: 'Hiragino Sans', '„Éí„É©„ÇÆ„ÉéËßí„Ç¥„Ç∑„ÉÉ„ÇØ', 'Yu Gothic UI', 'Meiryo UI', 'MS UI Gothic', sans-serif;
      letter-spacing: 2px;
      color: #003366;
      text-shadow: 0 1px 2px rgba(51, 133, 255, 0.1);
      text-align: center;
    }
    .date-button.active .date-detail {
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .location-save-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      animation: modalBackdropFadeIn 0.3s ease-out;
    }
    
    @keyframes modalBackdropFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .location-save-content {
      background: white;
      padding: 28px;
      border-radius: 16px;
      box-shadow: 
        0 10px 40px rgba(0,0,0,0.3),
        0 4px 12px rgba(0,0,0,0.1);
      max-width: 340px;
      width: 88%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      margin: 20px;
      transform: scale(1);
      animation: modalContentFadeIn 0.3s ease-out;
      border: 1px solid rgba(51, 133, 255, 0.1);
    }
    
    @keyframes modalContentFadeIn {
      from {
        opacity: 0;
        transform: scale(0.85) translateY(-30px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .location-save-title {
      color: #0059b3;
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 20px;
      text-align: center;
      line-height: 1.4;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .location-save-title::before {
      content: "üìç";
      font-size: 1.1em;
    }
    
    .location-save-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e9ff;
      border-radius: 10px;
      margin-bottom: 24px;
      font-size: 1em;
      box-sizing: border-box;
      outline: none;
      transition: all 0.3s ease;
      background: #fafcff;
      font-family: inherit;
    }
    
    .location-save-input:focus {
      border-color: #3385ff;
      background: white;
      box-shadow: 
        0 0 0 4px rgba(51, 133, 255, 0.1),
        0 2px 8px rgba(51, 133, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .location-save-input::placeholder {
      color: #94a3b8;
      font-style: italic;
    }
    
    .location-save-buttons {
      display: flex;
      gap: 14px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .location-save-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      transition: all 0.3s ease;
      min-width: 100px;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      overflow: hidden;
      font-family: inherit;
    }
    
    .location-save-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .location-save-btn:hover::before {
      left: 100%;
    }
    
    .save-btn {
      background: linear-gradient(135deg, #3385ff, #0059b3);
      color: white;
      box-shadow: 0 4px 12px rgba(51, 133, 255, 0.3);
    }
    
    .save-btn:hover, .save-btn:active {
      background: linear-gradient(135deg, #0059b3, #003d80);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(51, 133, 255, 0.4);
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      color: #475569;
      border: 1px solid #cbd5e1;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .cancel-btn:hover, .cancel-btn:active {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .main-content {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100vw;
      min-height: 0;
      min-width: 0;
    }
    
    .map-area {
      flex: 0 0 39%;
      min-height: 260px;
      max-height: 45.5vh;
      min-width: 0;
      position: relative;
      width: 100vw;
      background: #e6f2ff;
      border-bottom: 2px solid #99c2ff;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    
    #map {
      flex: 1 1 0;
      min-width: 0;
      min-height: 260px;
      width: 100vw;
      height: 100%;
      border-radius: 8px;
      border: 2px solid #99c2ff;
      margin: 0;
    }
    
    .current-location-btn {
      position: absolute;
      bottom: 12px;
      left: 12px;
      z-index: 1000;
      padding: 8px 16px;
      background: linear-gradient(135deg, #66a3ff, #3385ff);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      box-shadow: 0 3px 8px rgba(51, 133, 255, 0.25);
      transition: all 0.3s ease;
      user-select: none;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-touch-callout: none;
      touch-action: manipulation;
      outline: none;
    }
    .current-location-btn:hover {
      background: linear-gradient(135deg, #3385ff, #0059b3);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(51, 133, 255, 0.35);
    }
    .current-location-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(51, 133, 255, 0.4);
      background: linear-gradient(135deg, #0059b3, #003d80);
    }
    .current-location-btn:focus {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    
    .table-area {
      flex: 0 0 61%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      background: #fff;
      padding-top: 6px;
      min-height: 0;
      min-width: 0;
    }
    .error-message {
      color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      border: 1px solid #fca5a5;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 1em;
      width: 90vw;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.1);
    }
    .table-container {
      width: 99vw;
      height: 100%;
      overflow-x: auto;
      overflow-y: auto;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      table-layout: auto;
      background: #f8fbff;
    }
    th, td {
      border: 1px solid #99c2ff;
      padding: 10px 6px;
      text-align: center;
      color: #003366;
      font-size: 14px;
      white-space: normal;
      word-break: break-word;
      overflow: visible;
      text-overflow: unset;
    }
    th {
      background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
      font-weight: bold;
      color: #003366;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .current-time-highlight {
      background-color: rgba(255, 235, 153, 0.3) !important;
    }
    
    .hot-temperature {
      background-color: #dc2626 !important;
      color: white !important;
      font-weight: bold;
    }
    .cold-temperature {
      background-color: #1e40af !important;
      color: white !important;
      font-weight: bold;
    }
    .weather-emoji {
      font-size: 2.25em;
      vertical-align: middle;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    .progress-container {
      background: #e6f2ff;
      border-radius: 6px;
      width: 100%;
      height: 14px;
      position: relative;
      margin: 1px 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #3385ff, #0059b3);
      border-radius: 6px;
      transition: width 0.4s ease;
      position: relative;
    }
    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progressShine 2s ease-in-out infinite;
    }
    
    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .no-data-message {
      text-align: center;
      padding: 16px;
      color: #64748b;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      font-size: 1em;
      width: 90vw;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .clothing-index-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
    }
    .clothing-index-icon {
      font-size: 2.25em;
      margin-bottom: 2px;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    .clothing-index-label {
      font-size: 0.96em;
      margin-top: 2px;
      word-break: break-word;
      font-weight: 500;
    }
    
    .mobile-table {
      display: none;
    }
    
    .mobile-table th {
      font-size: 11px;
      padding: 6px 3px;
    }
    
    .mobile-table td {
      font-size: 11px;
      padding: 6px 3px;
    }
    
    .mobile-table .weather-emoji {
      font-size: 1.4em;
    }
    
    .mobile-table .clothing-index-icon {
      font-size: 1.4em;
    }
    
    .mobile-table .clothing-index-label {
      font-size: 0.75em;
    }
    
    .mobile-table .progress-container {
      height: 12px;
    }

    /* „Éï„ÉÉ„Çø„ÉºÔºà„Ç≥„Éî„Éº„É©„Ç§„ÉàÔºâ„ÅÆ„Çπ„Çø„Ç§„É´ */
    .footer {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-top: 1px solid #cbd5e1;
      padding: 12px 0;
      text-align: center;
      flex: 0 0 auto;
      margin-top: auto;
      position: relative;
      z-index: 1;
    }

    .footer small {
      color: #64748b;
      font-size: 0.875em;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 900px) {
      .title-header {
        flex: 0 0 28px;
      }
      .title-content { 
        flex-direction: row;
        gap: 4px;
        align-items: center;
        justify-content: center;
      }
      .title-text { 
        font-size: 1.0em;
        line-height: 1.2;
      }
      .title-icon { 
        font-size: 1.2em;
      }
      th, td { font-size: 13px; padding: 6px 3px; }
      .date-row { margin: 6px 0 6px 1vw; }
      .map-area { 
        flex: 0 0 32.5%;
        min-height: 234px;
        max-height: 39vh;
      }
      .table-area { flex: 0 0 67.5%; }
      .weather-emoji { font-size: 1.8em; }
      .clothing-index-icon { font-size: 1.8em; }
      
      #map {
        min-height: 234px;
      }
    }

    @media (max-width: 600px) {
      .title-header {
        flex: 0 0 28px;
        display: flex;
        align-items: center;
      }
      
      .title-content {
        gap: 3px;
        width: 100%;
      }
      
      .title-text { 
        font-size: 0.9em;
        letter-spacing: 0.5px;
      }
      
      .title-icon { 
        font-size: 1.1em; 
      }

      .context-menu {
        min-width: 160px;
        border-radius: 10px;
      }
      
      .context-menu-item {
        padding: 16px 18px;
        font-size: 1.05em;
      }
      
      .context-menu-header {
        padding: 14px 16px;
        font-size: 1em;
      }

      .location-address { 
        font-size: 0.75em; 
        padding: 3px 6px; 
        width: 110px;
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
        line-height: 1.2;
        height: auto;
        min-height: 20px;
      }
      
      .memory-btn { 
        padding: 6px 10px;
        font-size: 0.8em;
        min-width: 55px;
        font-weight: 600;
        min-height: 32px;
      }
      
      .refresh-btn { display: none; }
      .memory-group { margin-left: 5px; }
      .date-group { margin-left: 8px; }
      .date-button-content { font-size: 0.75em; }
      .date-detail { font-size: 1.1em; letter-spacing: 1px; }
      .date-button { min-width: 60px; }
      
      .date-group-icon {
        font-size: 1.44em;
        margin-right: 6px;
      }
      
      .map-area { 
        flex: 0 0 26%;
        min-height: 208px;
        max-height: 39vh;
      }
      
      #map {
        min-height: 208px;
      }
      
      .current-location-btn {
        padding: 8px 16px;
        font-size: 1em;
        border-radius: 6px;
        bottom: 12px;
        left: 12px;
      }
      
      .table-area { 
        flex: 0 0 74%;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }
      
      .desktop-table { display: none; }
      .mobile-table { 
        display: table;
        width: 100%;
        table-layout: fixed;
        border-spacing: 0;
        margin: 0;
      }
      
      .table-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        background: #fff;
        padding: 0 0 120px 0;
        margin: 0;
        box-sizing: border-box;
      }
      
      .mobile-table tr {
        display: table-row;
        height: auto;
        min-height: 50px;
      }
      
      .mobile-table td {
        padding: 12px 4px;
        font-size: 11px;
        line-height: 1.4;
        vertical-align: middle;
        height: auto;
        min-height: 48px;
        box-sizing: border-box;
        display: table-cell;
      }
      
      .mobile-table tr:last-child td {
        padding-bottom: 20px;
      }
      
      .location-save-content {
        width: 92%;
        max-width: none;
        margin: 8px;
        padding: 24px;
        border-radius: 12px;
      }
      
      .location-save-input {
        font-size: 16px;
        padding: 16px;
      }
      
      .location-save-buttons {
        flex-direction: row;
        gap: 12px;
      }
      
      .location-save-btn {
        flex: 1;
        min-width: 0;
        padding: 16px 20px;
        font-size: 1.05em;
      }
      
      .date-buttons .date-button:nth-child(n+4) {
        display: none;
      }

      .footer {
        padding: 10px 0;
      }
      
      .footer small {
        font-size: 0.8em;
      }
    }

    @media (max-width: 900px) and (min-width: 601px) {
      .memory-btn {
        padding: 6px 10px;
        font-size: 0.88em;
        min-width: 60px;
        font-weight: 600;
        min-height: 34px;
      }
    }

    @media (max-width: 400px) {
      .location-save-buttons {
        flex-direction: column;
      }
      
      .location-save-btn {
        width: 100%;
      }
      
      .location-save-content {
        padding: 20px;
        margin: 6px;
      }

      .map-area { 
        flex: 0 0 20.8%;
        min-height: 156px;
      }
      
      .table-area { 
        flex: 0 0 79.2%;
      }
      
      .date-group-icon {
        font-size: 1.3em;
        margin-right: 5px;
      }
    }

    @media (prefers-contrast: high) {
      .memory-btn, .date-button {
        border-width: 2px;
      }
      
      .location-save-input {
        border-width: 3px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <div class="title-header">
    <div class="title-content">
      <i class="fas fa-shirt title-icon"></i>
      <div style="display: flex; align-items: center; gap: 6px;">
        <div class="title-text">Fuku„Å™„Å≥ 
          <i class="fas fa-cloud-sun title-icon"></i>
        </div>
      </div>
    </div>
  </div>
  <div class="date-row">
    <div class="location-address">üìç {{ currentAddress || '‰ΩçÁΩÆ„ÇíÈÅ∏Êäû' }}</div>
    <div class="memory-group">
      <div class="memory-group-icon">üìí</div>
      <div class="memory-buttons">
        <button 
          v-for="(memory, index) in locationMemories" 
          :key="index"
          @click="loadLocationMemory(index)"
          @mousedown="startLongPress(index, $event)"
          @mouseup="endLongPress"
          @mouseleave="endLongPress"
          @touchstart="startLongPress(index, $event)"
          @touchend="endLongPress"
          :class="['memory-btn', { saved: memory.name }]"
        >
          {{ memory.name || `„É°„É¢„É™„Éº\n${getMemoryNumber(index)}` }}
        </button>
      </div>
    </div>
    <div class="date-group">
      <div class="date-group-icon">üìÖ</div>
      <div class="date-buttons">
        <button v-for="(date, index) in dateList" :key="date" @click="selectDate(index)" :class="['date-button', { active: selectedDateIndex === index }]">
          <div class="date-button-content">
            <div class="date-label">{{ dateLabel(date, index) }}</div>
            <div class="date-detail">{{ formatDateDetail(date) }}</div>
          </div>
        </button>
      </div>
    </div>
    <button class="refresh-btn" @click="refreshDateAndWeather">üîÑ Êõ¥Êñ∞</button>
  </div>
  <div class="main-content">
    <div class="map-area">
      <div id="map">
        <button 
          class="current-location-btn" 
          @click="getCurrentLocation"
          @touchend.prevent="getCurrentLocation"
          type="button"
        >üìç ÁèæÂú®Âú∞</button>
      </div>
    </div>
    <div class="table-area">
      <div v-if="errorMessage" class="error-message">‚ùå {{ errorMessage }}</div>
      <div class="table-container" ref="tableContainer">
        <table v-if="hasWeatherData" class="desktop-table">
          <thead>
            <tr>
              <th>ÊôÇÈñì</th>
              <th v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }" :id="`hour-${hour}`">
                <span class="weather-emoji">{{ weatherIcon(weatherData[hour]?.weather_code, weatherData[hour]?.precipitation_probability) }}</span> {{ hour }}:00
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>üåßÔ∏è ÈôçÊ∞¥Á¢∫Áéá</strong></td>
              <td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
                <div class="progress-container">
                  <div class="progress-bar" :style="{ width: (weatherData[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                </div>
                {{ weatherData[hour]?.precipitation_probability !== undefined ? weatherData[hour].precipitation_probability + "%" : '-' }}
              </td>
            </tr>
            <tr>
              <td><strong>üå°Ô∏è Ê∞óÊ∏©</strong></td>
              <td v-for="hour in hours" :key="hour" :class="[{ 'current-time-highlight': isCurrentHour(hour) }, temperatureClass(weatherData[hour]?.temperature_2m)]">
                {{ weatherData[hour]?.temperature_2m !== undefined ? weatherData[hour].temperature_2m + "‚ÑÉ" : '-' }}
              </td>
            </tr>
            <tr>
              <td><strong>ü§í ‰ΩìÊÑüÊ∏©Â∫¶</strong></td>
              <td v-for="hour in hours" :key="hour" :class="[{ 'current-time-highlight': isCurrentHour(hour) }, temperatureClass(weatherData[hour]?.apparent_temperature)]">
                {{ weatherData[hour]?.apparent_temperature !== undefined ? weatherData[hour].apparent_temperature + "‚ÑÉ" : '-' }}
              </td>
            </tr>
            <tr>
              <td><strong>üíß ÊπøÂ∫¶</strong></td>
              <td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
                {{ weatherData[hour]?.relative_humidity_2m !== undefined ? weatherData[hour].relative_humidity_2m + "%" : '-' }}
              </td>
            </tr>
            <tr>
              <td><strong>üò∞ ‰∏çÂø´ÊåáÊï∞</strong></td>
              <td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
                <div style="font-size: 0.9em; font-weight: bold;">
                  {{ calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) !== null ? calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) : '-' }}
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 2px;">
                  {{ discomfortLevel(calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m)) }}
                </div>
              </td>
            </tr>
            <tr>
              <td><strong>üëï ÊúçË£ÖÊåáÊï∞</strong></td>
              <td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
                <div class="clothing-index-cell">
                  <span class="clothing-index-icon">{{ clothingIcon(weatherData[hour]?.apparent_temperature, hour) }}</span>
                  <span class="clothing-index-label">{{ clothingLabel(weatherData[hour]?.apparent_temperature, hour) }}</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <table v-if="hasWeatherData" class="mobile-table">
          <thead>
            <tr>
              <th>ÊôÇÈñì</th>
              <th>üåßÔ∏è<br>ÈôçÊ∞¥Á¢∫Áéá</th>
              <th>üå°Ô∏è<br>Ê∞óÊ∏©</th>
              <th>ü§í<br>‰ΩìÊÑüÊ∏©Â∫¶</th>
              <th>üíß<br>ÊπøÂ∫¶</th>
              <th>üò∞<br>‰∏çÂø´ÊåáÊï∞</th>
              <th>üëï<br>ÊúçË£Ö</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }" :id="`mobile-hour-${hour}`">
              <td>
                <span class="weather-emoji">{{ weatherIcon(weatherData[hour]?.weather_code, weatherData[hour]?.precipitation_probability) }}</span><br>
                {{ hour }}:00
              </td>
              <td>
                <div class="progress-container">
                  <div class="progress-bar" :style="{ width: (weatherData[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                </div>
                {{ weatherData[hour]?.precipitation_probability !== undefined ? weatherData[hour].precipitation_probability + "%" : '-' }}
              </td>
              <td :class="temperatureClass(weatherData[hour]?.temperature_2m)">
                {{ weatherData[hour]?.temperature_2m !== undefined ? weatherData[hour].temperature_2m + "‚ÑÉ" : '-' }}
              </td>
              <td :class="temperatureClass(weatherData[hour]?.apparent_temperature)">
                {{ weatherData[hour]?.apparent_temperature !== undefined ? weatherData[hour].apparent_temperature + "‚ÑÉ" : '-' }}
              </td>
              <td>
                {{ weatherData[hour]?.relative_humidity_2m !== undefined ? weatherData[hour].relative_humidity_2m + "%" : '-' }}
              </td>
              <td>
                <div style="font-size: 0.8em; font-weight: bold;">
                  {{ calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) !== null ? calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) : '-' }}
                </div>
                <div style="font-size: 0.7em; color: #666;">
                  {{ discomfortLevel(calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m)) }}
                </div>
              </td>
              <td>
                <div class="clothing-index-cell">
                  <span class="clothing-index-icon">{{ clothingIcon(weatherData[hour]?.apparent_temperature, hour) }}</span>
                  <span class="clothing-index-label">{{ clothingLabel(weatherData[hour]?.apparent_temperature, hour) }}</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        
        <div v-if="!hasWeatherData && !errorMessage" class="no-data-message">
          üó∫Ô∏èÂú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Â§©Ê∞ó„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        </div>
      </div>
    </div>
  </div>

  <!-- „Éï„ÉÉ„Çø„ÉºÔºà„Ç≥„Éî„Éº„É©„Ç§„ÉàÔºâ -->
  <footer class="footer">
    <small>&copy; 2025 nokotubo</small>
  </footer>

  <!-- „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº -->
  <div v-if="showContextMenu" class="context-menu-overlay" @click="closeContextMenu">
    <div 
      class="context-menu" 
      @click.stop
      :style="{ left: contextMenuPosition.x + 'px', top: contextMenuPosition.y + 'px' }"
    >
      <div class="context-menu-header">
        „É°„É¢„É™„Éº{{ getMemoryNumber(contextMenuIndex) }}
      </div>
      
      <div 
        v-if="!isMemorySlotSaved(contextMenuIndex)" 
        class="context-menu-item register-item"
        @click="openSaveDialog"
      >
        <i class="fas fa-plus"></i>
        ‰ΩçÁΩÆ„ÇíÁôªÈå≤
      </div>
      
      <div 
        v-if="isMemorySlotSaved(contextMenuIndex)" 
        class="context-menu-item delete-item"
        @click="confirmDeleteMemory"
      >
        <i class="fas fa-trash"></i>
        ÂâäÈô§
      </div>
    </div>
  </div>

  <!-- ‰ΩçÁΩÆ‰øùÂ≠ò„É¢„Éº„ÉÄ„É´ -->
  <div v-if="showSaveDialog" class="location-save-modal" @click="closeSaveDialog">
    <div class="location-save-content" @click.stop>
      <div class="location-save-title">‰ΩçÁΩÆ„ÇíÁôªÈå≤</div>
      <input 
        v-model="saveLocationName" 
        class="location-save-input" 
        placeholder="‰æã: Ëá™ÂÆÖ„ÄÅËÅ∑Â†¥„ÄÅÂ≠¶Ê†°..."
        @keyup.enter="saveLocationMemory"
        ref="saveLocationInput"
        maxlength="20"
      >
      <div class="location-save-buttons">
        <button class="location-save-btn save-btn" @click="saveLocationMemory">ÁôªÈå≤</button>
        <button class="location-save-btn cancel-btn" @click="closeSaveDialog">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/vue@3.0.0"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
const { createApp, ref, reactive, onMounted, computed, nextTick, watch } = Vue;

createApp({
  setup() {
    const map = ref(null);
    const marker = ref(null);
    const selectedLatLng = reactive({ lat: 34.6937, lng: 135.5023 });
    const dateList = ref([]);
    const selectedDateIndex = ref(0);
    const weatherData = reactive({});
    const errorMessage = ref('');
    const currentAddress = ref('');
    const hours = Array.from({ length: 17 }, (_, i) => i + 6);
    const tableContainer = ref(null);

    const addressCache = new Map();
    const addressRequestInProgress = ref(false);

    // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„ÉºÈñ¢ÈÄ£„ÅÆÁä∂ÊÖã
    const showContextMenu = ref(false);
    const contextMenuPosition = reactive({ x: 0, y: 0 });
    const contextMenuIndex = ref(0);
    const showSaveDialog = ref(false);

    // ‰ΩçÁΩÆ„É°„É¢„É™„ÉºÈñ¢ÈÄ£„ÅÆÁä∂ÊÖã
    const locationMemories = ref([
      { name: '', lat: null, lng: null, address: '' },
      { name: '', lat: null, lng: null, address: '' },
      { name: '', lat: null, lng: null, address: '' }
    ]);
    const saveLocationName = ref('');
    const saveLocationIndex = ref(0);
    const longPressTimer = ref(null);
    const saveLocationInput = ref(null);

    const hasWeatherData = computed(() => Object.keys(weatherData).length > 0);

    function getMemoryNumber(index) {
      const numbers = ['‚ë†', '‚ë°', '‚ë¢'];
      return numbers[index] || `${index + 1}`;
    }

    // „É°„É¢„É™„Éº„Çπ„É≠„ÉÉ„Éà„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    function isMemorySlotSaved(index) {
      const memory = locationMemories.value[index];
      return memory.name && memory.lat && memory.lng;
    }

    // ‰øÆÊ≠£ÔºöÈï∑Êäº„ÅóÂá¶ÁêÜ„ÇíÊîπÂñÑ
    function startLongPress(index, event) {
      if (longPressTimer.value) {
        clearTimeout(longPressTimer.value);
      }
      
      longPressTimer.value = setTimeout(() => {
        if (!selectedLatLng.lat || !selectedLatLng.lng) {
          errorMessage.value = 'ÂÖà„Å´Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
          setTimeout(() => { errorMessage.value = ''; }, 3000);
          return;
        }
        
        showContextMenuDialog(index, event);
      }, 600); // 600ms„Å´Áü≠Á∏Æ
    }

    // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÇíË°®Á§∫
    function showContextMenuDialog(index, event) {
      contextMenuIndex.value = index;
      
      let clientX, clientY;
      
      if (event && event.type.startsWith('touch')) {
        const touch = event.touches[0] || event.changedTouches[0];
        clientX = touch.clientX;
        clientY = touch.clientY;
      } else if (event) {
        clientX = event.clientX;
        clientY = event.clientY;
      } else {
        clientX = window.innerWidth / 2;
        clientY = window.innerHeight / 2;
      }
      
      const menuWidth = 180;
      const menuHeight = 120;
      
      let x = clientX;
      let y = clientY;
      
      if (x + menuWidth > window.innerWidth - 20) {
        x = window.innerWidth - menuWidth - 20;
      }
      
      if (y + menuHeight > window.innerHeight - 20) {
        y = clientY - menuHeight - 10;
      }
      
      contextMenuPosition.x = Math.max(20, x);
      contextMenuPosition.y = Math.max(20, y);
      showContextMenu.value = true;
    }

    // ‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åè
    function openSaveDialog() {
      saveLocationIndex.value = contextMenuIndex.value;
      saveLocationName.value = '';
      closeContextMenu();
      showSaveDialog.value = true;
      
      nextTick(() => {
        setTimeout(() => {
          if (saveLocationInput.value) {
            saveLocationInput.value.focus();
          }
        }, 200);
      });
    }

    // ÂâäÈô§Á¢∫Ë™ç
    function confirmDeleteMemory() {
      const memory = locationMemories.value[contextMenuIndex.value];
      if (confirm(`„Äå${memory.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
        deleteLocationMemory();
      }
      closeContextMenu();
    }

    // „É°„É¢„É™„Éº„ÇíÂâäÈô§
    function deleteLocationMemory() {
      locationMemories.value[contextMenuIndex.value] = {
        name: '',
        lat: null,
        lng: null,
        address: ''
      };
      
      saveLocationMemoriesToStorage();
      errorMessage.value = '„É°„É¢„É™„Éº„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü';
      setTimeout(() => { errorMessage.value = ''; }, 2000);
    }

    // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
    function closeContextMenu() {
      showContextMenu.value = false;
      contextMenuPosition.x = 0;
      contextMenuPosition.y = 0;
      contextMenuIndex.value = 0;
    }

    // ‰øùÂ≠ò„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
    function closeSaveDialog() {
      showSaveDialog.value = false;
      saveLocationName.value = '';
      saveLocationIndex.value = 0;
    }

    function endLongPress() {
      if (longPressTimer.value) {
        clearTimeout(longPressTimer.value);
        longPressTimer.value = null;
      }
    }

    function getJSTDateString(date = new Date()) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function refreshDateAndWeather() {
      console.log('=== JSTÂØæÂøúÊó•‰ªòÊõ¥Êñ∞ÈñãÂßã ===');
      
      const now = new Date();
      const todayString = getJSTDateString(now);
      
      const newDateArray = [];
      for (let i = 0; i <= 7; i++) {
        const targetDate = new Date(now);
        targetDate.setDate(now.getDate() + i);
        const dateStr = getJSTDateString(targetDate);
        newDateArray.push(dateStr);
      }
      
      dateList.value = [...newDateArray];
      selectedDateIndex.value = 0;
      
      if (selectedLatLng.lat && selectedLatLng.lng) {
        fetchWeatherData();
      }
      
      console.log('=== JSTÂØæÂøúÊó•‰ªòÊõ¥Êñ∞ÂÆå‰∫Ü ===');
    }

    function isCurrentHour(hour) {
      if (selectedDateIndex.value !== 0) return false;
      const now = new Date();
      return now.getHours() === hour;
    }

    function scrollToCurrentTime() {
      if (selectedDateIndex.value !== 0) return;
      
      const now = new Date();
      const currentHour = now.getHours();
      
      if (currentHour < 6 || currentHour > 22) return;
      
      if (window.innerWidth > 600) return;
      
      setTimeout(() => {
        const currentTimeRow = document.getElementById(`mobile-hour-${currentHour}`);
        if (currentTimeRow && tableContainer.value) {
          const containerElement = tableContainer.value;
          const containerRect = containerElement.getBoundingClientRect();
          
          const currentScrollTop = containerElement.scrollTop;
          
          const rowAbsoluteTop = currentTimeRow.offsetTop;
          
          const containerViewHeight = containerRect.height;
          
          const rowHeight = currentTimeRow.offsetHeight;
          
          const targetScrollTop = rowAbsoluteTop - (containerViewHeight / 2) + (rowHeight / 2);
          
          containerElement.scrollTo({
            top: Math.max(0, targetScrollTop),
            behavior: 'smooth'
          });
        }
      }, 1000);
    }

    watch(hasWeatherData, (newValue) => {
      if (newValue) {
        scrollToCurrentTime();
      }
    });

    function temperatureClass(temp) {
      if (temp === undefined || temp === null) return '';
      if (temp >= 35) return 'hot-temperature';
      if (temp <= 0) return 'cold-temperature';
      return '';
    }

    function weatherIcon(weatherCode, precipitationProbability) {
      if (precipitationProbability !== undefined) {
        if (precipitationProbability <= 10) {
          if (weatherCode === 0) return '‚òÄÔ∏è';
          return '‚õÖ';
        }
        if (precipitationProbability >= 50) return '‚òî';
        if (precipitationProbability >= 30) return 'üåßÔ∏è';
        if (precipitationProbability >= 11) return 'üå¶Ô∏è';
        return '‚õÖ';
      }
      
      if (weatherCode === undefined || weatherCode === null) return '‚òÄÔ∏è';
      
      switch (weatherCode) {
        case 0: return '‚òÄÔ∏è';
        case 1: case 2: case 3: return '‚õÖ';
        case 45: case 48: return 'üå´Ô∏è';
        case 51: case 53: case 55: return 'üå¶Ô∏è';
        case 56: case 57: return 'üå®Ô∏è';
        case 61: case 63: case 65: return 'üåßÔ∏è';
        case 66: case 67: return 'üå®Ô∏è';
        case 71: case 73: case 75: return '‚ùÑÔ∏è';
        case 77: return '‚ùÑÔ∏è';
        case 80: case 81: case 82: return 'üå¶Ô∏è';
        case 85: case 86: return 'üå®Ô∏è';
        case 95: return '‚õàÔ∏è';
        case 96: case 99: return '‚õàÔ∏è';
        default: return '‚òÄÔ∏è';
      }
    }

    function calculateDiscomfortIndex(temperature, humidity) {
      if (temperature === undefined || temperature === null || humidity === undefined || humidity === null) {
        return null;
      }
      const discomfortIndex = 0.81 * temperature + 0.01 * humidity * (0.99 * temperature - 14.3) + 46.3;
      return Math.round(discomfortIndex * 10) / 10;
    }

    function discomfortLevel(discomfortIndex) {
      if (discomfortIndex === null || discomfortIndex === undefined) return '-';
      if (discomfortIndex < 55) return 'ÂØí„ÅÑ';
      if (discomfortIndex < 60) return 'ËÇåÂØí„ÅÑ';
      if (discomfortIndex < 65) return '‰Ωï„ÇÇÊÑü„Åò„Å™„ÅÑ';
      if (discomfortIndex < 70) return 'Âø´„ÅÑ';
      if (discomfortIndex < 75) return 'Êöë„Åè„Å™„ÅÑ';
      if (discomfortIndex < 80) return '„ÇÑ„ÇÑÊöë„ÅÑ';
      if (discomfortIndex < 85) return 'Êöë„Åè„Å¶Ê±ó„ÅåÂá∫„Çã';
      return 'Êöë„Åè„Å¶„Åü„Åæ„Çâ„Å™„ÅÑ';
    }

    function loadLocationMemoriesFromStorage() {
      const saved = localStorage.getItem('fukuanvi-location-memories');
      if (saved) {
        try {
          const memories = JSON.parse(saved);
          locationMemories.value = memories;
        } catch (error) {
          console.error('‰ΩçÁΩÆ„É°„É¢„É™„Éº„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
        }
      }
    }

    function saveLocationMemoriesToStorage() {
      localStorage.setItem('fukuanvi-location-memories', JSON.stringify(locationMemories.value));
    }

    function saveLocationMemory() {
      const name = saveLocationName.value.trim();
      if (name && name.length <= 20) {
        locationMemories.value[saveLocationIndex.value] = {
          name: name,
          lat: selectedLatLng.lat,
          lng: selectedLatLng.lng,
          address: currentAddress.value
        };
        saveLocationMemoriesToStorage();
        closeSaveDialog();
      } else if (!name) {
        if (saveLocationInput.value) {
          saveLocationInput.value.focus();
        }
      } else {
        errorMessage.value = '‰ΩçÁΩÆÂêç„ÅØ20ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        setTimeout(() => { errorMessage.value = ''; }, 3000);
      }
    }

    function loadLocationMemory(index) {
      const memory = locationMemories.value[index];
      if (memory.name && memory.lat && memory.lng) {
        selectedLatLng.lat = memory.lat;
        selectedLatLng.lng = memory.lng;
        
        currentAddress.value = '‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠...';
        
        if (map.value) {
          map.value.setView([memory.lat, memory.lng], 10);
          updateMarker();
        }
        
        fetchAddress(memory.lat, memory.lng);
        fetchWeatherData();
      }
    }

    async function fetchAddress(lat, lng) {
      const cacheKey = `${lat.toFixed(3)},${lng.toFixed(3)}`;
      
      if (addressCache.has(cacheKey)) {
        const cachedAddress = addressCache.get(cacheKey);
        currentAddress.value = cachedAddress;
        console.log('‰ΩèÊâÄ„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂèñÂæó:', cachedAddress);
        return;
      }

      if (addressRequestInProgress.value) {
        console.log('‰ΩèÊâÄÂèñÂæó„É™„ÇØ„Ç®„Çπ„ÉàÂÆüË°å‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó');
        return;
      }

      addressRequestInProgress.value = true;

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=ja&zoom=10`,
          { signal: controller.signal }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error('‰ΩèÊâÄÂèñÂæó„Å´Â§±Êïó');
        const data = await response.json();
        
        const address = data.address;
        let displayAddress = '‰ΩçÁΩÆ„ÇíÈÅ∏Êäû';
        
        if (address) {
          const prefecture = address.state || address.prefecture || '';
          const city = address.city || address.town || address.village || address.municipality || '';
          
          if (prefecture && city) {
            displayAddress = `${prefecture} ${city}`;
          } else if (prefecture || city) {
            displayAddress = prefecture || city;
          }
        }
        
        if (addressCache.size >= 100) {
          const firstKey = addressCache.keys().next().value;
          addressCache.delete(firstKey);
        }
        addressCache.set(cacheKey, displayAddress);
        
        currentAddress.value = displayAddress;
        console.log('‰ΩèÊâÄ„ÇíÊñ∞Ë¶èÂèñÂæó„Åó„Å¶„Ç≠„É£„ÉÉ„Ç∑„É•„Å´‰øùÂ≠ò:', displayAddress);
        
      } catch (error) {
        console.warn('‰ΩèÊâÄÂèñÂæó„Ç®„É©„Éº:', error.message);
        currentAddress.value = '‰ΩçÁΩÆ„ÇíÈÅ∏Êäû';
      } finally {
        addressRequestInProgress.value = false;
      }
    }

    function checkMapDisplay() {
      const mapElement = document.getElementById('map');
      if (mapElement) {
        const style = window.getComputedStyle(mapElement);
        console.log('Map element dimensions:', {
          width: style.width,
          height: style.height,
          display: style.display,
          visibility: style.visibility
        });
      }
    }

    function initMap() {
      const mapElement = document.getElementById('map');
      if (!mapElement) {
        console.error('Map container not found');
        return;
      }

      if (map.value) {
        map.value.remove();
        map.value = null;
      }

      try {
        map.value = L.map('map', {
          preferCanvas: true,
          zoomControl: true
        }).setView([selectedLatLng.lat, selectedLatLng.lng], 8);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors',
          loading: 'lazy'
        }).addTo(map.value);

        const locationIcon = L.divIcon({
          html: '<div style="background: linear-gradient(135deg, #3385ff, #0059b3); color: white; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(51, 133, 255, 0.4); border: 3px solid white;"><i class="fas fa-shirt" style="transform: rotate(45deg); font-size: 14px;"></i></div>',
          className: 'custom-location-marker',
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });

        marker.value = L.marker([selectedLatLng.lat, selectedLatLng.lng], { 
          icon: locationIcon 
        }).addTo(map.value);

        map.value.on('click', (e) => {
          selectedLatLng.lat = e.latlng.lat;
          selectedLatLng.lng = e.latlng.lng;
          updateMarker();
          fetchWeatherData();
          fetchAddress(e.latlng.lat, e.latlng.lng);
        });

        setTimeout(() => {
          if (map.value) {
            map.value.invalidateSize();
          }
        }, 100);

      } catch (error) {
        console.error('Map initialization failed:', error);
        errorMessage.value = 'Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      }
    }

    function updateMarker() {
      if (marker.value) {
        marker.value.setLatLng([selectedLatLng.lat, selectedLatLng.lng]);
      }
    }

    function getCurrentLocation() {
      console.log('ÁèæÂú®Âú∞ÂèñÂæóÈñãÂßã');
      
      if (!navigator.geolocation) {
        errorMessage.value = '‚ùå „Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nÊâãÂãï„ÅßÂú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        console.error('Geolocation not supported');
        return;
      }

      currentAddress.value = 'üîÑ ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠...';
      errorMessage.value = '';

      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 60000
      };

      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÊàêÂäü:', position);
          
          selectedLatLng.lat = position.coords.latitude;
          selectedLatLng.lng = position.coords.longitude;
          
          if (map.value) {
            map.value.setView([selectedLatLng.lat, selectedLatLng.lng], 12);
            updateMarker();
          }
          
          fetchWeatherData();
          fetchAddress(position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          console.error('‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', error);
          
          let message = '';
          
          switch (error.code) {
            case error.PERMISSION_DENIED:
              message = 'üö´ ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ\n\n„ÄêËß£Ê±∫ÊñπÊ≥ï„Äë\n1. „Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç¢„Éâ„É¨„Çπ„Éê„ÉºÂ∑¶„ÅÆüîí„Éû„Éº„ÇØ„Çí„Çø„ÉÉ„Éó\n2. ‰ΩçÁΩÆÊÉÖÂ†±„Çí„ÄåË®±ÂèØ„Äç„Å´Â§âÊõ¥\n3. „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
              break;
            case error.POSITION_UNAVAILABLE:
              message = 'üìç ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n\n„ÄêÁ¢∫Ë™ç‰∫ãÈ†Ö„Äë\n‚Ä¢ GPS„Åå„Ç™„É≥„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã\n‚Ä¢ Â±ãÂ§ñ„Å´„ÅÑ„Çã„ÅãÔºàÂ±ãÂÜÖ„Åß„ÅØÂèñÂæóÂõ∞Èõ£Ôºâ\n‚Ä¢ Ê©üÂÜÖ„É¢„Éº„Éâ„Åå„Ç™„Éï„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã';
              break;
            case error.TIMEOUT:
              message = '‚è±Ô∏è ‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Äê„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„Äë\n‚Ä¢ ÈõªÊ≥¢„ÅÆËâØ„ÅÑÂ†¥ÊâÄ„Å´ÁßªÂãï\n‚Ä¢ Â∞ë„ÅóÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶ÂÆüË°å\n‚Ä¢ ÊâãÂãï„ÅßÂú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩçÁΩÆÈÅ∏Êäû';
              break;
            default:
              message = `‚ùå ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº\n\n„Ç®„É©„Éº„Ç≥„Éº„Éâ: ${error.code}\n„É°„ÉÉ„Çª„Éº„Ç∏: ${error.message}\n\nÊâãÂãï„ÅßÂú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
              break;
          }
          
          errorMessage.value = message;
          currentAddress.value = '‰ΩçÁΩÆ„ÇíÈÅ∏Êäû';
          
          setTimeout(() => { 
            errorMessage.value = ''; 
          }, 15000);
        },
        options
      );
    }

    function generateDateList() {
      const today = new Date();
      dateList.value = [];
      for (let i = 0; i <= 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        dateList.value.push(getJSTDateString(d));
      }
    }

    function dateLabel(dateStr, index) {
      if (index === 0) return '‰ªäÊó•';
      if (index === 1) return 'ÊòéÊó•';
      if (index === 2) return 'ÊòéÂæåÊó•';
      return `${index}Êó•Âæå`;
    }

    function formatDateDetail(dateStr) {
      const date = new Date(dateStr);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = date.toLocaleDateString('ja-JP', { weekday: 'short' });
      return `${month}/${day}Ôºà${weekday}Ôºâ`;
    }

    function selectDate(index) {
      selectedDateIndex.value = index;
      fetchWeatherData();
    }

    function fetchWeatherData() {
      errorMessage.value = '';
      Object.keys(weatherData).forEach(key => delete weatherData[key]);
      
      const date = dateList.value[selectedDateIndex.value];
      const lat = selectedLatLng.lat.toFixed(4);
      const lng = selectedLatLng.lng.toFixed(4);
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code&start_date=${date}&end_date=${date}&timezone=Asia/Tokyo`;

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      fetch(url, { signal: controller.signal })
        .then(response => {
          clearTimeout(timeoutId);
          if (!response.ok) {
            throw new Error('Â§©Ê∞ó„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
          return response.json();
        })
        .then(data => {
          if (!data.hourly) {
            throw new Error('Â§©Ê∞ó„Éá„Éº„Çø„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
          for (const hour of hours) {
            const idx = data.hourly.time.findIndex(t => t.endsWith(`T${hour.toString().padStart(2, '0')}:00`));
            if (idx !== -1) {
              weatherData[hour] = {
                temperature_2m: Math.round(data.hourly.temperature_2m[idx]),
                apparent_temperature: Math.round(data.hourly.apparent_temperature[idx]),
                relative_humidity_2m: Math.round(data.hourly.relative_humidity_2m[idx]),
                precipitation_probability: Math.round(data.hourly.precipitation_probability[idx] || 0),
                weather_code: data.hourly.weather_code[idx]
              };
            }
          }
        })
        .catch(err => {
          clearTimeout(timeoutId);
          if (err.name === 'AbortError') {
            errorMessage.value = 'Â§©Ê∞ó„Éá„Éº„Çø„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
          } else {
            errorMessage.value = err.message;
          }
          setTimeout(() => { errorMessage.value = ''; }, 8000);
        });
    }

    function clothingIcon(temp, hour) {
      if (temp === undefined || temp === null) return '';
      let adjustedTemp = temp;
      if ((hour >= 6 && hour <= 9) || (hour >= 18 && hour <= 21)) adjustedTemp -= 1.5;
      else if (hour >= 22 || hour <= 5) adjustedTemp -= 1;
      
      if (adjustedTemp >= 35) return 'üßò‚Äç‚ôÇÔ∏è';
      if (adjustedTemp >= 30) return 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
      if (adjustedTemp >= 27) return 'üëï';
      if (adjustedTemp >= 24) return 'üëî';
      if (adjustedTemp >= 21) return 'ü¶∫';
      if (adjustedTemp >= 18) return 'üß•';
      if (adjustedTemp >= 15) return 'üß•';
      if (adjustedTemp >= 12) return 'üß•';
      if (adjustedTemp >= 9)  return 'üß•';
      if (adjustedTemp >= 6)  return 'üß•';
      if (adjustedTemp >= 3)  return 'üß•';
      return 'üß•';
    }

    function clothingLabel(temp, hour) {
      if (temp === undefined || temp === null) return '-';
      let adjustedTemp = temp;
      if ((hour >= 6 && hour <= 9) || (hour >= 18 && hour <= 21)) adjustedTemp -= 1.5;
      else if (hour >= 22 || hour <= 5) adjustedTemp -= 1;
      
      if (adjustedTemp >= 35) return 'ÂÖ®Ë£∏„É¨„Éô„É´';
      if (adjustedTemp >= 30) return '„Çø„É≥„ÇØ„Éà„ÉÉ„Éó';
      if (adjustedTemp >= 27) return 'ÂçäË¢ñT„Ç∑„É£„ÉÑ';
      if (adjustedTemp >= 24) return 'Èï∑Ë¢ñT„Ç∑„É£„ÉÑ';
      if (adjustedTemp >= 21) return 'ËñÑÊâã„Ç´„Éº„Éá„Ç£„Ç¨„É≥';
      if (adjustedTemp >= 18) return '„Çª„Éº„Çø„Éº';
      if (adjustedTemp >= 15) return '„Éë„Éº„Ç´„Éº';
      if (adjustedTemp >= 12) return '„Ç∏„É£„Ç±„ÉÉ„Éà';
      if (adjustedTemp >= 9)  return '„Ç≥„Éº„Éà';
      if (adjustedTemp >= 6)  return 'ÂéöÊâã„Ç≥„Éº„Éà';
      if (adjustedTemp >= 3)  return '„ÉÄ„Ç¶„É≥„Ç∏„É£„Ç±„ÉÉ„Éà';
      return 'Èò≤ÂØíÁùÄÂÆåÂÖ®Ë£ÖÂÇô';
    }

    onMounted(() => {
      generateDateList();
      
      nextTick(() => {
        setTimeout(() => {
          checkMapDisplay();
          initMap();
          fetchWeatherData();
          loadLocationMemoriesFromStorage();
        }, 200);
      });
    });

    return {
      dateList,
      selectedDateIndex,
      selectDate,
      dateLabel,
      formatDateDetail,
      weatherData,
      hours,
      clothingIcon,
      clothingLabel,
      weatherIcon,
      calculateDiscomfortIndex,
      discomfortLevel,
      errorMessage,
      hasWeatherData,
      getCurrentLocation,
      currentAddress,
      isCurrentHour,
      temperatureClass,
      locationMemories,
      showSaveDialog,
      saveLocationName,
      saveLocationInput,
      startLongPress,
      endLongPress,
      saveLocationMemory,
      closeSaveDialog,
      loadLocationMemory,
      refreshDateAndWeather,
      tableContainer,
      scrollToCurrentTime,
      getMemoryNumber,
      showContextMenu,
      contextMenuPosition,
      contextMenuIndex,
      isMemorySlotSaved,
      openSaveDialog,
      confirmDeleteMemory,
      deleteLocationMemory,
      closeContextMenu
    };
  }
}).mount('#app');
</script>

<script>
if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.hostname === 'localhost')) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
</script>
</body>
</html>