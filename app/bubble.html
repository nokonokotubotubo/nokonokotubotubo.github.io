<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Brave Search リアルタイムサジェスト シャボン玉ゲーム</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }

        .game-container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            height: 80vh;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.3));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d3436;
            font-weight: bold;
            text-align: center;
            word-wrap: break-word;
            font-size: 12px;
            user-select: none;
            transition: all 0.3s ease;
            animation: float 8s infinite linear;
            border: 2px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 5px;
        }

        .bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255,255,255,0.7);
            z-index: 100;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .stats h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .brave-api-settings {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .brave-api-settings h3 {
            margin-top: 0;
            color: #2d3436;
        }

        .brave-api-settings input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .btn {
            background: #ff6900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn:hover {
            background: #e55a00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.secondary {
            background: #00b894;
        }

        .btn.secondary:hover {
            background: #00a085;
        }

        .btn.danger {
            background: #d63031;
        }

        .btn.danger:hover {
            background: #b71c1c;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 18px;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .search-results {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .search-keyword-display {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .search-keyword {
            font-size: 20px;
            color: #2d3436;
            margin: 10px 0;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .instructions h3 {
            margin-top: 0;
        }

        .instructions a {
            color: #74b9ff;
            text-decoration: none;
        }

        .instructions a:hover {
            text-decoration: underline;
        }

        .api-info {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .error {
            background: rgba(255,107,107,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .success {
            background: rgba(0,184,148,0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }

        .control-panel label {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #2d3436;
            font-weight: bold;
        }

        .control-panel input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .suggestion-count {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .game-container {
                height: 60vh;
            }
            
            .stats h1 {
                font-size: 1.8em;
            }
            
            .bubble {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="stats">
            <h1>🦁 Brave Search リアルタイムサジェスト シャボン玉ゲーム</h1>
            <p>弾けた数: {{ poppedCount }} / {{ totalBubbles }}</p>
            <p>残りワード数: {{ activeBubblesCount }}個</p>
        </div>

        <!-- 検索キーワード表示エリア -->
        <div v-if="searchKeyword" class="search-keyword-display">
            <h3>🔍 現在の検索キーワード</h3>
            <p class="search-keyword"><strong>"{{ searchKeyword }}"</strong></p>
            <small>※このキーワードはシャボン玉として出現しません</small>
        </div>

        <!-- Brave API設定パネル -->
        <div class="brave-api-settings">
            <h3>🔥 Brave Search API 設定</h3>
            <div class="api-info">
                📊 <strong>無料プラン</strong>: 月2000クエリまで無料 | <strong>登録</strong>: <a href="https://brave.com/ja/search/api/" target="_blank">brave.com/ja/search/api</a>
            </div>
            <input v-model="braveApiKey" placeholder="Brave Search APIキーを入力" type="password">
            <input v-model="searchKeyword" placeholder="検索キーワード（例：プログラミング）" @keyup.enter="fetchBraveSuggestions">
            
            <div class="control-panel">
                <label>
                    <input type="number" v-model.number="suggestionCount" min="5" max="20">
                    サジェスト取得数（5-20個）
                </label>
                <label>
                    <input type="number" v-model.number="bubbleInterval" min="1000" max="5000" step="500">
                    シャボン玉生成間隔（ミリ秒）
                </label>
            </div>
            
            <div>
                <button class="btn" @click="fetchBraveSuggestions">🔍 サジェスト取得</button>
                <button class="btn secondary" @click="startAutoUpdate">⚡ 自動更新開始</button>
                <button class="btn secondary" @click="stopAutoUpdate">⏹️ 自動更新停止</button>
                <button class="btn secondary" @click="testConnection">🧪 接続テスト</button>
                <button class="btn danger" @click="clearGame">🗑️ ゲームリセット</button>
            </div>
        </div>

        <!-- ステータス表示 -->
        <div v-if="loading" class="loading">
            🔄 Brave Search APIからサジェストを取得中...
        </div>

        <div v-if="error" class="error">
            ❌ {{ error }}
        </div>

        <div v-if="successMessage" class="success">
            ✅ {{ successMessage }}
        </div>

        <!-- サジェスト数表示 -->
        <div v-if="currentSuggestions.length > 0" class="suggestion-count">
            📈 取得済みサジェスト: {{ currentSuggestions.length }}個
        </div>

        <!-- 使用方法説明 -->
        <div class="instructions">
            <h3>📝 使用方法</h3>
            <ol>
                <li><strong>APIキー取得</strong>: <a href="https://brave.com/ja/search/api/" target="_blank">Brave Search API</a>でアカウント作成</li>
                <li><strong>キー入力</strong>: 上記で取得したAPIキーを入力欄に貼り付け</li>
                <li><strong>テスト</strong>: 「🧪 接続テスト」で動作確認</li>
                <li><strong>開始</strong>: キーワードを入力して「🔍 サジェスト取得」またはEnterキーを押す</li>
                <li><strong>ゲーム</strong>: 浮上するシャボン玉をクリックして弾く</li>
            </ol>
        </div>

        <div class="game-container" ref="gameContainer">
            <div
                v-for="bubble in bubbles"
                :key="bubble.id"
                class="bubble"
                :style="{
                    left: bubble.x + 'px',
                    top: bubble.y + 'px',
                    width: bubble.size + 'px',
                    height: bubble.size + 'px',
                    fontSize: Math.max(10, bubble.size/8) + 'px',
                    animationDuration: bubble.speed + 's',
                    animationDelay: bubble.delay + 's'
                }"
                @click="popBubble(bubble.id)"
                :title="bubble.word"
            >
                {{ bubble.word }}
            </div>
        </div>

        <div v-if="selectedWords.length > 0" class="search-results">
            <h3>🔍 選択されたキーワード</h3>
            <p><strong>{{ selectedWords.join(', ') }}</strong></p>
            <button class="btn secondary" @click="clearSelectedWords">選択をクリア</button>
        </div>

        <!-- API使用状況 -->
        <div v-if="apiUsage.total > 0" class="api-info">
            📊 API使用状況: {{ apiUsage.total }}回 / 2000回（月間無料枠） | 自動更新: {{ autoUpdateStatus }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Brave API設定
                    braveApiKey: '',
                    searchKeyword: 'プログラミング',
                    suggestionCount: 15,
                    bubbleInterval: 2500,
                    loading: false,
                    error: '',
                    successMessage: '',
                    
                    // ゲーム状態
                    bubbles: [],
                    poppedCount: 0,
                    totalBubbles: 0,
                    selectedWords: [],
                    
                    // システム
                    bubbleId: 0,
                    gameInterval: null,
                    updateInterval: null,
                    autoUpdateStatus: '停止中',
                    
                    // 現在のサジェストワード
                    currentSuggestions: [],
                    
                    // API使用状況
                    apiUsage: {
                        total: 0,
                        today: 0,
                        lastReset: new Date().toDateString()
                    },
                    
                    // デモ用のサンプルワード
                    sampleWords: [
                        'JavaScript学習', 'HTML基礎', 'CSS入門', 'React開発',
                        'Vue.js実践', 'Python入門', 'データ分析', 'Web開発',
                        'プログラミング学習', 'フロントエンド', 'バックエンド', 'API開発',
                        'データベース設計', 'セキュリティ対策', 'クラウド運用'
                    ]
                }
            },
            computed: {
                activeBubblesCount() {
                    return this.bubbles.length;
                }
            },
            mounted() {
                // 保存されたAPIキーを復元
                const savedApiKey = localStorage.getItem('braveApiKey');
                if (savedApiKey) {
                    this.braveApiKey = savedApiKey;
                }
                
                // 保存されたAPI使用状況を復元
                const savedUsage = localStorage.getItem('braveApiUsage');
                if (savedUsage) {
                    this.apiUsage = JSON.parse(savedUsage);
                    // 日付が変わっていたらリセット
                    if (this.apiUsage.lastReset !== new Date().toDateString()) {
                        this.apiUsage.today = 0;
                        this.apiUsage.lastReset = new Date().toDateString();
                    }
                }
                
                // デモ用にサンプルワードで開始
                this.currentSuggestions = [...this.sampleWords];
                this.startGame();
                
                console.log('🦁 Brave Search API サジェストシステム初期化完了');
            },
            methods: {
                // Brave Search Suggest APIから直接サジェストを取得
                async fetchBraveSuggestions() {
                    if (!this.braveApiKey) {
                        this.error = 'Brave Search APIキーを入力してください';
                        return;
                    }
                    
                    if (!this.searchKeyword.trim()) {
                        this.error = '検索キーワードを入力してください';
                        return;
                    }

                    this.loading = true;
                    this.error = '';
                    this.successMessage = '';
                    
                    try {
                        // APIキーを保存
                        localStorage.setItem('braveApiKey', this.braveApiKey);
                        
                        // Brave Search Suggest API呼び出し
                        const response = await fetch(`https://api.search.brave.com/res/v1/suggest/search?q=${encodeURIComponent(this.searchKeyword)}&country=JP&count=${this.suggestionCount + 5}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Accept-Encoding': 'gzip',
                                'X-Subscription-Token': this.braveApiKey
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 401) {
                                throw new Error('APIキーが無効です。Brave Search APIの設定を確認してください。');
                            } else if (response.status === 429) {
                                throw new Error('API利用制限に達しました。しばらく待ってから再試行してください。');
                            } else {
                                throw new Error(`API呼び出しに失敗しました (${response.status})`);
                            }
                        }
                        
                        const data = await response.json();
                        console.log('Brave API Response:', data);
                        
                        // サジェストデータを抽出（検索キーワードを除外）
                        let suggestions = [];
                        if (data && Array.isArray(data)) {
                            suggestions = data
                                .filter(item => 
                                    item && 
                                    typeof item === 'string' && 
                                    item.trim().length > 0 &&
                                    // 検索キーワードと完全一致するものを除外
                                    item.toLowerCase() !== this.searchKeyword.toLowerCase() &&
                                    // 検索キーワードのみで構成されているものを除外
                                    !this.isExactSearchKeyword(item)
                                )
                                .slice(0, this.suggestionCount);
                        }
                        
                        if (suggestions.length === 0) {
                            // フォールバック: 関連キーワードを生成（検索キーワードを除外）
                            suggestions = this.generateFallbackSuggestions(this.searchKeyword);
                            console.log('フォールバックサジェストを使用:', suggestions);
                        }
                        
                        // 最終的なフィルタリングで検索キーワードを確実に除外
                        this.currentSuggestions = this.filterOutSearchKeyword(suggestions);
                        
                        // API使用状況を更新
                        this.apiUsage.total++;
                        this.apiUsage.today++;
                        localStorage.setItem('braveApiUsage', JSON.stringify(this.apiUsage));
                        
                        this.successMessage = `✅ ${this.currentSuggestions.length}個のサジェストを取得しました！`;
                        console.log('取得したサジェスト（検索キーワード除外後）:', this.currentSuggestions);
                        
                        // 新しいサジェストでゲームを再開始
                        this.restartGame();
                        
                    } catch (error) {
                        console.error('Brave API呼び出しエラー:', error);
                        this.error = error.message;
                        
                        // エラー時はフォールバックサジェストを使用（検索キーワード除外）
                        this.currentSuggestions = this.generateFallbackSuggestions(this.searchKeyword);
                        this.restartGame();
                        
                    } finally {
                        this.loading = false;
                        // 成功メッセージを3秒後に消す
                        if (this.successMessage) {
                            setTimeout(() => {
                                this.successMessage = '';
                            }, 3000);
                        }
                    }
                },

                // 検索キーワードかどうかを判定
                isExactSearchKeyword(suggestion) {
                    const keyword = this.searchKeyword.toLowerCase().trim();
                    const suggestionLower = suggestion.toLowerCase().trim();
                    
                    // 完全一致
                    if (suggestionLower === keyword) {
                        return true;
                    }
                    
                    // 検索キーワードのみを含む短い文字列（助詞などを除く）
                    const cleanSuggestion = suggestionLower.replace(/[のはがをにでとからまで]/g, '').trim();
                    if (cleanSuggestion === keyword) {
                        return true;
                    }
                    
                    return false;
                },

                // サジェストリストから検索キーワードを除外
                filterOutSearchKeyword(suggestions) {
                    const keyword = this.searchKeyword.toLowerCase().trim();
                    
                    return suggestions.filter(suggestion => {
                        const suggestionLower = suggestion.toLowerCase().trim();
                        
                        // 完全一致を除外
                        if (suggestionLower === keyword) {
                            return false;
                        }
                        
                        // 検索キーワードのみで構成されているものを除外
                        if (this.isExactSearchKeyword(suggestion)) {
                            return false;
                        }
                        
                        // 検索キーワードが単独で含まれているかチェック
                        const words = suggestionLower.split(/[\s　]+/);
                        if (words.length === 1 && words[0] === keyword) {
                            return false;
                        }
                        
                        return true;
                    });
                },

                // フォールバックサジェストを生成
                generateFallbackSuggestions(keyword) {
                    const suffixes = [
                        'とは', '方法', 'やり方', 'おすすめ', '比較', '無料',
                        '初心者', '入門', '基礎', '学習', 'ツール', 'コツ',
                        '使い方', '選び方', 'メリット', 'デメリット', '効果',
                        '種類', 'ランキング', '最新', '人気', '注意点'
                    ];
                    
                    const prefixes = [
                        '初心者向け', '無料の', 'おすすめの', '人気の', 
                        '最新の', '効果的な', '簡単な', '実践的な'
                    ];
                    
                    const suggestions = [];
                    
                    // サフィックス型サジェスト
                    suffixes.forEach(suffix => {
                        suggestions.push(`${keyword} ${suffix}`);
                    });
                    
                    // プレフィックス型サジェスト
                    prefixes.forEach(prefix => {
                        suggestions.push(`${prefix} ${keyword}`);
                    });
                    
                    // 検索キーワードを除外してフィルタリング
                    return this.filterOutSearchKeyword(suggestions).slice(0, this.suggestionCount);
                },

                // API接続テスト
                async testConnection() {
                    if (!this.braveApiKey) {
                        this.error = 'APIキーを入力してください';
                        return;
                    }
                    
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        const response = await fetch('https://api.search.brave.com/res/v1/suggest/search?q=test&count=1', {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'X-Subscription-Token': this.braveApiKey
                            }
                        });
                        
                        if (response.ok) {
                            this.successMessage = '✅ API接続に成功しました！';
                            localStorage.setItem('braveApiKey', this.braveApiKey);
                        } else {
                            throw new Error(`接続に失敗しました (${response.status})`);
                        }
                        
                    } catch (error) {
                        this.error = `❌ 接続テスト失敗: ${error.message}`;
                    } finally {
                        this.loading = false;
                        
                        // メッセージを3秒後に消す
                        setTimeout(() => {
                            this.successMessage = '';
                        }, 3000);
                    }
                },

                // 自動更新開始
                startAutoUpdate() {
                    if (!this.braveApiKey) {
                        this.error = 'APIキーを入力してから自動更新を開始してください';
                        return;
                    }
                    
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                    }
                    
                    // 60秒毎に自動更新（API制限を考慮）
                    this.updateInterval = setInterval(() => {
                        this.fetchBraveSuggestions();
                    }, 60000);
                    
                    this.autoUpdateStatus = '動作中（60秒毎）';
                    this.successMessage = '⚡ 自動更新を開始しました（60秒毎）';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 3000);
                },

                // 自動更新停止
                stopAutoUpdate() {
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                        this.updateInterval = null;
                        this.autoUpdateStatus = '停止中';
                        this.successMessage = '⏹️ 自動更新を停止しました';
                        setTimeout(() => {
                            this.successMessage = '';
                        }, 3000);
                    }
                },

                // ゲーム開始
                startGame() {
                    if (this.gameInterval) {
                        clearInterval(this.gameInterval);
                    }
                    
                    this.gameInterval = setInterval(() => {
                        this.createBubble();
                    }, this.bubbleInterval);
                },

                // ゲーム再開始
                restartGame() {
                    // 既存のシャボン玉をクリア
                    this.bubbles = [];
                    this.poppedCount = 0;
                    this.totalBubbles = 0;
                    
                    // ゲームを再開始
                    this.startGame();
                },

                // ゲームクリア
                clearGame() {
                    this.bubbles = [];
                    this.poppedCount = 0;
                    this.totalBubbles = 0;
                    this.selectedWords = [];
                    this.successMessage = '🗑️ ゲームをリセットしました';
                    setTimeout(() => {
                        this.successMessage = '';
                    }, 2000);
                },

                // 選択されたワードをクリア
                clearSelectedWords() {
                    this.selectedWords = [];
                },

                // シャボン玉作成
                createBubble() {
                    if (this.currentSuggestions.length === 0) return;
                    
                    const containerWidth = this.$refs.gameContainer?.clientWidth || 1200;
                    
                    // 検索キーワードを除外済みのサジェストからランダム選択
                    const availableSuggestions = this.currentSuggestions.filter(suggestion => 
                        !this.isExactSearchKeyword(suggestion)
                    );
                    
                    if (availableSuggestions.length === 0) {
                        console.log('利用可能なサジェストがありません');
                        return;
                    }
                    
                    const word = availableSuggestions[Math.floor(Math.random() * availableSuggestions.length)];
                    
                    // 検索キーワードではないことを再確認
                    if (this.isExactSearchKeyword(word)) {
                        console.log(`"${word}"は検索キーワードと判定されたため除外`);
                        return;
                    }
                    
                    const bubble = {
                        id: this.bubbleId++,
                        word: word,
                        x: Math.random() * (containerWidth - 150),
                        y: window.innerHeight,
                        size: Math.random() * 50 + 90,
                        speed: Math.random() * 3 + 7,
                        delay: Math.random() * 1
                    };
                    
                    this.bubbles.push(bubble);
                    this.totalBubbles++;
                    
                    console.log(`シャボン玉作成: "${word}" (検索キーワード: "${this.searchKeyword}")`);
                    
                    // 画面外に出たシャボン玉を削除
                    setTimeout(() => {
                        this.bubbles = this.bubbles.filter(b => b.id !== bubble.id);
                    }, bubble.speed * 1000 + 2000);
                },

                // シャボン玉をクリック
                popBubble(id) {
                    const bubbleIndex = this.bubbles.findIndex(b => b.id === id);
                    if (bubbleIndex !== -1) {
                        const bubble = this.bubbles[bubbleIndex];
                        
                        // 重複チェック
                        if (!this.selectedWords.includes(bubble.word)) {
                            this.selectedWords.push(bubble.word);
                        }
                        
                        this.bubbles.splice(bubbleIndex, 1);
                        this.poppedCount++;
                        
                        // エフェクト音（オプション）
                        console.log(`🎯 "${bubble.word}" がクリックされました！`);
                    }
                }
            },
            
            watch: {
                // シャボン玉生成間隔が変更されたらゲームを再開始
                bubbleInterval() {
                    if (this.gameInterval) {
                        this.startGame();
                    }
                }
            },
            
            beforeUnmount() {
                if (this.gameInterval) {
                    clearInterval(this.gameInterval);
                }
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
