<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>とりっぺんちゃん - 旅行予定調整サイト</title>

<!-- 外部ライブラリ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
/* 既存のスタイル */
:root {
  --primary: #87CEEB;
  --secondary: #B0E0E6;
  --accent: #4682B4;
  --text: #2F4F4F;
  --bg: #F0F8FF;
  --time-bg: #E6F3FF;
  --transition: all 0.3s ease;
  --radius: 15px;
  --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
  margin: 0;
  padding: 0;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, sans-serif;
  display: flex;
  flex-direction: column;
}

/* ヘッダー */
.header {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  padding: 15px 20px;
  box-shadow: var(--shadow);
  flex-shrink: 0;
  z-index: 1000;
  position: relative;
}

.header h1 {
  margin: 0;
  font-size: 1.8rem;
  font-weight: bold;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.header .subtitle {
  font-size: 0.9rem;
  opacity: 0.9;
  margin-top: 2px;
}

/* セットアップ画面 */
.setup-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: var(--bg);
}

.setup-card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 30px;
  max-width: 500px;
  width: 100%;
}

.setup-card h2 {
  color: var(--accent);
  margin-bottom: 20px;
  text-align: center;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: var(--text);
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 2px solid var(--secondary);
  border-radius: 8px;
  font-size: 16px;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.1);
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  display: inline-block;
  text-align: center;
}

.btn-primary {
  background: var(--accent);
  color: white;
}

.btn-primary:hover {
  background: #5a9bd4;
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--secondary);
  color: var(--text);
}

.btn-secondary:hover {
  background: #9fd3e8;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

/* デスクトップUI */
.desktop-ui {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.day-tabs {
  display: flex;
  background: white;
  border-bottom: 2px solid var(--secondary);
  flex-shrink: 0;
}

.day-tab {
  flex: 1;
  padding: 15px;
  text-align: center;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--text);
  font-weight: bold;
  transition: var(--transition);
  position: relative;
}

.day-tab:hover {
  background: var(--secondary);
}

.day-tab.active {
  background: var(--accent);
  color: white;
}

.day-tab.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--accent);
}

/* タイムライン */
.timeline-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.timeline-scroll-container {
  flex: 1;
  overflow-y: auto;
  position: relative;
}

.time-axis {
  display: flex;
  flex-direction: column;
  position: absolute;
  left: 0;
  top: 0;
  width: 80px;
  z-index: 100;
  background: var(--time-bg);
  border-right: 2px solid var(--secondary);
}

.time-slot {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-bottom: 1px solid var(--secondary);
  font-weight: bold;
  color: var(--text);
  font-size: 0.9rem;
}

.schedule-area {
  margin-left: 80px;
  position: relative;
  min-height: 1200px;
  background: white;
}

.schedule-grid {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
}

.grid-line {
  height: 60px;
  border-bottom: 1px solid #f0f0f0;
  position: relative;
}

.quarter-line {
  height: 25%;
  border-bottom: 1px dotted #f8f8f8;
}

.quarter-line:last-child {
  border-bottom: none;
}

/* 予定ブロック */
.event-block {
  position: absolute;
  background: white;
  border: 2px solid var(--secondary);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: var(--transition);
  z-index: 10;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-block:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.event-block.edit-mode {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.3);
}

.event-block.dragging {
  opacity: 0.7;
  transform: rotate(2deg);
}

.event-content-inline {
  font-size: 0.9rem;
  font-weight: bold;
  position: relative;
  padding-left: 20px;
}

.event-content-inline i {
  margin-right: 8px;
  color: var(--accent);
}

/* 天気絵文字 */
.weather-emoji-icon {
  position: absolute;
  top: 2px;
  left: 4px;
  font-size: 1.25em;
  cursor: pointer;
  z-index: 20;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.25));
  transition: transform 0.2s ease;
}

.weather-emoji-icon:hover {
  transform: scale(1.15);
}

/* カテゴリ別カラー */
.event-category-travel {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  border-color: #2196f3;
}

.event-category-food {
  background: linear-gradient(135deg, #fff3e0, #ffcc80);
  border-color: #ff9800;
}

.event-category-sightseeing {
  background: linear-gradient(135deg, #f3e5f5, #ce93d8);
  border-color: #9c27b0;
}

.event-category-shopping {
  background: linear-gradient(135deg, #e8f5e8, #a5d6a7);
  border-color: #4caf50;
}

.event-category-accommodation {
  background: linear-gradient(135deg, #fce4ec, #f8bbd9);
  border-color: #e91e63;
}

.event-category-meeting {
  background: linear-gradient(135deg, #fff8e1, #ffecb3);
  border-color: #ffc107;
}

.event-category-other {
  background: linear-gradient(135deg, #f1f8e9, #dcedc8);
  border-color: #8bc34a;
}

/* 予定操作 */
.event-actions {
  position: absolute;
  top: -12px;
  right: -12px;
  display: flex;
  gap: 4px;
}

.event-action-btn {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 0.7rem;
  transition: var(--transition);
}

.event-action-btn.cut {
  background: #dc3545;
  color: white;
}

.event-action-btn.cut:hover {
  background: #c82333;
  transform: scale(1.1);
}

.resize-handle {
  position: absolute;
  left: 0;
  right: 0;
  height: 8px;
  cursor: ns-resize;
  background: transparent;
  z-index: 15;
}

.resize-handle.top {
  top: -4px;
}

.resize-handle.bottom {
  bottom: -4px;
}

.resize-handle:hover {
  background: rgba(70, 130, 180, 0.3);
}

/* コンテキストメニュー */
.context-menu {
  position: fixed;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 2000;
  min-width: 180px;
  overflow: hidden;
}

.context-menu-item {
  padding: 12px 16px;
  cursor: pointer;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  font-size: 14px;
  color: var(--text);
  transition: var(--transition);
}

.context-menu-item:hover {
  background: var(--secondary);
}

.context-menu-item i {
  margin-right: 8px;
  width: 16px;
}

/* モバイルUI */
.mobile-ui {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.mobile-day-selector {
  background: white;
  border-bottom: 2px solid var(--secondary);
  padding: 10px;
  flex-shrink: 0;
}

.mobile-day-selector select {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--secondary);
  border-radius: 8px;
  font-size: 16px;
  background: white;
  color: var(--text);
}

/* FAB */
.fab {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  border: none;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: var(--transition);
  z-index: 1000;
}

.fab:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* 天気ポップアップ */
.weather-popup-modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(2px);
  z-index: 4000;
}

.weather-popup-content {
  background: #fff;
  border-radius: 16px;
  max-width: 95vw;
  max-height: 90vh;
  width: 950px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.35);
}

.weather-popup-header {
  background: linear-gradient(135deg, #66a3ff, #0059b3);
  color: #fff;
  padding: 14px 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}

.weather-popup-header h5 {
  margin: 0;
  font-size: 1.05em;
  font-weight: bold;
}

.weather-popup-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.45rem;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.25s;
}

.weather-popup-close:hover {
  background: rgba(255,255,255,0.25);
}

.weather-popup-body {
  padding: 18px;
  display: flex;
  flex-direction: column;
  flex: 1;
  overflow: hidden;
}

.weather-popup-info {
  background: #f8fbff;
  border: 1px solid #e0e9ff;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 14px;
  flex-shrink: 0;
}

.weather-desktop-table, .weather-mobile-table {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.weather-table-container {
  flex: 1;
  overflow: auto;
  border: 1px solid #e0e9ff;
  border-radius: 8px;
}

.weather-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  table-layout: fixed;
  min-width: 1380px;
  background: #f8fbff;
}

.weather-table th, .weather-table td {
  border: 1px solid #e0e9ff;
  padding: 12px 6px;
  text-align: center;
  vertical-align: middle;
}

.weather-table th {
  background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 10;
}

.weather-row-header {
  background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
  font-weight: bold;
  position: sticky;
  left: 0;
  z-index: 11;
}

.weather-emoji {
  font-size: 1.8em;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
}

.progress-container {
  background: #e6f2ff;
  border-radius: 6px;
  width: 100%;
  height: 12px;
  margin: 2px 0;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(135deg, #3385ff, #0059b3);
  border-radius: 6px;
  transition: width .4s ease;
}

.current-time-highlight {
  background-color: rgba(255,235,153,0.35) !important;
}

.hot-temperature {
  background: #dc2626 !important;
  color: #fff !important;
  font-weight: bold;
}

.cold-temperature {
  background: #1e40af !important;
  color: #fff !important;
  font-weight: bold;
}

/* モーダル */
.modal {
  display: none;
  position: fixed;
  z-index: 3000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: var(--radius);
  max-width: 90vw;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  margin: 0;
  font-size: 1.2em;
}

.modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

.modal-close:hover {
  background: rgba(255,255,255,0.2);
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 15px 20px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* レスポンシブ */
@media (max-width: 768px) {
  .weather-emoji-icon {
    font-size: 1.1em;
    top: 1px;
    left: 2px;
  }
  
  .weather-popup-content {
    width: 95vw;
    height: 88vh;
  }
  
  .weather-table {
    font-size: 11px;
    min-width: 100%;
  }
  
  .weather-table th, .weather-table td {
    padding: 8px 4px;
  }
}
</style>
</head>
<body>
<div id="app">
  <!-- ヘッダー -->
  <header class="header">
    <h1><i class="fas fa-plane"></i> とりっぺんちゃん</h1>
    <div class="subtitle">旅行予定調整サイト</div>
  </header>

  <!-- 旅行セットアップ画面 -->
  <div v-if="!tripInitialized" class="setup-container">
    <div class="setup-card">
      <h2><i class="fas fa-calendar-alt"></i> 旅行の設定</h2>
      
      <div v-if="hasExistingData" class="alert alert-info">
        <i class="fas fa-info-circle"></i> 
        既存の旅行データがあります。
        <button @click="loadData(); tripInitialized = true" class="btn btn-primary btn-sm ms-2">
          データを読み込む
        </button>
      </div>

      <div class="form-group">
        <label for="startDate">開始日</label>
        <input type="date" id="startDate" v-model="tripStartDate" :min="today" class="form-control">
      </div>
      
      <div class="form-group">
        <label for="endDate">終了日</label>
        <input type="date" id="endDate" v-model="tripEndDate" :min="tripStartDate || today" class="form-control">
      </div>
      
      <div class="form-group">
        <button @click="setupTrip" class="btn btn-primary w-100">
          <i class="fas fa-play"></i> 旅行を開始する
        </button>
      </div>
      
      <div v-if="hasExistingData" class="form-group">
        <button @click="resetTrip" class="btn btn-danger w-100">
          <i class="fas fa-trash"></i> 既存データを削除
        </button>
      </div>
    </div>
  </div>

  <!-- デスクトップUI -->
  <div v-if="tripInitialized && !isMobile" class="desktop-ui">
    <!-- 日程タブ -->
    <div class="day-tabs">
      <button v-for="(day, index) in tripDays" :key="index"
              @click="setActiveDay(index)"
              :class="['day-tab', { active: activeDay === index }]">
        {{ day.date }}
      </button>
    </div>

    <!-- タイムライン -->
    <div class="timeline-content">
      <div class="timeline-scroll-container" ref="scrollContainer">
        <div class="time-axis">
          <div class="time-slot" v-for="hour in timeSlots" :key="hour">{{ hour }}:00</div>
        </div>

        <div class="schedule-area" @click="editModeEvent = null" @contextmenu="handleScheduleContextMenu">
          <div class="schedule-grid">
            <div class="grid-line" v-for="hour in timeSlots" :key="hour">
              <div class="quarter-line"></div>
              <div class="quarter-line"></div>
              <div class="quarter-line"></div>
            </div>
          </div>

          <!-- 予定ブロック -->
          <div class="event-block"
               v-for="event in getCurrentDayEvents()" :key="event.id"
               :class="[
                 'event-category-' + event.category,
                 { 'edit-mode': editModeEvent && editModeEvent.id === event.id },
                 { 'dragging': draggingEvent && draggingEvent.id === event.id }
               ]"
               :style="getEventStyle(event)"
               @contextmenu.prevent="handleEventContextMenu($event, event)"
               @click="handleEventClick($event, event)"
               @mousedown="handleEventMouseDown($event, event)">
            <div class="event-content-inline">
              <span class="weather-emoji-icon" v-if="event.weatherEmoji"
                    @click.stop="openWeatherPopup(event)" :title="'天気予報を表示'">
                {{ event.weatherEmoji }}
              </span>
              <i :class="getCategoryIcon(event.category)"></i>
              {{ event.inlineText }}
            </div>

            <div class="event-actions"
                 v-if="editModeEvent && editModeEvent.id === event.id">
              <button class="event-action-btn cut"
                      @click="handleCutButtonClick($event, event)" @mousedown.stop title="切り取り">
                <i class="fas fa-cut"></i>
              </button>
            </div>
            <div class="resize-handle top"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @mousedown="startResize($event, event, 'top')"></div>
            <div class="resize-handle bottom"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @mousedown="startResize($event, event, 'bottom')"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- モバイルUI -->
  <div v-if="tripInitialized && isMobile" class="mobile-ui">
    <div class="mobile-day-selector">
      <select v-model="activeDay" @change="setActiveDay(activeDay)">
        <option v-for="(day, index) in tripDays" :key="index" :value="index">
          {{ day.date }}
        </option>
      </select>
    </div>

    <div class="timeline-content">
      <div class="timeline-scroll-container" ref="mobileTimelineContainer">
        <div class="time-axis">
          <div class="time-slot" v-for="hour in timeSlots" :key="hour">{{ hour }}:00</div>
        </div>

        <div class="schedule-area"
             @click="editModeEvent = null"
             @touchstart="handleScheduleTouchStart"
             @touchend="handleScheduleTouchEnd"
             @touchmove="handleScheduleTouchMove">
          <div class="schedule-grid">
            <div class="grid-line" v-for="hour in timeSlots" :key="hour">
              <div class="quarter-line"></div>
              <div class="quarter-line"></div>
              <div class="quarter-line"></div>
            </div>
          </div>

          <!-- 予定ブロック -->
          <div class="event-block"
               v-for="event in getCurrentDayEvents()" :key="event.id"
               :class="[
                 'event-category-' + event.category,
                 { 'edit-mode': editModeEvent && editModeEvent.id === event.id },
                 { 'dragging': draggingEvent && draggingEvent.id === event.id }
               ]"
               :style="getEventStyle(event)"
               @click="handleEventClick($event, event)"
               @touchstart="handleEventTouchStart($event, event)">
            <div class="event-content-inline">
              <span class="weather-emoji-icon" v-if="event.weatherEmoji"
                    @click.stop="openWeatherPopup(event)" :title="'天気予報を表示'">
                {{ event.weatherEmoji }}
              </span>
              <i :class="getCategoryIcon(event.category)"></i>
              {{ event.inlineText }}
            </div>

            <div class="event-actions"
                 v-if="editModeEvent && editModeEvent.id === event.id">
              <button class="event-action-btn cut"
                      @click="handleCutButtonClick($event, event)"
                      @touchstart.stop title="切り取り">
                <i class="fas fa-cut"></i>
              </button>
            </div>
            <div class="resize-handle top"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @touchstart="startResizeTouch($event, event, 'top')"></div>
            <div class="resize-handle bottom"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @touchstart="startResizeTouch($event, event, 'bottom')"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- FAB -->
    <button class="fab" @click="addNewEvent">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- 天気ポップアップ -->
  <div v-if="showWeatherPopup" class="weather-popup-modal" @click="closeWeatherPopup">
    <div class="weather-popup-content" @click.stop>
      <div class="weather-popup-header">
        <h5><i class="fas fa-cloud-sun"></i> {{ weatherPopupEvent?.title }} の天気予報</h5>
        <button class="weather-popup-close" @click="closeWeatherPopup">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="weather-popup-body">
        <div class="weather-popup-info">
          <div class="weather-event-info">
            <strong>{{ weatherPopupEvent?.title }}</strong><br>
            {{ tripDays[weatherPopupEvent?.dayIndex]?.date }} {{ weatherPopupEvent?.startTime }} - {{ weatherPopupEvent?.endTime }}
          </div>
          <div class="weather-location-info" v-if="weatherPopupEvent?.coordinates">
            <i class="fas fa-map-marker-alt"></i> {{ weatherPopupEvent?.coordinates }}
          </div>
        </div>

        <!-- デスクトップ表示 -->
        <div class="weather-desktop-table" v-if="!isMobile">
          <div class="weather-table-container" ref="weatherTableContainer">
            <table class="weather-table">
              <thead>
                <tr>
                  <th class="weather-row-header">⛅ 天気</th>
                  <th v-for="hour in weatherHours" :key="hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }"
                      :id="'weather-hour-' + hour">
                    <span class="weather-emoji">{{ getWeatherIcon(fullDayWeather[hour]) }}</span><br>
                    {{ hour }}:00
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="weather-row-header"><strong>🌧️ 降水確率</strong></td>
                  <td v-for="hour in weatherHours" :key="'p'+hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }">
                    <div class="progress-container">
                      <div class="progress-bar"
                           :style="{ width: (fullDayWeather[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                    </div>
                    {{ fullDayWeather[hour]?.precipitation_probability ?? 0 }}%
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>🌡️ 気温</strong></td>
                  <td v-for="hour in weatherHours" :key="'t'+hour"
                      :class="[{ 'current-time-highlight': isEventHour(hour) }, getTemperatureClass(fullDayWeather[hour]?.temperature)]">
                    {{ fullDayWeather[hour]?.temperature ?? '-' }}℃
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>🤒 体感温度</strong></td>
                  <td v-for="hour in weatherHours" :key="'a'+hour"
                      :class="[{ 'current-time-highlight': isEventHour(hour) }, getTemperatureClass(fullDayWeather[hour]?.apparent_temperature)]">
                    {{ fullDayWeather[hour]?.apparent_temperature ?? '-' }}℃
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>💧 湿度</strong></td>
                  <td v-for="hour in weatherHours" :key="'h'+hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }">
                    {{ fullDayWeather[hour]?.humidity ?? '-' }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- モバイル表示 -->
        <div class="weather-mobile-table" v-if="isMobile">
          <div class="weather-table-container" ref="weatherMobileTableContainer">
            <table class="weather-table">
              <thead>
                <tr>
                  <th>⛅<br>天気</th>
                  <th>🌧️<br>降水確率</th>
                  <th>🌡️<br>気温</th>
                  <th>🤒<br>体感温度</th>
                  <th>💧<br>湿度</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="hour in weatherHours" :key="hour"
                    :class="{ 'current-time-highlight': isEventHour(hour) }"
                    :id="'weather-mobile-hour-' + hour">
                  <td>
                    <span class="weather-emoji">{{ getWeatherIcon(fullDayWeather[hour]) }}</span><br>
                    {{ hour }}:00
                  </td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar"
                           :style="{ width: (fullDayWeather[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                    </div>
                    {{ fullDayWeather[hour]?.precipitation_probability ?? 0 }}%
                  </td>
                  <td :class="getTemperatureClass(fullDayWeather[hour]?.temperature)">
                    {{ fullDayWeather[hour]?.temperature ?? '-' }}℃
                  </td>
                  <td :class="getTemperatureClass(fullDayWeather[hour]?.apparent_temperature)">
                    {{ fullDayWeather[hour]?.apparent_temperature ?? '-' }}℃
                  </td>
                  <td>{{ fullDayWeather[hour]?.humidity ?? '-' }}%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- コンテキストメニュー -->
  <div v-if="showContextMenu" class="context-menu" :style="contextMenuStyle" @click="closeContextMenu">
    <button class="context-menu-item" @click="addNewEvent">
      <i class="fas fa-plus"></i> 新しい予定を追加
    </button>
    <button class="context-menu-item" v-if="clipboardEvent" @click="pasteEvent">
      <i class="fas fa-paste"></i> 予定を貼り付け
    </button>
  </div>

  <!-- 予定編集モーダル -->
  <div class="modal" :class="{ show: isModalOpen('eventModal') }">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">予定の編集</h3>
        <button class="modal-close" @click="closeModal('eventModal')">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>タイトル</label>
          <input type="text" v-model="eventForm.title" class="form-control" placeholder="予定のタイトル">
        </div>
        <div class="form-group">
          <label>開始時刻</label>
          <input type="time" v-model="eventForm.startTime" class="form-control">
        </div>
        <div class="form-group">
          <label>終了時刻</label>
          <input type="time" v-model="eventForm.endTime" class="form-control">
        </div>
        <div class="form-group">
          <label>カテゴリ</label>
          <select v-model="eventForm.category" class="form-control">
            <option value="travel">移動</option>
            <option value="food">食事</option>
            <option value="sightseeing">観光</option>
            <option value="shopping">買い物</option>
            <option value="accommodation">宿泊</option>
            <option value="meeting">会議</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div class="form-group">
          <label>説明</label>
          <textarea v-model="eventForm.description" class="form-control" placeholder="詳細な説明"></textarea>
        </div>
        <div class="form-group">
          <label>位置情報</label>
          <div class="input-group">
            <input type="text" v-model="eventForm.coordinates" class="form-control" placeholder="緯度, 経度">
            <button type="button" class="btn btn-secondary" @click="openMapModal">
              <i class="fas fa-map"></i> 地図で選択
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeModal('eventModal')">キャンセル</button>
        <button class="btn btn-primary" @click="saveEvent">保存</button>
      </div>
    </div>
  </div>

  <!-- 地図モーダル -->
  <div v-if="showMapModal" class="modal show">
    <div class="modal-content" style="width: 80vw; height: 80vh;">
      <div class="modal-header">
        <h3 class="modal-title">位置を選択</h3>
        <button class="modal-close" @click="closeMapModal">×</button>
      </div>
      <div class="modal-body" style="padding: 0; position: relative;">
        <div id="map" style="width: 100%; height: 60vh;"></div>
        <div style="padding: 15px;">
          <p v-if="selectedCoordinates">選択された座標: {{ selectedCoordinates }}</p>
          <p v-else>地図をクリックして位置を選択してください</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" @click="closeMapModal">キャンセル</button>
        <button class="btn btn-primary" @click="selectCoordinates" :disabled="!selectedCoordinates">選択</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const { createApp } = Vue;
const app = createApp({
  data() {
    return {
      /* 前回提供したスクリプト内容と同じ */
      tripInitialized: false,
      tripStartDate: '',
      tripEndDate: '',
      today: new Date().toISOString().split('T')[0],
      hasExistingData: false,
      tripDays: [],
      activeDay: 0,
      showMobilePopup: false,
      selectedDayForPopup: null,
      selectedDayIndex: null,
      isMobile: false,
      scrollPosition: 0,
      maxScrollPosition: 0,
      timeSlots: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
      events: [],
      editModeEvent: null,
      clipboardEvent: null,
      showContextMenu: false,
      contextMenuStyle: {},
      pasteTargetTime: null,
      touchStartTime: 0,
      touchStartPosition: { x: 0, y: 0 },
      longPressTimer: null,
      longPressExecuted: false,
      eventTouchOffset: { x: 0, y: 0 },
      draggingEvent: null,
      isDragComplete: false,
      isResizeComplete: false,
      dragStarted: false,
      longPressEventData: null,
      longPressEvent: null,
      readyToMoveEventId: null,
      showMapModal: false,
      map: null,
      selectedCoordinates: null,
      mapMarker: null,
      eventForm: {
        title: '',
        dayIndex: 0,
        startTime: '09:00',
        endTime: '10:00',
        category: 'travel',
        description: '',
        coordinates: ''
      },
      modals: [],
      showWeatherPopup: false,
      weatherPopupEvent: null,
      fullDayWeather: {},
      weatherHours: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],
      weatherCache: {}
    };
  },
  
  methods: {
    /* 前回提供したメソッド内容と同じ */
    detectMobile() {
      this.isMobile = window.innerWidth <= 768;
    },
    
    checkExistingData() {
      const saved = localStorage.getItem('tripData');
      this.hasExistingData = !!saved;
    },
    
    loadData() {
      const saved = localStorage.getItem('tripData');
      if (saved) {
        const data = JSON.parse(saved);
        this.tripDays = data.tripDays || [];
        this.events = data.events || [];
        this.tripStartDate = data.tripStartDate || '';
        this.tripEndDate = data.tripEndDate || '';
        this.activeDay = data.activeDay || 0;
        this.updateEventInlineText();
      }
    },
    
    saveData() {
      const data = {
        tripDays: this.tripDays,
        events: this.events,
        tripStartDate: this.tripStartDate,
        tripEndDate: this.tripEndDate,
        activeDay: this.activeDay
      };
      localStorage.setItem('tripData', JSON.stringify(data));
    },
    
    setupTrip() {
      if (!this.tripStartDate || !this.tripEndDate) {
        alert('開始日と終了日を入力してください');
        return;
      }
      
      if (new Date(this.tripStartDate) > new Date(this.tripEndDate)) {
        alert('開始日は終了日より前の日付を入力してください');
        return;
      }
      
      this.tripDays = [];
      const start = new Date(this.tripStartDate);
      const end = new Date(this.tripEndDate);
      
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][d.getDay()];
        this.tripDays.push({
          date: `${d.getMonth() + 1}/${d.getDate()}(${dayOfWeek})`,
          fullDate: d.toISOString().split('T')[0]
        });
      }
      
      this.tripInitialized = true;
      this.activeDay = 0;
      this.saveData();
      this.updateWeatherEmoji();
    },
    
    resetTrip() {
      if (confirm('すべてのデータが削除されます。よろしいですか？')) {
        localStorage.removeItem('tripData');
        this.tripDays = [];
        this.events = [];
        this.tripStartDate = '';
        this.tripEndDate = '';
        this.activeDay = 0;
        this.tripInitialized = false;
        this.hasExistingData = false;
        this.weatherCache = {};
      }
    },
    
    setActiveDay(index) {
      this.activeDay = index;
      this.editModeEvent = null;
      this.saveData();
    },
    
    getCurrentDayEvents() {
      return this.events.filter(event => event.dayIndex === this.activeDay);
    },
    
    getEventStyle(event) {
      const startMinutes = this.timeToMinutes(event.startTime);
      const endMinutes = this.timeToMinutes(event.endTime);
      const duration = endMinutes - startMinutes;
      
      const top = ((startMinutes - 240) / 60) * 60;
      const height = (duration / 60) * 60;
      
      return {
        top: `${top}px`,
        height: `${height}px`,
        left: '10px',
        right: '10px'
      };
    },
    
    timeToMinutes(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    },
    
    minutesToTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    },
    
    getCategoryIcon(category) {
      const icons = {
        travel: 'fas fa-plane',
        food: 'fas fa-utensils',
        sightseeing: 'fas fa-camera',
        shopping: 'fas fa-shopping-bag',
        accommodation: 'fas fa-bed',
        meeting: 'fas fa-users',
        other: 'fas fa-star'
      };
      return icons[category] || 'fas fa-star';
    },
    
    handleEventClick(event, eventData) {
      event.stopPropagation();
      if (this.editModeEvent && this.editModeEvent.id === eventData.id) {
        this.editModeEvent = null;
      } else {
        this.editModeEvent = eventData;
      }
    },
    
    handleEventMouseDown(event, eventData) {
      if (this.isMobile) return;
      
      this.dragStarted = false;
      this.draggingEvent = null;
      
      const moveHandler = (e) => {
        if (!this.dragStarted) {
          this.dragStarted = true;
          this.draggingEvent = eventData;
          this.editModeEvent = null;
        }
        
        const container = this.$refs.scrollContainer;
        const rect = container.getBoundingClientRect();
        const y = e.clientY - rect.top + container.scrollTop;
        const newStartMinutes = Math.round((y / 60) * 60) + 240;
        
        if (newStartMinutes >= 240 && newStartMinutes <= 1440) {
          const duration = this.timeToMinutes(eventData.endTime) - this.timeToMinutes(eventData.startTime);
          const newEndMinutes = newStartMinutes + duration;
          
          if (newEndMinutes <= 1440) {
            eventData.startTime = this.minutesToTime(newStartMinutes);
            eventData.endTime = this.minutesToTime(newEndMinutes);
            this.updateEventInlineText();
          }
        }
      };
      
      const upHandler = () => {
        if (this.draggingEvent) {
          this.isDragComplete = true;
          this.saveData();
          setTimeout(() => {
            this.draggingEvent = null;
            this.isDragComplete = false;
          }, 100);
        }
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', upHandler);
      };
      
      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', upHandler);
    },
    
    startResize(event, eventData, direction) {
      event.stopPropagation();
      event.preventDefault();
      
      const moveHandler = (e) => {
        const container = this.$refs.scrollContainer;
        const rect = container.getBoundingClientRect();
        const y = e.clientY - rect.top + container.scrollTop;
        const minutes = Math.round((y / 60) * 60) + 240;
        
        if (direction === 'top') {
          if (minutes >= 240 && minutes < this.timeToMinutes(eventData.endTime)) {
            eventData.startTime = this.minutesToTime(minutes);
            this.updateEventInlineText();
          }
        } else {
          if (minutes > this.timeToMinutes(eventData.startTime) && minutes <= 1440) {
            eventData.endTime = this.minutesToTime(minutes);
            this.updateEventInlineText();
          }
        }
      };
      
      const upHandler = () => {
        this.isResizeComplete = true;
        this.saveData();
        setTimeout(() => {
          this.isResizeComplete = false;
        }, 100);
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', upHandler);
      };
      
      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', upHandler);
    },
    
    handleScheduleContextMenu(event) {
      event.preventDefault();
      const container = this.$refs.scrollContainer;
      const rect = container.getBoundingClientRect();
      const y = event.clientY - rect.top + container.scrollTop;
      const minutes = Math.round((y / 60) * 60) + 240;
      
      this.pasteTargetTime = this.minutesToTime(minutes);
      this.contextMenuStyle = {
        top: `${event.clientY}px`,
        left: `${event.clientX}px`
      };
      this.showContextMenu = true;
    },
    
    handleEventContextMenu(event, eventData) {
      event.preventDefault();
      this.contextMenuStyle = {
        top: `${event.clientY}px`,
        left: `${event.clientX}px`
      };
      this.showContextMenu = true;
    },
    
    closeContextMenu() {
      this.showContextMenu = false;
    },
    
    addNewEvent() {
      this.eventForm = {
        title: '',
        dayIndex: this.activeDay,
        startTime: this.pasteTargetTime || '09:00',
        endTime: this.pasteTargetTime ? this.minutesToTime(this.timeToMinutes(this.pasteTargetTime) + 60) : '10:00',
        category: 'travel',
        description: '',
        coordinates: ''
      };
      this.openModal('eventModal');
      this.closeContextMenu();
    },
    
    editEvent(event) {
      this.eventForm = { ...event };
      this.openModal('eventModal');
      this.closeContextMenu();
    },
    
    deleteEvent(event) {
      if (confirm('この予定を削除しますか？')) {
        this.events = this.events.filter(e => e.id !== event.id);
        this.saveData();
      }
      this.closeContextMenu();
    },
    
    saveEvent() {
      if (!this.eventForm.title.trim()) {
        alert('タイトルを入力してください');
        return;
      }
      
      if (this.eventForm.id) {
        const index = this.events.findIndex(e => e.id === this.eventForm.id);
        if (index !== -1) {
          this.events[index] = { ...this.eventForm };
        }
      } else {
        this.eventForm.id = Date.now();
        this.events.push({ ...this.eventForm });
      }
      
      this.updateEventInlineText();
      this.saveData();
      this.closeModal('eventModal');
      this.updateWeatherEmoji();
    },
    
    updateEventInlineText() {
      this.events.forEach(event => {
        event.inlineText = `${event.startTime}-${event.endTime} ${event.title}`;
      });
    },
    
    handleCutButtonClick(event, eventData) {
      event.stopPropagation();
      this.cutEvent(eventData);
    },
    
    cutEvent(event) {
      this.clipboardEvent = { ...event };
      this.events = this.events.filter(e => e.id !== event.id);
      this.editModeEvent = null;
      this.saveData();
      this.closeContextMenu();
    },
    
    pasteEvent() {
      if (!this.clipboardEvent) return;
      
      const newEvent = {
        ...this.clipboardEvent,
        id: Date.now(),
        dayIndex: this.activeDay,
        startTime: this.pasteTargetTime,
        endTime: this.minutesToTime(
          this.timeToMinutes(this.pasteTargetTime) + 
          (this.timeToMinutes(this.clipboardEvent.endTime) - this.timeToMinutes(this.clipboardEvent.startTime))
        )
      };
      
      newEvent.inlineText = `${newEvent.startTime}-${newEvent.endTime} ${newEvent.title}`;
      this.events.push(newEvent);
      this.clipboardEvent = null;
      this.saveData();
      this.closeContextMenu();
      this.updateWeatherEmoji();
    },
    
    openModal(modalId) {
      if (!this.modals.includes(modalId)) {
        this.modals.push(modalId);
      }
    },
    
    closeModal(modalId) {
      this.modals = this.modals.filter(id => id !== modalId);
    },
    
    isModalOpen(modalId) {
      return this.modals.includes(modalId);
    },
    
    openMapModal() {
      this.showMapModal = true;
      this.$nextTick(() => {
        this.initMap();
      });
    },
    
    closeMapModal() {
      this.showMapModal = false;
      this.selectedCoordinates = null;
      if (this.map) {
        this.map.remove();
        this.map = null;
      }
    },
    
    initMap() {
      if (this.map) return;
      
      this.map = L.map('map').setView([35.6762, 139.6503], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(this.map);
      
      this.map.on('click', (e) => {
        this.selectedCoordinates = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
        
        if (this.mapMarker) {
          this.map.removeLayer(this.mapMarker);
        }
        
        this.mapMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(this.map);
      });
    },
    
    selectCoordinates() {
      if (this.selectedCoordinates) {
        this.eventForm.coordinates = this.selectedCoordinates;
        this.closeMapModal();
      }
    },
    
    handleScheduleTouchStart(event) {
      if (event.touches.length !== 1) return;
      this.touchStartTime = Date.now();
      this.touchStartPosition = {
        x: event.touches[0].clientX,
        y: event.touches[0].clientY
      };
    },
    
    handleScheduleTouchEnd(event) {
      const touchDuration = Date.now() - this.touchStartTime;
      const touch = event.changedTouches[0];
      const deltaX = Math.abs(touch.clientX - this.touchStartPosition.x);
      const deltaY = Math.abs(touch.clientY - this.touchStartPosition.y);
      
      if (touchDuration >= 800 && deltaX < 20 && deltaY < 20) {
        const container = this.$refs.mobileTimelineContainer;
        const rect = container.getBoundingClientRect();
        const y = touch.clientY - rect.top + container.scrollTop;
        const minutes = Math.round((y / 60) * 60) + 240;
        
        this.pasteTargetTime = this.minutesToTime(minutes);
        this.addNewEvent();
      }
    },
    
    handleScheduleTouchMove(event) {
      // タッチ移動時の処理
    },
    
    handleEventTouchStart(event, eventData) {
      if (event.touches.length !== 1) return;
      event.preventDefault();
      
      this.touchStartTime = Date.now();
      this.touchStartPosition = {
        x: event.touches[0].clientX,
        y: event.touches[0].clientY
      };
      
      this.longPressEventData = eventData;
      this.longPressExecuted = false;
      
      this.longPressTimer = setTimeout(() => {
        this.longPressExecuted = true;
        this.editModeEvent = eventData;
        this.readyToMoveEventId = eventData.id;
      }, 600);
    },
    
    startResizeTouch(event, eventData, direction) {
      event.preventDefault();
      event.stopPropagation();
      
      const moveHandler = (e) => {
        if (e.touches.length !== 1) return;
        
        const container = this.$refs.mobileTimelineContainer;
        const rect = container.getBoundingClientRect();
        const y = e.touches[0].clientY - rect.top + container.scrollTop;
        const minutes = Math.round((y / 60) * 60) + 240;
        
        if (direction === 'top') {
          if (minutes >= 240 && minutes < this.timeToMinutes(eventData.endTime)) {
            eventData.startTime = this.minutesToTime(minutes);
            this.updateEventInlineText();
          }
        } else {
          if (minutes > this.timeToMinutes(eventData.startTime) && minutes <= 1440) {
            eventData.endTime = this.minutesToTime(minutes);
            this.updateEventInlineText();
          }
        }
      };
      
      const endHandler = () => {
        this.isResizeComplete = true;
        this.saveData();
        setTimeout(() => {
          this.isResizeComplete = false;
        }, 100);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
      };
      
      document.addEventListener('touchmove', moveHandler);
      document.addEventListener('touchend', endHandler);
    },
    
    async fetchWeatherForEvent(event) {
      if (!event.coordinates) return null;
      const [lat, lng] = event.coordinates.split(',').map(c => parseFloat(c.trim()));
      if (isNaN(lat) || isNaN(lng)) return null;
      const dayData = this.tripDays[event.dayIndex];
      if (!dayData) return null;
      
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat.toFixed(4)}&longitude=${lng.toFixed(4)}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weather_code&start_date=${dayData.fullDate}&end_date=${dayData.fullDate}&timezone=Asia/Tokyo`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('天気取得失敗');
        const data = await res.json();
        const hour = parseInt(event.startTime.split(':')[0]);
        const idx = data.hourly.time.findIndex(t => t.endsWith(`T${hour.toString().padStart(2, '0')}:00`));
        if (idx === -1) return null;
        return {
          weather_code: data.hourly.weather_code[idx],
          precipitation_probability: data.hourly.precipitation_probability[idx] ?? 0
        };
      } catch (e) {
        console.error(e);
        return null;
      }
    },
    
    getWeatherIcon(d) {
      if (!d) return '☀️';
      const p = d.precipitation_probability ?? 0, c = d.weather_code ?? 0;
      if (p >= 70) return '☔';
      if (p >= 40) return '🌧️';
      if (p >= 20) return '🌦️';
      const icons = {
        0: '☀️', 1: '⛅', 2: '⛅', 3: '⛅', 45: '🌫️', 48: '🌫️', 51: '🌦️', 53: '🌦️', 55: '🌦️',
        61: '🌧️', 63: '🌧️', 65: '🌧️', 71: '❄️', 73: '❄️', 75: '❄️', 80: '🌦️', 81: '🌦️', 82: '🌦️',
        95: '⛈️', 96: '⛈️', 99: '⛈️'
      };
      return icons[c] || '☀️';
    },
    
    getTemperatureClass(t) {
      if (t === undefined || t === null) return '';
      if (t >= 35) return 'hot-temperature';
      if (t <= 0) return 'cold-temperature';
      return '';
    },
    
    async updateWeatherEmoji() {
      for (const ev of this.events) {
        if (!ev.coordinates) continue;
        const key = `${ev.coordinates}_${this.tripDays[ev.dayIndex]?.fullDate}_${ev.startTime}`;
        if (this.weatherCache[key]) {
          ev.weatherEmoji = this.weatherCache[key];
          continue;
        }
        const d = await this.fetchWeatherForEvent(ev);
        if (d) {
          const emoji = this.getWeatherIcon(d);
          this.$set(ev, 'weatherEmoji', emoji);
          this.weatherCache[key] = emoji;
        }
      }
    },
    
    async openWeatherPopup(event) {
      if (!event.coordinates) {
        alert('位置情報がありません');
        return;
      }
      this.weatherPopupEvent = event;
      this.showWeatherPopup = true;
      await this.$nextTick();
      await this.fetchFullDayWeather();
      await this.scrollToEventTime();
    },
    
    async fetchFullDayWeather() {
      if (!this.weatherPopupEvent?.coordinates) return;
      const [lat, lng] = this.weatherPopupEvent.coordinates.split(',').map(c => parseFloat(c.trim()));
      const dayData = this.tripDays[this.weatherPopupEvent.dayIndex];
      if (!dayData) return;
      
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat.toFixed(4)}&longitude=${lng.toFixed(4)}&hourly=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code&start_date=${dayData.fullDate}&end_date=${dayData.fullDate}&timezone=Asia/Tokyo`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('天気取得失敗');
        const data = await res.json();
        this.fullDayWeather = {};
        
        for (const h of this.weatherHours) {
          const idx = data.hourly.time.findIndex(t => t.endsWith(`T${h.toString().padStart(2, '0')}:00`));
          if (idx === -1) continue;
          this.fullDayWeather[h] = {
            temperature: Math.round(data.hourly.temperature_2m[idx]),
            apparent_temperature: Math.round(data.hourly.apparent_temperature[idx]),
            humidity: Math.round(data.hourly.relative_humidity_2m[idx]),
            precipitation_probability: Math.round(data.hourly.precipitation_probability[idx] ?? 0),
            weather_code: data.hourly.weather_code[idx]
          };
        }
      } catch (e) {
        console.error(e);
        alert('天気取得に失敗しました');
      }
    },
    
    async scrollToEventTime() {
      await this.$nextTick();
      const hour = parseInt(this.weatherPopupEvent.startTime.split(':')[0]);
      
      setTimeout(() => {
        if (this.isMobile) {
          const container = this.$refs.weatherMobileTableContainer;
          const target = document.getElementById('weather-mobile-hour-' + hour);
          if (container && target) {
            const pos = target.offsetTop - container.offsetTop - 60;
            container.scrollTo({ top: Math.max(0, pos), behavior: 'smooth' });
          }
        } else {
          const container = this.$refs.weatherTableContainer;
          const target = document.getElementById('weather-hour-' + hour);
          if (container && target) {
            const pos = target.offsetLeft - container.offsetLeft - 60;
            container.scrollTo({ left: Math.max(0, pos), behavior: 'smooth' });
          }
        }
      }, 120);
    },
    
    closeWeatherPopup() {
      this.showWeatherPopup = false;
      this.weatherPopupEvent = null;
      this.fullDayWeather = {};
    },
    
    isEventHour(h) {
      if (!this.weatherPopupEvent?.startTime) return false;
      return h === parseInt(this.weatherPopupEvent.startTime.split(':')[0]);
    }
  },
  
  mounted() {
    this.detectMobile();
    this.checkExistingData();
    this.loadData();
    if (this.tripDays.length > 0) {
      this.tripInitialized = true;
      this.updateWeatherEmoji();
    }
    window.addEventListener('resize', this.detectMobile);
    
    this.$watch(() => this.events.length, () => {
      this.updateWeatherEmoji();
    });
    
    window.app = this;
  },
  
  beforeUnmount() {
    window.removeEventListener('resize', this.detectMobile);
    if (this.longPressTimer) {
      clearTimeout(this.longPressTimer);
      this.longPressTimer = null;
    }
  }
}).mount('#app');
</script>
</body>
</html>
