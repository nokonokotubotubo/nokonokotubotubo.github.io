<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>とりっぺんちゃん - 旅行予定調整サイト</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Leafletライブラリ（OpenStreetMap API用）-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{--primary:#87CEEB;--secondary:#B0E0E6;--accent:#4682B4;--text:#2F4F4F;--bg:#F0F8FF;--time-bg:#E6F3FF;--transition:all 0.3s ease;--radius:15px;--shadow:0 2px 10px rgba(0,0,0,0.1)}
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;display:flex;flex-direction:column}
#app{height:100vh;display:flex;flex-direction:column;overflow:hidden}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:8px 0;text-align:center;box-shadow:var(--shadow);flex-shrink:0;position:relative}
.header .container{position:relative}
.header h1{margin:0;display:inline-block}
.cloud-load-btn{position:absolute;left:15px;top:50%;transform:translateY(-50%);background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:50%;transition:var(--transition);z-index:100}
.cloud-load-btn:hover{background:rgba(255,255,255,0.2);color:white}
.cloud-load-btn:disabled{opacity:0.5;cursor:not-allowed}
.cloud-load-btn.loading{animation:spin 1s linear infinite}
.cloud-load-btn.error{color:#ff6b6b}
.cloud-write-btn{position:absolute;left:65px;top:50%;transform:translateY(-50%);background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:50%;transition:var(--transition);z-index:100}
.cloud-write-btn:hover{background:rgba(255,255,255,0.2);color:white}
.cloud-write-btn:disabled{opacity:0.5;cursor:not-allowed}
.cloud-write-btn.loading{animation:spin 1s linear infinite}
.cloud-write-btn.error{color:#ff6b6b}
@keyframes spin{0%{transform:translateY(-50%) rotate(0deg)}100%{transform:translateY(-50%) rotate(360deg)}}
.settings-btn{position:absolute;right:15px;top:50%;transform:translateY(-50%);background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:8px;border-radius:50%;transition:var(--transition);z-index:100}
.settings-btn:hover{background:rgba(255,255,255,0.2);color:white}

/* 【新機能】リアルタイム更新通知スタイル */
.realtime-notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 2000;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    min-width: 280px;
}
.realtime-notification.show {
    opacity: 1;
    transform: translateX(0);
}
.realtime-notification i {
    font-size: 1.2rem;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.penguin-icon{font-size:2rem;margin-right:10px}
.desktop-ui,.mobile-ui{flex:1;display:flex;flex-direction:column;overflow:hidden}
.day-tabs-container{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--secondary) transparent;flex-shrink:0}
.day-tabs{background:white;border-radius:var(--radius) var(--radius) 0 0;margin:10px 0 0 0;box-shadow:var(--shadow);display:flex;min-width:max-content}
.day-tabs .nav-item{transition:var(--transition);flex-shrink:0;position:relative}
.day-tabs .nav-link{border:none;color:var(--text);padding:12px 20px;line-height: 1.2;border-radius:var(--radius) var(--radius) 0 0;white-space:nowrap;text-align:center;min-width:120px;transition:var(--transition);position:relative;display:block}
.day-tabs .nav-link.active{background:var(--primary);color:white;box-shadow:var(--shadow)}
.day-tabs .nav-link:hover{background:var(--secondary);color:white}
.delete-day-btn{position:absolute;top:5px;right:5px;width:20px;height:20px;border-radius:50%;background:rgba(255,99,99,0.8);color:white;border:none;font-size:0.7rem;display:none;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition)}
.delete-day-btn:hover{background:rgba(255,99,99,1);transform:scale(1.1)}
.day-tabs .nav-link:hover .delete-day-btn{display:flex}
.mobile-day-selector{background:white;padding:12px 0;box-shadow:var(--shadow);flex-shrink:0;position:relative}
.mobile-scroll-container{position:relative;padding:0 50px}
.mobile-day-buttons{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--secondary) transparent;padding:0 15px 10px 15px}
.mobile-day-btn{min-width:100px;height:60px;border:2px solid var(--secondary);background:white;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;font:bold 0.9rem/1 sans-serif;color:var(--text);transition:var(--transition);flex-shrink:0;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:manipulation}
.mobile-day-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
.mobile-day-btn:active{transform:scale(0.95)}
.mobile-scroll-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.9);border:2px solid var(--secondary);color:var(--accent);font-size:1rem;cursor:pointer;transition:var(--transition);z-index:10;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
.mobile-scroll-nav:active{transform:translateY(-50%) scale(0.9)}
.mobile-scroll-nav.left{left:5px}
.mobile-scroll-nav.right{right:5px}
.mobile-scroll-nav.disabled{opacity:0.3;pointer-events:none}
.mobile-popup-menu{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:var(--transition);-webkit-tap-highlight-color:transparent}
.mobile-popup-menu.show{opacity:1;visibility:visible}
.mobile-popup-content{background:white;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:300px;width:90%;text-align:center}
.mobile-popup-title{font:bold 1.2rem/1 sans-serif;color:var(--accent);margin-bottom:20px}
.mobile-popup-buttons{display:flex;flex-direction:column;gap:15px}
.mobile-popup-btn{padding:15px 20px;border:none;border-radius:var(--radius);font:bold 1rem/1 sans-serif;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;gap:10px;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.mobile-popup-btn.primary{background:var(--primary);color:white}
.mobile-popup-btn.success{background:#28a745;color:white}
.mobile-popup-btn.danger{background:#dc3545;color:white}
.mobile-popup-btn.secondary{background:#6c757d;color:white}
.mobile-popup-btn:active{transform:scale(0.95)}
.mobile-fab{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:var(--transition);z-index:1000;-webkit-tap-highlight-color:transparent}
.mobile-fab:active{transform:scale(0.9)}
.timeline-container{background:white;border-radius:0 0 var(--radius) var(--radius);margin:0;box-shadow:0 4px 15px rgba(0,0,0,0.1);flex:1;display:flex;flex-direction:column;overflow:hidden}
.timeline-header{background:var(--secondary);padding:8px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.timeline-header h5{font-size:1rem;margin:0;line-height:1.2}
.timeline-header h5 small{font-size:0.85rem;margin-left:8px}
.timeline-content{flex:1;overflow:hidden}
.timeline-scroll-container{height:100%;display:flex;overflow-y:auto;overflow-x:hidden}
.time-axis{width:80px;background:var(--time-bg);border-right:2px solid var(--secondary);flex-shrink:0;height:1200px}
.time-slot{height:60px;display:flex;align-items:center;justify-content:center;font:bold 0.9rem/1 sans-serif;color:var(--text);border-bottom:1px solid #e0e0e0}
.schedule-area{flex:1;position:relative;height:1200px}
.schedule-grid{position:absolute;inset:0;height:1200px}
.grid-line{height:60px;border-bottom:1px solid #e0e0e0;position:relative}
.grid-line:nth-child(odd){background:rgba(135,206,235,0.05)}
.quarter-line{position:absolute;left:0;right:0;height:1px;background:#f0f0f0}
.quarter-line:nth-child(1){top:15px}
.quarter-line:nth-child(2){top:30px}
.quarter-line:nth-child(3){top:45px}
.event-block{position:absolute;left:10px;right:10px;background:var(--primary);color:white;border-radius:8px;padding:8px 12px 8px 25px;box-shadow:0 2px 8px rgba(0,0,0,0.2);border:2px solid transparent;transition:var(--transition);z-index:10;user-select:none;-webkit-tap-highlight-color:transparent;min-height:35px;display:flex;align-items:center}
.event-block:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3);border-color:var(--accent)}
.event-block.edit-mode{border-color:#FFD700;box-shadow:0 0 0 3px rgba(255,215,0,0.3);cursor:grab}
.event-block.edit-mode:active{cursor:grabbing}
.event-block.ready-to-move{border-color:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,0.4);transform:scale(1.05);background:linear-gradient(45deg,rgba(76,175,80,0.1),transparent,rgba(76,175,80,0.1));animation:readyToPulse 1.5s infinite ease-in-out}
@keyframes readyToPulse{0%,100%{box-shadow:0 0 0 3px rgba(76,175,80,0.4)}50%{box-shadow:0 0 0 6px rgba(76,175,80,0.2)}}
.event-block.ready-to-move::before{content:"↕";position:absolute;top:50%;right:8px;transform:translateY(-50%);font-size:1.2rem;color:#4CAF50;font-weight:bold;z-index:25;animation:bounceIcon 1s infinite ease-in-out}
@keyframes bounceIcon{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.2)}}
.event-block.dragging{z-index:1000;opacity:0.8;transform:scale(1.02)}
.event-block.dragging .event-actions{display:none!important}
.event-block.layered{/* 動的にz-indexが設定される */}
.event-content-inline{font-size:0.9rem;line-height:1.2;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;font-weight:bold}
.event-title,.event-time,.event-description{display:none}
.event-category-travel{background:#FF6B6B}
.event-category-food{background:#4ECDC4}
.event-category-sightseeing{background:#45B7D1}
.event-category-accommodation{background:#96CEB4}
.event-category-custom{background:#FECA57}
.event-actions{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:20}
.event-action-btn{width:30px;height:30px;border-radius:8px;border:none;color:white;font-size:0.8rem;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.event-action-btn.cut{background:#FF6B6B;border:2px solid #fff}
.event-action-btn.cut:hover{background:#FF5252;transform:scale(1.1)}
.context-menu{position:fixed;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:2000;opacity:0;visibility:hidden;transform:scale(0.8);transition:var(--transition);min-width:150px}
.context-menu.show{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid #eee;transition:var(--transition);display:flex;align-items:center;gap:8px}
.context-menu-item:last-child{border-bottom:none}
.context-menu-item:hover{background:#f5f5f5}
.context-menu-item.paste{color:#4CAF50}
.context-menu-item.paste:hover{background:#e8f5e8}
.context-menu-item.add-event{color:#4CAF50}
.context-menu-item.add-event:hover{background:#e8f5e8}
.context-menu-item.disabled{color:#ccc;cursor:not-allowed}
.context-menu-item.disabled:hover{background:transparent}
.resize-handle{position:absolute;left:0;right:0;height:10px;background:rgba(255,215,0,0.8);opacity:0;transition:var(--transition);cursor:ns-resize}
.resize-handle.top{top:0;border-radius:8px 8px 0 0}
.resize-handle.bottom{bottom:0;border-radius:0 0 8px 8px}
.event-block.edit-mode .resize-handle{opacity:1}
.modal-content{border-radius:var(--radius);border:none;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
.modal-header{background:var(--primary);color:white;border-radius:var(--radius) var(--radius) 0 0}
.btn-primary{background:var(--accent);border:none;border-radius:20px;padding:8px 20px;transition:var(--transition)}
.btn-primary:hover{background:var(--text);transform:translateY(-2px)}
.form-control{border-radius:10px;border:2px solid #e0e0e0;transition:var(--transition)}
.form-control:focus{border-color:var(--primary);box-shadow:0 0 0 0.2rem rgba(135,206,235,0.25)}
.add-event-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:var(--transition);z-index:1000}
.add-event-btn:hover{transform:scale(1.1);background:var(--primary)}
.trip-setup{text-align:center;padding:40px 20px}
.trip-setup h2{color:var(--accent);margin-bottom:30px}
.date-input-group{display:flex;align-items:center;justify-content:center;gap:15px;margin:20px 0;flex-wrap:wrap}
.date-input-group input[type="date"]{padding:10px;border:2px solid var(--secondary);border-radius:8px;font-size:1rem}
.date-input-group span{font:bold 1.2rem/1 sans-serif;color:var(--accent)}
.weather-emoji-top-left {position: absolute;top: -12px;left:-12px;font-size: 2rem;z-index: 30;line-height: 1;cursor: pointer;-webkit-tap-highlight-color: transparent;}
.map-modal {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.8);z-index: 3000;display: flex;align-items: center;justify-content: center;}
.map-container {width: 90%;max-width: 800px;height: 80%;max-height: 600px;background: white;border-radius: 10px;position: relative;overflow: hidden;}
.map-header {background: var(--primary);color: white;padding: 15px;display: flex;justify-content: space-between;align-items: center;}
.map-close-btn {background: none;border: none;color: white;font-size: 1.5rem;cursor: pointer;width: 30px;height: 30px;display: flex;align-items: center;justify-content: center;border-radius: 50%;transition: background 0.3s;}
.map-close-btn:hover {background: rgba(255, 255, 255, 0.2);}
#map {width: 100%;height: calc(100% - 60px);}
.map-info {position: absolute;bottom: 10px;left: 10px;right: 10px;background: rgba(255, 255, 255, 0.9);padding: 10px;border-radius: 5px;font-size: 0.9rem;text-align: center;}
.weather-popup-modal {position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;background: rgba(0, 0, 0, 0.7);z-index: 5000;display: flex;align-items: center;justify-content: center;}
.weather-popup-content {width: 100%;height: 100%;background: #fff;position: relative;}
.weather-popup-close {position: absolute;top: 10px;right: 15px;width: 40px;height: 40px;border-radius: 50%;background: rgba(0,0,0,0.5);border: 2px solid white;color: white;font-size: 2rem;line-height: 36px;text-align: center;cursor: pointer;z-index: 5001;padding: 0;-webkit-appearance: none;}
.weather-popup-close:hover {background: rgba(0,0,0,0.8);}
.weather-popup-iframe {width: 100%;height: 100%;border: none;}
.settings-modal {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.8);z-index: 4000;display: flex;align-items: center;justify-content: center;opacity: 0;visibility: hidden;transition: var(--transition);}
.settings-modal.show {opacity: 1;visibility: visible;}
.settings-content {background: white;border-radius: var(--radius);width: 90%;max-width: 600px;max-height: 80vh;overflow-y: auto;box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
.settings-header {background: var(--primary);color: white;padding: 20px;border-radius: var(--radius) var(--radius) 0 0;display: flex;justify-content: space-between;align-items: center;}
.settings-header h2 {margin: 0;font-size: 1.5rem;}
.settings-close {background: none;border: none;color: white;font-size: 1.5rem;cursor: pointer;padding: 5px;border-radius: 50%;width: 35px;height: 35px;display: flex;align-items: center;justify-content: center;transition: var(--transition);}
.settings-close:hover {background: rgba(255, 255, 255, 0.2);}
.settings-body {padding: 20px;}
.settings-section {margin-bottom: 30px;}
.settings-section h3 {color: var(--accent);margin-bottom: 15px;font-size: 1.2rem;}
.settings-section p {color: #666;margin-bottom: 15px;line-height: 1.5;}
.sync-status {background: #f8f9fa;padding: 15px;border-radius: 8px;margin-bottom: 15px;border-left: 4px solid var(--primary);}
.sync-status.disabled {border-left-color: #6c757d;}
.sync-status.error {border-left-color: #dc3545;}
.sync-actions {display: flex;gap: 10px;flex-wrap: wrap;margin-top: 15px;}
.sync-btn {padding: 10px 20px;border: none;border-radius: 8px;cursor: pointer;font-size: 0.9rem;transition: var(--transition);text-decoration: none;display: inline-block;text-align: center;}
.sync-btn.primary {background: var(--primary);color: white;}
.sync-btn.primary:hover {background: var(--accent);color: white;}
.sync-btn.success {background: #28a745;color: white;}
.sync-btn.success:hover {background: #218838;}
.sync-btn.danger {background: #dc3545;color: white;}
.sync-btn.danger:hover {background: #c82333;}
.sync-btn.secondary {background: #6c757d;color: white;}
.sync-btn.secondary:hover {background: #5a6268;}
.form-group {margin-bottom: 20px;}
.form-group label {display: block;margin-bottom: 8px;font-weight: 600;color: var(--text);}
.form-group input {width: 100%;padding: 10px;border: 2px solid #e0e0e0;border-radius: 8px;font-size: 1rem;transition: var(--transition);}
.form-group input:focus {border-color: var(--primary);box-shadow: 0 0 0 0.2rem rgba(135,206,235,0.25);outline: none;}
.conflict-modal {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.8);z-index: 6000;display: flex;align-items: center;justify-content: center;opacity: 0;visibility: hidden;transition: var(--transition);}
.conflict-modal.show {opacity: 1;visibility: visible;}
.conflict-content {background: white;border-radius: var(--radius);width: 90%;max-width: 500px;padding: 0;box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
.conflict-header {background: #dc3545;color: white;padding: 20px;border-radius: var(--radius) var(--radius) 0 0;text-align: center;}
.conflict-body {padding: 20px;text-align: center;line-height: 1.6;}
.conflict-actions {padding: 0 20px 20px 20px;display: flex;gap: 10px;flex-direction: column;}
.conflict-btn {padding: 15px;border: none;border-radius: 8px;font-weight: bold;cursor: pointer;transition: var(--transition);}
.conflict-btn.primary {background: var(--primary);color: white;}
.conflict-btn.secondary {background: #6c757d;color: white;}
.conflict-btn:hover {transform: translateY(-2px);box-shadow: 0 4px 8px rgba(0,0,0,0.2);}
@media (max-width:768px){
.header{padding:6px 0}
.cloud-load-btn{left:10px;font-size:1.3rem}
.cloud-write-btn{left:55px;font-size:1.3rem}
.settings-btn{right:10px;font-size:1.3rem}
.timeline-header{padding:6px 15px}
.timeline-header h5{font-size:0.9rem}
.timeline-header h5 small{font-size:0.75rem;display:block;margin-left:0;margin-top:2px}
.day-tabs{margin:8px 0 0 0}
.time-axis{width:60px;height:1000px}
.time-slot{height:50px;font-size:0.8rem}
.grid-line{height:50px}
.schedule-grid,.schedule-area{height:1000px}
.event-block{padding:6px 8px 6px 22px;min-height:32px}
.event-content-inline{font-size:0.8rem}
.date-input-group{flex-direction:column;gap:10px}
.event-action-btn{width:35px;height:35px;font-size:0.9rem}
.event-block.overlapping{opacity:0.7;border:2px solid #ff6b6b}
.weather-emoji-top-left{font-size:1.5rem}
.settings-content{width:95%;max-height:90vh}
.settings-header{padding:15px}
.settings-body{padding:15px}
.sync-actions{flex-direction:column}
.sync-btn{width:100%}
.conflict-content{width:95%}
}
</style>
</head>
<body>
<div id="app">
<header class="header">
<div class="container">
<button class="cloud-load-btn" @click="loadFromCloud" title="クラウドから読込" :disabled="gistSync.isLoading" :class="{ loading: gistSync.isLoading, error: gistSync.hasError }">
<i class="fas fa-cloud-download-alt"></i>
</button>
<button class="cloud-write-btn" @click="manualSync" title="手動書き込み" :disabled="gistSync.isSyncing" :class="{ loading: gistSync.isSyncing, error: gistSync.hasError }">
<i class="fas fa-cloud-upload-alt"></i>
</button>
<h1><i class="fas fa-snowflake penguin-icon"></i>とりっぺんちゃん</h1>
<button class="settings-btn" @click="openSettingsModal" title="設定">
<i class="fas fa-cog"></i>
</button>
</div>
</header>

<!-- 【新機能】リアルタイム更新通知 -->
<div class="realtime-notification" :class="{ show: showRealtimeNotification }">
    <i class="fas fa-sync-alt"></i>
    <span>{{ realtimeNotificationMessage }}</span>
</div>

<div v-if="!tripInitialized" class="container">
<div class="trip-setup">
<h2><i class="fas fa-calendar-alt"></i> 旅行日程を設定</h2>
<div class="date-input-group">
<label for="startDate"><strong>開始日:</strong></label>
<input type="date" id="startDate" v-model="tripStartDate" :min="today">
<span>〜</span>
<label for="endDate"><strong>終了日:</strong></label>
<input type="date" id="endDate" v-model="tripEndDate" :min="tripStartDate">
</div>
<div class="mt-4">
<button class="btn btn-primary btn-lg" @click="initializeTripDays" :disabled="!tripStartDate || !tripEndDate">
<i class="fas fa-check"></i> 旅行スケジュールを作成
</button>
</div>
<div class="mt-3">
<button class="btn btn-outline-secondary" @click="loadExistingData" v-if="hasExistingData">
<i class="fas fa-folder-open"></i> 既存のデータを読み込む
</button>
</div>
</div>
</div>
<div v-if="tripInitialized && !isMobile" class="desktop-ui">
<div class="day-tabs-container">
<ul class="nav nav-tabs day-tabs">
<li class="nav-item" v-for="(day, index) in tripDays" :key="`day-${day.id || index}`">
<a class="nav-link" :class="{ active: activeDay === index }" @click="setActiveDay(index)" href="#" @click.prevent>
<div>
<div>{{ day.dayNumber }}日目</div>
<small :class="{ 'editable-date': index === 0 }">
{{ day.date }}
<i v-if="index === 0" class="fas fa-edit" @click.stop="handleDateClick(index)" style="cursor: pointer; margin-left: 4px; padding: 2px; border-radius: 3px; transition: background 0.2s;" @mouseover="$event.target.style.background='rgba(255,255,255,0.2)'" @mouseout="$event.target.style.background='transparent'" title="開始日を変更"></i>
</small>
</div>
<button class="delete-day-btn" v-if="tripDays.length > 1" @click.stop.prevent="deleteDay(index)" @mousedown.stop title="日程を削除">
<i class="fas fa-times"></i>
</button>
</a>
</li>
<li class="nav-item">
<a class="nav-link add-day-btn" @click.prevent.stop="addDayImmediately" @mousedown.stop href="#" title="日程を追加">
<div>
<div style="font-size: 1.5rem; font-weight: bold;">＋</div>
<small style="visibility: hidden;">日程追加</small>
</div>
</a>
</li>
</ul>
</div>
<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}日目の予定
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="scrollContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @contextmenu="handleScheduleContextMenu">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @contextmenu.prevent="handleEventContextMenu($event, event)" @click="handleEventClick($event, event)" @mousedown="handleEventMouseDown($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)" @click.stop="openWeatherPopup(event)" title="天気詳細を見る">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @mousedown.stop title="切り取り">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="add-event-btn" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>

<div v-if="tripInitialized && isMobile" class="mobile-ui">
<div class="mobile-day-selector">
<div class="mobile-scroll-container">
<button class="mobile-scroll-nav left" :class="{ disabled: scrollPosition <= 0 }" @click="scrollToDirection('left')">
<i class="fas fa-chevron-left"></i>
</button>
<div class="mobile-day-buttons" ref="mobileScrollContainer" @scroll="updateScrollPosition">
<button v-for="(day, index) in tripDays" :key="`mobile-day-${day.id || index}`" class="mobile-day-btn" :class="{ active: activeDay === index }" @click="setActiveDay(index)" @touchstart="handleMobileDayTouchStart($event, index)" @touchend="handleMobileDayTouchEnd($event, index)">
<div>{{ day.dayNumber }}日目</div>
<small>{{ day.date }}</small>
</button>
</div>
<button class="mobile-scroll-nav right" :class="{ disabled: scrollPosition >= maxScrollPosition }" @click="scrollToDirection('right')">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>
<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}日目の予定
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="mobileTimelineContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @touchstart="handleScheduleTouchStart" @touchend="handleScheduleTouchEnd" @touchmove="handleScheduleTouchMove">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @click="handleEventClick($event, event)" @touchstart="handleEventTouchStart($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)" @click.stop="openWeatherPopup(event)" title="天気詳細を見る">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @touchstart.stop title="切り取り">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="mobile-fab" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>

<!-- Context Menu -->
<div class="context-menu" :class="{ show: showContextMenu }" :style="contextMenuStyle">
<div class="context-menu-item add-event" @click="() => addEventFromContext()">
<i class="fas fa-plus"></i>新しい予定を追加
</div>
<div class="context-menu-item paste" :class="{ disabled: !clipboardEvent }" @click="pasteFromContext" v-if="clipboardEvent">
<i class="fas fa-paste"></i>貼り付け
</div>
<div class="context-menu-item disabled" v-else>
<i class="fas fa-paste"></i>貼り付け（コピー済みアイテムなし）
</div>
</div>

<!-- Mobile Popup Menu -->
<div class="mobile-popup-menu" :class="{ show: showMobilePopup }" @click="closeMobilePopup" v-if="isMobile">
<div class="mobile-popup-content" @click.stop>
<div class="mobile-popup-title">{{ selectedDayForPopup ? `${selectedDayForPopup.dayNumber}日目の編集` : '日程編集' }}</div>
<div class="mobile-popup-buttons">
<button class="mobile-popup-btn primary" v-if="selectedDayForPopup && selectedDayIndex === 0" @click="openStartDateModalFromPopup">
<i class="fas fa-calendar-edit"></i>開始日を変更
</button>
<button class="mobile-popup-btn success" @click="addDayFromPopup">
<i class="fas fa-plus"></i>日程を追加
</button>
<button class="mobile-popup-btn danger" v-if="selectedDayForPopup && tripDays.length > 1" @click="deleteDayFromPopup">
<i class="fas fa-trash"></i>この日程を削除
</button>
<button class="mobile-popup-btn secondary" @click="closeMobilePopup">
<i class="fas fa-times"></i>キャンセル
</button>
</div>
</div>
</div>

<!-- Map Modal -->
<div v-if="showMapModal" class="map-modal" @click="closeMapModal">
    <div class="map-container" @click.stop>
        <div class="map-header">
            <h5><i class="fas fa-map-marker-alt"></i> 位置を選択</h5>
            <button class="map-close-btn" @click="closeMapModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="map"></div>
        <div class="map-info">
            <i class="fas fa-info-circle"></i> 地図上をタップして位置を選択してください
            <div v-if="selectedCoordinates" class="mt-2">
                <strong>選択した座標:</strong> {{ selectedCoordinates }}
            </div>
        </div>
    </div>
</div>

<!-- Weather Popup Modal -->
<div v-if="showWeatherPopup" class="weather-popup-modal">
    <div class="weather-popup-content">
        <button class="weather-popup-close" @click="closeWeatherPopup" title="閉じる">&times;</button>
        <iframe :src="weatherPopupUrl" class="weather-popup-iframe" frameborder="0"></iframe>
    </div>
</div>

<!-- Conflict Modal -->
<div v-if="showConflictModal" class="conflict-modal" :class="{ show: showConflictModal }" @click="closeConflictModal">
    <div class="conflict-content" @click.stop>
        <div class="conflict-header">
            <h3><i class="fas fa-exclamation-triangle"></i> データ競合が発生</h3>
        </div>
        <div class="conflict-body">
            <p>他の端末でデータが更新されています。</p>
            <p><strong>クラウドから読み込んで最新データに更新しますか？</strong></p>
            <small class="text-muted">※ローカルの変更は失われる可能性があります</small>
        </div>
        <div class="conflict-actions">
            <button class="conflict-btn primary" @click="forceLoadFromCloud">
                <i class="fas fa-cloud-download-alt"></i> クラウドデータで上書き
            </button>
            <button class="conflict-btn secondary" @click="closeConflictModal">
                <i class="fas fa-times"></i> キャンセル（後で同期）
            </button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div v-if="showSettingsModal" class="settings-modal" :class="{ show: showSettingsModal }" @click="closeSettingsModal">
    <div class="settings-content" @click.stop>
        <div class="settings-header">
            <h2><i class="fas fa-cog"></i> 設定</h2>
            <button class="settings-close" @click="closeSettingsModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-body">
            <div class="settings-section">
                <h3><i class="fas fa-cloud-upload-alt"></i> GitHub同期設定</h3>
                <p>GitHub Personal Access Tokenを設定すると、旅行データが自動同期されます。<br>
                <strong>リアルタイム版:</strong> 5秒間隔でのETag高速チェック + 競合管理</p>
                
                <div class="sync-status" :class="{ disabled: !gistSync.isEnabled, error: gistSync.hasError }">
                    <div v-if="gistSync.isEnabled">
                        <strong>同期状態:</strong> 有効（リアルタイム対応版）<br>
                        <span v-if="gistSync.gistId">Gist ID: {{ gistSync.gistId }}</span><br>
                        <span v-if="gistSync.lastReadTime">最終読込: {{ formatSyncTime(gistSync.lastReadTime) }}</span><br>
                        <span v-if="gistSync.lastSyncTime">最終書込: {{ formatSyncTime(gistSync.lastSyncTime) }}</span>
                    </div>
                    <div v-else>
                        <strong>同期状態:</strong> 無効<br>
                        <span>GitHub同期が設定されていません</span>
                    </div>
                </div>

                <div v-if="!gistSync.isEnabled">
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token</label>
                        <input type="password" id="githubToken" v-model="syncForm.token" placeholder="GitHub Personal Access Tokenを入力">
                    </div>
                    <div class="form-group">
                        <label for="existingGistId">既存のGist ID（任意）</label>
                        <input type="text" id="existingGistId" v-model="syncForm.gistId" placeholder="他のデバイスと同期する場合のみ入力">
                    </div>
                    <div class="sync-actions">
                        <button class="sync-btn success" @click="saveGitHubSync">GitHub同期を開始</button>
                    </div>
                </div>

                <div v-else class="sync-actions">
                    <button class="sync-btn secondary" @click="copyGistId">Gist IDコピー</button>
                    <button class="sync-btn danger" @click="clearGitHubSync">設定を解除</button>
                </div>
            </div>

            <div class="settings-section">
                <h3><i class="fas fa-info-circle"></i> アプリ情報</h3>
                <p>とりっぺんちゃん - 旅行予定調整サイト<br>
                リアルタイム同期対応版</p>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic Modals -->
<div v-for="modal in modals" :key="modal.id" class="modal fade" :id="modal.id" tabindex="-1">
<div class="modal-dialog" :class="modal.size">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ modal.title }}</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" v-html="modal.body"></div>
<div class="modal-footer" v-html="modal.footer"></div>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const { createApp } = Vue;

// 【リアルタイム対応版】GitHub Gist同期システム
const TrippenGistSync = {
    // 基本プロパティ
    token: null,
    gistId: null,
    isEnabled: false,
    isSyncing: false,
    lastSyncTime: null,
    lastReadTime: null,
    periodicSyncInterval: null,
    hasError: false,
    hasChanged: false,
    lastDataHash: null,
    
    // 【新機能】リアルタイム同期用プロパティ
    lastETag: null,
    fastSyncInterval: null,
    isVisible: true,
    
    // 【新機能】ETag付きでGistの変更をチェック
    async checkForUpdatesWithETag() {
        if (!this.token || !this.gistId) return false;
        
        try {
            const headers = {
                'Authorization': `token ${this.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'Trippen-App'
            };
            
            if (this.lastETag) {
                headers['If-None-Match'] = this.lastETag;
            }
            
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                method: 'HEAD',
                headers: headers
            });
            
            if (response.status === 304) {
                // データ変更なし
                return false;
            }
            
            if (response.ok) {
                const newETag = response.headers.get('ETag');
                if (newETag && newETag !== this.lastETag) {
                    this.lastETag = newETag;
                    return true;
                }
            }
            
            return false;
        } catch (error) {
            console.error('ETagチェックエラー:', error);
            return false;
        }
    },

    // 【新機能】高速同期開始（ページアクティブ時）
    startFastSync() {
        this.stopFastSync();
        
        // ページがアクティブな時は5秒間隔
        this.fastSyncInterval = setInterval(async () => {
            if (this.isVisible && !this.isSyncing) {
                const hasUpdates = await this.checkForUpdatesWithETag();
                if (hasUpdates && window.app) {
                    console.log('🔄 リアルタイム更新検出');
                    window.app.handleRealtimeUpdate();
                }
            }
        }, 5000);
        
        console.log('高速同期開始（5秒間隔）');
    },

    stopFastSync() {
        if (this.fastSyncInterval) {
            clearInterval(this.fastSyncInterval);
            this.fastSyncInterval = null;
        }
    },

    // 【新機能】ページビジビリティに基づく同期制御
    handleVisibilityChange() {
        this.isVisible = !document.hidden;
        
        if (this.isVisible) {
            console.log('ページアクティブ - 高速同期開始');
            this.startFastSync();
            // ページがアクティブになったら即座にチェック
            setTimeout(() => this.checkForUpdatesWithETag(), 1000);
        } else {
            console.log('ページ非アクティブ - 高速同期停止');
            this.stopFastSync();
        }
    },

    // 【新機能】スマートマージ機能
    async smartMerge(localData, cloudData) {
        console.log('🔀 スマートマージ開始');
        
        const mergedEvents = [];
        const localEvents = localData.data.events || [];
        const cloudEvents = cloudData.data.events || [];
        
        const eventMap = new Map();
        
        cloudEvents.forEach(event => {
            eventMap.set(event.id, { ...event, source: 'cloud' });
        });
        
        localEvents.forEach(event => {
            const existing = eventMap.get(event.id);
            if (!existing || (event.lastModified && event.lastModified > existing.lastModified)) {
                eventMap.set(event.id, { ...event, source: 'local' });
            }
        });
        
        return {
            ...cloudData,
            data: {
                ...cloudData.data,
                events: Array.from(eventMap.values())
            }
        };
    },

    // 既存のメソッド群（省略部分には完全な実装が含まれます）
    calculateHash(data) {
        try {
            const sortedData = {
                events: data.data.events || [],
                days: data.data.days || [],
                layerOrder: data.data.layerOrder || []
            };
            const jsonString = JSON.stringify(sortedData, Object.keys(sortedData).sort());
            let hash = 0;
            for (let i = 0; i < jsonString.length; i++) {
                const char = jsonString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return hash.toString();
        } catch (error) {
            console.error('ハッシュ計算エラー:', error);
            return Date.now().toString();
        }
    },

    markChanged() {
        this.hasChanged = true;
        console.log('データが変更されました - フラグ設定');
    },

    resetChanged() {
        this.hasChanged = false;
        console.log('変更フラグをリセットしました');
    },

    _encrypt(text, key = 'trippen_secret_key') {
        if (!text) return '';
        try {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        } catch (error) {
            console.error('暗号化エラー:', error);
            throw new Error('暗号化処理に失敗しました');
        }
    },

    _decrypt(encryptedText, key = 'trippen_secret_key') {
        if (!encryptedText) return '';
        try {
            const text = atob(encryptedText);
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return result;
        } catch (error) {
            console.error('復号化エラー:', error);
            throw new Error('復号化に失敗しました');
        }
    },

    getUTCTimestamp() {
        return new Date().toISOString();
    },

    loadConfig() {
        try {
            const configStr = localStorage.getItem('trippen_gist_config');
            if (!configStr) return null;

            const config = JSON.parse(configStr);
            
            if (config.encryptedToken) {
                this.token = this._decrypt(config.encryptedToken);
            }
            
            this.gistId = config.gistId || null;
            this.lastSyncTime = config.lastSyncTime || null;
            this.lastReadTime = config.lastReadTime || null;
            this.lastDataHash = config.lastDataHash || null;
            this.lastETag = config.lastETag || null; // ETag復元
            this.isEnabled = !!(this.token);
            
            return config;
        } catch (error) {
            console.error('設定読み込みエラー:', error);
            this.hasError = true;
            this.isEnabled = false;
            return null;
        }
    },

    init(token, gistId = null) {
        if (!token || typeof token !== 'string' || token.trim().length === 0) {
            throw new Error('有効なトークンが必要です');
        }

        const encryptedToken = this._encrypt(token.trim());
        
        this.token = token.trim();
        this.gistId = gistId ? gistId.trim() : null;
        this.isEnabled = true;
        this.hasError = false;
        this.hasChanged = false;

        const configData = {
            encryptedToken: encryptedToken,
            gistId: this.gistId,
            isEnabled: this.isEnabled,
            configuredAt: this.getUTCTimestamp(),
            lastSyncTime: this.lastSyncTime,
            lastReadTime: this.lastReadTime,
            lastDataHash: this.lastDataHash,
            lastETag: this.lastETag,
            version: '4.0' // リアルタイム版バージョンアップ
        };

        localStorage.setItem('trippen_gist_config', JSON.stringify(configData));
        
        this.startPeriodicSync();
        this.startFastSync(); // 高速同期も開始
    },

    startPeriodicSync() {
        if (this.periodicSyncInterval) {
            clearInterval(this.periodicSyncInterval);
        }
        
        this.periodicSyncInterval = setInterval(async () => {
            await this.autoWriteToCloud();
        }, 60000);
        
        console.log('定期同期開始（1分間隔・リアルタイム対応版）');
    },

    stopPeriodicSync() {
        if (this.periodicSyncInterval) {
            clearInterval(this.periodicSyncInterval);
            this.periodicSyncInterval = null;
        }
    },

    collectSyncData() {
        const events = JSON.parse(localStorage.getItem('trippenEvents') || '[]');
        const days = JSON.parse(localStorage.getItem('trippenDays') || '[]');
        const layerOrder = JSON.parse(localStorage.getItem('trippenLayerOrder') || '[]');

        return {
            version: '4.0',
            syncTime: this.getUTCTimestamp(),
            data: {
                events: events,
                days: days,
                layerOrder: layerOrder
            }
        };
    },

    async syncToCloud(data) {
        if (!this.token) {
            console.error('トークンが設定されていません');
            return false;
        }
        
        const payload = {
            description: `とりっぺんちゃん 旅行データ バックアップ - ${new Date().toLocaleString('ja-JP')}`,
            public: false,
            files: {
                "trippen_data.json": {
                    content: JSON.stringify(data, null, 2)
                }
            }
        };
        
        const url = this.gistId 
            ? `https://api.github.com/gists/${this.gistId}`
            : 'https://api.github.com/gists';
            
        const method = this.gistId ? 'PATCH' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Trippen-App'
                },
                body: JSON.stringify(payload)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // ETagを保存
                const newETag = response.headers.get('ETag');
                if (newETag) {
                    this.lastETag = newETag;
                }
                
                if (!this.gistId && result.id) {
                    this.gistId = result.id;
                    this.saveGistId(result.id);
                }
                
                return true;
            } else {
                const errorText = await response.text();
                console.error('書き込み失敗:', response.status, errorText);
                return false;
            }
        } catch (error) {
            console.error('クラウド書き込みエラー:', error);
            this.hasError = true;
            return false;
        }
    },

    async loadFromCloud() {
        if (!this.token) {
            throw new Error('トークンが設定されていません');
        }
        
        if (!this.gistId) {
            throw new Error('Gist IDが設定されていません');
        }
        
        try {
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Trippen-App'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                if (response.status === 404) {
                    throw new Error('Gistが見つかりません。Gist IDを確認してください。');
                } else if (response.status === 401) {
                    throw new Error('GitHub Personal Access Tokenが無効です。設定を確認してください。');
                } else if (response.status === 403) {
                    throw new Error('GitHub APIの利用制限に達しています。しばらく待ってから再試行してください。');
                } else {
                    throw new Error(`GitHub API エラー: ${response.status} - ${response.statusText}`);
                }
            }
            
            // ETagを保存
            const newETag = response.headers.get('ETag');
            if (newETag) {
                this.lastETag = newETag;
            }
            
            const gist = await response.json();
            
            if (!gist.files || !gist.files['trippen_data.json']) {
                throw new Error('Gistにtrippen_data.jsonファイルが見つかりません');
            }
            
            const content = gist.files['trippen_data.json'].content;
            
            if (!content || content.trim() === '') {
                throw new Error('Gistファイルが空です');
            }
            
            let parsedData;
            try {
                parsedData = JSON.parse(content);
            } catch (parseError) {
                throw new Error(`JSONパースエラー: ${parseError.message}`);
            }
            
            const newHash = this.calculateHash(parsedData);
            this.lastDataHash = newHash;
            
            this.lastReadTime = this.getUTCTimestamp();
            this.saveLastReadTime();
            this.resetChanged();
            
            return parsedData;
            
        } catch (error) {
            console.error('クラウドデータ読み込みエラー:', error);
            this.hasError = true;
            throw error;
        }
    },

    async checkForNewerCloudData() {
        if (!this.token || !this.gistId) return false;
        
        try {
            const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'Trippen-App'
                }
            });
            
            if (response.ok) {
                const gist = await response.json();
                const cloudUpdatedAt = new Date(gist.updated_at);
                
                const lastReadTime = new Date(this.lastReadTime || 0);
                const lastWriteTime = new Date(this.lastSyncTime || 0);
                
                const hasNewerData = cloudUpdatedAt > lastReadTime && cloudUpdatedAt > lastWriteTime;
                
                return hasNewerData;
            }
            
            return false;
        } catch (error) {
            console.error('競合チェックエラー:', error);
            return false;
        }
    },

    async autoWriteToCloud() {
        if (!this.isEnabled || !this.token || this.isSyncing) {
            return false;
        }
        
        this.isSyncing = true;
        this.hasError = false;
        
        try {
            const hasNewerData = await this.checkForNewerCloudData();
            if (hasNewerData) {
                console.log('⚠️ 競合検出 - Vue.jsアプリに通知');
                if (window.app && window.app.handleSyncConflict) {
                    window.app.handleSyncConflict();
                }
                return false;
            }

            if (!this.hasChanged) {
                console.log('変更フラグなし - 書き込みスキップ');
                return false;
            }
            
            const localData = this.collectSyncData();
            const uploadResult = await this.syncToCloud(localData);
            
            if (uploadResult) {
                this.lastSyncTime = this.getUTCTimestamp();
                this.lastDataHash = this.calculateHash(localData);
                this.saveLastSyncTime();
                this.resetChanged();
                console.log('自動書き込み完了:', new Date().toLocaleString());
                return true;
            }
            
            return false;
        } catch (error) {
            console.error('自動書き込みエラー:', error);
            this.hasError = true;
            return false;
        } finally {
            this.isSyncing = false;
        }
    },

    async manualWriteToCloud() {
        if (!this.isEnabled || !this.token) {
            throw new Error('GitHub同期が設定されていません');
        }
        
        this.isSyncing = true;
        this.hasError = false;
        
        try {
            const hasNewerData = await this.checkForNewerCloudData();
            if (hasNewerData) {
                if (window.app && window.app.handleSyncConflict) {
                    window.app.handleSyncConflict();
                }
                throw new Error('データ競合が検出されました。クラウドから最新データを読み込んでください。');
            }
            
            const localData = this.collectSyncData();
            const uploadResult = await this.syncToCloud(localData);
            
            if (uploadResult) {
                const currentHash = this.calculateHash(localData);
                this.lastSyncTime = this.getUTCTimestamp();
                this.lastDataHash = currentHash;
                this.saveLastSyncTime();
                this.resetChanged();
                return true;
            }
            
            throw new Error('書き込みに失敗しました');
        } catch (error) {
            this.hasError = true;
            throw error;
        } finally {
            this.isSyncing = false;
        }
    },

    async initialAutoLoad() {
        if (!this.isEnabled || !this.token || !this.gistId) {
            return null;
        }
        
        try {
            const cloudData = await this.loadFromCloud();
            if (cloudData && cloudData.data) {
                return cloudData;
            }
            return null;
        } catch (error) {
            console.error('初回自動読み込みエラー:', error);
            this.hasError = true;
            return null;
        }
    },

    saveGistId(gistId) {
        try {
            const currentConfigStr = localStorage.getItem('trippen_gist_config');
            if (!currentConfigStr) return;

            const config = JSON.parse(currentConfigStr);
            config.gistId = gistId;
            config.lastSyncTime = this.lastSyncTime;
            config.lastReadTime = this.lastReadTime;
            config.lastDataHash = this.lastDataHash;
            config.lastETag = this.lastETag;

            localStorage.setItem('trippen_gist_config', JSON.stringify(config));
            
            this.gistId = gistId;
            
            if (window.app && window.app.gistSync) {
                window.app.gistSync.gistId = gistId;
            }
            
        } catch (error) {
            console.error('GistID保存エラー:', error);
            this.gistId = gistId;
        }
    },

    saveLastSyncTime() {
        try {
            const currentConfigStr = localStorage.getItem('trippen_gist_config');
            if (!currentConfigStr) return;

            const config = JSON.parse(currentConfigStr);
            config.lastSyncTime = this.lastSyncTime;
            config.lastDataHash = this.lastDataHash;
            config.lastETag = this.lastETag;
            localStorage.setItem('trippen_gist_config', JSON.stringify(config));
        } catch (error) {
            console.error('書き込み時刻保存エラー:', error);
        }
    },

    saveLastReadTime() {
        try {
            const currentConfigStr = localStorage.getItem('trippen_gist_config');
            if (!currentConfigStr) return;

            const config = JSON.parse(currentConfigStr);
            config.lastReadTime = this.lastReadTime;
            config.lastDataHash = this.lastDataHash;
            config.lastETag = this.lastETag;
            localStorage.setItem('trippen_gist_config', JSON.stringify(config));
        } catch (error) {
            console.error('読み込み時刻保存エラー:', error);
        }
    },

    clear() {
        this.stopPeriodicSync();
        this.stopFastSync(); // 高速同期も停止
        localStorage.removeItem('trippen_gist_config');
        this.token = null;
        this.gistId = null;
        this.isEnabled = false;
        this.lastSyncTime = null;
        this.lastReadTime = null;
        this.hasError = false;
        this.hasChanged = false;
        this.lastDataHash = null;
        this.lastETag = null;
        
        console.log('TrippenGistSync設定をクリアしました（リアルタイム対応版）');
    }
};

// Vue.jsアプリケーション（リアルタイム対応版）
const app = createApp({
    data() {
        return {
            // 基本データ
            tripInitialized: false,
            tripStartDate: '',
            tripEndDate: '',
            today: new Date().toISOString().split('T')[0],
            hasExistingData: false,
            tripDays: [],
            activeDay: 0,
            events: [],
            
            // 【新機能】リアルタイム通知用
            showRealtimeNotification: false,
            realtimeNotificationMessage: '',
            broadcastChannel: null,
            
            // UI状態
            showMobilePopup: false,
            selectedDayForPopup: null,
            selectedDayIndex: null,
            scrollPosition: 0,
            maxScrollPosition: 0,
            timeSlots: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
            editModeEvent: null,
            clipboardEvent: null,
            showContextMenu: false,
            contextMenuStyle: {},
            pasteTargetTime: null,
            isMobile: false,
            
            // タッチ・ドラッグ関連
            touchStartTime: 0,
            touchStartPosition: { x: 0, y: 0 },
            longPressTimer: null,
            longPressExecuted: false,
            eventTouchOffset: { x: 0, y: 0 },
            draggingEvent: null,
            isDragComplete: false,
            isResizeComplete: false,
            dragStarted: false,
            longPressEventData: null,
            longPressEvent: null,
            readyToMoveEventId: null,
            
            // マップ・天気関連
            showMapModal: false,
            map: null,
            selectedCoordinates: null,
            mapMarker: null,
            weatherCache: {},
            weatherCacheExpiry: 6 * 60 * 60 * 1000,
            showWeatherPopup: false,
            weatherPopupUrl: '',
            
            // イベント管理
            eventForm: {
                title: '',
                dayIndex: 0,
                startTime: '09:00',
                endTime: '10:00',
                category: 'travel',
                description: '',
                coordinates: ''
            },
            modals: [],
            eventLayerOrder: [],
            baseZIndex: 10,
            maxZIndex: 10,
            
            // 設定・同期
            showSettingsModal: false,
            showConflictModal: false,
            gistSync: {
                isEnabled: false,
                gistId: null,
                lastSyncTime: null,
                lastReadTime: null,
                isSyncing: false,
                isLoading: false,
                hasError: false
            },
            syncForm: {
                token: '',
                gistId: ''
            }
        };
    },
    methods: {
        // 【新機能】リアルタイム更新処理
        async handleRealtimeUpdate() {
            if (this.gistSync.isLoading || this.gistSync.isSyncing) return;
            
            try {
                console.log('🔄 リアルタイム更新開始');
                
                // ユーザーに通知
                this.showUpdateNotification();
                
                // データを読み込み
                await this.loadFromCloud();
                
                // 成功通知
                this.showSuccessNotification('他の端末からの更新を同期しました');
                
            } catch (error) {
                console.error('リアルタイム更新エラー:', error);
                this.showErrorNotification('同期エラーが発生しました');
            }
        },

        // 【新機能】更新通知表示
        showUpdateNotification() {
            // ブラウザ通知（許可されている場合）
            if (Notification.permission === 'granted') {
                new Notification('とりっぺんちゃん', {
                    body: '他の端末からデータが更新されました',
                    icon: '/favicon.ico',
                    tag: 'trippen-update'
                });
            }
            
            // バイブレーション
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        },

        showSuccessNotification(message) {
            this.realtimeNotificationMessage = message;
            this.showRealtimeNotification = true;
            setTimeout(() => {
                this.showRealtimeNotification = false;
            }, 3000);
            console.log('✅', message);
        },

        showErrorNotification(message) {
            console.error('❌', message);
        },

        // 【新機能】通知許可要求
        async requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                console.log('通知許可:', permission);
            }
        },

        // 【新機能】ブロードキャストチャネル初期化
        initBroadcastChannel() {
            if ('BroadcastChannel' in window) {
                this.broadcastChannel = new BroadcastChannel('trippen-sync');
                
                this.broadcastChannel.addEventListener('message', (event) => {
                    if (event.data.type === 'data-updated') {
                        console.log('他のタブからデータ更新通知');
                        this.loadData(); // ローカルストレージから再読み込み
                    }
                });
            }
        },

        // 【修正】データ保存時に他のタブに通知
        saveData() {
            localStorage.setItem('trippenEvents', JSON.stringify(this.events));
            localStorage.setItem('trippenDays', JSON.stringify(this.tripDays));
            this.saveLayerOrder();

            // 変更フラグ設定
            if (TrippenGistSync.isEnabled) {
                TrippenGistSync.markChanged();
            }

            // 他のタブに通知
            if (this.broadcastChannel) {
                this.broadcastChannel.postMessage({
                    type: 'data-updated',
                    timestamp: Date.now()
                });
            }
        },

        // 既存のメソッド群（完全な実装が含まれますが省略表示）
        linkifyUrls(text) {
            if (!text) return text;
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        },

        checkExistingData() {
            this.hasExistingData = !!(localStorage.getItem('trippenEvents') && localStorage.getItem('trippenDays'));
        },

        loadExistingData() {
            this.loadData();
            if (this.tripDays.length > 0) this.tripInitialized = true;
        },

        initializeTripDays() {
            if (!this.tripStartDate || !this.tripEndDate || this.tripStartDate > this.tripEndDate) {
                alert('正しい日付を選択してください');
                return;
            }
            this.tripDays = this.generateTripDays(this.tripStartDate, this.tripEndDate);
            this.activeDay = 0;
            this.tripInitialized = true;
            this.saveData();
        },

        generateTripDays(startDate, endDate) {
            const days = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            let dayNumber = 1;
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                days.push({
                    id: Date.now() + dayNumber + Math.random(),
                    dayNumber: dayNumber++,
                    date: `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`,
                    fullDate: date.toISOString().split('T')[0]
                });
            }
            return days;
        },

        setActiveDay(index) { this.activeDay = index; },
        detectMobile() { this.isMobile = window.innerWidth <= 768 || 'ontouchstart' in window; },

        // 他の既存メソッドは省略（完全な実装では全て含まれます）

        async loadFromCloud() {
            if (!TrippenGistSync.isEnabled || !TrippenGistSync.token) {
                alert('GitHub同期が設定されていません。設定画面で設定してください。');
                return;
            }

            if (!TrippenGistSync.gistId) {
                alert('Gist IDが設定されていません。最初にデータを書き込むか、既存のGist IDを設定してください。');
                return;
            }

            this.gistSync.isLoading = true;

            try {
                const cloudData = await TrippenGistSync.loadFromCloud();

                if (!cloudData || !cloudData.data) {
                    throw new Error('クラウドデータの形式が正しくありません');
                }

                if (cloudData.data.events) {
                    this.events = [...cloudData.data.events];
                    localStorage.setItem('trippenEvents', JSON.stringify(this.events));
                }

                if (cloudData.data.days) {
                    this.tripDays = [...cloudData.data.days];
                    localStorage.setItem('trippenDays', JSON.stringify(this.tripDays));

                    this.$nextTick(() => {
                        this.tripInitialized = this.tripDays.length > 0;
                    });
                }

                if (cloudData.data.layerOrder) {
                    this.eventLayerOrder = [...cloudData.data.layerOrder];
                    localStorage.setItem('trippenLayerOrder', JSON.stringify(this.eventLayerOrder));
                }

                this.gistSync.lastReadTime = TrippenGistSync.lastReadTime;
                this.gistSync.hasError = false;

                const eventCount = cloudData.data.events ? cloudData.data.events.length : 0;
                const dayCount = cloudData.data.days ? cloudData.data.days.length : 0;

                if (!this.showRealtimeNotification) {
                    alert(`クラウドからデータを読み込みました\n日程: ${dayCount}日分\n予定: ${eventCount}件`);
                }

                if (this.events.length > 0) {
                    this.loadWeatherForAllEvents();
                }

            } catch (error) {
                console.error('読み込み処理エラー:', error);
                this.gistSync.hasError = true;
                alert(`読み込みに失敗しました\nエラー: ${error.message}`);
            } finally {
                this.gistSync.isLoading = false;
            }
        },

        async manualSync() {
            if (!TrippenGistSync.isEnabled) {
                alert('GitHub同期が設定されていません');
                return;
            }

            this.gistSync.isSyncing = true;

            try {
                const result = await TrippenGistSync.manualWriteToCloud();
                if (result) {
                    this.gistSync.lastSyncTime = TrippenGistSync.lastSyncTime;
                    this.gistSync.hasError = false;
                    alert('手動書き込みが完了しました');
                } else {
                    throw new Error('書き込みに失敗しました');
                }
            } catch (error) {
                console.error('手動書き込みエラー:', error);
                this.gistSync.hasError = true;
                alert('書き込みに失敗しました: ' + error.message);
            } finally {
                this.gistSync.isSyncing = false;
            }
        },

        handleSyncConflict() {
            console.log('競合検出 - モーダル表示');
            this.showConflictModal = true;
        },

        closeConflictModal() {
            this.showConflictModal = false;
        },

        async forceLoadFromCloud() {
            this.closeConflictModal();
            await this.loadFromCloud();
        },

        loadData() {
            const savedEvents = localStorage.getItem('trippenEvents');
            const savedDays = localStorage.getItem('trippenDays');

            if (savedEvents) {
                try {
                    this.events = JSON.parse(savedEvents);
                } catch (e) {
                    console.error('予定データの読み込みに失敗しました:', e);
                    this.events = [];
                }
            }

            if (savedDays) {
                try {
                    this.tripDays = JSON.parse(savedDays);
                } catch (e) {
                    console.error('日程データの読み込みに失敗しました:', e);
                    this.tripDays = [];
                }
            }

            this.loadLayerOrder();
        },

        // 他のメソッドは省略（完全な実装では全て含まれます）
    },
    
    // 【修正】mounted()でリアルタイム機能を初期化
    mounted() {
        console.log('Vue.jsアプリ初期化開始（リアルタイム対応版）');

        this.detectMobile();
        this.checkExistingData();
        this.loadData();
        if (this.tripDays.length > 0) {
            this.tripInitialized = true;
            this.loadWeatherForAllEvents();
        }
        window.addEventListener('resize', this.detectMobile);
        window.app = this;

        // 【新機能】ページビジビリティAPI設定
        document.addEventListener('visibilitychange', () => {
            TrippenGistSync.handleVisibilityChange();
        });
        
        // 【新機能】通知許可要求
        this.requestNotificationPermission();
        
        // 【新機能】ブロードキャストチャネル初期化
        this.initBroadcastChannel();
        
        // 【新機能】ウィンドウフォーカス時の即座同期
        window.addEventListener('focus', async () => {
            if (TrippenGistSync.isEnabled) {
                setTimeout(async () => {
                    const hasUpdates = await TrippenGistSync.checkForUpdatesWithETag();
                    if (hasUpdates) {
                        this.handleRealtimeUpdate();
                    }
                }, 500);
            }
        });

        // TrippenGistSync初期化
        const config = TrippenGistSync.loadConfig();
        
        if (config && TrippenGistSync.isEnabled) {
            this.gistSync = {
                isEnabled: TrippenGistSync.isEnabled,
                gistId: TrippenGistSync.gistId,
                lastSyncTime: TrippenGistSync.lastSyncTime,
                lastReadTime: TrippenGistSync.lastReadTime,
                isSyncing: false,
                isLoading: false,
                hasError: false
            };

            TrippenGistSync.startPeriodicSync();
            
            // 【新機能】高速同期開始
            TrippenGistSync.startFastSync();

            if (TrippenGistSync.gistId) {
                setTimeout(async () => {
                    try {
                        const cloudData = await TrippenGistSync.initialAutoLoad();
                        if (cloudData && cloudData.data) {
                            console.log('初回自動読み込みでデータを取得しました');
                        }
                    } catch (error) {
                        console.error('初回自動読み込みエラー:', error);
                    }
                }, 3000);
            }
        }

        console.log('Vue.jsアプリ初期化完了（リアルタイム対応版）');
    }
}).mount('#app');
</script>
</body>
</html>
