<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>とりっぺんちゃん - 旅行予定調整サイト</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Leafletライブラリ（OpenStreetMap API用）-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app">
<header class="header">
<div class="container">
<button class="cloud-load-btn" @click="loadFromCloud" title="クラウドから読込" :disabled="gistSync.isLoading" :class="{ loading: gistSync.isLoading, error: gistSync.hasError }">
<i class="fas fa-cloud-download-alt"></i>
</button>
<button class="cloud-write-btn" @click="manualSync" title="手動書き込み" :disabled="gistSync.isSyncing" :class="{ loading: gistSync.isSyncing, error: gistSync.hasError }">
<i class="fas fa-cloud-upload-alt"></i>
</button>
<h1 v-if="!tripInitialized"><i class="fas fa-snowflake penguin-icon"></i>とりっぺんちゃん</h1>
<h1 v-else class="trip-title-header" @click="editTripTitle" title="旅行タイトルを編集">
    <i class="fas fa-snowflake penguin-icon"></i>
    <span class="editable-title">{{ tripTitle || 'タイトル未設定（クリックして編集）' }}</span>
    <i class="fas fa-edit edit-icon"></i>
</h1>

<button class="settings-btn" @click="openSettingsModal" title="設定">
<i class="fas fa-cog"></i>
</button>
</div>
</header>

<div v-if="!tripInitialized" class="container">
<div class="trip-setup">
<h2><i class="fas fa-calendar-alt"></i> 旅行日程を設定</h2>
<div class="date-input-group">
<label for="startDate"><strong>開始日:</strong></label>
<input type="date" id="startDate" v-model="tripStartDate" :min="today">
<span>〜</span>
<label for="endDate"><strong>終了日:</strong></label>
<input type="date" id="endDate" v-model="tripEndDate" :min="tripStartDate">
</div>
<div class="mt-4">
<button class="btn btn-primary btn-lg" @click="initializeTripDays" :disabled="!tripStartDate || !tripEndDate">
<i class="fas fa-check"></i> 旅行スケジュールを作成
</button>
</div>
<div class="mt-3">
<button class="btn btn-outline-secondary" @click="loadExistingData" v-if="hasExistingData">
<i class="fas fa-folder-open"></i> 既存のデータを読み込む
</button>
</div>
</div>
</div>

<!-- デスクトップ版UI -->
<div v-if="tripInitialized && !isMobile" class="desktop-ui">
<div class="day-tabs-container">
<ul class="nav nav-tabs day-tabs">
<li class="nav-item" v-for="(day, index) in tripDays" :key="`day-${day.id || index}`">
<a class="nav-link" :class="{ active: activeDay === index }" @click="setActiveDay(index)" href="#" @click.prevent>
<div>
<div>{{ day.dayNumber }}日目</div>
<small :class="{ 'editable-date': index === 0 }">
{{ day.date }}
<i v-if="index === 0" class="fas fa-edit" @click.stop="handleDateClick(index)" style="cursor: pointer; margin-left: 4px; padding: 2px; border-radius: 3px; transition: background 0.2s;" @mouseover="$event.target.style.background='rgba(255,255,255,0.2)'" @mouseout="$event.target.style.background='transparent'" title="開始日を変更"></i>
</small>
</div>
<button class="delete-day-btn" v-if="tripDays.length > 1" @click.stop.prevent="deleteDay(index)" @mousedown.stop title="日程を削除">
<i class="fas fa-times"></i>
</button>
</a>
</li>
<li class="nav-item">
<a class="nav-link add-day-btn" @click.prevent.stop="addDayImmediately" @mousedown.stop href="#" title="日程を追加">
<div>
<div style="font-size: 1.5rem; font-weight: bold;">＋</div>
<small style="visibility: hidden;">日程追加</small>
</div>
</a>
</li>
</ul>
</div>

<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}日目の予定
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="scrollContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @contextmenu="handleScheduleContextMenu">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @contextmenu.prevent="handleEventContextMenu($event, event)" @click="handleEventClick($event, event)" @mousedown="handleEventMouseDown($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)" @click.stop="openWeatherPopup(event)" title="天気詳細を見る">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @mousedown.stop title="切り取り">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="add-event-btn" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>

<!-- モバイル版UI -->
<div v-if="tripInitialized && isMobile" class="mobile-ui">
<div class="mobile-day-selector">
<div class="mobile-scroll-container">
<button class="mobile-scroll-nav left" :class="{ disabled: scrollPosition <= 0 }" @click="scrollToDirection('left')">
<i class="fas fa-chevron-left"></i>
</button>
<div class="mobile-day-buttons" ref="mobileScrollContainer" @scroll="updateScrollPosition">
<button v-for="(day, index) in tripDays" :key="`mobile-day-${day.id || index}`" class="mobile-day-btn" :class="{ active: activeDay === index }" @click="setActiveDay(index)" @touchstart="handleMobileDayTouchStart($event, index)" @touchend="handleMobileDayTouchEnd($event, index)">
<div>{{ day.dayNumber }}日目</div>
<small>{{ day.date }}</small>
</button>
</div>
<button class="mobile-scroll-nav right" :class="{ disabled: scrollPosition >= maxScrollPosition }" @click="scrollToDirection('right')">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>

<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}日目の予定
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="mobileTimelineContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @touchstart="handleScheduleTouchStart" @touchend="handleScheduleTouchEnd" @touchmove="handleScheduleTouchMove">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @click="handleEventClick($event, event)" @touchstart="handleEventTouchStart($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)" @click.stop="openWeatherPopup(event)" title="天気詳細を見る">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @touchstart.stop title="切り取り">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="mobile-fab" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>

<!-- コンテキストメニューとモーダル -->
<div class="context-menu" :class="{ show: showContextMenu }" :style="contextMenuStyle">
<div class="context-menu-item add-event" @click="() => addEventFromContext()">
<i class="fas fa-plus"></i>新しい予定を追加
</div>
<div class="context-menu-item paste" :class="{ disabled: !clipboardEvent }" @click="pasteFromContext" v-if="clipboardEvent">
<i class="fas fa-paste"></i>貼り付け
</div>
<div class="context-menu-item disabled" v-else>
<i class="fas fa-paste"></i>貼り付け（コピー済みアイテムなし）
</div>
</div>

<div class="mobile-popup-menu" :class="{ show: showMobilePopup }" @click="closeMobilePopup" v-if="isMobile">
<div class="mobile-popup-content" @click.stop>
<div class="mobile-popup-title">{{ selectedDayForPopup ? `${selectedDayForPopup.dayNumber}日目の編集` : '日程編集' }}</div>
<div class="mobile-popup-buttons">
<button class="mobile-popup-btn primary" v-if="selectedDayForPopup && selectedDayIndex === 0" @click="openStartDateModalFromPopup">
<i class="fas fa-calendar-edit"></i>開始日を変更
</button>
<button class="mobile-popup-btn success" @click="addDayFromPopup">
<i class="fas fa-plus"></i>日程を追加
</button>
<button class="mobile-popup-btn danger" v-if="selectedDayForPopup && tripDays.length > 1" @click="deleteDayFromPopup">
<i class="fas fa-trash"></i>この日程を削除
</button>
<button class="mobile-popup-btn secondary" @click="closeMobilePopup">
<i class="fas fa-times"></i>キャンセル
</button>
</div>
</div>
</div>

<!-- 地図モーダル -->
<div v-if="showMapModal" class="map-modal" @click="closeMapModal">
<div class="map-container" @click.stop>
<div class="map-header">
<h5><i class="fas fa-map-marker-alt"></i> 位置を選択</h5>
<button class="map-close-btn" @click="closeMapModal">
<i class="fas fa-times"></i>
</button>
</div>
<div id="map"></div>
<div class="map-info">
<i class="fas fa-info-circle"></i> 地図上をタップして位置を選択してください
<div v-if="selectedCoordinates" class="mt-2">
<strong>選択した座標:</strong> {{ selectedCoordinates }}
</div>
</div>
</div>
</div>

<!-- 天気予報ポップアップ -->
<div v-if="showWeatherPopup" class="weather-popup-modal">
<div class="weather-popup-content">
<button class="weather-popup-close" @click="closeWeatherPopup" title="閉じる">&times;</button>
<iframe :src="weatherPopupUrl" class="weather-popup-iframe" frameborder="0"></iframe>
</div>
</div>

<!-- 競合検出モーダル -->
<div v-if="showConflictModal" class="conflict-modal" :class="{ show: showConflictModal }" @click="closeConflictModal">
<div class="conflict-content" @click.stop>
<div class="conflict-header">
<h3><i class="fas fa-exclamation-triangle"></i> データ競合が発生</h3>
</div>
<div class="conflict-body">
<p>他の端末でデータが更新されています。</p>
<p><strong>クラウドから読み込んで最新データに更新しますか？</strong></p>
<small class="text-muted">※ローカルの変更は失われる可能性があります</small>
</div>
<div class="conflict-actions">
<button class="conflict-btn primary" @click="forceLoadFromCloud">
<i class="fas fa-cloud-download-alt"></i> クラウドデータで上書き
</button>
<button class="conflict-btn secondary" @click="closeConflictModal">
<i class="fas fa-times"></i> キャンセル（後で同期）
</button>
</div>
</div>
</div>

<!-- 設定モーダル -->
<div v-if="showSettingsModal" class="settings-modal" :class="{ show: showSettingsModal }" @click="closeSettingsModal">
<div class="settings-content" @click.stop>
<div class="settings-header">
<h2><i class="fas fa-cog"></i> 設定</h2>
<button class="settings-close" @click="closeSettingsModal">
<i class="fas fa-times"></i>
</button>
</div>
<div class="settings-body">
<div class="settings-section">
<h3><i class="fas fa-cloud-upload-alt"></i> GitHub同期設定</h3>
<p>GitHub Personal Access Tokenを設定すると、旅行データが自動同期されます。<br>
<strong>新方式:</strong> 変更フラグ管理で効率的同期 + 競合チェック</p>

<div class="sync-status" :class="{ disabled: !gistSync.isEnabled, error: gistSync.hasError }">
<div v-if="gistSync.isEnabled">
<strong>同期状態:</strong> 有効（変更フラグ管理版・手動書き込みボタンヘッダー移動版）<br>
<span v-if="gistSync.gistId">Gist ID: {{ gistSync.gistId }}</span><br>
<span v-if="gistSync.lastReadTime">最終読込: {{ formatSyncTime(gistSync.lastReadTime) }}</span><br>
<span v-if="gistSync.lastSyncTime">最終書込: {{ formatSyncTime(gistSync.lastSyncTime) }}</span>
</div>
<div v-else>
<strong>同期状態:</strong> 無効<br>
<span>GitHub同期が設定されていません</span>
</div>
</div>

<div v-if="!gistSync.isEnabled">
<div class="form-group">
<label for="githubToken">GitHub Personal Access Token</label>
<input type="password" id="githubToken" v-model="syncForm.token" placeholder="GitHub Personal Access Tokenを入力">
</div>
<div class="form-group">
<label for="existingGistId">既存のGist ID（任意）</label>
<input type="text" id="existingGistId" v-model="syncForm.gistId" placeholder="他のデバイスと同期する場合のみ入力">
</div>
<div class="sync-actions">
<button class="sync-btn success" @click="saveGitHubSync">GitHub同期を開始</button>
</div>
</div>

<div v-else class="sync-actions">
<button class="sync-btn secondary" @click="copyGistId">Gist IDコピー</button>
<button class="sync-btn danger" @click="clearGitHubSync">設定を解除</button>
</div>
</div>

<div class="settings-section">
<h3><i class="fas fa-info-circle"></i> アプリ情報</h3>
<p>とりっぺんちゃん - 旅行予定調整サイト<br>
GitHub変更フラグ管理版・手動書き込みボタンヘッダー移動版</p>
</div>
</div>
</div>
</div>

<!-- 動的モーダル -->
<div v-for="modal in modals" :key="modal.id" class="modal fade" :id="modal.id" tabindex="-1">
<div class="modal-dialog" :class="modal.size">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ modal.title }}</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" v-html="modal.body"></div>
<div class="modal-footer" v-html="modal.footer"></div>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="script.js"></script>
</body>
</html>
