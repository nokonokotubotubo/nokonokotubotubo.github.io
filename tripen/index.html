<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¨ã‚Šã£ãºã‚“ã¡ã‚ƒã‚“ - æ—…è¡Œäºˆå®šèª¿æ•´ã‚µã‚¤ãƒˆ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆOpenStreetMap APIç”¨ï¼‰-->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{--primary:#87CEEB;--secondary:#B0E0E6;--accent:#4682B4;--text:#2F4F4F;--bg:#F0F8FF;--time-bg:#E6F3FF;--transition:all 0.3s ease;--radius:15px;--shadow:0 2px 10px rgba(0,0,0,0.1)}
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;display:flex;flex-direction:column}
#app{height:100vh;display:flex;flex-direction:column;overflow:hidden}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:8px 0;text-align:center;box-shadow:var(--shadow);flex-shrink:0}
.penguin-icon{font-size:2rem;margin-right:10px}
.desktop-ui,.mobile-ui{flex:1;display:flex;flex-direction:column;overflow:hidden}
.day-tabs-container{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--secondary) transparent;flex-shrink:0}
.day-tabs{background:white;border-radius:var(--radius) var(--radius) 0 0;margin:10px 0 0 0;box-shadow:var(--shadow);display:flex;min-width:max-content}
.day-tabs .nav-item{transition:var(--transition);flex-shrink:0;position:relative}
.day-tabs .nav-link{border:none;color:var(--text);padding:12px 20px;line-height: 1.2;border-radius:var(--radius) var(--radius) 0 0;white-space:nowrap;text-align:center;min-width:120px;transition:var(--transition);position:relative;display:block}
.day-tabs .nav-link.active{background:var(--primary);color:white;box-shadow:var(--shadow)}
.day-tabs .nav-link:hover{background:var(--secondary);color:white}
.delete-day-btn{position:absolute;top:5px;right:5px;width:20px;height:20px;border-radius:50%;background:rgba(255,99,99,0.8);color:white;border:none;font-size:0.7rem;display:none;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition)}
.delete-day-btn:hover{background:rgba(255,99,99,1);transform:scale(1.1)}
.day-tabs .nav-link:hover .delete-day-btn{display:flex}
.mobile-day-selector{background:white;padding:12px 0;box-shadow:var(--shadow);flex-shrink:0;position:relative}
.mobile-scroll-container{position:relative;padding:0 50px}
.mobile-day-buttons{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--secondary) transparent;padding:0 15px 10px 15px}
.mobile-day-btn{min-width:100px;height:60px;border:2px solid var(--secondary);background:white;border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;justify-content:center;font:bold 0.9rem/1 sans-serif;color:var(--text);transition:var(--transition);flex-shrink:0;-webkit-tap-highlight-color:transparent;user-select:none;touch-action:manipulation}
.mobile-day-btn.active{background:var(--primary);color:white;border-color:var(--primary)}
.mobile-day-btn:active{transform:scale(0.95)}
.mobile-scroll-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.9);border:2px solid var(--secondary);color:var(--accent);font-size:1rem;cursor:pointer;transition:var(--transition);z-index:10;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
.mobile-scroll-nav:active{transform:translateY(-50%) scale(0.9)}
.mobile-scroll-nav.left{left:5px}
.mobile-scroll-nav.right{right:5px}
.mobile-scroll-nav.disabled{opacity:0.3;pointer-events:none}
.mobile-popup-menu{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:var(--transition);-webkit-tap-highlight-color:transparent}
.mobile-popup-menu.show{opacity:1;visibility:visible}
.mobile-popup-content{background:white;border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);max-width:300px;width:90%;text-align:center}
.mobile-popup-title{font:bold 1.2rem/1 sans-serif;color:var(--accent);margin-bottom:20px}
.mobile-popup-buttons{display:flex;flex-direction:column;gap:15px}
.mobile-popup-btn{padding:15px 20px;border:none;border-radius:var(--radius);font:bold 1rem/1 sans-serif;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;gap:10px;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
.mobile-popup-btn.primary{background:var(--primary);color:white}
.mobile-popup-btn.success{background:#28a745;color:white}
.mobile-popup-btn.danger{background:#dc3545;color:white}
.mobile-popup-btn.secondary{background:#6c757d;color:white}
.mobile-popup-btn:active{transform:scale(0.95)}
.mobile-fab{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:var(--transition);z-index:1000;-webkit-tap-highlight-color:transparent}
.mobile-fab:active{transform:scale(0.9)}
.timeline-container{background:white;border-radius:0 0 var(--radius) var(--radius);margin:0;box-shadow:0 4px 15px rgba(0,0,0,0.1);flex:1;display:flex;flex-direction:column;overflow:hidden}
.timeline-header{background:var(--secondary);padding:8px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.timeline-header h5{font-size:1rem;margin:0;line-height:1.2}
.timeline-header h5 small{font-size:0.85rem;margin-left:8px}
.timeline-content{flex:1;overflow:hidden}
.timeline-scroll-container{height:100%;display:flex;overflow-y:auto;overflow-x:hidden}
.time-axis{width:80px;background:var(--time-bg);border-right:2px solid var(--secondary);flex-shrink:0;height:1200px}
.time-slot{height:60px;display:flex;align-items:center;justify-content:center;font:bold 0.9rem/1 sans-serif;color:var(--text);border-bottom:1px solid #e0e0e0}
.schedule-area{flex:1;position:relative;height:1200px}
.schedule-grid{position:absolute;inset:0;height:1200px}
.grid-line{height:60px;border-bottom:1px solid #e0e0e0;position:relative}
.grid-line:nth-child(odd){background:rgba(135,206,235,0.05)}
.quarter-line{position:absolute;left:0;right:0;height:1px;background:#f0f0f0}
.quarter-line:nth-child(1){top:15px}
.quarter-line:nth-child(2){top:30px}
.quarter-line:nth-child(3){top:45px}
.event-block{position:absolute;left:10px;right:10px;background:var(--primary);color:white;border-radius:8px;padding:8px 12px 8px 25px;box-shadow:0 2px 8px rgba(0,0,0,0.2);border:2px solid transparent;transition:var(--transition);z-index:10;user-select:none;-webkit-tap-highlight-color:transparent;min-height:35px;display:flex;align-items:center}
.event-block:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3);border-color:var(--accent)}
.event-block.edit-mode{border-color:#FFD700;box-shadow:0 0 0 3px rgba(255,215,0,0.3);cursor:grab}
.event-block.edit-mode:active{cursor:grabbing}
.event-block.ready-to-move{border-color:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,0.4);transform:scale(1.05);background:linear-gradient(45deg,rgba(76,175,80,0.1),transparent,rgba(76,175,80,0.1));animation:readyToPulse 1.5s infinite ease-in-out}
@keyframes readyToPulse{0%,100%{box-shadow:0 0 0 3px rgba(76,175,80,0.4)}50%{box-shadow:0 0 0 6px rgba(76,175,80,0.2)}}
.event-block.ready-to-move::before{content:"â†•";position:absolute;top:50%;right:8px;transform:translateY(-50%);font-size:1.2rem;color:#4CAF50;font-weight:bold;z-index:25;animation:bounceIcon 1s infinite ease-in-out}
@keyframes bounceIcon{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.2)}}
.event-block.dragging{z-index:1000;opacity:0.8;transform:scale(1.02)}
.event-block.dragging .event-actions{display:none!important}
.event-block.layered{/* å‹•çš„ã«z-indexãŒè¨­å®šã•ã‚Œã‚‹ */}
.event-content-inline{font-size:0.9rem;line-height:1.2;text-align:left;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;font-weight:bold}
.event-title,.event-time,.event-description{display:none}
.event-category-travel{background:#FF6B6B}
.event-category-food{background:#4ECDC4}
.event-category-sightseeing{background:#45B7D1}
.event-category-accommodation{background:#96CEB4}
.event-category-custom{background:#FECA57}
.event-actions{position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);display:flex;gap:5px;z-index:20}
.event-action-btn{width:30px;height:30px;border-radius:8px;border:none;color:white;font-size:0.8rem;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);touch-action:manipulation;-webkit-tap-highlight-color:transparent}
.event-action-btn.cut{background:#FF6B6B;border:2px solid #fff}
.event-action-btn.cut:hover{background:#FF5252;transform:scale(1.1)}
.context-menu{position:fixed;background:white;border:1px solid #ddd;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:2000;opacity:0;visibility:hidden;transform:scale(0.8);transition:var(--transition);min-width:150px}
.context-menu.show{opacity:1;visibility:visible;transform:scale(1)}
.context-menu-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid #eee;transition:var(--transition);display:flex;align-items:center;gap:8px}
.context-menu-item:last-child{border-bottom:none}
.context-menu-item:hover{background:#f5f5f5}
.context-menu-item.paste{color:#4CAF50}
.context-menu-item.paste:hover{background:#e8f5e8}
.context-menu-item.add-event{color:#4CAF50}
.context-menu-item.add-event:hover{background:#e8f5e8}
.context-menu-item.disabled{color:#ccc;cursor:not-allowed}
.context-menu-item.disabled:hover{background:transparent}
.resize-handle{position:absolute;left:0;right:0;height:10px;background:rgba(255,215,0,0.8);opacity:0;transition:var(--transition);cursor:ns-resize}
.resize-handle.top{top:0;border-radius:8px 8px 0 0}
.resize-handle.bottom{bottom:0;border-radius:0 0 8px 8px}
.event-block.edit-mode .resize-handle{opacity:1}
.modal-content{border-radius:var(--radius);border:none;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
.modal-header{background:var(--primary);color:white;border-radius:var(--radius) var(--radius) 0 0}
.btn-primary{background:var(--accent);border:none;border-radius:20px;padding:8px 20px;transition:var(--transition)}
.btn-primary:hover{background:var(--text);transform:translateY(-2px)}
.form-control{border-radius:10px;border:2px solid #e0e0e0;transition:var(--transition)}
.form-control:focus{border-color:var(--primary);box-shadow:0 0 0 0.2rem rgba(135,206,235,0.25)}
.add-event-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--accent);border:none;color:white;font-size:1.5rem;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:var(--transition);z-index:1000}
.add-event-btn:hover{transform:scale(1.1);background:var(--primary)}
.trip-setup{text-align:center;padding:40px 20px}
.trip-setup h2{color:var(--accent);margin-bottom:30px}
.date-input-group{display:flex;align-items:center;justify-content:center;gap:15px;margin:20px 0;flex-wrap:wrap}
.date-input-group input[type="date"]{padding:10px;border:2px solid var(--secondary);border-radius:8px;font-size:1rem}
.date-input-group span{font:bold 1.2rem/1 sans-serif;color:var(--accent)}

/* å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå·¦ä¸Šé…ç½®ãƒ»å¤§ãã‚ã‚µã‚¤ã‚ºï¼‰ */
.weather-emoji-top-left {
    position: absolute;
    top: -4px;
    left: -4px;
    font-size: 2.4rem;
    z-index: 30;
    line-height: 1;
    pointer-events: none;
}

/* OpenStreetMapåœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.map-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.map-container {
    width: 90%;
    max-width: 800px;
    height: 80%;
    max-height: 600px;
    background: white;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
}

.map-header {
    background: var(--primary);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.map-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.3s;
}

.map-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

#map {
    width: 100%;
    height: calc(100% - 60px);
}

.map-info {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 5px;
    font-size: 0.9rem;
    text-align: center;
}

@media (max-width:768px){
.header{padding:6px 0}
.timeline-header{padding:6px 15px}
.timeline-header h5{font-size:0.9rem}
.timeline-header h5 small{font-size:0.75rem;display:block;margin-left:0;margin-top:2px}
.day-tabs{margin:8px 0 0 0}
.time-axis{width:60px;height:1000px}
.time-slot{height:50px;font-size:0.8rem}
.grid-line{height:50px}
.schedule-grid,.schedule-area{height:1000px}
.event-block{padding:6px 8px 6px 22px;min-height:32px}
.event-content-inline{font-size:0.8rem}
.date-input-group{flex-direction:column;gap:10px}
.event-action-btn{width:35px;height:35px;font-size:0.9rem}
.event-block.overlapping{opacity:0.7;border:2px solid #ff6b6b}
.weather-emoji-top-left{font-size:1.5rem}
}
</style>
</head>
<body>
<div id="app">
<header class="header">
<div class="container">
<h1><i class="fas fa-snowflake penguin-icon"></i>ã¨ã‚Šã£ãºã‚“ã¡ã‚ƒã‚“</h1>
<p class="mb-0">ã¿ã‚“ãªã§æ¥½ã—ã„æ—…è¡Œè¨ˆç”»ã‚’ç«‹ã¦ã‚ˆã†ï¼</p>
</div>
</header>
<div v-if="!tripInitialized" class="container">
<div class="trip-setup">
<h2><i class="fas fa-calendar-alt"></i> æ—…è¡Œæ—¥ç¨‹ã‚’è¨­å®šã—ã¦ãã ã•ã„</h2>
<p>æ—…è¡Œã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼</p>
<div class="date-input-group">
<label for="startDate"><strong>é–‹å§‹æ—¥:</strong></label>
<input type="date" id="startDate" v-model="tripStartDate" :min="today">
<span>ã€œ</span>
<label for="endDate"><strong>çµ‚äº†æ—¥:</strong></label>
<input type="date" id="endDate" v-model="tripEndDate" :min="tripStartDate">
</div>
<div class="mt-4">
<button class="btn btn-primary btn-lg" @click="initializeTripDays" :disabled="!tripStartDate || !tripEndDate">
<i class="fas fa-check"></i> æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆ
</button>
</div>
<div class="mt-3">
<button class="btn btn-outline-secondary" @click="loadExistingData" v-if="hasExistingData">
<i class="fas fa-folder-open"></i> æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
</button>
</div>
</div>
</div>
<div v-if="tripInitialized && !isMobile" class="desktop-ui">
<div class="day-tabs-container">
<ul class="nav nav-tabs day-tabs">
<li class="nav-item" v-for="(day, index) in tripDays" :key="`day-${day.id || index}`">
<a class="nav-link" :class="{ active: activeDay === index }" @click="setActiveDay(index)" href="#" @click.prevent>
<div>
<div>{{ day.dayNumber }}æ—¥ç›®</div>
<small :class="{ 'editable-date': index === 0 }">
{{ day.date }}
<i v-if="index === 0" class="fas fa-edit" @click.stop="handleDateClick(index)" style="cursor: pointer; margin-left: 4px; padding: 2px; border-radius: 3px; transition: background 0.2s;" @mouseover="$event.target.style.background='rgba(255,255,255,0.2)'" @mouseout="$event.target.style.background='transparent'" title="é–‹å§‹æ—¥ã‚’å¤‰æ›´"></i>
</small>
</div>
<button class="delete-day-btn" v-if="tripDays.length > 1" @click.stop.prevent="deleteDay(index)" @mousedown.stop title="æ—¥ç¨‹ã‚’å‰Šé™¤">
<i class="fas fa-times"></i>
</button>
</a>
</li>
<li class="nav-item">
<a class="nav-link add-day-btn" @click.prevent.stop="addDayImmediately" @mousedown.stop href="#" title="æ—¥ç¨‹ã‚’è¿½åŠ ">
<div>
<div style="font-size: 1.5rem; font-weight: bold;">ï¼‹</div>
<small style="visibility: hidden;">æ—¥ç¨‹è¿½åŠ </small>
</div>
</a>
</li>
</ul>
</div>
<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}æ—¥ç›®ã®äºˆå®š
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="scrollContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @contextmenu="handleScheduleContextMenu">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @contextmenu.prevent="handleEventContextMenu($event, event)" @click="handleEventClick($event, event)" @mousedown="handleEventMouseDown($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @mousedown.stop title="åˆ‡ã‚Šå–ã‚Š">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @mousedown="startResize($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="add-event-btn" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>
<div v-if="tripInitialized && isMobile" class="mobile-ui">
<div class="mobile-day-selector">
<div class="mobile-scroll-container">
<button class="mobile-scroll-nav left" :class="{ disabled: scrollPosition <= 0 }" @click="scrollToDirection('left')">
<i class="fas fa-chevron-left"></i>
</button>
<div class="mobile-day-buttons" ref="mobileScrollContainer" @scroll="updateScrollPosition">
<button v-for="(day, index) in tripDays" :key="`mobile-day-${day.id || index}`" class="mobile-day-btn" :class="{ active: activeDay === index }" @click="setActiveDay(index)" @touchstart="handleMobileDayTouchStart($event, index)" @touchend="handleMobileDayTouchEnd($event, index)">
<div>{{ day.dayNumber }}æ—¥ç›®</div>
<small>{{ day.date }}</small>
</button>
</div>
<button class="mobile-scroll-nav right" :class="{ disabled: scrollPosition >= maxScrollPosition }" @click="scrollToDirection('right')">
<i class="fas fa-chevron-right"></i>
</button>
</div>
</div>
<div class="timeline-container">
<div class="timeline-header">
<h5>
<i class="fas fa-calendar-day"></i>
{{ tripDays[activeDay]?.dayNumber }}æ—¥ç›®ã®äºˆå®š
<small class="text-muted">{{ tripDays[activeDay]?.date }}</small>
</h5>
</div>
<div class="timeline-content">
<div class="timeline-scroll-container" ref="mobileTimelineContainer">
<div class="time-axis">
<div class="time-slot" v-for="hour in timeSlots" :key="hour">
{{ hour }}:00
</div>
</div>
<div class="schedule-area" @click="editModeEvent = null" @touchstart="handleScheduleTouchStart" @touchend="handleScheduleTouchEnd" @touchmove="handleScheduleTouchMove">
<div class="schedule-grid">
<div class="grid-line" v-for="hour in timeSlots" :key="hour">
<div class="quarter-line"></div>
<div class="quarter-line"></div>
<div class="quarter-line"></div>
</div>
</div>
<div class="event-block" v-for="event in getCurrentDayEvents()" :key="event.id" :class="[
'event-category-' + event.category,
{ 'edit-mode': editModeEvent && editModeEvent.id === event.id },
{ 'dragging': draggingEvent && draggingEvent.id === event.id },
{ 'ready-to-move': readyToMoveEventId === event.id }
]" :style="getEventStyle(event)" @click="handleEventClick($event, event)" @touchstart="handleEventTouchStart($event, event)">
<div class="event-content-inline">
<i :class="getCategoryIcon(event.category)"></i>
{{ event.inlineText }}
</div>
<span class="weather-emoji-top-left" v-if="getEventWeatherEmoji(event)">
{{ getEventWeatherEmoji(event) }}
</span>
<div class="event-actions" v-if="editModeEvent && editModeEvent.id === event.id">
<button class="event-action-btn cut" @click="handleCutButtonClick($event, event)" @touchstart.stop title="åˆ‡ã‚Šå–ã‚Š">
<i class="fas fa-cut"></i>
</button>
</div>
<div class="resize-handle top" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'top')"></div>
<div class="resize-handle bottom" v-if="editModeEvent && editModeEvent.id === event.id" @touchstart="startResizeTouch($event, event, 'bottom')"></div>
</div>
</div>
</div>
</div>
</div>
<button class="mobile-fab" @click="openEventModal()">
<i class="fas fa-plus"></i>
</button>
</div>
<div class="context-menu" :class="{ show: showContextMenu }" :style="contextMenuStyle">
<div class="context-menu-item add-event" @click="addEventFromContext">
<i class="fas fa-plus"></i>æ–°ã—ã„äºˆå®šã‚’è¿½åŠ 
</div>
<div class="context-menu-item paste" :class="{ disabled: !clipboardEvent }" @click="pasteFromContext" v-if="clipboardEvent">
<i class="fas fa-paste"></i>è²¼ã‚Šä»˜ã‘
</div>
<div class="context-menu-item disabled" v-else>
<i class="fas fa-paste"></i>è²¼ã‚Šä»˜ã‘ï¼ˆã‚³ãƒ”ãƒ¼æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãªã—ï¼‰
</div>
</div>
<div class="mobile-popup-menu" :class="{ show: showMobilePopup }" @click="closeMobilePopup" v-if="isMobile">
<div class="mobile-popup-content" @click.stop>
<div class="mobile-popup-title">{{ selectedDayForPopup ? `${selectedDayForPopup.dayNumber}æ—¥ç›®ã®ç·¨é›†` : 'æ—¥ç¨‹ç·¨é›†' }}</div>
<div class="mobile-popup-buttons">
<button class="mobile-popup-btn primary" v-if="selectedDayForPopup && selectedDayIndex === 0" @click="openStartDateModalFromPopup">
<i class="fas fa-calendar-edit"></i>é–‹å§‹æ—¥ã‚’å¤‰æ›´
</button>
<button class="mobile-popup-btn success" @click="addDayFromPopup">
<i class="fas fa-plus"></i>æ—¥ç¨‹ã‚’è¿½åŠ 
</button>
<button class="mobile-popup-btn danger" v-if="selectedDayForPopup && tripDays.length > 1" @click="deleteDayFromPopup">
<i class="fas fa-trash"></i>ã“ã®æ—¥ç¨‹ã‚’å‰Šé™¤
</button>
<button class="mobile-popup-btn secondary" @click="closeMobilePopup">
<i class="fas fa-times"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
</button>
</div>
</div>
</div>

<!-- OpenStreetMapåœ°å›³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæŒ‡ç¤ºé€šã‚Šã®ã¿ï¼‰-->
<div v-if="showMapModal" class="map-modal" @click="closeMapModal">
    <div class="map-container" @click.stop>
        <div class="map-header">
            <h5><i class="fas fa-map-marker-alt"></i> ä½ç½®ã‚’é¸æŠ</h5>
            <button class="map-close-btn" @click="closeMapModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="map"></div>
        <div class="map-info">
            <i class="fas fa-info-circle"></i> åœ°å›³ä¸Šã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„
            <div v-if="selectedCoordinates" class="mt-2">
                <strong>é¸æŠã—ãŸåº§æ¨™:</strong> {{ selectedCoordinates }}
            </div>
        </div>
    </div>
</div>

<div v-for="modal in modals" :key="modal.id" class="modal fade" :id="modal.id" tabindex="-1">
<div class="modal-dialog" :class="modal.size">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">{{ modal.title }}</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body" v-html="modal.body"></div>
<div class="modal-footer" v-html="modal.footer"></div>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const { createApp } = Vue;
const app = createApp({
data() {
return {
tripInitialized: false,
tripStartDate: '',
tripEndDate: '',
today: new Date().toISOString().split('T')[0],
hasExistingData: false,
tripDays: [],
activeDay: 0,
showMobilePopup: false,
selectedDayForPopup: null,
selectedDayIndex: null,
scrollPosition: 0,
maxScrollPosition: 0,
timeSlots: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
events: [],
editModeEvent: null,
clipboardEvent: null,
showContextMenu: false,
contextMenuStyle: {},
pasteTargetTime: null,
isMobile: false,
touchStartTime: 0,
touchStartPosition: { x: 0, y: 0 },
longPressTimer: null,
longPressExecuted: false,
eventTouchOffset: { x: 0, y: 0 },
draggingEvent: null,
isDragComplete: false,
isResizeComplete: false,
dragStarted: false,
longPressEventData: null,
longPressEvent: null,
readyToMoveEventId: null,
// OpenStreetMapåœ°å›³æ©Ÿèƒ½ç”¨ã®ãƒ‡ãƒ¼ã‚¿
showMapModal: false,
map: null,
selectedCoordinates: null,
mapMarker: null,
eventForm: {
title: '',
dayIndex: 0,
startTime: '09:00',
endTime: '10:00',
category: 'travel',
description: '',
coordinates: ''
},
modals: [],
// ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸé †åºã§z-indexã‚’ç®¡ç†
eventLayerOrder: [],
baseZIndex: 10,
maxZIndex: 10,
// å¤©æ°—äºˆå ±æ©Ÿèƒ½ã®ãƒ‡ãƒ¼ã‚¿
weatherCache: {},
weatherCacheExpiry: 6 * 60 * 60 * 1000 // 6æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
};
},
methods: {
linkifyUrls(text) {
if (!text) return text;
const urlRegex = /(https?:\/\/[^\s]+)/g;
return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
},
checkExistingData() {
this.hasExistingData = !!(localStorage.getItem('trippenEvents') && localStorage.getItem('trippenDays'));
},
loadExistingData() {
this.loadData();
if (this.tripDays.length > 0) this.tripInitialized = true;
},
initializeTripDays() {
if (!this.tripStartDate || !this.tripEndDate || this.tripStartDate > this.tripEndDate) {
alert('æ­£ã—ã„æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}
this.tripDays = this.generateTripDays(this.tripStartDate, this.tripEndDate);
this.activeDay = 0;
this.tripInitialized = true;
this.saveData();
},
generateTripDays(startDate, endDate) {
const days = [];
const start = new Date(startDate);
const end = new Date(endDate);
const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
let dayNumber = 1;
for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
days.push({
id: Date.now() + dayNumber + Math.random(),
dayNumber: dayNumber++,
date: `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`,
fullDate: date.toISOString().split('T')[0]
});
}
return days;
},
setActiveDay(index) { this.activeDay = index; },
detectMobile() { this.isMobile = window.innerWidth <= 768 || 'ontouchstart' in window; },
addDayImmediately() {
const startDate = this.tripDays[0].fullDate;
this.tripDays = this.generateConsecutiveDays(startDate, this.tripDays.length + 1);
this.saveData();
},
deleteDay(index) {
if (this.tripDays.length <= 1) {
alert('æœ€ä½1ã¤ã®æ—¥ç¨‹ã¯å¿…è¦ã§ã™');
return;
}
if (confirm(`${this.tripDays[index].dayNumber}æ—¥ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
this.events = this.events.filter(event => event.dayIndex !== index)
.map(event => event.dayIndex > index ? { ...event, dayIndex: event.dayIndex - 1 } : event);
this.tripDays = this.generateConsecutiveDays(this.tripDays[0].fullDate, this.tripDays.length - 1);
if (this.activeDay >= this.tripDays.length) this.activeDay = this.tripDays.length - 1;
this.saveData();
}
},
generateConsecutiveDays(startDate, dayCount) {
const days = [];
const start = new Date(startDate);
const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
for (let i = 0; i < dayCount; i++) {
const date = new Date(start);
date.setDate(start.getDate() + i);
days.push({
id: Date.now() + i + Math.random(),
dayNumber: i + 1,
date: `${date.getMonth() + 1}/${date.getDate()}(${dayNames[date.getDay()]})`,
fullDate: date.toISOString().split('T')[0]
});
}
return days;
},
handleDateClick(index) {
if (index === 0) this.openStartDateModal();
else this.setActiveDay(index);
},
getCurrentDayEvents() {
return this.events
.filter(event => event.dayIndex === this.activeDay)
.map(event => {
const inlineText = `${event.title}ï¼ˆ${event.startTime}-${event.endTime}ï¼‰`;
return {
...event,
inlineText
};
});
},
// é‡ãªã‚Šåˆ¤å®šãƒ¡ã‚½ãƒƒãƒ‰
checkEventOverlap(eventA, eventB) {
if (eventA.dayIndex !== eventB.dayIndex) return false;
  
const startA = this.timeToMinutes(eventA.startTime);
const endA = this.timeToMinutes(eventA.endTime);
const startB = this.timeToMinutes(eventB.startTime);
const endB = this.timeToMinutes(eventB.endTime);
  
return !(endA <= startB || endB <= startA);
},

// ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã¨é‡ãªã‚‹å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
getOverlappingEvents(targetEvent) {
return this.events.filter(event => 
event.id !== targetEvent.id && 
this.checkEventOverlap(targetEvent, event)
);
},

// z-indexã‚’æ›´æ–°ã™ã‚‹
updateEventZIndex(eventId) {
const targetEvent = this.events.find(e => e.id === eventId);
if (!targetEvent) return;
  
const overlappingEvents = this.getOverlappingEvents(targetEvent);
  
// é‡ãªã‚ŠãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
if (overlappingEvents.length === 0) return;
  
// æ—¢å­˜ã®é †åºã‹ã‚‰å‰Šé™¤
this.eventLayerOrder = this.eventLayerOrder.filter(id => id !== eventId);
  
// æœ€å‰é¢ã«è¿½åŠ 
this.eventLayerOrder.push(eventId);
  
// æœ€å¤§z-indexã‚’æ›´æ–°
this.maxZIndex = Math.max(this.maxZIndex, this.baseZIndex + this.eventLayerOrder.length);
  
// ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
this.saveLayerOrder();
},

handleEventClick(event, eventData) {
if (this.isDragComplete) {
this.isDragComplete = false;
return;
}
if (this.isResizeComplete) {
this.isResizeComplete = false;
return;
}
if (this.draggingEvent) {
return;
}
if (this.editModeEvent && this.editModeEvent.id === eventData.id) {
return;
}
if (!event.target.closest('.event-action-btn') && 
!event.target.closest('.resize-handle')) {
this.openDetailModal(eventData);
}
},
handleEventMouseDown(event, eventData) {
if (this.editModeEvent && this.editModeEvent.id === eventData.id) {
if (!event.target.closest('.event-action-btn') && 
!event.target.closest('.resize-handle')) {
event.preventDefault();
event.stopPropagation();
this.startEventDrag(event, eventData);
}
}
},
handleEventContextMenu(event, eventData) {
event.preventDefault();
event.stopPropagation();
this.editModeEvent = this.editModeEvent?.id === eventData.id ? null : eventData;
if (navigator.vibrate) navigator.vibrate(50);
},
startEventDrag(event, eventData) {
this.draggingEvent = eventData;
this.isDragComplete = false;
const startY = event.clientY;
const container = this.$refs.scrollContainer || this.$refs.mobileTimelineContainer;
const rect = container.getBoundingClientRect();
const timelineHeader = container.querySelector('.timeline-header');
const headerHeight = timelineHeader ? timelineHeader.offsetHeight : 0;
const centerOffset = (this.timeToPixels(eventData.endTime) - this.timeToPixels(eventData.startTime)) / 2;
const moveHandler = (e) => {
const newCenterTop = e.clientY - rect.top - headerHeight + container.scrollTop;
const newStartTop = newCenterTop - centerOffset;
const snappedTop = Math.round(newStartTop / 15) * 15;
this.updateEventTimeFromDrag(eventData, snappedTop);
};
const endHandler = () => {
document.removeEventListener('mousemove', moveHandler);
document.removeEventListener('mouseup', endHandler);
this.draggingEvent = null;
this.isDragComplete = true;

// ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸäºˆå®šã®z-indexã‚’æ›´æ–°
this.updateEventZIndex(eventData.id);

this.saveData();
setTimeout(() => {
this.isDragComplete = false;
}, 150);
};
document.addEventListener('mousemove', moveHandler);
document.addEventListener('mouseup', endHandler);
},
startEventDragTouch(event, eventData) {
this.draggingEvent = eventData;
this.isDragComplete = false;
const coords = event.touches[0];
const container = this.$refs.mobileTimelineContainer;
const rect = container.getBoundingClientRect();
const timelineHeader = container.querySelector('.timeline-header');
const headerHeight = timelineHeader ? timelineHeader.offsetHeight : 0;
const centerOffset = (this.timeToPixels(eventData.endTime) - this.timeToPixels(eventData.startTime)) / 2;
const moveHandler = (e) => {
e.preventDefault();
const touch = e.touches[0];
const newCenterTop = touch.clientY - rect.top - headerHeight + container.scrollTop;
const newStartTop = newCenterTop - centerOffset;
const snappedTop = Math.round(newStartTop / 15) * 15;
this.updateEventTimeFromDrag(eventData, snappedTop);
};
const endHandler = () => {
document.removeEventListener('touchmove', moveHandler);
document.removeEventListener('touchend', endHandler);
this.draggingEvent = null;
this.isDragComplete = true;

// ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸäºˆå®šã®z-indexã‚’æ›´æ–°
this.updateEventZIndex(eventData.id);

this.saveData();
setTimeout(() => {
this.isDragComplete = false;
}, 150);
};
document.addEventListener('touchmove', moveHandler, { passive: false });
document.addEventListener('touchend', endHandler, { passive: true });
},
updateEventTimeFromDrag(eventData, snappedTop) {
const minTime = '04:00';
const maxTime = '24:00';
const eventIndex = this.events.findIndex(ev => ev.id === eventData.id);
if (eventIndex === -1) return;
  
const currentDuration = this.timeToMinutes(this.events[eventIndex].endTime) - this.timeToMinutes(this.events[eventIndex].startTime);
const newTime = this.pixelsToTime(snappedTop);
const newEndTime = this.minutesToTime(this.timeToMinutes(newTime) + currentDuration);
  
if (newTime < minTime) {
this.events[eventIndex].startTime = minTime;
this.events[eventIndex].endTime = this.minutesToTime(this.timeToMinutes(minTime) + currentDuration);
return;
}
  
if (newEndTime > maxTime) {
this.events[eventIndex].endTime = maxTime;
this.events[eventIndex].startTime = this.minutesToTime(this.timeToMinutes(maxTime) - currentDuration);
return;
}
  
this.events[eventIndex].startTime = newTime;
this.events[eventIndex].endTime = newEndTime;
},
handleMobileDayTouchStart(event, index) {
this.touchStartTime = Date.now();
this.longPressTimer = setTimeout(() => {
if (navigator.vibrate) navigator.vibrate(50);
this.showMobilePopupForDay(index);
}, 800);
},
handleMobileDayTouchEnd(event, index) {
if (this.longPressTimer) {
clearTimeout(this.longPressTimer);
this.longPressTimer = null;
}
if (Date.now() - this.touchStartTime < 500) this.setActiveDay(index);
},
showMobilePopupForDay(index) {
this.selectedDayForPopup = this.tripDays[index];
this.selectedDayIndex = index;
this.showMobilePopup = true;
},
closeMobilePopup() {
this.showMobilePopup = false;
this.selectedDayForPopup = null;
this.selectedDayIndex = null;
},
openStartDateModalFromPopup() {
this.closeMobilePopup();
setTimeout(() => this.openStartDateModal(), 300);
},
addDayFromPopup() {
this.closeMobilePopup();
setTimeout(() => this.addDayImmediately(), 300);
},
deleteDayFromPopup() {
const index = this.selectedDayIndex;
this.closeMobilePopup();
setTimeout(() => index !== null && this.deleteDay(index), 300);
},
updateScrollPosition() {
const container = this.$refs.mobileScrollContainer;
if (!container) return;
this.scrollPosition = container.scrollLeft;
this.maxScrollPosition = container.scrollWidth - container.clientWidth;
},
scrollToDirection(direction) {
const container = this.$refs.mobileScrollContainer;
if (!container) return;
container.scrollBy({ left: direction === 'left' ? -120 : 120, behavior: 'smooth' });
},
handleEventTouchStart(event, eventData) {
if (this.isDragComplete) {
return;
}
if (this.draggingEvent) {
return;
}
if (this.editModeEvent && this.editModeEvent.id === eventData.id) {
if (!event.target.closest('.event-action-btn') && 
!event.target.closest('.resize-handle')) {
event.preventDefault();
event.stopPropagation();
this.startEventDragTouch(event, eventData);
}
} else {
if (!event.target.closest('.event-action-btn') && 
!event.target.closest('.resize-handle')) {
event.preventDefault();
event.stopPropagation();
this.touchStartTime = Date.now();
this.longPressExecuted = false;
this.dragStarted = false;
this.longPressEventData = eventData;
this.longPressEvent = event;
this.readyToMoveEventId = null;
this.touchStartPosition = { 
x: event.touches[0].clientX, 
y: event.touches[0].clientY 
};
this.longPressTimer = setTimeout(() => {
this.longPressExecuted = true;
this.readyToMoveEventId = eventData.id;
if (navigator.vibrate) navigator.vibrate(50);
}, 500);
const handleTouchMove = (e) => {
if (!this.longPressExecuted) return;
const deltaX = Math.abs(e.touches[0].clientX - this.touchStartPosition.x);
const deltaY = Math.abs(e.touches[0].clientY - this.touchStartPosition.y);
if ((deltaX > 5 || deltaY > 5) && !this.dragStarted) {
this.dragStarted = true;
this.editModeEvent = eventData;
this.readyToMoveEventId = null;
this.startEventDragTouch(this.longPressEvent, eventData);
}
};
const handleTouchEnd = () => {
if (this.longPressTimer) {
clearTimeout(this.longPressTimer);
this.longPressTimer = null;
}
const touchDuration = Date.now() - this.touchStartTime;
if (this.longPressExecuted && !this.dragStarted) {
this.editModeEvent = eventData;
this.readyToMoveEventId = null;
} else if (!this.longPressExecuted && touchDuration < 500) {
this.openDetailModal(eventData);
}
this.dragStarted = false;
this.longPressEventData = null;
this.longPressEvent = null;
this.readyToMoveEventId = null;
document.removeEventListener('touchmove', handleTouchMove);
document.removeEventListener('touchend', handleTouchEnd);
};
document.addEventListener('touchmove', handleTouchMove, { passive: false });
document.addEventListener('touchend', handleTouchEnd, { passive: true });
}
}
},
handleCutButtonClick(event, eventData) {
event.preventDefault();
event.stopPropagation();
this.cutEvent(eventData);
},
cutEvent(event) {
try {
this.clipboardEvent = { ...event };
const eventIndex = this.events.findIndex(e => e.id === event.id);
if (eventIndex !== -1) {
this.events.splice(eventIndex, 1);
this.editModeEvent = null;
this.saveData();
if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
}
} catch (error) {
console.error('äºˆå®šã®åˆ‡ã‚Šå–ã‚Šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
alert('äºˆå®šã®åˆ‡ã‚Šå–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}
},
pasteFromContext() {
if (!this.clipboardEvent) return;
const newEvent = {
...this.clipboardEvent,
id: Date.now() + Math.random(),
dayIndex: this.activeDay
};
if (this.pasteTargetTime) {
const duration = this.timeToMinutes(this.clipboardEvent.endTime) - this.timeToMinutes(this.clipboardEvent.startTime);
const startMinutes = this.timeToMinutes(this.pasteTargetTime);
let endMinutes = startMinutes + duration;
if (endMinutes > 1440) {
endMinutes = 1440;
}
newEvent.startTime = this.pasteTargetTime;
newEvent.endTime = this.minutesToTime(endMinutes);
}
this.events.push(newEvent);
this.clipboardEvent = null;
this.hideContextMenu();
this.saveData();
},
addEventFromContext() {
if (!this.pasteTargetTime) return;
const startMinutes = this.timeToMinutes(this.pasteTargetTime);
const endTime = this.minutesToTime(startMinutes + 60);
this.eventForm = {
title: '',
dayIndex: this.activeDay,
startTime: this.pasteTargetTime,
endTime: endTime,
category: 'travel',
description: '',
coordinates: ''
};
this.hideContextMenu();
setTimeout(() => {
this.openEventModal(null, true);
}, 100);
},
timeToMinutes(timeString) {
const [hours, minutes] = timeString.split(':').map(Number);
return hours * 60 + minutes;
},
minutesToTime(minutes) {
const hours = Math.floor(minutes / 60);
const mins = minutes % 60;
return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
},
timeToPixels(timeString) {
const [hours, minutes] = timeString.split(':').map(Number);
const totalMinutes = (hours - 4) * 60 + minutes;
return totalMinutes * (this.isMobile ? 50/60 : 1);
},
pixelsToTime(pixels) {
const totalMinutes = pixels / (this.isMobile ? 50/60 : 1);
const roundedMinutes = Math.round(totalMinutes / 15) * 15;
const hours = Math.max(4, Math.min(24, Math.floor(roundedMinutes / 60) + 4));
const minutes = hours === 24 ? 0 : roundedMinutes % 60;
return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
},
handleScheduleContextMenu(event) {
if (!this.isMobile) {
event.preventDefault();
this.showContextMenuAt(event.clientX, event.clientY, event);
}
},
showContextMenuAt(x, y, event) {
const container = this.isMobile ? this.$refs.mobileTimelineContainer : this.$refs.scrollContainer;
const timelineHeader = container.querySelector('.timeline-header');
const scheduleArea = container.querySelector('.schedule-area');
if (!scheduleArea) {
const containerRect = container.getBoundingClientRect();
this.pasteTargetTime = this.pixelsToTime(y - containerRect.top + container.scrollTop);
} else {
const containerRect = container.getBoundingClientRect();
const scheduleAreaRect = scheduleArea.getBoundingClientRect();
const headerHeight = timelineHeader ? timelineHeader.offsetHeight : 0;
const relativeY = y - containerRect.top - headerHeight + container.scrollTop;
const snappedY = Math.round(relativeY / 15) * 15;
this.pasteTargetTime = this.pixelsToTime(Math.max(0, snappedY));
}
this.contextMenuStyle = { left: `${x}px`, top: `${y}px` };
this.showContextMenu = true;
setTimeout(() => {
document.addEventListener('click', this.hideContextMenu, { once: true });
}, 100);
},
hideContextMenu() { this.showContextMenu = false; },
handleScheduleTouchStart(event) {
if (!this.isMobile) return;
if (event.target.closest('.event-block')) {
return;
}
this.touchStartTime = Date.now();
this.touchStartPosition = { x: event.touches[0].clientX, y: event.touches[0].clientY };
this.longPressTimer = setTimeout(() => {
this.showContextMenuAt(this.touchStartPosition.x, this.touchStartPosition.y, event);
if (navigator.vibrate) navigator.vibrate(50);
}, 500);
},
handleScheduleTouchMove(event) {
if (!this.isMobile) return;
if (event.target.closest('.event-block')) {
return;
}
const deltaX = Math.abs(event.touches[0].clientX - this.touchStartPosition.x);
const deltaY = Math.abs(event.touches[0].clientY - this.touchStartPosition.y);
if (deltaX > 10 || deltaY > 10) this.clearLongPress();
},
handleScheduleTouchEnd(event) {
if (!this.isMobile) return;
if (event.target.closest('.event-block')) {
return;
}
this.clearLongPress();
if (Date.now() - this.touchStartTime < 300) this.editModeEvent = null;
},
clearLongPress() {
if (this.longPressTimer) {
clearTimeout(this.longPressTimer);
this.longPressTimer = null;
}
},
startResize(event, eventData, direction) {
this.startResizeHandler(event, direction, 'mouse');
},
startResizeTouch(event, eventData, direction) {
this.startResizeHandler(event, direction, 'touch');
},
startResizeHandler(event, direction, type) {
event.preventDefault();
event.stopPropagation();
const moveEvent = type === 'touch' ? 'touchmove' : 'mousemove';
const endEvent = type === 'touch' ? 'touchend' : 'mouseup';
const moveHandler = (e) => {
const coords = type === 'touch' ? e.touches[0] : e;
const container = this.isMobile ? this.$refs.mobileTimelineContainer : this.$refs.scrollContainer;
const rect = container.getBoundingClientRect();
const timelineHeader = container.querySelector('.timeline-header');
const headerHeight = timelineHeader ? timelineHeader.offsetHeight : 0;
const y = coords.clientY - rect.top - headerHeight + container.scrollTop;
const snappedY = Math.round(y / 15) * 15;
const newTime = this.pixelsToTime(snappedY);
const eventIndex = this.events.findIndex(ev => ev.id === this.editModeEvent.id);
if (eventIndex === -1) return;
if (direction === 'top' && newTime < this.events[eventIndex].endTime) {
this.events[eventIndex].startTime = newTime;
} else if (direction === 'bottom' && newTime > this.events[eventIndex].startTime) {
this.events[eventIndex].endTime = newTime;
}
};
const endHandler = () => {
document.removeEventListener(moveEvent, moveHandler);
document.removeEventListener(endEvent, endHandler);
this.isResizeComplete = true;
this.saveData();
setTimeout(() => {
this.isResizeComplete = false;
}, 150);
};
document.addEventListener(moveEvent, moveHandler, { passive: false });
document.addEventListener(endEvent, endHandler);
},
getEventStyle(event) {
const startPixels = this.timeToPixels(event.startTime);
const endPixels = this.timeToPixels(event.endTime);
const duration = Math.max(endPixels - startPixels, this.isMobile ? 25 : 30);

// z-indexã‚’å‹•çš„ã«è¨­å®š
let zIndex = this.baseZIndex;
const layerIndex = this.eventLayerOrder.indexOf(event.id);
if (layerIndex !== -1) {
zIndex = this.baseZIndex + layerIndex + 1;
}

return {
top: `${startPixels}px`,
height: `${duration}px`,
minHeight: this.isMobile ? '32px' : '35px',
zIndex: zIndex
};
},
getCategoryIcon(category) {
const icons = {
travel: 'fas fa-car',
food: 'fas fa-utensils',
sightseeing: 'fas fa-camera',
accommodation: 'fas fa-bed',
custom: 'fas fa-star'
};
return icons[category] || 'fas fa-calendar';
},

// å¤©æ°—äºˆå ±ã‚’å–å¾—ã™ã‚‹
async fetchWeatherForEvent(event) {
if (!event.coordinates) return null;

try {
const [lat, lng] = event.coordinates.split(',').map(Number);
if (isNaN(lat) || isNaN(lng)) return null;

const cacheKey = `${lat},${lng}_${event.dayIndex}`;
const cachedWeather = this.weatherCache[cacheKey];

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ãªå ´åˆã¯è¿”ã™
if (cachedWeather && Date.now() - cachedWeather.timestamp < this.weatherCacheExpiry) {
return cachedWeather.data;
}

const dayData = this.tripDays[event.dayIndex];
if (!dayData) return null;

const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode&timezone=auto&start_date=${dayData.fullDate}&end_date=${dayData.fullDate}`;

const response = await fetch(url);
if (!response.ok) throw new Error('Weather API request failed');

const data = await response.json();
const weatherCode = data.daily.weathercode[0];

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
this.weatherCache[cacheKey] = {
data: weatherCode,
timestamp: Date.now()
};

return weatherCode;
} catch (error) {
console.error('å¤©æ°—äºˆå ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
return null;
}
},

// å¤©æ°—ã‚³ãƒ¼ãƒ‰ã‚’çµµæ–‡å­—ã«å¤‰æ›
getWeatherEmoji(weatherCode) {
if (!weatherCode) return '';

const weatherMap = {
0: 'â˜€ï¸',    // æ™´ã‚Œ
1: 'ğŸŒ¤ï¸',   // ä¸»ã«æ™´ã‚Œ
2: 'â›…',    // éƒ¨åˆ†çš„ã«æ›‡ã‚Š
3: 'â˜ï¸',    // æ›‡ã‚Š
45: 'ğŸŒ«ï¸',  // éœ§
48: 'ğŸŒ«ï¸',  // éœ§æ°·
51: 'ğŸŒ¦ï¸',  // è»½ã„éœ§é›¨
53: 'ğŸŒ¦ï¸',  // ä¸­ç¨‹åº¦ã®éœ§é›¨
55: 'ğŸŒ§ï¸',  // æ¿€ã—ã„éœ§é›¨
56: 'ğŸŒ§ï¸',  // è»½ã„æ°·é›¨
57: 'ğŸŒ§ï¸',  // æ¿€ã—ã„æ°·é›¨
61: 'ğŸŒ§ï¸',  // è»½ã„é›¨
63: 'ğŸŒ§ï¸',  // ä¸­ç¨‹åº¦ã®é›¨
65: 'ğŸŒ§ï¸',  // æ¿€ã—ã„é›¨
66: 'ğŸŒ§ï¸',  // è»½ã„æ°·é›¨
67: 'ğŸŒ§ï¸',  // æ¿€ã—ã„æ°·é›¨
71: 'ğŸŒ¨ï¸',  // è»½ã„é›ª
73: 'ğŸŒ¨ï¸',  // ä¸­ç¨‹åº¦ã®é›ª
75: 'ğŸŒ¨ï¸',  // æ¿€ã—ã„é›ª
77: 'ğŸŒ¨ï¸',  // é›ªã®ç²’
80: 'ğŸŒ¦ï¸',  // è»½ã„ã«ã‚ã‹é›¨
81: 'ğŸŒ¦ï¸',  // ä¸­ç¨‹åº¦ã®ã«ã‚ã‹é›¨
82: 'ğŸŒ§ï¸',  // æ¿€ã—ã„ã«ã‚ã‹é›¨
85: 'ğŸŒ¨ï¸',  // è»½ã„ã«ã‚ã‹é›ª
86: 'ğŸŒ¨ï¸',  // æ¿€ã—ã„ã«ã‚ã‹é›ª
95: 'â›ˆï¸',  // é›·é›¨
96: 'â›ˆï¸',  // è»½ã„é›¹ã‚’ä¼´ã†é›·é›¨
99: 'â›ˆï¸'   // æ¿€ã—ã„é›¹ã‚’ä¼´ã†é›·é›¨
};

return weatherMap[weatherCode] || '';
},

// å…¨ã¦ã®äºˆå®šã®å¤©æ°—äºˆå ±ã‚’å–å¾—
async loadWeatherForAllEvents() {
const promises = this.events
.filter(event => event.coordinates)
.map(event => this.fetchWeatherForEvent(event));

await Promise.all(promises);
},

// äºˆå®šã®å¤©æ°—äºˆå ±çµµæ–‡å­—ã‚’å–å¾—
getEventWeatherEmoji(event) {
if (!event.coordinates) return '';

const cacheKey = `${event.coordinates}_${event.dayIndex}`;
const cachedWeather = this.weatherCache[cacheKey];

if (cachedWeather && Date.now() - cachedWeather.timestamp < this.weatherCacheExpiry) {
return this.getWeatherEmoji(cachedWeather.data);
}

return '';
},

// OpenStreetMapåœ°å›³æ©Ÿèƒ½ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆæŒ‡ç¤ºé€šã‚Šã®ã¿ï¼‰
setLocationFromMap() {
this.showMapModal = true;
this.$nextTick(() => {
this.initializeMap();
});
},

initializeMap() {
// å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºã®åº§æ¨™ (34.7024, 135.4959)
const initialLat = 34.7024;
const initialLng = 135.4959;

this.map = L.map('map').setView([initialLat, initialLng], 15);

// OpenStreetMap APIã‚’ä½¿ç”¨
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: 'Â© OpenStreetMap contributors'
}).addTo(this.map);

// åœ°å›³ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¿ãƒƒãƒ—ï¼‰ã‚¤ãƒ™ãƒ³ãƒˆ - åº§æ¨™å–å¾—
this.map.on('click', (e) => {
this.handleMapClick(e);
});
},

handleMapClick(e) {
const lat = e.latlng.lat.toFixed(6);
const lng = e.latlng.lng.toFixed(6);
this.selectedCoordinates = `${lat},${lng}`;

// æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
if (this.mapMarker) {
this.map.removeLayer(this.mapMarker);
}

// æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
this.mapMarker = L.marker([lat, lng]).addTo(this.map);

// åº§æ¨™ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
const coordinatesInput = document.getElementById('eventCoordinates');
if (coordinatesInput) {
coordinatesInput.value = this.selectedCoordinates;
}

// ã‚¿ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
if (navigator.vibrate) navigator.vibrate(100);

// åœ°å›³ã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹
this.closeMapModal();
},

closeMapModal() {
this.showMapModal = false;
if (this.map) {
this.map.remove();
this.map = null;
}
this.mapMarker = null;
},

copyCoordinates() {
const coordinatesInput = document.getElementById('eventCoordinates');
if (!coordinatesInput || !coordinatesInput.value.trim()) {
alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹ç·¯åº¦çµŒåº¦ãŒã‚ã‚Šã¾ã›ã‚“');
return;
}

const coordinates = coordinatesInput.value.trim();

try {
navigator.clipboard.writeText(coordinates).then(() => {
alert('ç·¯åº¦çµŒåº¦ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
if (navigator.vibrate) navigator.vibrate(100);
}).catch(() => {
// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
coordinatesInput.select();
document.execCommand('copy');
alert('ç·¯åº¦çµŒåº¦ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
if (navigator.vibrate) navigator.vibrate(100);
});
} catch (error) {
console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
},

openGoogleMap(coordinates) {
if (!coordinates || !coordinates.trim()) {
alert('ç·¯åº¦çµŒåº¦ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
return;
}

const coords = coordinates.trim();
const googleMapsUrl = `https://maps.google.co.jp/maps?ll=${coords}&z=15`;

try {
if (this.isMobile) {
// ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ã‚¢ãƒ—ãƒªã§é–‹ã
window.location.href = googleMapsUrl;
} else {
// ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®å ´åˆã¯åˆ¥ã‚¿ãƒ–ã§é–‹ã
window.open(googleMapsUrl, '_blank', 'noopener,noreferrer');
}
} catch (error) {
console.error('Googleãƒãƒƒãƒ—ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
alert('Googleãƒãƒƒãƒ—ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
}
},

openDetailModal(event) {
const eventData = typeof event === 'string' ? this.events.find(e => String(e.id) === String(event)) : event;
if (!eventData) {
console.error('openDetailModal: äºˆå®šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', event);
alert('äºˆå®šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
return;
}
const safeEventId = String(eventData.id).replace(/'/g, "\\'");
const safeTitle = String(eventData.title).replace(/'/g, "\\'").replace(/"/g, "&quot;");
const safeCoordinates = String(eventData.coordinates || '').replace(/"/g, "&quot;");
this.openModal('è©³ç´°', `
<div class="mb-3"><h6><i class="${this.getCategoryIcon(eventData.category)}"></i> ${safeTitle}</h6></div>
<div class="mb-3"><strong>æ—¥ä»˜:</strong> ${this.tripDays[eventData.dayIndex]?.date || 'ä¸æ˜'}</div>
<div class="mb-3"><strong>æ™‚é–“:</strong> ${eventData.startTime} - ${eventData.endTime}</div>
${eventData.coordinates ? `<div class="mb-3"><strong>ç·¯åº¦çµŒåº¦:</strong> ${safeCoordinates} <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="window.app.openGoogleMap('${safeCoordinates}')" title="Googleãƒãƒƒãƒ—ã§è¡¨ç¤º">ğŸ—¾</button></div>` : ''}
${eventData.description ? `<div class="mb-3"><strong>è©³ç´°:</strong><br>${this.linkifyUrls(String(eventData.description).replace(/"/g, "&quot;"))}</div>` : ''}
`, `
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
<button type="button" class="btn btn-danger" onclick="window.app.deleteEventFromDetail('${safeEventId}')">å‰Šé™¤</button>
<button type="button" class="btn btn-primary" onclick="window.app.editEventFromDetail('${safeEventId}')">ç·¨é›†</button>
`);
},

deleteEventFromDetail(eventId) {
try {
if (!confirm('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
return;
}
const eventIndex = this.events.findIndex(e => String(e.id) === String(eventId));
if (eventIndex === -1) {
alert('äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
return;
}
this.events.splice(eventIndex, 1);
this.saveData();
this.editModeEvent = null;
this.closeAllModals();
if (navigator.vibrate) navigator.vibrate(100);
} catch (error) {
console.error('äºˆå®šã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
alert('äºˆå®šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
}
},

editEventFromDetail(eventId) {
try {
const event = this.events.find(e => String(e.id) === String(eventId));
if (!event) {
alert('äºˆå®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
return;
}
this.closeAllModals();
setTimeout(() => {
this.openEventModal(event);
}, 100);
} catch (error) {
console.error('äºˆå®šã®ç·¨é›†æº–å‚™ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
alert('äºˆå®šã®ç·¨é›†æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
}
},

openEventModal(event = null, fromContextMenu = false) {
const isEdit = !!event;
if (isEdit) {
// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
this.eventForm = { ...event };
} else {
// æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
this.eventForm = {
title: '',
dayIndex: this.activeDay,
startTime: '09:00',
endTime: '10:00',
category: 'travel',
description: '',
coordinates: ''
};
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’è¨­å®š
const modalTitle = isEdit ? 'äºˆå®šã‚’ç·¨é›†' : 'æ–°ã—ã„äºˆå®šã‚’è¿½åŠ ';
const modalBody = this.generateEventModalBody();
const modalFooter = this.generateEventModalFooter(isEdit);

this.openModal(modalTitle, modalBody, modalFooter);
},

generateEventModalBody() {
return `
<div class="mb-3">
<label for="eventTitle" class="form-label">äºˆå®šã‚¿ã‚¤ãƒˆãƒ«</label>
<input type="text" class="form-control" id="eventTitle" value="${this.eventForm.title.replace(/"/g, '&quot;')}" placeholder="äºˆå®šã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
</div>
<div class="mb-3">
<label for="eventDay" class="form-label">æ—¥ç¨‹</label>
<select class="form-select" id="eventDay">
${this.tripDays.map((day, index) => 
`<option value="${index}" ${this.eventForm.dayIndex === index ? 'selected' : ''}>${day.dayNumber}æ—¥ç›® (${day.date})</option>`
).join('')}
</select>
</div>
<div class="row">
<div class="col-md-6">
<div class="mb-3">
<label for="eventStartTime" class="form-label">é–‹å§‹æ™‚é–“</label>
<input type="time" class="form-control" id="eventStartTime" value="${this.eventForm.startTime}" min="04:00" max="23:59">
</div>
</div>
<div class="col-md-6">
<div class="mb-3">
<label for="eventEndTime" class="form-label">çµ‚äº†æ™‚é–“</label>
<input type="time" class="form-control" id="eventEndTime" value="${this.eventForm.endTime}" min="04:00" max="24:00">
</div>
</div>
</div>
<div class="mb-3">
<label for="eventCategory" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
<select class="form-select" id="eventCategory">
<option value="travel" ${this.eventForm.category === 'travel' ? 'selected' : ''}>ğŸš— ç§»å‹•</option>
<option value="food" ${this.eventForm.category === 'food' ? 'selected' : ''}>ğŸ½ï¸ é£Ÿäº‹</option>
<option value="sightseeing" ${this.eventForm.category === 'sightseeing' ? 'selected' : ''}>ğŸ“¸ è¦³å…‰</option>
<option value="accommodation" ${this.eventForm.category === 'accommodation' ? 'selected' : ''}>ğŸ¨ å®¿æ³Š</option>
<option value="custom" ${this.eventForm.category === 'custom' ? 'selected' : ''}>â­ ãã®ä»–</option>
</select>
</div>
<div class="mb-3">
<label for="eventCoordinates" class="form-label">ç·¯åº¦çµŒåº¦ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
<div class="input-group">
<input type="text" class="form-control" id="eventCoordinates" value="${this.eventForm.coordinates.replace(/"/g, '&quot;')}" placeholder="ä¾‹: 34.702485,135.495951">
<button class="btn btn-outline-secondary" type="button" onclick="window.app.setLocationFromMap()" title="åœ°å›³ã‹ã‚‰é¸æŠ">ğŸ—¾</button>
<button class="btn btn-outline-secondary" type="button" onclick="window.app.copyCoordinates()" title="ã‚³ãƒ”ãƒ¼">ğŸ“‹</button>
</div>
<div class="form-text">åœ°å›³ã‹ã‚‰ä½ç½®ã‚’é¸æŠã™ã‚‹ã‹ã€ç·¯åº¦,çµŒåº¦ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
</div>
<div class="mb-3">
<label for="eventDescription" class="form-label">è©³ç´° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
<textarea class="form-control" id="eventDescription" rows="3" placeholder="äºˆå®šã®è©³ç´°ã‚’å…¥åŠ›">${this.eventForm.description.replace(/"/g, '&quot;')}</textarea>
</div>
`;
},

generateEventModalFooter(isEdit) {
return `
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button type="button" class="btn btn-primary" onclick="window.app.saveEvent(${isEdit})">${isEdit ? 'æ›´æ–°' : 'è¿½åŠ '}</button>
`;
},

saveEvent(isEdit) {
const title = document.getElementById('eventTitle').value.trim();
const dayIndex = parseInt(document.getElementById('eventDay').value);
const startTime = document.getElementById('eventStartTime').value;
const endTime = document.getElementById('eventEndTime').value;
const category = document.getElementById('eventCategory').value;
const coordinates = document.getElementById('eventCoordinates').value.trim();
const description = document.getElementById('eventDescription').value.trim();

if (!title) {
alert('äºˆå®šã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
return;
}

if (!startTime || !endTime) {
alert('é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}

if (startTime >= endTime) {
alert('çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
return;
}

// åº§æ¨™ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
if (coordinates && !this.validateCoordinates(coordinates)) {
alert('ç·¯åº¦çµŒåº¦ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\næ­£ã—ã„å½¢å¼ï¼š34.702485,135.495951');
return;
}

const eventData = {
title,
dayIndex,
startTime,
endTime,
category,
coordinates,
description
};

if (isEdit) {
// ç·¨é›†ã®å ´åˆ
const eventIndex = this.events.findIndex(e => e.id === this.eventForm.id);
if (eventIndex !== -1) {
this.events[eventIndex] = { ...this.events[eventIndex], ...eventData };
}
} else {
// æ–°è¦è¿½åŠ ã®å ´åˆ
eventData.id = Date.now() + Math.random();
this.events.push(eventData);
}

this.saveData();
this.closeAllModals();
this.editModeEvent = null;

// è¿½åŠ ãƒ»ç·¨é›†ã—ãŸæ—¥ç¨‹ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
this.activeDay = dayIndex;

// å¤©æ°—äºˆå ±ã‚’å†å–å¾—
this.loadWeatherForAllEvents();

if (navigator.vibrate) navigator.vibrate(100);
},

validateCoordinates(coordinates) {
const coordPattern = /^-?\d+\.?\d*,-?\d+\.?\d*$/;
if (!coordPattern.test(coordinates)) return false;

const [lat, lng] = coordinates.split(',').map(Number);
return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
},

openModal(title, body, footer, size = '') {
const modalId = 'modal-' + Date.now();
const modal = {
id: modalId,
title,
body,
footer,
size
};

this.modals.push(modal);

this.$nextTick(() => {
const modalElement = document.getElementById(modalId);
if (modalElement) {
const bootstrapModal = new bootstrap.Modal(modalElement);
bootstrapModal.show();

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã¨ãã«modalsé…åˆ—ã‹ã‚‰å‰Šé™¤
modalElement.addEventListener('hidden.bs.modal', () => {
const index = this.modals.findIndex(m => m.id === modalId);
if (index !== -1) {
this.modals.splice(index, 1);
}
});
}
});
},

closeAllModals() {
this.modals.forEach(modal => {
const modalElement = document.getElementById(modal.id);
if (modalElement) {
const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
if (bootstrapModal) {
bootstrapModal.hide();
}
}
});
this.modals = [];
},

openStartDateModal() {
this.openModal('é–‹å§‹æ—¥ã‚’å¤‰æ›´', `
<div class="mb-3">
<label for="newStartDate" class="form-label">æ–°ã—ã„é–‹å§‹æ—¥</label>
<input type="date" class="form-control" id="newStartDate" value="${this.tripDays[0].fullDate}" min="${this.today}">
</div>
<div class="alert alert-warning">
<i class="fas fa-exclamation-triangle"></i>
<strong>æ³¨æ„:</strong> é–‹å§‹æ—¥ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ—¢å­˜ã®äºˆå®šã®æ—¥ç¨‹ã‚‚è‡ªå‹•çš„ã«èª¿æ•´ã•ã‚Œã¾ã™ã€‚
</div>
`, `
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button type="button" class="btn btn-primary" onclick="window.app.updateStartDate()">å¤‰æ›´</button>
`);
},

updateStartDate() {
const newStartDate = document.getElementById('newStartDate').value;
if (!newStartDate) {
alert('æ–°ã—ã„é–‹å§‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}

if (newStartDate < this.today) {
alert('é–‹å§‹æ—¥ã¯ä»Šæ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
return;
}

if (confirm('é–‹å§‹æ—¥ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®äºˆå®šã‚‚æ—¥ç¨‹ãŒèª¿æ•´ã•ã‚Œã¾ã™ã€‚')) {
this.tripDays = this.generateConsecutiveDays(newStartDate, this.tripDays.length);
this.saveData();
this.closeAllModals();
// å¤©æ°—äºˆå ±ã‚’å†å–å¾—
this.loadWeatherForAllEvents();
if (navigator.vibrate) navigator.vibrate(100);
}
},

// ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºã®ä¿å­˜
saveLayerOrder() {
localStorage.setItem('trippenLayerOrder', JSON.stringify(this.eventLayerOrder));
localStorage.setItem('trippenMaxZIndex', this.maxZIndex.toString());
},

// ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºã®èª­ã¿è¾¼ã¿
loadLayerOrder() {
const savedLayerOrder = localStorage.getItem('trippenLayerOrder');
const savedMaxZIndex = localStorage.getItem('trippenMaxZIndex');

if (savedLayerOrder) {
try {
this.eventLayerOrder = JSON.parse(savedLayerOrder);
} catch (e) {
console.error('ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
this.eventLayerOrder = [];
}
}

if (savedMaxZIndex) {
this.maxZIndex = parseInt(savedMaxZIndex) || this.baseZIndex;
}
},

// saveDataãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£
saveData() {
localStorage.setItem('trippenEvents', JSON.stringify(this.events));
localStorage.setItem('trippenDays', JSON.stringify(this.tripDays));
this.saveLayerOrder();
},

// loadDataãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£
loadData() {
const savedEvents = localStorage.getItem('trippenEvents');
const savedDays = localStorage.getItem('trippenDays');

if (savedEvents) {
try {
this.events = JSON.parse(savedEvents);
} catch (e) {
console.error('äºˆå®šãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
this.events = [];
}
}

if (savedDays) {
try {
this.tripDays = JSON.parse(savedDays);
} catch (e) {
console.error('æ—¥ç¨‹ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
this.tripDays = [];
}
}

// ãƒ¬ã‚¤ãƒ¤ãƒ¼é †åºã®èª­ã¿è¾¼ã¿
this.loadLayerOrder();
}
},
mounted() {
this.detectMobile();
this.checkExistingData();
this.loadData();
if (this.tripDays.length > 0) {
this.tripInitialized = true;
// å¤©æ°—äºˆå ±ã‚’èª­ã¿è¾¼ã‚€
this.loadWeatherForAllEvents();
}
window.addEventListener('resize', this.detectMobile);
window.app = this;
}
}).mount('#app');
</script>
</body>
</html>

