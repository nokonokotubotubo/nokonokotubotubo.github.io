<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI RSS „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</title>
    
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
          --primary-light: #E0F7FF;
          --primary-medium: #B8E6FF;
          --primary-dark: #87CEEB;
          --primary-accent: #5BA8C4;
          --background-gradient: linear-gradient(135deg, #E0F7FF 0%, #F0FBFF 100%);
          --card-shadow: 0 4px 20px rgba(91, 168, 196, 0.12);
          --card-shadow-hover: 0 8px 30px rgba(91, 168, 196, 0.2);
          --text-primary: #2C3E50;
          --text-secondary: #5A6C7D;
          --text-light: #8FA0B3;
          --border-color: #E8F4F8;
          --border-hover: #B8E6FF;
          --interested-color: #10B981;
          --neutral-color: #F59E0B;
          --not-interested-color: #EF4444;
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Noto Sans JP', sans-serif;
          background: var(--background-gradient);
          color: var(--text-primary);
          line-height: 1.7;
          min-height: 100vh;
        }

        .loading {
          text-align: center;
          padding: 4rem;
          font-size: 1.5rem;
          color: var(--primary-accent);
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.6; }
        }

        .header {
          background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-accent) 100%);
          padding: 2rem;
          text-align: center;
          margin-bottom: 3rem;
          box-shadow: 0 4px 20px rgba(91, 168, 196, 0.2);
        }

        .header h1 {
          color: #fff;
          font-size: 3.5rem;
          font-weight: 900;
          margin-bottom: 1rem;
          text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          animation: slideInDown 0.8s ease;
        }

        .header p {
          color: rgba(255, 255, 255, 0.95);
          font-size: 1.3rem;
          margin-bottom: 1rem;
        }

        .header-stats {
          display: flex;
          justify-content: center;
          gap: 2rem;
          color: rgba(255, 255, 255, 0.8);
          font-size: 0.9rem;
          animation: fadeIn 1s ease 0.5s both;
        }

        @keyframes slideInDown {
          from { transform: translateY(-50px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

        .stats-section {
          max-width: 1200px;
          margin: 0 auto 3rem;
          padding: 0 2rem;
          position: relative;
        }

        /* ‚úÖ 1. „Ç´„ÉÜ„Ç¥„É™„Éº„Éó„É´„ÉÄ„Ç¶„É≥„Çí„Éò„ÉÉ„ÉÄ„Éº„ÅÆ‰∏ã„Å´ÈÖçÁΩÆ */
        .category-filter-wrapper {
          position: absolute;
          top: 1rem;
          left: 2rem;
          z-index: 10;
        }

        .category-filter {
          padding: 0.8rem 1.2rem;
          border: 2px solid var(--border-color);
          border-radius: 8px;
          background: linear-gradient(135deg, #fff 0%, #F8FDFF 100%);
          color: var(--text-secondary);
          font-size: 0.9rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: var(--card-shadow);
        }

        .category-filter:hover {
          border-color: var(--border-hover);
          transform: translateY(-2px);
        }

        .stats-tabs {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 1.5rem;
          margin-top: 4rem; /* „Ç´„ÉÜ„Ç¥„É™„Éº„Éï„Ç£„É´„Çø„ÉºÂàÜ„ÅÆ„Çπ„Éö„Éº„ÇπÁ¢∫‰øù */
        }

        .stat-tab-card {
          background: linear-gradient(135deg, #fff 0%, #F8FDFF 100%);
          border: 2px solid var(--border-color);
          border-radius: 20px;
          padding: 2rem;
          text-align: center;
          box-shadow: var(--card-shadow);
          transition: all 0.4s ease;
          position: relative;
          overflow: hidden;
          cursor: pointer;
          user-select: none;
        }

        .stat-tab-card:hover {
          transform: translateY(-8px) scale(1.02);
          box-shadow: var(--card-shadow-hover);
          border-color: var(--border-hover);
        }

        .stat-tab-card.active {
          background: linear-gradient(135deg, var(--primary-accent) 0%, var(--primary-dark) 100%);
          border-color: var(--primary-accent);
          color: #fff;
          transform: translateY(-8px) scale(1.05);
        }

        .stat-tab-card.interested.active {
          background: linear-gradient(135deg, var(--interested-color), #059669);
        }

        .stat-tab-card.neutral.active {
          background: linear-gradient(135deg, var(--neutral-color), #D97706);
        }

        .stat-tab-card.not-interested.active {
          background: linear-gradient(135deg, var(--not-interested-color), #DC2626);
        }

        .stat-number {
          font-size: 3rem;
          font-weight: 900;
          margin-bottom: 0.5rem;
          transition: all 0.3s ease;
        }

        .stat-label {
          font-size: 1rem;
          font-weight: 600;
          transition: all 0.3s ease;
        }

        .articles-container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 2rem;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
          gap: 2rem;
        }

        .hidden {
          display: none;
        }

        .articles-container.show-animation {
          animation: slideInUp 0.6s ease;
        }

        .article-card.show-animation {
          animation: fadeInScale 0.6s ease;
        }

        @keyframes slideInUp {
          from { transform: translateY(50px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInScale {
          from { transform: scale(0.9); opacity: 0; }
          to { transform: scale(1); opacity: 1; }
        }

        .article-card {
          background: linear-gradient(135deg, #fff 0%, #F8FDFF 100%);
          border: 2px solid var(--border-color);
          border-radius: 24px;
          overflow: hidden;
          transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
          position: relative;
          box-shadow: var(--card-shadow);
        }

        .article-card:hover {
          border-color: var(--border-hover);
          transform: translateY(-8px) scale(1.02);
          box-shadow: var(--card-shadow-hover);
        }

        .article-card.interested {
          border-left: 4px solid var(--interested-color);
        }

        .article-card.neutral {
          border-left: 4px solid var(--neutral-color);
        }

        .article-card.not-interested {
          border-left: 4px solid var(--not-interested-color);
        }

        .article-card.moving-out {
          animation: cardMoveOut 0.5s ease-in-out forwards;
        }

        .article-card.moving-in {
          animation: cardMoveIn 0.5s ease-in-out forwards;
        }

        @keyframes cardMoveOut {
          0% { transform: scale(1); opacity: 1; }
          100% { transform: scale(0.8); opacity: 0; }
        }

        @keyframes cardMoveIn {
          0% { transform: scale(0.8); opacity: 0; }
          100% { transform: scale(1); opacity: 1; }
        }

        .article-card.light-scale {
          animation: lightScale 0.2s ease;
        }

        @keyframes lightScale {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.01); }
        }

        .category-highlight {
          animation: categoryPulse 1s ease-in-out;
        }

        @keyframes categoryPulse {
          0%, 100% { transform: scale(1); }
          50% { transform: scale(1.05); box-shadow: 0 12px 40px rgba(91, 168, 196, 0.4); }
        }

        .article-content {
          padding: 2.5rem;
        }

        .article-title {
          font-size: 1.4rem;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: 1rem;
          line-height: 1.4;
          cursor: pointer;
          transition: color 0.3s ease;
        }

        .article-title:hover {
          color: var(--primary-accent);
        }

        .article-meta {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 1.5rem;
          flex-wrap: wrap;
        }

        .preference-badge {
          padding: 0.5rem 1rem;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 700;
          color: #fff;
          transition: all 0.3s ease;
        }

        .badge-interested {
          background: linear-gradient(135deg, var(--interested-color), #059669);
        }

        .badge-neutral {
          background: linear-gradient(135deg, var(--neutral-color), #D97706);
        }

        .badge-not-interested {
          background: linear-gradient(135deg, var(--not-interested-color), #DC2626);
        }

        .article-info {
          font-size: 0.9rem;
          color: var(--text-light);
          font-weight: 500;
        }

        .article-description {
          color: var(--text-secondary);
          font-size: 1rem;
          line-height: 1.8;
          margin-bottom: 2rem;
        }

        .rating-section {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding-top: 1.5rem;
          border-top: 2px solid var(--border-color);
        }

        .rating-stars {
          display: flex;
          gap: 0.5rem;
        }

        .star {
          cursor: pointer;
          font-size: 1.8rem;
          color: #E5E7EB;
          transition: all 0.3s ease;
          user-select: none;
        }

        .star.filled {
          color: #FBBF24;
          transform: scale(1.1);
          filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.4));
        }

        .star:hover {
          color: #FBBF24;
          transform: scale(1.2);
        }

        .rating-label {
          font-size: 0.9rem;
          color: var(--text-light);
          font-weight: 600;
        }

        .user-rated-mark {
          position: absolute;
          top: 10px;
          right: 10px;
          background: var(--interested-color);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 0.7rem;
          font-weight: bold;
          box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .rating-feedback {
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--interested-color);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
          z-index: 1000;
          animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }

        .particle-effect {
          position: absolute;
          width: 6px;
          height: 6px;
          border-radius: 50%;
          pointer-events: none;
          z-index: 1000;
        }

        .scroll-to-top {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, var(--primary-accent) 0%, var(--primary-dark) 100%);
          border: none;
          border-radius: 50%;
          color: white;
          font-size: 24px;
          cursor: pointer;
          box-shadow: 0 4px 20px rgba(91, 168, 196, 0.3);
          transition: all 0.3s ease;
          z-index: 1000;
          opacity: 0;
          visibility: hidden;
        }

        .scroll-to-top.visible {
          opacity: 1;
          visibility: visible;
        }

        .scroll-to-top:hover {
          transform: translateY(-5px) scale(1.1);
          box-shadow: 0 8px 30px rgba(91, 168, 196, 0.4);
        }

        @media (max-width: 1024px) {
          .stats-tabs {
            grid-template-columns: repeat(2, 1fr);
          }
          .articles-container {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          }
        }

        @media (max-width: 768px) {
          .header h1 {
            font-size: 2.8rem;
          }
          .header-stats {
            flex-direction: column;
            gap: 0.5rem;
          }
          .stats-tabs {
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 2rem;
          }
          .articles-container {
            grid-template-columns: 1fr;
            padding: 0 1rem;
          }
          .stats-section {
            padding: 0 1rem;
          }
          .category-filter-wrapper {
            position: relative;
            left: 0;
            top: 0;
            margin-bottom: 1rem;
          }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        ü§ñ ÊúÄÊñ∞„ÅÆAIÂàÜÊûê„Éã„É•„Éº„Çπ„ÇíË™≠„ÅøËæº„Åø‰∏≠...
    </div>
    
    <div id="dashboard-container" style="display: none;"></div>

    <script>
        let currentData = null;
        let currentTab = 'all';
        let currentCategory = 'all';
        
        const USER_RATING_EXPIRY_DAYS = 30;

        async function loadLatestData() {
            try {
                const cacheBuster = Date.now();
                const response = await fetch(`./data/articles.json?v=${cacheBuster}`, {
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                const data = await response.json();
                console.log('‚úÖ „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', data.articles.length + '‰ª∂');
                
                const articlesWithUserPreferences = applyUserPreferencesToFeed(data.articles);
                
                currentData = {
                    ...data,
                    articles: articlesWithUserPreferences
                };
                
                renderDashboard(currentData);
                
            } catch (error) {
                console.error('‚ùå „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
                document.getElementById('loading').innerHTML = '‚ö†Ô∏è „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü<br><button onclick="loadLatestData()">üîÑ ÂÜçË©¶Ë°å</button>';
            }
        }

        function applyUserPreferencesToFeed(articles) {
            const userFeedback = getUserFeedbackWithinExpiry();
            
            return articles.map(article => {
                const userRating = userFeedback[article.id];
                
                if (userRating && userRating.rating) {
                    const newPreference = calculatePreferenceFromRating(userRating.rating);
                    
                    return {
                        ...article,
                        preference: newPreference,
                        userRating: userRating.rating,
                        userOverride: true,
                        lastRatedAt: userRating.timestamp
                    };
                }
                
                return article;
            });
        }

        function getUserFeedbackWithinExpiry() {
            const allFeedback = JSON.parse(localStorage.getItem('ai-rss-feedback') || '{}');
            const currentTime = new Date().getTime();
            const expiryTime = USER_RATING_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
            
            const validFeedback = {};
            let expiredCount = 0;
            
            Object.keys(allFeedback).forEach(articleId => {
                const feedback = allFeedback[articleId];
                const feedbackTime = new Date(feedback.timestamp).getTime();
                
                if (currentTime - feedbackTime < expiryTime) {
                    validFeedback[articleId] = feedback;
                } else {
                    expiredCount++;
                }
            });
            
            if (expiredCount > 0) {
                localStorage.setItem('ai-rss-feedback', JSON.stringify(validFeedback));
            }
            
            return validFeedback;
        }

        function calculatePreferenceFromRating(rating) {
            if (rating >= 4) return 'interested';
            if (rating <= 2) return 'not-interested';
            return 'neutral';
        }

        function getCurrentPreference(articleId) {
            if (currentData && currentData.articles) {
                const article = currentData.articles.find(a => a.id === articleId);
                if (article) {
                    return article.preference;
                }
            }
            
            const articleCard = document.querySelector(`[data-article-id="${articleId}"]`);
            if (articleCard) {
                if (articleCard.classList.contains('interested')) return 'interested';
                if (articleCard.classList.contains('neutral')) return 'neutral';
                if (articleCard.classList.contains('not-interested')) return 'not-interested';
            }
            
            return 'neutral';
        }

        function updateUserRatingMark(articleId, rating) {
            const cards = document.querySelectorAll(`[data-article-id="${articleId}"]`);
            
            cards.forEach(card => {
                let userMark = card.querySelector('.user-rated-mark');
                if (!userMark) {
                    userMark = document.createElement('span');
                    userMark.className = 'user-rated-mark';
                    userMark.textContent = '‚úì „É¶„Éº„Ç∂„ÉºË©ï‰æ°';
                    card.appendChild(userMark);
                }
                
                let ratingInfo = card.querySelector('.article-info[data-rating]');
                if (!ratingInfo) {
                    const metaDiv = card.querySelector('.article-meta');
                    ratingInfo = document.createElement('span');
                    ratingInfo.className = 'article-info';
                    ratingInfo.setAttribute('data-rating', 'true');
                    metaDiv.appendChild(ratingInfo);
                }
                ratingInfo.textContent = `‚≠ê ${rating}/5Ôºà${USER_RATING_EXPIRY_DAYS}Êó•Èñì‰øùÊåÅÔºâ`;
                
                card.classList.add('light-scale');
                setTimeout(() => {
                    card.classList.remove('light-scale');
                }, 200);
            });
        }

        function setRating(articleId, rating) {
            let userFeedback = JSON.parse(localStorage.getItem('ai-rss-feedback') || '{}');
            
            if (!userFeedback[articleId]) {
                userFeedback[articleId] = {};
            }
            
            const currentPreference = getCurrentPreference(articleId);
            const newPreference = calculatePreferenceFromRating(rating);
            
            const article = currentData.articles.find(a => a.id === articleId);
            
            userFeedback[articleId] = {
                rating: rating,
                timestamp: new Date().toISOString(),
                title: article ? article.title : '',
                category: article ? article.category : '',
                feedName: article ? article.feedName : '',
                expiresAt: new Date(Date.now() + (USER_RATING_EXPIRY_DAYS * 24 * 60 * 60 * 1000)).toISOString()
            };
            
            localStorage.setItem('ai-rss-feedback', JSON.stringify(userFeedback));
            
            const stars = document.querySelectorAll(`[data-article-id="${articleId}"] .star`);
            stars.forEach((star, index) => {
                star.classList.toggle('filled', index < rating);
            });
            
            if (currentPreference === newPreference) {
                updateUserRatingMark(articleId, rating);
                showFeedbackMessage(`Ë©ï‰æ°„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºà${rating}/5Ôºâ`);
                return;
            }
            
            if (currentData && currentData.articles) {
                const articleIndex = currentData.articles.findIndex(a => a.id === articleId);
                if (articleIndex !== -1) {
                    currentData.articles[articleIndex].preference = newPreference;
                    currentData.articles[articleIndex].userRating = rating;
                    currentData.articles[articleIndex].userOverride = true;
                }
            }
            
            moveArticleToNewCategory(articleId, currentPreference, newPreference, rating);
            updateTabCountsFromCurrentData();
            
            showCategoryChangeAnimation(articleId, newPreference);
            showFeedbackMessage(`Ë©ï‰æ°„Çí‰øùÂ≠ò„Åó„ÄÅ„Äå${getPreferenceName(newPreference)}„Äç„Å´ÁßªÂãï„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        function moveArticleToNewCategory(articleId, oldPreference, newPreference, rating) {
            const articleCard = document.querySelector(`[data-article-id="${articleId}"]`);
            if (!articleCard) return;
            
            updateArticlePreferenceVisual(articleCard, newPreference, rating);
            
            const updatedCard = articleCard.cloneNode(true);
            
            const allContainer = document.getElementById('articles-all');
            const interestedContainer = document.getElementById('articles-interested');
            const neutralContainer = document.getElementById('articles-neutral');
            const notInterestedContainer = document.getElementById('articles-not-interested');
            
            [allContainer, interestedContainer, neutralContainer, notInterestedContainer].forEach(container => {
                const existingCard = container.querySelector(`[data-article-id="${articleId}"]`);
                if (existingCard) {
                    existingCard.classList.add('moving-out');
                    setTimeout(() => {
                        if (existingCard.parentNode) {
                            existingCard.remove();
                        }
                    }, 500);
                }
            });
            
            setTimeout(() => {
                const allCardClone = updatedCard.cloneNode(true);
                setupCardEventListeners(allCardClone);
                allCardClone.classList.add('moving-in');
                allContainer.appendChild(allCardClone);
                
                let targetContainer;
                if (newPreference === 'interested') {
                    targetContainer = interestedContainer;
                } else if (newPreference === 'neutral') {
                    targetContainer = neutralContainer;
                } else {
                    targetContainer = notInterestedContainer;
                }
                
                if (targetContainer) {
                    const categoryCardClone = updatedCard.cloneNode(true);
                    setupCardEventListeners(categoryCardClone);
                    categoryCardClone.classList.add('moving-in');
                    targetContainer.appendChild(categoryCardClone);
                }
            }, 600);
            
            setTimeout(() => {
                highlightCategoryTab(newPreference);
            }, 800);
        }

        function updateArticlePreferenceVisual(card, newPreference, rating) {
            const preferenceSpan = card.querySelector('.preference-badge');
            
            card.classList.remove('interested', 'neutral', 'not-interested');
            preferenceSpan.classList.remove('badge-interested', 'badge-neutral', 'badge-not-interested');
            
            card.classList.add(newPreference);
            preferenceSpan.classList.add(`badge-${newPreference}`);
            
            let userMark = card.querySelector('.user-rated-mark');
            if (!userMark) {
                userMark = document.createElement('span');
                userMark.className = 'user-rated-mark';
                userMark.textContent = '‚úì „É¶„Éº„Ç∂„ÉºË©ï‰æ°';
                card.appendChild(userMark);
            }
            
            if (newPreference === 'interested') {
                preferenceSpan.textContent = 'üòç ËààÂë≥„ÅÇ„Çä„Åù„ÅÜÔºà„É¶„Éº„Ç∂„ÉºË©ï‰æ°Ôºâ';
            } else if (newPreference === 'neutral') {
                preferenceSpan.textContent = 'üòê ÊôÆÈÄöÔºà„É¶„Éº„Ç∂„ÉºË©ï‰æ°Ôºâ';
            } else {
                preferenceSpan.textContent = 'üòï ËààÂë≥„Å™„Åï„Åù„ÅÜÔºà„É¶„Éº„Ç∂„ÉºË©ï‰æ°Ôºâ';
            }
            
            let ratingInfo = card.querySelector('.article-info[data-rating]');
            if (!ratingInfo) {
                const metaDiv = card.querySelector('.article-meta');
                ratingInfo = document.createElement('span');
                ratingInfo.className = 'article-info';
                ratingInfo.setAttribute('data-rating', 'true');
                metaDiv.appendChild(ratingInfo);
            }
            ratingInfo.textContent = `‚≠ê ${rating}/5Ôºà${USER_RATING_EXPIRY_DAYS}Êó•Èñì‰øùÊåÅÔºâ`;
        }

        function setupCardEventListeners(card) {
            const stars = card.querySelectorAll('.star');
            stars.forEach(star => {
                const articleId = card.dataset.articleId;
                const rating = star.dataset.rating;
                star.onclick = () => setRating(articleId, parseInt(rating));
            });
            
            const title = card.querySelector('.article-title');
            if (title) {
                const onclickAttr = title.getAttribute('onclick');
                if (onclickAttr) {
                    const link = onclickAttr.match(/'([^']+)'/)[1];
                    title.onclick = () => window.open(link, '_blank');
                }
            }
        }

        function highlightCategoryTab(preference) {
            const targetTab = document.querySelector(`[data-tab="${preference}"]`);
            if (targetTab) {
                targetTab.classList.add('category-highlight');
                
                setTimeout(() => {
                    targetTab.classList.remove('category-highlight');
                }, 1000);
            }
        }

        function showCategoryChangeAnimation(articleId, newPreference) {
            const card = document.querySelector(`[data-article-id="${articleId}"]`);
            if (!card) return;
            
            const colors = {
                'interested': '#10B981',
                'neutral': '#F59E0B',
                'not-interested': '#EF4444'
            };
            
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle-effect';
                particle.style.background = colors[newPreference];
                
                const rect = card.getBoundingClientRect();
                particle.style.left = (rect.left + rect.width / 2) + 'px';
                particle.style.top = (rect.top + rect.height / 2) + 'px';
                
                document.body.appendChild(particle);
                
                const angle = (i * 72) * Math.PI / 180;
                const distance = 100;
                
                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { 
                        transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0)`, 
                        opacity: 0 
                    }
                ], {
                    duration: 800,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        function getPreferenceName(preference) {
            const names = {
                'interested': 'ËààÂë≥„ÅÇ„Çä„Åù„ÅÜ',
                'neutral': 'ÊôÆÈÄö',
                'not-interested': 'ËààÂë≥„Å™„Åï„Åù„ÅÜ'
            };
            return names[preference] || preference;
        }

        function updateTabCountsFromCurrentData() {
            if (!currentData || !currentData.articles) return;
            
            const articlesByPreference = {
                interested: currentData.articles.filter(a => a.preference === 'interested'),
                neutral: currentData.articles.filter(a => a.preference === 'neutral'),
                'not-interested': currentData.articles.filter(a => a.preference === 'not-interested'),
                all: currentData.articles
            };
            
            Object.keys(articlesByPreference).forEach(category => {
                const tabCard = document.querySelector(`[data-tab="${category}"]`);
                if (tabCard) {
                    const numberElement = tabCard.querySelector('.stat-number');
                    numberElement.textContent = articlesByPreference[category].length;
                }
            });
        }

        // ‚úÖ 2. ÂÖ®„Çø„Éñ„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÉºÂàá„ÇäÊõø„ÅàÊôÇ„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
        function updateAllTabCountsForCategory() {
            if (!currentData || !currentData.articles) return;

            if (currentCategory === 'all') {
                // ÂÖ®„Ç´„ÉÜ„Ç¥„É™Ë°®Á§∫ÊôÇ„ÅØÂÖÉ„ÅÆÊï∞„Å´Êàª„Åô
                updateTabCountsFromCurrentData();
            } else {
                // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®ÊôÇ„ÅØÂêÑ„Çø„Éñ„ÅÆË©≤ÂΩì„Ç´„ÉÜ„Ç¥„É™Ë®ò‰∫ãÊï∞„ÇíË®àÁÆó
                const filteredArticlesByPreference = {
                    interested: currentData.articles.filter(a => a.preference === 'interested' && a.category === currentCategory),
                    neutral: currentData.articles.filter(a => a.preference === 'neutral' && a.category === currentCategory),
                    'not-interested': currentData.articles.filter(a => a.preference === 'not-interested' && a.category === currentCategory),
                    all: currentData.articles.filter(a => a.category === currentCategory)
                };

                // ÂêÑ„Çø„Éñ„ÅÆÊï∞„ÇíÊõ¥Êñ∞
                Object.keys(filteredArticlesByPreference).forEach(preference => {
                    const tabCard = document.querySelector(`[data-tab="${preference}"]`);
                    if (tabCard) {
                        const numberElement = tabCard.querySelector('.stat-number');
                        numberElement.textContent = filteredArticlesByPreference[preference].length;
                    }
                });
            }
        }
        
        function renderDashboard(data) {
            const articles = data.articles;
            const updateTime = new Date(data.timestamp).toLocaleString('ja-JP');
            const categories = [...new Set(articles.map(article => article.category))];
            
            const articlesByPreference = {
                interested: articles.filter(a => a.preference === 'interested'),
                neutral: articles.filter(a => a.preference === 'neutral'),
                'not-interested': articles.filter(a => a.preference === 'not-interested')
            };
            
            const userRatedCount = articles.filter(a => a.userOverride).length;
            
            const html = `
            <header class="header">
                <h1>ü§ñ AI RSS „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</h1>
                <p>AI„ÅåÂé≥ÈÅ∏„Åó„Åü„ÅÇ„Å™„ÅüÂ•Ω„Åø„ÅÆ„Éã„É•„Éº„Çπ„Çí„ÅäÂ±ä„Åë</p>
                <div class="header-stats">
                    <span>ÊúÄÁµÇÊõ¥Êñ∞: ${updateTime}</span>
                    <span>Á∑èË®ò‰∫ãÊï∞: ${articles.length}‰ª∂</span>
                    <span>„É¶„Éº„Ç∂„ÉºË©ï‰æ°Ê∏à„Åø: ${userRatedCount}‰ª∂</span>
                    <span>üîÑ „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞</span>
                </div>
            </header>

            <div class="stats-section">
                <div class="category-filter-wrapper">
                    <select id="categoryFilter" class="category-filter">
                        <option value="all">üìÇ „Åô„Åπ„Å¶Ë°®Á§∫</option>
                        ${categories.map(cat => `<option value="${cat}">üè∑Ô∏è ${cat}</option>`).join('')}
                    </select>
                </div>

                <div class="stats-tabs">
                    <div class="stat-tab-card interested ${currentTab === 'interested' ? 'active' : ''}" data-tab="interested">
                        <div class="stat-number">${articlesByPreference.interested.length}</div>
                        <div class="stat-label">üòç ËààÂë≥„ÅÇ„Çä„Åù„ÅÜ</div>
                    </div>
                    <div class="stat-tab-card neutral ${currentTab === 'neutral' ? 'active' : ''}" data-tab="neutral">
                        <div class="stat-number">${articlesByPreference.neutral.length}</div>
                        <div class="stat-label">üòê ÊôÆÈÄö</div>
                    </div>
                    <div class="stat-tab-card not-interested ${currentTab === 'not-interested' ? 'active' : ''}" data-tab="not-interested">
                        <div class="stat-number">${articlesByPreference['not-interested'].length}</div>
                        <div class="stat-label">üòï ËààÂë≥„Å™„Åï„Åù„ÅÜ</div>
                    </div>
                    <div class="stat-tab-card all ${currentTab === 'all' ? 'active' : ''}" data-tab="all">
                        <div class="stat-number">${articles.length}</div>
                        <div class="stat-label">üìÑ Á∑èË®ò‰∫ãÊï∞</div>
                    </div>
                </div>
            </div>

            <div id="articles-all" class="articles-container ${currentTab === 'all' ? '' : 'hidden'}">
                ${articles.map(article => generateArticleCard(article)).join('')}
            </div>

            <div id="articles-interested" class="articles-container ${currentTab === 'interested' ? '' : 'hidden'}">
                ${articlesByPreference.interested.map(article => generateArticleCard(article)).join('')}
            </div>

            <div id="articles-neutral" class="articles-container ${currentTab === 'neutral' ? '' : 'hidden'}">
                ${articlesByPreference.neutral.map(article => generateArticleCard(article)).join('')}
            </div>

            <div id="articles-not-interested" class="articles-container ${currentTab === 'not-interested' ? '' : 'hidden'}">
                ${articlesByPreference['not-interested'].map(article => generateArticleCard(article)).join('')}
            </div>`;
            
            document.getElementById('dashboard-container').innerHTML = html;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            
            setupEventListeners();
            restoreUserRatings();
            setupScrollToTop();
        }
        
        function generateArticleCard(article) {
            const publishDate = new Date(article.pubDate).toLocaleDateString('ja-JP');
            const relativeTime = getRelativeTime(article.pubDate);
            const userRating = article.userRating || 0;
            const isUserRated = article.userOverride || false;
            
            return `
            <div class="article-card ${article.preference}" data-category="${article.category}" data-article-id="${article.id}">
                ${isUserRated ? '<span class="user-rated-mark">‚úì „É¶„Éº„Ç∂„ÉºË©ï‰æ°</span>' : ''}
                <div class="article-content">
                    <h2 class="article-title" onclick="window.open('${article.link}', '_blank')" title="${article.title}">
                        ${article.title}
                    </h2>
                    <div class="article-meta">
                        <span class="preference-badge badge-${article.preference}">
                            ${article.preference === 'interested' ? 'üòç ËààÂë≥„ÅÇ„Çä„Åù„ÅÜ' : 
                              article.preference === 'neutral' ? 'üòê ÊôÆÈÄö' : 'üòï ËààÂë≥„Å™„Åï„Åù„ÅÜ'}${isUserRated ? 'Ôºà„É¶„Éº„Ç∂„ÉºË©ï‰æ°Ôºâ' : ''}
                        </span>
                        <span class="article-info">üìÖ ${publishDate}</span>
                        <span class="article-info">‚è∞ ${relativeTime}</span>
                        <span class="article-info">üì∞ ${article.feedName}</span>
                        <span class="article-info">üè∑Ô∏è ${article.category}</span>
                        ${isUserRated ? `<span class="article-info" data-rating="true">‚≠ê ${userRating}/5Ôºà${USER_RATING_EXPIRY_DAYS}Êó•Èñì‰øùÊåÅÔºâ</span>` : ''}
                    </div>
                    <div class="article-description">
                        ${article.description.substring(0, 200)}${article.description.length > 200 ? '...' : ''}
                    </div>
                    <div class="rating-section">
                        <div class="rating-stars">
                            ${[1,2,3,4,5].map(rating => 
                                `<span class="star ${rating <= userRating ? 'filled' : ''}" 
                                      data-rating="${rating}" 
                                      onclick="setRating('${article.id}', ${rating})" 
                                      title="${rating}„Å§Êòü">‚≠ê</span>`
                            ).join('')}
                        </div>
                        <div class="rating-label">„Åì„ÅÆË®ò‰∫ã„ÇíË©ï‰æ°</div>
                    </div>
                </div>
            </div>`;
        }

        function getRelativeTime(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) return '1ÊôÇÈñìÊú™Ê∫ÄÂâç';
            if (diffHours < 24) return `${diffHours}ÊôÇÈñìÂâç`;
            if (diffDays < 7) return `${diffDays}Êó•Ââç`;
            return '1ÈÄ±Èñì‰ª•‰∏äÂâç';
        }
        
        function getUserRating(articleId) {
            const feedback = getUserFeedbackWithinExpiry();
            return feedback[articleId]?.rating || 0;
        }

        function showFeedbackMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.className = 'rating-feedback';
            
            document.body.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function setupScrollToTop() {
            const existingButton = document.querySelector('.scroll-to-top');
            if (existingButton) {
                existingButton.remove();
            }

            const scrollButton = document.createElement('button');
            scrollButton.className = 'scroll-to-top';
            scrollButton.innerHTML = '‚Üë';
            scrollButton.title = '1Áï™‰∏ä„Å´Êàª„Çã';
            document.body.appendChild(scrollButton);

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    scrollButton.classList.add('visible');
                } else {
                    scrollButton.classList.remove('visible');
                }
            });

            scrollButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.stat-tab-card').forEach(card => {
                card.addEventListener('click', () => {
                    const tabType = card.dataset.tab;
                    switchTab(tabType);
                });
            });

            document.getElementById('categoryFilter').addEventListener('change', (e) => {
                currentCategory = e.target.value;
                applyFilters();
            });
        }

        function switchTab(tabType) {
            currentTab = tabType;
            
            document.querySelectorAll('.articles-container').forEach(container => {
                container.classList.add('hidden');
                container.classList.remove('show-animation');
            });
            
            const targetContainer = document.getElementById('articles-' + tabType);
            if (targetContainer) {
                targetContainer.classList.remove('hidden');
                targetContainer.classList.add('show-animation');
                targetContainer.querySelectorAll('.article-card').forEach(card => {
                    card.classList.add('show-animation');
                });
            }
            
            document.querySelectorAll('.stat-tab-card').forEach(card => {
                card.classList.remove('active');
            });
            
            const activeCard = document.querySelector(`[data-tab="${tabType}"]`);
            if (activeCard) {
                activeCard.classList.add('active');
            }

            applyFilters();
        }

        function applyFilters() {
            const activeContainer = document.querySelector('.articles-container:not(.hidden)');
            if (!activeContainer) return;

            let visibleCount = 0;
            activeContainer.querySelectorAll('.article-card').forEach(card => {
                const category = card.dataset.category;
                if (currentCategory === 'all' || category === currentCategory) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // ‚úÖ ÂÖ®„Çø„Éñ„ÅÆË®ò‰∫ãÊï∞„ÇíÊõ¥Êñ∞
            updateAllTabCountsForCategory();
        }
        
        function restoreUserRatings() {
            const userFeedback = getUserFeedbackWithinExpiry();
            Object.keys(userFeedback).forEach(articleId => {
                const feedback = userFeedback[articleId];
                if (feedback.rating) {
                    const stars = document.querySelectorAll(`[data-article-id="${articleId}"] .star`);
                    stars.forEach((star, index) => {
                        star.classList.toggle('filled', index < feedback.rating);
                    });
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', loadLatestData);
        setInterval(loadLatestData, 300000);

        document.addEventListener("visibilitychange", function() {
            if (!document.hidden) {
                loadLatestData();
            }
        });
    </script>
</body>
</html>
