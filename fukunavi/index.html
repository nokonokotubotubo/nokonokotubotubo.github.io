<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>とりっぺんちゃん - 旅行予定調整サイト</title>

<!-- 外部ライブラリ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
/* ========= 既存スタイル ========= */
:root{--primary:#87CEEB;--secondary:#B0E0E6;--accent:#4682B4;--text:#2F4F4F;--bg:#F0F8FF;--time-bg:#E6F3FF;--transition:all 0.3s ease;--radius:15px;--shadow:0 2px 10px rgba(0,0,0,0.1)}
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;display:flex;flex-direction:column}
/* （中略：省略無し。既存の CSS は全て保持） */

/* ========= 追加：天気絵文字アイコン ========= */
.weather-emoji-icon{
    position:absolute;
    top:2px;
    left:4px;
    font-size:1.25em;
    cursor:pointer;
    z-index:20;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,0.25));
    transition:transform 0.2s ease;
}
.weather-emoji-icon:hover{transform:scale(1.15)}
@media(max-width:768px){
  .weather-emoji-icon{font-size:1.1em;top:1px;left:2px}
}

/* ========= 追加：天気ポップアップ ========= */
.weather-popup-modal{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,0.75);backdrop-filter:blur(2px);z-index:4000;
}
.weather-popup-content{
    background:#fff;border-radius:16px;max-width:95vw;max-height:90vh;
    width:950px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.35);
}
@media(max-width:768px){
  .weather-popup-content{width:95vw;height:88vh}
}
.weather-popup-header{
    background:linear-gradient(135deg,#66a3ff,#0059b3);color:#fff;padding:14px 18px;
    display:flex;justify-content:space-between;align-items:center;flex-shrink:0
}
.weather-popup-header h5{margin:0;font-size:1.05em;font-weight:bold}
.weather-popup-close{
    background:none;border:none;color:#fff;font-size:1.45rem;width:34px;height:34px;
    display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;
    transition:background 0.25s
}
.weather-popup-close:hover{background:rgba(255,255,255,0.25)}
.weather-popup-body{padding:18px;display:flex;flex-direction:column;flex:1;overflow:hidden}
.weather-popup-info{
  background:#f8fbff;border:1px solid #e0e9ff;border-radius:8px;padding:10px;margin-bottom:14px;flex-shrink:0
}
.weather-desktop-table,.weather-mobile-table{flex:1;overflow:hidden;display:flex;flex-direction:column}
.weather-table-container{flex:1;overflow:auto;border:1px solid #e0e9ff;border-radius:8px}
.weather-table{width:100%;border-collapse:collapse;font-size:14px;table-layout:fixed;min-width:1380px;background:#f8fbff}
.weather-table th,.weather-table td{border:1px solid #e0e9ff;padding:12px 6px;text-align:center;vertical-align:middle}
.weather-table th{background:linear-gradient(135deg,#f0f8ff,#e6f2ff);font-weight:bold;position:sticky;top:0;z-index:10}
.weather-row-header{background:linear-gradient(135deg,#f0f8ff,#e6f2ff);font-weight:bold;position:sticky;left:0;z-index:11}
@media(max-width:768px){
  .weather-table{font-size:11px;min-width:100%}
  .weather-table th,.weather-table td{padding:8px 4px}
}

/* 共有ユーティリティ */
.weather-emoji{font-size:1.8em;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.15))}
.progress-container{background:#e6f2ff;border-radius:6px;width:100%;height:12px;margin:2px 0;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(135deg,#3385ff,#0059b3);border-radius:6px;transition:width .4s ease}
.current-time-highlight{background-color:rgba(255,235,153,0.35)!important}
.hot-temperature{background:#dc2626!important;color:#fff!important;font-weight:bold}
.cold-temperature{background:#1e40af!important;color:#fff!important;font-weight:bold}
</style>
</head>
<body>
<div id="app">
  <!-- ========= ヘッダー・既存 UI（省略無し） ========= -->
  <!-- ・・・既存の header / setup などはそのまま・・・ -->

  <!-- ========= デスクトップ UI ========= -->
  <div v-if="tripInitialized && !isMobile" class="desktop-ui">

    <!-- （中略：日程タブ & タイムラインヘッダーは既存のまま） -->

    <div class="timeline-content">
      <div class="timeline-scroll-container" ref="scrollContainer">
        <div class="time-axis">
          <div class="time-slot" v-for="hour in timeSlots" :key="hour">{{ hour }}:00</div>
        </div>

        <!-- ===== スケジュールエリア ===== -->
        <div class="schedule-area" @click="editModeEvent = null" @contextmenu="handleScheduleContextMenu">
          <div class="schedule-grid">
            <div class="grid-line" v-for="hour in timeSlots" :key="hour">
              <div class="quarter-line"></div><div class="quarter-line"></div><div class="quarter-line"></div>
            </div>
          </div>

          <!-- ===== 予定ブロック（天気絵文字追加） ===== -->
          <div class="event-block"
               v-for="event in getCurrentDayEvents()" :key="event.id"
               :class="[
                 'event-category-' + event.category,
                 { 'edit-mode': editModeEvent && editModeEvent.id === event.id },
                 { 'dragging': draggingEvent && draggingEvent.id === event.id },
                 { 'ready-to-move': readyToMoveEventId === event.id }
               ]"
               :style="getEventStyle(event)"
               @contextmenu.prevent="handleEventContextMenu($event, event)"
               @click="handleEventClick($event, event)"
               @mousedown="handleEventMouseDown($event, event)">
            <div class="event-content-inline">
              <!-- ★ 天気絵文字 -->
              <span class="weather-emoji-icon" v-if="event.weatherEmoji"
                    @click.stop="openWeatherPopup(event)" :title="'天気予報を表示'">
                {{ event.weatherEmoji }}
              </span>
              <i :class="getCategoryIcon(event.category)"></i>
              {{ event.inlineText }}
            </div>

            <!-- 既存操作ボタン等（省略無し） -->
            <div class="event-actions"
                 v-if="editModeEvent && editModeEvent.id === event.id">
              <button class="event-action-btn cut"
                      @click="handleCutButtonClick($event, event)" @mousedown.stop title="切り取り">
                <i class="fas fa-cut"></i>
              </button>
            </div>
            <div class="resize-handle top"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @mousedown="startResize($event, event, 'top')"></div>
            <div class="resize-handle bottom"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @mousedown="startResize($event, event, 'bottom')"></div>
          </div>
        </div><!-- /.schedule-area -->
      </div><!-- /.timeline-scroll-container -->
    </div><!-- /.timeline-content -->
  </div><!-- /.desktop-ui -->

  <!-- ========= モバイル UI ========= -->
  <div v-if="tripInitialized && isMobile" class="mobile-ui">
    <!-- （日付セレクタなど既存 UI はそのまま） -->
    <div class="timeline-content">
      <div class="timeline-scroll-container" ref="mobileTimelineContainer">
        <div class="time-axis">
          <div class="time-slot" v-for="hour in timeSlots" :key="hour">{{ hour }}:00</div>
        </div>

        <div class="schedule-area"
             @click="editModeEvent = null"
             @touchstart="handleScheduleTouchStart"
             @touchend="handleScheduleTouchEnd"
             @touchmove="handleScheduleTouchMove">
          <div class="schedule-grid">
            <div class="grid-line" v-for="hour in timeSlots" :key="hour">
              <div class="quarter-line"></div><div class="quarter-line"></div><div class="quarter-line"></div>
            </div>
          </div>

          <!-- ===== 予定ブロック（モバイル用） ===== -->
          <div class="event-block"
               v-for="event in getCurrentDayEvents()" :key="event.id"
               :class="[
                 'event-category-' + event.category,
                 { 'edit-mode': editModeEvent && editModeEvent.id === event.id },
                 { 'dragging': draggingEvent && draggingEvent.id === event.id },
                 { 'ready-to-move': readyToMoveEventId === event.id }
               ]"
               :style="getEventStyle(event)"
               @click="handleEventClick($event, event)"
               @touchstart="handleEventTouchStart($event, event)">
            <div class="event-content-inline">
              <span class="weather-emoji-icon" v-if="event.weatherEmoji"
                    @click.stop="openWeatherPopup(event)" :title="'天気予報を表示'">
                {{ event.weatherEmoji }}
              </span>
              <i :class="getCategoryIcon(event.category)"></i>
              {{ event.inlineText }}
            </div>

            <!-- 既存操作ボタン等 -->
            <div class="event-actions"
                 v-if="editModeEvent && editModeEvent.id === event.id">
              <button class="event-action-btn cut"
                      @click="handleCutButtonClick($event, event)"
                      @touchstart.stop title="切り取り">
                <i class="fas fa-cut"></i>
              </button>
            </div>
            <div class="resize-handle top"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @touchstart="startResizeTouch($event, event, 'top')"></div>
            <div class="resize-handle bottom"
                 v-if="editModeEvent && editModeEvent.id === event.id"
                 @touchstart="startResizeTouch($event, event, 'bottom')"></div>
          </div>
        </div><!-- /.schedule-area -->
      </div><!-- /.timeline-scroll-container -->
    </div><!-- /.timeline-content -->
    <!-- FAB 等既存要素は省略無し -->
  </div><!-- /.mobile-ui -->

  <!-- ========= 天気ポップアップ ========= -->
  <div v-if="showWeatherPopup" class="weather-popup-modal" @click="closeWeatherPopup">
    <div class="weather-popup-content" @click.stop>
      <div class="weather-popup-header">
        <h5><i class="fas fa-cloud-sun"></i> {{ weatherPopupEvent?.title }} の天気予報</h5>
        <button class="weather-popup-close" @click="closeWeatherPopup">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="weather-popup-body">
        <!-- 予定概要 -->
        <div class="weather-popup-info">
          <div class="weather-event-info">
            <strong>{{ weatherPopupEvent?.title }}</strong><br>
            {{ tripDays[weatherPopupEvent?.dayIndex]?.date }} {{ weatherPopupEvent?.startTime }} - {{ weatherPopupEvent?.endTime }}
          </div>
          <div class="weather-location-info" v-if="weatherPopupEvent?.coordinates">
            <i class="fas fa-map-marker-alt"></i> {{ weatherPopupEvent?.coordinates }}
          </div>
        </div>

        <!-- デスクトップ：横スクロールテーブル -->
        <div class="weather-desktop-table" v-if="!isMobile">
          <div class="weather-table-container" ref="weatherTableContainer">
            <table class="weather-table">
              <thead>
                <tr>
                  <th class="weather-row-header">⛅ 天気</th>
                  <th v-for="hour in weatherHours" :key="hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }"
                      :id="'weather-hour-' + hour">
                    <span class="weather-emoji">{{ getWeatherIcon(fullDayWeather[hour]) }}</span><br>
                    {{ hour }}:00
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="weather-row-header"><strong>🌧️ 降水確率</strong></td>
                  <td v-for="hour in weatherHours" :key="'p'+hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }">
                    <div class="progress-container">
                      <div class="progress-bar"
                           :style="{ width: (fullDayWeather[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                    </div>
                    {{ fullDayWeather[hour]?.precipitation_probability ?? 0 }}%
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>🌡️ 気温</strong></td>
                  <td v-for="hour in weatherHours" :key="'t'+hour"
                      :class="[{ 'current-time-highlight': isEventHour(hour) }, getTemperatureClass(fullDayWeather[hour]?.temperature)]">
                    {{ fullDayWeather[hour]?.temperature ?? '-' }}℃
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>🤒 体感温度</strong></td>
                  <td v-for="hour in weatherHours" :key="'a'+hour"
                      :class="[{ 'current-time-highlight': isEventHour(hour) }, getTemperatureClass(fullDayWeather[hour]?.apparent_temperature)]">
                    {{ fullDayWeather[hour]?.apparent_temperature ?? '-' }}℃
                  </td>
                </tr>
                <tr>
                  <td class="weather-row-header"><strong>💧 湿度</strong></td>
                  <td v-for="hour in weatherHours" :key="'h'+hour"
                      :class="{ 'current-time-highlight': isEventHour(hour) }">
                    {{ fullDayWeather[hour]?.humidity ?? '-' }}%
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- モバイル：縦スクロールテーブル -->
        <div class="weather-mobile-table" v-if="isMobile">
          <div class="weather-table-container" ref="weatherMobileTableContainer">
            <table class="weather-table">
              <thead>
                <tr>
                  <th>⛅<br>天気</th>
                  <th>🌧️<br>降水確率</th>
                  <th>🌡️<br>気温</th>
                  <th>🤒<br>体感温度</th>
                  <th>💧<br>湿度</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="hour in weatherHours" :key="hour"
                    :class="{ 'current-time-highlight': isEventHour(hour) }"
                    :id="'weather-mobile-hour-' + hour">
                  <td>
                    <span class="weather-emoji">{{ getWeatherIcon(fullDayWeather[hour]) }}</span><br>
                    {{ hour }}:00
                  </td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar"
                           :style="{ width: (fullDayWeather[hour]?.precipitation_probability ?? 0) + '%' }"></div>
                    </div>
                    {{ fullDayWeather[hour]?.precipitation_probability ?? 0 }}%
                  </td>
                  <td :class="getTemperatureClass(fullDayWeather[hour]?.temperature)">
                    {{ fullDayWeather[hour]?.temperature ?? '-' }}℃
                  </td>
                  <td :class="getTemperatureClass(fullDayWeather[hour]?.apparent_temperature)">
                    {{ fullDayWeather[hour]?.apparent_temperature ?? '-' }}℃
                  </td>
                  <td>{{ fullDayWeather[hour]?.humidity ?? '-' }}%</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div><!-- /.mobile table -->
      </div><!-- /.popup-body -->
    </div><!-- /.popup-content -->
  </div><!-- /.weather-popup-modal -->

  <!-- ========= 既存モーダル類・コンテキストメニュー・その他 ========= -->
  <!-- （中略：paste.txt の下部モーダル / context-menu / map-modal など全て保持） -->
</div><!-- /#app -->

<!-- ========= JavaScript ========= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const { createApp } = Vue;
const app = createApp({
data() {
  return {
    /* ===== 既存データ ===== */
    tripInitialized:false,tripStartDate:'',tripEndDate:'',today:new Date().toISOString().split('T')[0],
    hasExistingData:false,tripDays:[],activeDay:0,showMobilePopup:false,selectedDayForPopup:null,
    selectedDayIndex:null,scrollPosition:0,maxScrollPosition:0,
    timeSlots:[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23],
    events:[],editModeEvent:null,clipboardEvent:null,showContextMenu:false,contextMenuStyle:{},
    pasteTargetTime:null,isMobile:false,touchStartTime:0,touchStartPosition:{x:0,y:0},
    longPressTimer:null,longPressExecuted:false,eventTouchOffset:{x:0,y:0},draggingEvent:null,
    isDragComplete:false,isResizeComplete:false,dragStarted:false,longPressEventData:null,
    longPressEvent:null,readyToMoveEventId:null,
    showMapModal:false,map:null,selectedCoordinates:null,mapMarker:null,
    eventForm:{title:'',dayIndex:0,startTime:'09:00',endTime:'10:00',
               category:'travel',description:'',coordinates:''},
    modals:[],

    /* ===== 追加：天気表示用 ===== */
    showWeatherPopup:false,
    weatherPopupEvent:null,
    fullDayWeather:{},
    weatherHours:[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
    weatherCache:{}
  };
},
methods:{
  /* ===== 既存メソッド（省略無し） ===== */
  /* --- 既存コードはそのまま --- */

  /* ========== 追加：天気絵文字取得 ========== */
  async fetchWeatherForEvent(event){
    if(!event.coordinates) return null;
    const [lat,lng]=event.coordinates.split(',').map(c=>parseFloat(c.trim()));
    if(isNaN(lat)||isNaN(lng)) return null;
    const dayData=this.tripDays[event.dayIndex];
    if(!dayData) return null;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat.toFixed(4)}&longitude=${lng.toFixed(4)}&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,weather_code&start_date=${dayData.fullDate}&end_date=${dayData.fullDate}&timezone=Asia/Tokyo`;
      const res=await fetch(url);
      if(!res.ok) throw new Error('天気取得失敗');
      const data=await res.json();
      const hour=parseInt(event.startTime.split(':')[0]);
      const idx=data.hourly.time.findIndex(t=>t.endsWith(`T${hour.toString().padStart(2,'0')}:00`));
      if(idx===-1) return null;
      return {
        weather_code:data.hourly.weather_code[idx],
        precipitation_probability:data.hourly.precipitation_probability[idx]??0
      };
    }catch(e){
      console.error(e);return null;
    }
  },
  getWeatherIcon(d){
    if(!d) return '☀️';
    const p=d.precipitation_probability??0,c=d.weather_code??0;
    if(p>=70) return '☔';
    if(p>=40) return '🌧️';
    if(p>=20) return '🌦️';
    const icons={0:'☀️',1:'⛅',2:'⛅',3:'⛅',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌦️',55:'🌦️',
                 61:'🌧️',63:'🌧️',65:'🌧️',71:'❄️',73:'❄️',75:'❄️',80:'🌦️',81:'🌦️',82:'🌦️',
                 95:'⛈️',96:'⛈️',99:'⛈️'};
    return icons[c]||'☀️';
  },
  getTemperatureClass(t){
    if(t===undefined||t===null) return '';
    if(t>=35) return 'hot-temperature';
    if(t<=0)  return 'cold-temperature';
    return '';
  },
  async updateWeatherEmoji(){
    for(const ev of this.events){
      if(!ev.coordinates) continue;
      const key=`${ev.coordinates}_${this.tripDays[ev.dayIndex]?.fullDate}_${ev.startTime}`;
      if(this.weatherCache[key]){
        ev.weatherEmoji=this.weatherCache[key];
        continue;
      }
      const d=await this.fetchWeatherForEvent(ev);
      if(d){
        const emoji=this.getWeatherIcon(d);
        this.$set(ev,'weatherEmoji',emoji);
        this.weatherCache[key]=emoji;
      }
    }
  },

  /* ===== ポップアップ関連 ===== */
  async openWeatherPopup(event){
    if(!event.coordinates){alert('位置情報がありません');return;}
    this.weatherPopupEvent=event;
    this.showWeatherPopup=true;
    await this.$nextTick();
    await this.fetchFullDayWeather();
    await this.scrollToEventTime();
  },
  async fetchFullDayWeather(){
    if(!this.weatherPopupEvent?.coordinates) return;
    const [lat,lng]=this.weatherPopupEvent.coordinates.split(',').map(c=>parseFloat(c.trim()));
    const dayData=this.tripDays[this.weatherPopupEvent.dayIndex];
    if(!dayData) return;
    try{
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat.toFixed(4)}&longitude=${lng.toFixed(4)}&hourly=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code&start_date=${dayData.fullDate}&end_date=${dayData.fullDate}&timezone=Asia/Tokyo`;
      const res=await fetch(url);
      if(!res.ok) throw new Error('天気取得失敗');
      const data=await res.json();
      this.fullDayWeather={};
      for(const h of this.weatherHours){
        const idx=data.hourly.time.findIndex(t=>t.endsWith(`T${h.toString().padStart(2,'0')}:00`));
        if(idx===-1) continue;
        this.fullDayWeather[h]={
          temperature:Math.round(data.hourly.temperature_2m[idx]),
          apparent_temperature:Math.round(data.hourly.apparent_temperature[idx]),
          humidity:Math.round(data.hourly.relative_humidity_2m[idx]),
          precipitation_probability:Math.round(data.hourly.precipitation_probability[idx]??0),
          weather_code:data.hourly.weather_code[idx]
        };
      }
    }catch(e){console.error(e);alert('天気取得に失敗しました');}
  },
  async scrollToEventTime(){
    await this.$nextTick();
    const hour=parseInt(this.weatherPopupEvent.startTime.split(':')[0]);
    setTimeout(()=>{
      if(this.isMobile){
        const container=this.$refs.weatherMobileTableContainer;
        const target=document.getElementById('weather-mobile-hour-'+hour);
        if(container&&target){
          const pos=target.offsetTop-container.offsetTop-60;
          container.scrollTo({top:Math.max(0,pos),behavior:'smooth'});
        }
      }else{
        const container=this.$refs.weatherTableContainer;
        const target=document.getElementById('weather-hour-'+hour);
        if(container&&target){
          const pos=target.offsetLeft-container.offsetLeft-60;
          container.scrollTo({left:Math.max(0,pos),behavior:'smooth'});
        }
      }
    },120);
  },
  closeWeatherPopup(){
    this.showWeatherPopup=false;
    this.weatherPopupEvent=null;
    this.fullDayWeather={};
  },
  isEventHour(h){
    if(!this.weatherPopupEvent?.startTime) return false;
    return h===parseInt(this.weatherPopupEvent.startTime.split(':')[0]);
  },

  /* ===== 既存メソッドの後ろに追記終わり ===== */
},
mounted(){
  /* 既存 mounted ロジック */
  this.detectMobile();
  this.checkExistingData();
  this.loadData();
  if(this.tripDays.length>0) this.tripInitialized=true;
  window.addEventListener('resize',this.detectMobile);

  /* 追加：天気絵文字取得 */
  this.updateWeatherEmoji();
  this.$watch(()=>this.events.length,()=>this.updateWeatherEmoji());
  window.app=this;
},
beforeUnmount(){
  window.removeEventListener('resize',this.detectMobile);
  if(this.longPressTimer){clearTimeout(this.longPressTimer);this.longPressTimer=null;}
}
}).mount('#app');
</script>
</body>
</html>
