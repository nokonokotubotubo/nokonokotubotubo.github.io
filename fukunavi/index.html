<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Fukuãªã³</title>
<meta name="theme-color" content="#3385ff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Fukuãªã³">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script>
  // manifest.json ã®å­˜åœ¨ç¢ºèª
  fetch('/manifest.json', { method: 'HEAD' })
    .then(response => {
      if (response.ok) {
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = '/manifest.json';
        document.head.appendChild(link);
      }
    })
    .catch(() => {
      // manifest.json ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    });
</script>
<style>
*{box-sizing:border-box}
html,body,#app{height:100vh;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif}
body{background:#e6f2ff;overflow:hidden}
#app{display:flex;flex-direction:column;background:#fff}
.title-header{background:linear-gradient(135deg,#66a3ff,#0059b3);border-radius:0 0 10px 10px;padding:8px 16px;text-align:center;box-shadow:0 2px 6px rgba(0,89,179,.1);flex:0 0 44px;display:flex;align-items:center;justify-content:center;position:relative}
.desktop-location-address{width:12em;font-size:.9em;color:#0059b3;background:#f0f8ff;padding:4px 8px;border-radius:3px;border:1px solid #cce0ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-left:auto;margin-right: 40px;align-self:center}
.title-content{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;gap:6px;height:100%}
.title-icon{font-size:1.4em;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.2)}
.title-text{color:#fff;font-size:1.1em;font-weight:bold;letter-spacing:2px;line-height:1.2}
.mobile-copyright{display:none}
.date-row{display:flex;align-items:center;gap:10px;margin:6px 0 6px 8px;flex:0 0 36px;flex-wrap:wrap}
.location-address{width:8em;font-size:.9em;color:#0059b3;background:#f0f8ff;padding:4px 8px;border-radius:3px;border:1px solid #cce0ff;margin-right:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.memory-group,.date-group{display:flex;align-items:flex-start;gap:8px;margin-left:0;min-height:40px}
.memory-group-icon,.date-group-icon{font-size:1.8em;color:#0059b3;width:1.5em;height:1.5em;display:flex;align-items:center;justify-content:center;margin:2px 4px 0 0}
.memory-buttons,.date-buttons{display:flex;gap:5px;flex-wrap:wrap}
.memory-btn,.date-button{padding:7px 12px;border:1.2px solid #66a3ff;border-radius:5px;background:#cce0ff;color:#003366;font-size:.85em;cursor:pointer;transition:all .2s ease;min-width:70px;text-align:center;position:relative;user-select:none;font-weight:600;white-space:pre-line;line-height:1.1;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:36px}
.memory-btn:hover,.date-button:hover{background:#99c2ff;border-color:#3385ff;transform:translateY(-1px);box-shadow:0 2px 6px rgba(51,133,255,.2)}
.memory-btn.saved{background:#3385ff;color:#fff;border-color:#0059b3;box-shadow:0 2px 8px rgba(51,133,255,.22)}
.memory-btn.memory-selected{background:#0059b3!important;color:#fff!important;border-color:#003d80!important;box-shadow:0 3px 12px rgba(0,89,179,.35)!important}
.date-button.active{background:#0059b3;color:#fff;border-color:#003d80;box-shadow:0 2px 8px rgba(0,89,179,.25)}
.memory-btn.saved:hover,.date-button.active:hover{background:#003d80;transform:translateY(-1px);box-shadow:0 3px 12px rgba(0,89,179,.35)}
.memory-btn.memory-selected:hover{background:#003d80!important;transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,89,179,.45)!important}
.date-button{font-size:.95em}
.date-button-content{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.85em;line-height:1.1;width:100%}
.date-label{font-weight:bold;margin-bottom:2px;text-align:center;width:100%}
.date-detail{font-size:1.2em;font-weight:600;width:100%;font-family:'Hiragino Sans','ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯','Yu Gothic UI','Meiryo UI','MS UI Gothic',sans-serif;letter-spacing:2px;color:#003366;text-shadow:0 1px 2px rgba(51,133,255,.1);text-align:center}
.date-button.active .date-detail{color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.2)}
.main-content{flex:1;display:flex;flex-direction:column;height:100%;width:100vw;min-height:0}
.map-area{flex:0 0 39%;min-height:260px;max-height:45.5vh;position:relative;width:100vw;background:#e6f2ff;border-bottom:2px solid #99c2ff;display:flex;align-items:stretch;justify-content:center}
#map{flex:1;min-width:0;min-height:260px;width:100vw;height:100%;border-radius:8px;border:2px solid #99c2ff;margin:0}
.current-location-btn{position:absolute;bottom:12px;left:12px;z-index:1000;padding:8px 16px;background:linear-gradient(135deg,#66a3ff,#3385ff);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:1em;box-shadow:0 3px 8px rgba(51,133,255,.25);transition:all .3s ease;user-select:none;outline:none}
.current-location-btn:hover{background:linear-gradient(135deg,#3385ff,#0059b3);transform:translateY(-2px);box-shadow:0 5px 15px rgba(51,133,255,.35)}
.table-area{flex:0 0 61%;overflow:hidden;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;background:#fff;padding-top:6px;min-height:0}
.error-message{color:#dc2626;background:linear-gradient(135deg,#fef2f2,#fee2e2);border:1px solid #fca5a5;border-radius:8px;padding:12px 16px;margin:0 auto 12px;font-weight:600;font-size:1em;width:90vw;box-shadow:0 2px 8px rgba(220,38,38,.1)}
.table-container{width:99vw;height:100%;overflow:auto;margin:0 auto;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;background:#fff}
table{width:100%;border-collapse:collapse;font-size:14px;table-layout:auto;background:#f8fbff}
th,td{border:1px solid #99c2ff;padding:18px 6px;text-align:center;color:#003366;font-size:14px;white-space:normal;word-break:break-word}
th{background:linear-gradient(135deg,#f0f8ff,#e6f2ff);font-weight:bold;position:sticky;top:0;z-index:10}
.current-time-highlight{background-color:rgba(255,235,153,.3)!important}
.hot-temperature{background:#dc2626!important;color:#fff!important;font-weight:bold}
.cold-temperature{background:#1e40af!important;color:#fff!important;font-weight:bold}
.weather-emoji{font-size:2.25em;vertical-align:middle;filter:drop-shadow(0 1px 2px rgba(0,0,0,.1))}
.progress-container{background:#e6f2ff;border-radius:6px;width:100%;height:14px;position:relative;margin:1px 0;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(135deg,#3385ff,#0059b3);border-radius:6px;transition:width .4s ease;position:relative}
.progress-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#003366;font-weight:600;font-size:.85em;z-index:1;text-shadow:0 1px 2px rgba(255,255,255,.8)}
.no-data-message{text-align:center;padding:16px;color:#64748b;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:8px;border:1px solid #e2e8f0;font-size:1em;width:90vw;margin:0 auto;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.clothing-index-cell{display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.2}
.clothing-index-icon{font-size:2.25em;margin-bottom:2px;filter:drop-shadow(0 1px 2px rgba(0,0,0,.1))}
.clothing-index-label{font-size:.96em;margin-top:2px;word-break:break-word;font-weight:500}
.mobile-table{display:none}
.footer{background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-top:1px solid #cbd5e1;padding:12px 0;text-align:center;position:relative;z-index:1}
.footer small{color:#64748b;font-size:.875em;font-weight:500;letter-spacing:.5px}
.context-menu-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.3);z-index:999998;backdrop-filter:blur(2px)}
.context-menu{position:absolute;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.3),0 2px 8px rgba(0,0,0,.1);min-width:180px;overflow:hidden;border:1px solid rgba(51,133,255,.2);animation:contextMenuFadeIn .2s ease-out}
.context-menu-header{background:linear-gradient(135deg,#f0f8ff,#e6f2ff);color:#0059b3;font-weight:bold;font-size:.9em;padding:12px 16px;text-align:center;border-bottom:1px solid #e0e9ff}
.context-menu-item{padding:14px 18px;cursor:pointer;display:flex;align-items:center;gap:12px;font-size:1em;font-weight:500;transition:all .2s ease;user-select:none;border-bottom:1px solid #f0f0f0}
.context-menu-item:last-child{border-bottom:none}
.context-menu-item i{font-size:1.1em;width:16px;text-align:center}
.register-item{color:#0059b3}
.register-item:hover{background:linear-gradient(135deg,#f0f8ff,#e6f2ff);color:#003d80}
.delete-item{color:#dc2626}
.delete-item:hover{background:linear-gradient(135deg,#fef2f2,#fee2e2);color:#b91c1c}
.location-save-modal{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:999999;backdrop-filter:blur(3px);animation:modalBackdropFadeIn .3s ease-out}
.location-save-content{background:#fff;padding:28px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.3),0 4px 12px rgba(0,0,0,.1);max-width:340px;width:88%;max-height:85vh;overflow-y:auto;position:relative;margin:20px;border:1px solid rgba(51,133,255,.1);animation:modalContentFadeIn .3s ease-out}
.location-save-title{color:#0059b3;font-weight:bold;font-size:1.2em;margin-bottom:20px;text-align:center;line-height:1.4;display:flex;align-items:center;justify-content:center;gap:8px}
.location-save-title::before{content:"ğŸ“";font-size:1.1em}
.location-save-select{width:100%;padding:14px 16px;border:2px solid #e0e9ff;border-radius:10px;margin-bottom:12px;font-size:1em;outline:none;transition:all .3s ease;background:#fafcff;font-family:inherit}
.location-save-select:focus{border-color:#3385ff;background:#fff;box-shadow:0 0 0 4px rgba(51,133,255,.1),0 2px 8px rgba(51,133,255,.15);transform:translateY(-1px)}
.location-save-input{width:100%;padding:14px 16px;border:2px solid #e0e9ff;border-radius:10px;margin-bottom:24px;font-size:1em;outline:none;transition:all .3s ease;background:#fafcff;font-family:inherit}
.location-save-input:focus{border-color:#3385ff;background:#fff;box-shadow:0 0 0 4px rgba(51,133,255,.1),0 2px 8px rgba(51,133,255,.15);transform:translateY(-1px)}
.location-save-buttons{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
.location-save-btn{padding:14px 24px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:1em;transition:all .3s ease;min-width:100px;text-align:center;user-select:none;position:relative;overflow:hidden;font-family:inherit}
.save-btn{background:linear-gradient(135deg,#3385ff,#0059b3);color:#fff;box-shadow:0 4px 12px rgba(51,133,255,.3)}
.save-btn:hover{background:linear-gradient(135deg,#0059b3,#003d80);transform:translateY(-2px);box-shadow:0 6px 20px rgba(51,133,255,.4)}
.cancel-btn{background:linear-gradient(135deg,#f1f5f9,#e2e8f0);color:#475569;border:1px solid #cbd5e1;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.cancel-btn:hover{background:linear-gradient(135deg,#e2e8f0,#cbd5e1);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
@keyframes contextMenuFadeIn{from{opacity:0;transform:scale(.8)translateY(-10px)}to{opacity:1;transform:scale(1)translateY(0)}}
@keyframes modalBackdropFadeIn{from{opacity:0}to{opacity:1}}
@keyframes modalContentFadeIn{from{opacity:0;transform:scale(.85)translateY(-30px)}to{opacity:1;transform:scale(1)translateY(0)}}
@media(min-width: 901px){
.date-row {gap: 30px;}
}
@media(max-width:900px){
.title-header{padding:8px 0;justify-content:center;flex:0 0 28px}
.title-text{font-size:1em}
.title-icon{font-size:1.2em}
th,td{font-size:13px;padding:6px 3px}
.date-row{margin:6px 0 6px 1vw;}
.map-area{flex:0 0 32.5%;min-height:234px;max-height:39vh}
.table-area{flex:0 0 67.5%}
.weather-emoji,.clothing-index-icon{font-size:2.34em}
#map{min-height:234px}
.memory-btn{padding:6px 10px;font-size:.88em;min-width:60px;min-height:34px}
.memory-group,.date-group{min-height:36px}
.memory-group-icon,.date-group-icon{font-size:1.65em;margin-right:4px;width:1.3em;height:1.3em}
}
@media(max-width:600px){
.title-text{font-size:.9em;letter-spacing:.5px}
.title-icon{font-size:1.1em}
.title-header{padding:8px 6px;justify-content:center;flex:0 0 28px}
.title-content{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;gap:6px;height:100%}
.date-row{margin:6px 0 6px 1vw;align-items:flex-start;width:calc(100% - 2vw);flex-direction:column;gap:4px;flex:0 0 76px}
.desktop-location-address{display:none!important}
.memory-group,.date-group{margin:0 5px;gap:3px;width:calc(100% - 10px);align-items:flex-start}
.memory-buttons,.date-buttons{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;gap:3px}
.memory-btn,.date-button{min-width:55px;flex-shrink:0}
.memory-btn{padding:6px 10px;font-size:.8em;min-height:32px}
.date-button-content{font-size:.75em}
.date-detail{font-size:1.1em;letter-spacing:1px}
.memory-group-icon,.date-group-icon{font-size:1.65em;margin-right:4px;width:1.3em;height:1.3em}
.map-area{flex:0 0 26%;min-height:208px;max-height:39vh}
#map{min-height:208px}
.table-area{flex:0 0 74%;overflow:hidden;position:relative}
.map-area.map-hidden{flex:0 0 0;min-height:0;max-height:0;overflow:hidden}
.table-area.table-full{flex:0 0 100%}
.desktop-table{display:none}
.mobile-table{display:table;width:100%;table-layout:fixed;border-spacing:0;margin:0}
.table-container{position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;overflow:auto;background:#fff;padding:0 0 120px 0}
.mobile-table td{padding:12px 4px;font-size:11px;line-height:1.4;vertical-align:middle;height:auto;min-height:48px}
.mobile-table th{font-size:11px;padding:6px 3px}
.mobile-table .weather-emoji,.mobile-table .clothing-index-icon{font-size:2.2em}
.mobile-table .clothing-index-label{font-size:.75em}
.mobile-table .progress-container{height:12px}
.mobile-table tr:last-child td{padding-bottom:20px}
.location-save-content{width:92%;margin:8px;padding:24px;border-radius:12px}
.location-save-input{font-size:16px;padding:16px}
.location-save-buttons{flex-direction:row;gap:12px}
.location-save-btn{flex:1;min-width:0;padding:16px 20px;font-size:1.05em}
.footer{display:none}
.mobile-copyright{display:block;position:absolute;top:50%;right:8px;transform:translateY(-50%);z-index:5000;line-height:1;font-size:.65em;color:rgba(255,255,255,.8);font-weight:500;text-shadow:0 1px 2px rgba(0,0,0,.2);user-select:none;pointer-events:none;font-family:Verdana,"Droid Sans","ãƒ¡ã‚¤ãƒªã‚ª",Meiryo,sans-serif}
}
@media(max-width:400px){
.location-save-buttons{flex-direction:column}
.location-save-btn{width:100%}
.location-save-content{padding:20px;margin:6px}
.map-area{flex:0 0 20.8%;min-height:156px}
.table-area{flex:0 0 79.2%}
.map-area.map-hidden{flex:0 0 0;min-height:0}
.table-area.table-full{flex:0 0 100%}
.memory-group-icon,.date-group-icon{font-size:1.5em;margin-right:3px;width:1.2em;height:1.2em}
.mobile-copyright{right:6px;font-size:.6em}
.date-button{min-width:50px}
.date-buttons,.memory-buttons{gap:2px}
}
</style>
</head>
<body>
<div id="app">
<div class="title-header">
<div class="title-content" @click="isMobile ? toggleMap() : null" :style="{ cursor: isMobile ? 'pointer' : 'default' }">
<i class="fas fa-shirt title-icon"></i>
<div class="title-text">Fukuãªã³ <i class="fas fa-cloud-sun title-icon"></i></div>
</div>
<div class="mobile-copyright">&copy; 2025 nokotubo</div>
</div>
<div class="date-row">
<div class="memory-group">
<div class="memory-group-icon">ğŸ“’</div>
<div class="memory-buttons">
<button v-for="(memory, index) in locationMemories" :key="index" @click="loadLocationMemory(index)" @mousedown="startLongPress(index, $event)" @mouseup="endLongPress" @mouseleave="endLongPress" @touchstart="startLongPress(index, $event)" @touchend="endLongPress" :class="['memory-btn', { saved: memory.name, 'memory-selected': selectedMemoryIndex === index }]">
{{ memory.name || `ãƒ¡ãƒ¢ãƒª\n${getMemoryNumber(index)}` }}
</button>
</div>
</div>
<div class="date-group">
<div class="date-group-icon">ğŸ“…</div>
<div class="date-buttons">
<button v-for="(date, index) in dateList" :key="date" @click="selectDate(index)" :class="['date-button', { active: selectedDateIndex === index }]">
<div class="date-button-content">
<div class="date-label">{{ dateLabel(date, index) }}</div>
<div class="date-detail">{{ formatDateDetail(date) }}</div>
</div>
</button>
</div>
</div>
<div class="desktop-location-address">ğŸ“ {{ currentAddress || 'ä½ç½®ã‚’é¸æŠ' }}</div>
</div>
<div class="main-content">
<div class="map-area" :class="{ 'map-hidden': !showMap }">
<div id="map">
<button class="current-location-btn" @click="getCurrentLocation" @touchend.prevent="getCurrentLocation">ğŸ“ ç¾åœ¨åœ°</button>
</div>
</div>
<div class="table-area" :class="{ 'table-full': !showMap }">
<div v-if="errorMessage" class="error-message">âŒ {{ errorMessage }}</div>
<div class="table-container" ref="tableContainer">
<table v-if="hasWeatherData" class="desktop-table">
<thead>
<tr>
<th>â›… å¤©æ°—</th>
<th v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }" :id="`hour-${hour}`">
<span class="weather-emoji">{{ weatherIcon(weatherData[hour]?.weather_code, weatherData[hour]?.precipitation_probability) }}</span><br>{{ hour }}:00
</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ğŸŒ§ï¸ é™æ°´ç¢ºç‡</strong></td>
<td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
<div class="progress-container">
<div class="progress-bar" :style="{ width: (weatherData[hour]?.precipitation_probability ?? 0) + '%' }"></div>
</div>
{{ weatherData[hour]?.precipitation_probability !== undefined ? weatherData[hour].precipitation_probability + "%" : '-' }}
</td>
</tr>
<tr>
<td><strong>ğŸŒ¡ï¸ æ°—æ¸©</strong></td>
<td v-for="hour in hours" :key="hour" :class="[{ 'current-time-highlight': isCurrentHour(hour) }, temperatureClass(weatherData[hour]?.temperature_2m)]">
{{ weatherData[hour]?.temperature_2m !== undefined ? weatherData[hour].temperature_2m + "â„ƒ" : '-' }}
</td>
</tr>
<tr>
<td><strong>ğŸ¤’ ä½“æ„Ÿæ¸©åº¦</strong></td>
<td v-for="hour in hours" :key="hour" :class="[{ 'current-time-highlight': isCurrentHour(hour) }, temperatureClass(weatherData[hour]?.apparent_temperature)]">
{{ weatherData[hour]?.apparent_temperature !== undefined ? weatherData[hour].apparent_temperature + "â„ƒ" : '-' }}
</td>
</tr>
<tr>
<td><strong>ğŸ’§ æ¹¿åº¦</strong></td>
<td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
{{ weatherData[hour]?.relative_humidity_2m !== undefined ? weatherData[hour].relative_humidity_2m + "%" : '-' }}
</td>
</tr>
<tr>
<td><strong>ğŸ˜° ä¸å¿«æŒ‡æ•°</strong></td>
<td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
<div style="font-size: 0.9em; font-weight: bold;">
{{ calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) !== null ? calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) : '-' }}
</div>
<div style="font-size: 0.8em; color: #666; margin-top: 2px;">
{{ discomfortLevel(calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m)) }}
</div>
</td>
</tr>
<tr>
<td><strong>ğŸ‘• æœè£…æŒ‡æ•°</strong></td>
<td v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }">
<div class="clothing-index-cell">
<span class="clothing-index-icon">{{ clothingIcon(weatherData[hour]?.apparent_temperature, hour) }}</span>
<span class="clothing-index-label">{{ clothingLabel(weatherData[hour]?.apparent_temperature, hour) }}</span>
</div>
</td>
</tr>
</tbody>
</table>
<table v-if="hasWeatherData" class="mobile-table">
<thead>
<tr>
<th>â›…<br>å¤©æ°—</th>
<th>ğŸŒ§ï¸<br>é™æ°´ç¢ºç‡</th>
<th>ğŸŒ¡ï¸<br>æ°—æ¸©</th>
<th>ğŸ¤’<br>ä½“æ„Ÿæ¸©åº¦</th>
<th>ğŸ’§<br>æ¹¿åº¦</th>
<th>ğŸ˜°<br>ä¸å¿«æŒ‡æ•°</th>
<th>ğŸ‘•<br>æœè£…</th>
</tr>
</thead>
<tbody>
<tr v-for="hour in hours" :key="hour" :class="{ 'current-time-highlight': isCurrentHour(hour) }" :id="`mobile-hour-${hour}`">
<td>
<span class="weather-emoji">{{ weatherIcon(weatherData[hour]?.weather_code, weatherData[hour]?.precipitation_probability) }}</span><br>
{{ hour }}:00
</td>
<td>
<div class="progress-container">
<div class="progress-bar" :style="{ width: (weatherData[hour]?.precipitation_probability ?? 0) + '%' }"></div>
</div>
{{ weatherData[hour]?.precipitation_probability !== undefined ? weatherData[hour].precipitation_probability + "%" : '-' }}
</td>
<td :class="temperatureClass(weatherData[hour]?.temperature_2m)">
{{ weatherData[hour]?.temperature_2m !== undefined ? weatherData[hour].temperature_2m + "â„ƒ" : '-' }}
</td>
<td :class="temperatureClass(weatherData[hour]?.apparent_temperature)">
{{ weatherData[hour]?.apparent_temperature !== undefined ? weatherData[hour].apparent_temperature + "â„ƒ" : '-' }}
</td>
<td>
{{ weatherData[hour]?.relative_humidity_2m !== undefined ? weatherData[hour].relative_humidity_2m + "%" : '-' }}
</td>
<td>
<div style="font-size: 0.8em; font-weight: bold;">
{{ calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) !== null ? calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m) : '-' }}
</div>
<div style="font-size: 0.7em; color: #666;">
{{ discomfortLevel(calculateDiscomfortIndex(weatherData[hour]?.temperature_2m, weatherData[hour]?.relative_humidity_2m)) }}
</div>
</td>
<td>
<div class="clothing-index-cell">
<span class="clothing-index-icon">{{ clothingIcon(weatherData[hour]?.apparent_temperature, hour) }}</span>
<span class="clothing-index-label">{{ clothingLabel(weatherData[hour]?.apparent_temperature, hour) }}</span>
</div>
</td>
</tr>
</tbody>
</table>
<div v-if="!hasWeatherData && !errorMessage" class="no-data-message">
ğŸ—ºï¸åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„
</div>
</div>
</div>
</div>
</div>
<footer class="footer">
<small>&copy; 2025 nokotubo</small>
</footer>
<div v-if="showContextMenu" class="context-menu-overlay" @click="closeContextMenu">
<div class="context-menu" @click.stop :style="{ left: contextMenuPosition.x + 'px', top: contextMenuPosition.y + 'px' }">
<div class="context-menu-header">ãƒ¡ãƒ¢ãƒª{{ getMemoryNumber(contextMenuIndex) }}</div>
<div v-if="!isMemorySlotSaved(contextMenuIndex)" class="context-menu-item register-item" @click="openSaveDialog">
<i class="fas fa-plus"></i>ä½ç½®ã‚’ç™»éŒ²
</div>
<div v-if="isMemorySlotSaved(contextMenuIndex)" class="context-menu-item delete-item" @click="confirmDeleteMemory">
<i class="fas fa-trash"></i>å‰Šé™¤
</div>
</div>
</div>
<div v-if="showSaveDialog" class="location-save-modal" @click="closeSaveDialog">
<div class="location-save-content" @click.stop>
<div class="location-save-title">ä½ç½®ã‚’ç™»éŒ²</div>
<select v-model="selectedPreset" class="location-save-select">
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>
<option value="è‡ªå®…">è‡ªå®…</option>
<option value="è·å ´">è·å ´</option>
<option value="å®Ÿå®¶">å®Ÿå®¶</option>
</select>
<input v-model="saveLocationName" class="location-save-input" placeholder="è‡ªç”±å…¥åŠ›æ¬„ï¼ˆä¾‹: ã‚«ãƒ•ã‚§ã€å‹äººå®…ãªã©ï¼‰" @keyup.enter="saveLocationMemory" ref="saveLocationInput" maxlength="20">
<div class="location-save-buttons">
<button class="location-save-btn save-btn" @click="saveLocationMemory">ç™»éŒ²</button>
<button class="location-save-btn cancel-btn" @click="closeSaveDialog">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
</div>
</div>
</div>
<script src="https://unpkg.com/vue@3.0.0/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
const { createApp, ref, reactive, onMounted, computed, nextTick, watch, onUnmounted } = Vue;
createApp({
  setup() {
    const map = ref(null);
    const marker = ref(null);
    const selectedLatLng = reactive({ 
      lat: 34.6937, 
      lng: 135.5023,
      timezoneOffset: null,
      timezone: null,
      timezoneAbbreviation: null
    });
    const dateList = ref([]);
    const selectedDateIndex = ref(0);
    const weatherData = reactive({});
    const errorMessage = ref('');
    const currentAddress = ref('');
    const hours = Array.from({ length: 17 }, (_, i) => i + 6);
    const tableContainer = ref(null);
    const addressCache = new Map();
    const addressRequestInProgress = ref(false);
    const showContextMenu = ref(false);
    const contextMenuPosition = reactive({ x: 0, y: 0 });
    const contextMenuIndex = ref(0);
    const showSaveDialog = ref(false);
    const locationMemories = ref(Array.from({ length: 5 }, () => ({ name: '', lat: null, lng: null, address: '' })));
    const saveLocationName = ref('');
    const selectedPreset = ref('');
    const saveLocationIndex = ref(0);
    const longPressTimer = ref(null);
    const saveLocationInput = ref(null);
    const showMap = ref(false);
    const windowWidth = ref(window.innerWidth);
    const selectedMemoryIndex = ref(-1);
    const urlTargetHour = ref(null);
    const urlParams = ref(null);

    const isMobile = computed(() => windowWidth.value <= 600);
    const hasWeatherData = computed(() => Object.keys(weatherData).length > 0);

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹é–¢æ•°ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œç‰ˆï¼‰
    const getUrlParams = () => {
      const params = new URLSearchParams(window.location.search);
      const lat = params.get('lat');
      const lng = params.get('lng');
      const datetime = params.get('datetime');
      
      let result = null;
      
      // ç·¯åº¦çµŒåº¦ã®å‡¦ç†
      if (lat && lng) {
        const parsedLat = parseFloat(lat);
        const parsedLng = parseFloat(lng);
        if (!isNaN(parsedLat) && !isNaN(parsedLng) && 
            parsedLat >= -90 && parsedLat <= 90 && 
            parsedLng >= -180 && parsedLng <= 180) {
          result = { lat: parsedLat, lng: parsedLng };
        }
      }
      
      // æ—¥æ™‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‡¦ç†ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œç‰ˆï¼‰
      if (datetime && datetime.length === 12) {
        const year = parseInt(datetime.substring(0, 4));
        const month = parseInt(datetime.substring(4, 6));
        const day = parseInt(datetime.substring(6, 8));
        const hour = parseInt(datetime.substring(8, 10));
        const minute = parseInt(datetime.substring(10, 12));
        
        // åŸºæœ¬çš„ãªæ•°å€¤ç¯„å›²ãƒã‚§ãƒƒã‚¯
        if (year >= 2020 && year <= 2030 && 
            month >= 1 && month <= 12 && 
            day >= 1 && day <= 31 && 
            hour >= 0 && hour <= 23 && 
            minute >= 0 && minute <= 59) {
          
          // UTCãƒ™ãƒ¼ã‚¹ã§æ—¥ä»˜å·®åˆ†ã‚’è¨ˆç®—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³éä¾å­˜ï¼‰
          const targetDateUTC = new Date(Date.UTC(year, month - 1, day, 0, 0, 0));
          const todayUTC = new Date();
          todayUTC.setUTCHours(0, 0, 0, 0);
          const diffDays = Math.floor((targetDateUTC - todayUTC) / (1000 * 60 * 60 * 24));
          
          // ä»Šæ—¥ã‹ã‚‰7æ—¥å¾Œã¾ã§ã€æ™‚åˆ»ã¯6-22æ™‚ã®ç¯„å›²å†…ã‚’ãƒã‚§ãƒƒã‚¯
          if (diffDays >= 0 && diffDays <= 7 && hour >= 6 && hour <= 22) {
            result = result || {};
            result.dateIndex = diffDays;
            result.targetHour = hour;
            result.isValidDateTime = true;
          }
        }
      }
      
      return result;
    };

    // URLæ›´æ–°é–¢æ•°
    const updateUrl = (lat, lng) => {
      const url = new URL(window.location);
      url.searchParams.set('lat', lat.toFixed(6));
      url.searchParams.set('lng', lng.toFixed(6));
      window.history.replaceState({}, '', url);
    };

    const updateWindowWidth = () => windowWidth.value = window.innerWidth;

    const getMemoryNumber = i => ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤'][i] || `${i + 1}`;

    const isMemorySlotSaved = i => {
      const m = locationMemories.value[i];
      return m.name && m.lat && m.lng;
    };

    const toggleMap = () => {
      showMap.value = !showMap.value;
      showMap.value && map.value && setTimeout(() => map.value.invalidateSize(), 100);
    };

    const startLongPress = (i, e) => {
      longPressTimer.value && clearTimeout(longPressTimer.value);
      longPressTimer.value = setTimeout(() => {
        if (!selectedLatLng.lat || !selectedLatLng.lng) {
          errorMessage.value = 'å…ˆã«åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„';
          setTimeout(() => errorMessage.value = '', 3000);
          return;
        }
        showContextMenuDialog(i, e);
      }, 600);
    };

    const showContextMenuDialog = (i, e) => {
      contextMenuIndex.value = i;
      let clientX, clientY;
      if (e && e.type.startsWith('touch')) {
        const t = e.touches[0] || e.changedTouches[0];
        clientX = t.clientX;
        clientY = t.clientY;
      } else if (e) {
        clientX = e.clientX;
        clientY = e.clientY;
      } else {
        clientX = windowWidth.value / 2;
        clientY = window.innerHeight / 2;
      }
      const w = 180, h = 120;
      let x = clientX, y = clientY;
      x + w > windowWidth.value - 20 && (x = windowWidth.value - w - 20);
      y + h > window.innerHeight - 20 && (y = clientY - h - 10);
      contextMenuPosition.x = Math.max(20, x);
      contextMenuPosition.y = Math.max(20, y);
      showContextMenu.value = true;
    };

    const openSaveDialog = () => {
      saveLocationIndex.value = contextMenuIndex.value;
      saveLocationName.value = '';
      selectedPreset.value = '';
      closeContextMenu();
      showSaveDialog.value = true;
      nextTick(() => setTimeout(() => saveLocationInput.value && saveLocationInput.value.focus(), 200));
    };

    const confirmDeleteMemory = () => {
      const m = locationMemories.value[contextMenuIndex.value];
      confirm(`ã€Œ${m.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`) && deleteLocationMemory();
      closeContextMenu();
    };

    const deleteLocationMemory = () => {
      selectedMemoryIndex.value === contextMenuIndex.value && (selectedMemoryIndex.value = -1);
      locationMemories.value[contextMenuIndex.value] = { name: '', lat: null, lng: null, address: '' };
      saveLocationMemoriesToStorage();
      errorMessage.value = 'ãƒ¡ãƒ¢ãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
      setTimeout(() => errorMessage.value = '', 2000);
    };

    const closeContextMenu = () => {
      showContextMenu.value = false;
      contextMenuPosition.x = 0;
      contextMenuPosition.y = 0;
      contextMenuIndex.value = 0;
    };

    const closeSaveDialog = () => {
      showSaveDialog.value = false;
      saveLocationName.value = '';
      selectedPreset.value = '';
      saveLocationIndex.value = 0;
    };

    const endLongPress = () => {
      longPressTimer.value && (clearTimeout(longPressTimer.value), longPressTimer.value = null);
    };

    const getJSTDateString = (d = new Date()) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    };

    const isCurrentHour = h => {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ãªå ´åˆã®å‡¦ç†
      if (urlTargetHour.value !== null) {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯
        const urlDateIndex = urlParams.value?.dateIndex || 0;
        return selectedDateIndex.value === urlDateIndex && h === urlTargetHour.value;
      }
      
      // é€šå¸¸ã®ç¾åœ¨æ™‚åˆ»ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (selectedDateIndex.value === 0) {
        // é¸æŠä½ç½®ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
        const now = new Date();
        const timezoneOffset = selectedLatLng.timezoneOffset || 0;
        const localNow = new Date(now.getTime() + (timezoneOffset * 60000));
        return h === localNow.getHours();
      }
      
      return false;
    };

    const scrollToCurrentTime = () => {
      let targetHour, targetDateIndex;
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ãªå ´åˆ
      if (urlTargetHour.value !== null && urlParams.value?.dateIndex !== undefined) {
        targetHour = urlTargetHour.value;
        targetDateIndex = urlParams.value.dateIndex;
      } else {
        // é€šå¸¸ã®ç¾åœ¨æ™‚åˆ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        targetDateIndex = 0;
        const now = new Date();
        const timezoneOffset = selectedLatLng.timezoneOffset || 0;
        const localNow = new Date(now.getTime() + (timezoneOffset * 60000));
        targetHour = localNow.getHours();
      }
      
      // é¸æŠã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ãŒå¯¾è±¡æ—¥ä»˜ã¨ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      if (selectedDateIndex.value !== targetDateIndex) return;
      
      const scrollHour = targetHour + 3;
      
      if (targetHour < 6 || targetHour > 22 || windowWidth.value > 600) return;
      
      const scrollTarget = scrollHour > 22 ? 22 : scrollHour;
      
      setTimeout(() => {
        const el = document.getElementById(`mobile-hour-${scrollTarget}`);
        if (el && tableContainer.value) {
          const c = tableContainer.value;
          const rect = c.getBoundingClientRect();
          const abs = el.offsetTop;
          const vh = rect.height;
          const rh = el.offsetHeight;
          const target = abs - vh / 2 + rh / 2;
          c.scrollTo({ top: Math.max(0, target), behavior: 'instant' });
        }
      }, 50);
    };

    watch(hasWeatherData, v => v && scrollToCurrentTime());

    const temperatureClass = t => void 0 === t || null === t ? '' : t >= 35 ? 'hot-temperature' : t <= 0 ? 'cold-temperature' : '';

    const weatherIcon = (c, p) => {
      if (void 0 !== p) {
        if (p <= 10) return 0 === c ? 'â˜€ï¸' : 'â›…';
        if (p >= 50) return 'â˜”';
        if (p >= 30) return 'ğŸŒ§ï¸';
        if (p >= 11) return 'ğŸŒ¦ï¸';
        return 'â›…';
      }
      if (void 0 === c || null === c) return 'â˜€ï¸';
      const icons = {
        0: 'â˜€ï¸', 1: 'â›…', 2: 'â›…', 3: 'â›…', 45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
        51: 'ğŸŒ¦ï¸', 53: 'ğŸŒ¦ï¸', 55: 'ğŸŒ¦ï¸', 56: 'ğŸŒ¨ï¸', 57: 'ğŸŒ¨ï¸',
        61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸', 66: 'ğŸŒ¨ï¸', 67: 'ğŸŒ¨ï¸',
        71: 'â„ï¸', 73: 'â„ï¸', 75: 'â„ï¸', 77: 'â„ï¸',
        80: 'ğŸŒ¦ï¸', 81: 'ğŸŒ¦ï¸', 82: 'ğŸŒ¦ï¸', 85: 'ğŸŒ¨ï¸', 86: 'ğŸŒ¨ï¸',
        95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
      };
      return icons[c] || 'â˜€ï¸';
    };

    const calculateDiscomfortIndex = (t, h) => void 0 === t || null === t || void 0 === h || null === h ? null : Math.round((0.81 * t + 0.01 * h * (0.99 * t - 14.3) + 46.3) * 10) / 10;

    const discomfortLevel = d => null === d || void 0 === d ? '-' : d < 55 ? 'å¯’ã„' : d < 60 ? 'è‚Œå¯’ã„' : d < 65 ? 'ä½•ã‚‚æ„Ÿã˜ãªã„' : d < 70 ? 'å¿«ã„' : d < 75 ? 'æš‘ããªã„' : d < 80 ? 'ã‚„ã‚„æš‘ã„' : d < 85 ? 'æš‘ãã¦æ±—ãŒå‡ºã‚‹' : 'æš‘ãã¦ãŸã¾ã‚‰ãªã„';

    const loadLocationMemoriesFromStorage = () => {
      const s = localStorage.getItem('fukuanvi-location-memories');
      if (s) try {
        locationMemories.value = JSON.parse(s);
      } catch (e) {
        console.error('ä½ç½®ãƒ¡ãƒ¢ãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
    };

    const saveLocationMemoriesToStorage = () => localStorage.setItem('fukuanvi-location-memories', JSON.stringify(locationMemories.value));

    const saveLocationMemory = () => {
      let n = selectedPreset.value || saveLocationName.value.trim();
      if (!n) {
        errorMessage.value = 'ä½ç½®åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        saveLocationInput.value && saveLocationInput.value.focus();
        setTimeout(() => errorMessage.value = '', 3000);
        return;
      }
      if (n.length > 20) {
        errorMessage.value = 'ä½ç½®åã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      locationMemories.value[saveLocationIndex.value] = {
        name: n,
        lat: selectedLatLng.lat,
        lng: selectedLatLng.lng,
        address: currentAddress.value
      };
      saveLocationMemoriesToStorage();
      closeSaveDialog();
    };

    const loadLocationMemory = i => {
      const m = locationMemories.value[i];
      m.name && m.lat && m.lng && (
        selectedMemoryIndex.value = i,
        selectedLatLng.lat = m.lat,
        selectedLatLng.lng = m.lng,
        currentAddress.value = 'ä½ç½®æƒ…å ±å–å¾—ä¸­...',
        map.value && (map.value.setView([m.lat, m.lng], 10), updateMarker()),
        fetchAddress(m.lat, m.lng),
        fetchWeatherData()
      );
    };

    const fetchAddress = async (lat, lng) => {
      const k = `${lat.toFixed(3)},${lng.toFixed(3)}`;
      if (addressCache.has(k)) return void (currentAddress.value = addressCache.get(k));
      if (addressRequestInProgress.value) return;
      addressRequestInProgress.value = true;
      try {
        const c = new AbortController();
        const tid = setTimeout(() => c.abort(), 3000);
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&accept-language=ja&zoom=10`, { signal: c.signal });
        if (clearTimeout(tid), !r.ok) throw new Error('ä½æ‰€å–å¾—ã«å¤±æ•—');
        const d = await r.json();
        const a = d.address;
        let display = 'ä½ç½®ã‚’é¸æŠ';
        if (a) {
          const pref = a.state || a.prefecture || '';
          const city = a.city || a.town || a.village || a.municipality || '';
          display = pref && city ? `${pref} ${city}` : pref || city;
        }
        addressCache.size >= 100 && addressCache.delete(addressCache.keys().next().value);
        addressCache.set(k, display);
        currentAddress.value = display;
      } catch (e) {
        currentAddress.value = 'ä½ç½®ã‚’é¸æŠ';
      } finally {
        addressRequestInProgress.value = false;
      }
    };

    const initMap = () => {
      const el = document.getElementById('map');
      if (!el) return;
      map.value && (map.value.remove(), map.value = null);
      try {
        map.value = L.map('map', { preferCanvas: true, zoomControl: true }).setView([selectedLatLng.lat, selectedLatLng.lng], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap contributors',
          loading: 'lazy'
        }).addTo(map.value);
        const icon = L.divIcon({
          html: '<div style="background: linear-gradient(135deg, #3385ff, #0059b3); color: white; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 8px rgba(51, 133, 255, 0.4); border: 3px solid white;"><i class="fas fa-shirt" style="transform: rotate(45deg); font-size: 14px;"></i></div>',
          className: 'custom-location-marker',
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });
        marker.value = L.marker([selectedLatLng.lat, selectedLatLng.lng], { icon }).addTo(map.value);
        map.value.on('click', e => {
          selectedMemoryIndex.value = -1;
          selectedLatLng.lat = e.latlng.lat;
          selectedLatLng.lng = e.latlng.lng;
          updateMarker();
          fetchWeatherData();
          fetchAddress(e.latlng.lat, e.latlng.lng);
          updateUrl(e.latlng.lat, e.latlng.lng);
        });
        setTimeout(() => map.value && map.value.invalidateSize(), 100);
      } catch (e) {
        errorMessage.value = 'åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
      }
    };

    const updateMarker = () => marker.value && marker.value.setLatLng([selectedLatLng.lat, selectedLatLng.lng]);

    const getCurrentLocation = () => {
      if (!navigator.geolocation) return void (errorMessage.value = 'âŒ ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\næ‰‹å‹•ã§åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      selectedMemoryIndex.value = -1;
      currentAddress.value = 'ğŸ”„ ä½ç½®æƒ…å ±å–å¾—ä¸­...';
      errorMessage.value = '';
      const opts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 };
      navigator.geolocation.getCurrentPosition(pos => {
        selectedLatLng.lat = pos.coords.latitude;
        selectedLatLng.lng = pos.coords.longitude;
        map.value && (map.value.setView([selectedLatLng.lat, selectedLatLng.lng], 12), updateMarker());
        fetchWeatherData();
        fetchAddress(pos.coords.latitude, pos.coords.longitude);
        updateUrl(pos.coords.latitude, pos.coords.longitude);
      }, err => {
        let msg = '';
        switch (err.code) {
          case err.PERMISSION_DENIED:
            msg = 'ğŸš« ä½ç½®æƒ…å ±ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n\nã€è§£æ±ºæ–¹æ³•ã€‘\n1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ãƒãƒ¼ã‚¯ã‚’ã‚¿ãƒƒãƒ—\n2. ä½ç½®æƒ…å ±ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´\n3. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„';
            break;
          case err.POSITION_UNAVAILABLE:
            msg = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚\n\nã€ç¢ºèªäº‹é …ã€‘\nâ€¢ GPSãŒã‚ªãƒ³ã«ãªã£ã¦ã„ã‚‹ã‹\nâ€¢ å±‹å¤–ã«ã„ã‚‹ã‹ï¼ˆå±‹å†…ã§ã¯å–å¾—å›°é›£ï¼‰\nâ€¢ æ©Ÿå†…ãƒ¢ãƒ¼ãƒ‰ãŒã‚ªãƒ•ã«ãªã£ã¦ã„ã‚‹ã‹';
            break;
          case err.TIMEOUT:
            msg = 'â±ï¸ ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚\n\nã€ãŠè©¦ã—ãã ã•ã„ã€‘\nâ€¢ é›»æ³¢ã®è‰¯ã„å ´æ‰€ã«ç§»å‹•\nâ€¢ å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦å®Ÿè¡Œ\nâ€¢ æ‰‹å‹•ã§åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®é¸æŠ';
            break;
          default:
            msg = `âŒ ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼\n\nã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${err.code}\nãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${err.message}\n\næ‰‹å‹•ã§åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`;
        }
        errorMessage.value = msg;
        currentAddress.value = 'ä½ç½®ã‚’é¸æŠ';
        setTimeout(() => errorMessage.value = '', 15000);
      }, opts);
    };

    const generateDateList = () => {
      const today = new Date();
      dateList.value = [];
      for (let i = 0; i <= 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        dateList.value.push(getJSTDateString(d));
      }
    };

    const dateLabel = (s, i) => 0 === i ? 'ä»Šæ—¥' : 1 === i ? 'æ˜æ—¥' : 2 === i ? 'æ˜å¾Œæ—¥' : 7 === i ? '1é€±é–“å¾Œ' : `${i}æ—¥å¾Œ`;

    const formatDateDetail = s => {
      const d = new Date(s);
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const w = d.toLocaleDateString('ja-JP', { weekday: 'short' });
      return `${m}/${day}ï¼ˆ${w}ï¼‰`;
    };

    const selectDate = i => {
      selectedDateIndex.value = i;
      selectedLatLng.lat && selectedLatLng.lng && fetchWeatherData();
    };

    const fetchWeatherData = () => {
      errorMessage.value = '';
      Object.keys(weatherData).forEach(k => delete weatherData[k]);
      const d = dateList.value[selectedDateIndex.value];
      const lat = selectedLatLng.lat.toFixed(4);
      const lng = selectedLatLng.lng.toFixed(4);
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&hourly=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation_probability,weather_code&start_date=${d}&end_date=${d}&timezone=auto&timezone_abbreviation=true`;
      const c = new AbortController();
      const tid = setTimeout(() => c.abort(), 15000);
      fetch(url, { signal: c.signal }).then(r => {
        if (clearTimeout(tid), !r.ok) throw new Error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        return r.json();
      }).then(data => {
        if (!data.hourly) throw new Error('å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        
        // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’ä¿å­˜
        selectedLatLng.timezoneOffset = data.utc_offset_seconds / 60; // åˆ†å˜ä½ã«å¤‰æ›
        selectedLatLng.timezone = data.timezone;
        selectedLatLng.timezoneAbbreviation = data.timezone_abbreviation;
        
        for (const h of hours) {
          const idx = data.hourly.time.findIndex(t => t.endsWith(`T${h.toString().padStart(2, '0')}:00`));
          -1 !== idx && (weatherData[h] = {
            temperature_2m: Math.round(data.hourly.temperature_2m[idx]),
            apparent_temperature: Math.round(data.hourly.apparent_temperature[idx]),
            relative_humidity_2m: Math.round(data.hourly.relative_humidity_2m[idx]),
            precipitation_probability: Math.round(data.hourly.precipitation_probability[idx] || 0),
            weather_code: data.hourly.weather_code[idx]
          });
        }
      }).catch(e => {
        clearTimeout(tid);
        errorMessage.value = 'AbortError' === e.name ? 'å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚' : e.message;
        setTimeout(() => errorMessage.value = '', 8000);
      });
    };

    const clothingIcon = (t, h) => {
      if (void 0 === t || null === t) return '';
      let adj = t;
      h >= 6 && h <= 9 || h >= 18 && h <= 21 ? adj -= 1.5 : (h >= 22 || h <= 5) && (adj -= 1);
      return adj >= 35 ? 'ğŸ§˜â€â™‚ï¸' : adj >= 30 ? 'ğŸ‹ï¸â€â™‚ï¸' : adj >= 27 ? 'ğŸ‘•' : adj >= 24 ? 'ğŸ‘”' : adj >= 21 ? 'ğŸ¦º' : 'ğŸ§¥';
    };

    const clothingLabel = (t, h) => {
      if (void 0 === t || null === t) return '-';
      let adj = t;
      h >= 6 && h <= 9 || h >= 18 && h <= 21 ? adj -= 1.5 : (h >= 22 || h <= 5) && (adj -= 1);
      return adj >= 35 ? 'å…¨è£¸ãƒ¬ãƒ™ãƒ«' : adj >= 30 ? 'ã‚¿ãƒ³ã‚¯ãƒˆãƒƒãƒ—' : adj >= 27 ? 'åŠè¢–Tã‚·ãƒ£ãƒ„' : adj >= 24 ? 'é•·è¢–Tã‚·ãƒ£ãƒ„' : adj >= 21 ? 'è–„æ‰‹ã‚«ãƒ¼ãƒ‡ã‚£ã‚¬ãƒ³' : adj >= 18 ? 'ã‚»ãƒ¼ã‚¿ãƒ¼' : adj >= 15 ? 'ãƒ‘ãƒ¼ã‚«ãƒ¼' : adj >= 12 ? 'ã‚¸ãƒ£ã‚±ãƒƒãƒˆ' : adj >= 9 ? 'ã‚³ãƒ¼ãƒˆ' : adj >= 6 ? 'åšæ‰‹ã‚³ãƒ¼ãƒˆ' : adj >= 3 ? 'ãƒ€ã‚¦ãƒ³ã‚¸ãƒ£ã‚±ãƒƒãƒˆ' : 'é˜²å¯’ç€å®Œå…¨è£…å‚™';
    };

    onMounted(() => {
      generateDateList();
      const now = new Date();
      now.getHours() >= 21 && (selectedDateIndex.value = 1);
      window.addEventListener('resize', updateWindowWidth);
      nextTick(() => setTimeout(() => {
        initMap();
        loadLocationMemoriesFromStorage();
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
        const urlParamsResult = getUrlParams();
        urlParams.value = urlParamsResult;
        
        if (urlParamsResult) {
          selectedMemoryIndex.value = -1;
          
          // ä½ç½®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
          if (urlParamsResult.lat && urlParamsResult.lng) {
            selectedLatLng.lat = urlParamsResult.lat;
            selectedLatLng.lng = urlParamsResult.lng;
            map.value && (map.value.setView([selectedLatLng.lat, selectedLatLng.lng], 12), updateMarker());
            fetchAddress(selectedLatLng.lat, selectedLatLng.lng);
          }
          
          // æ—¥æ™‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
          if (urlParamsResult.isValidDateTime) {
            selectedDateIndex.value = urlParamsResult.dateIndex;
            urlTargetHour.value = urlParamsResult.targetHour;
          }
          
          fetchWeatherData();
        } else if (locationMemories.value[0].name && locationMemories.value[0].lat && locationMemories.value[0].lng) {
          selectedMemoryIndex.value = 0;
          selectedLatLng.lat = locationMemories.value[0].lat;
          selectedLatLng.lng = locationMemories.value[0].lng;
          map.value && (map.value.setView([selectedLatLng.lat, selectedLatLng.lng], 10), updateMarker());
          fetchAddress(selectedLatLng.lat, selectedLatLng.lng);
          fetchWeatherData();
        } else {
          fetchWeatherData();
        }
      }, 200));
    });

    onUnmounted(() => window.removeEventListener('resize', updateWindowWidth));

    return {
      dateList,
      selectedDateIndex,
      selectDate,
      dateLabel,
      formatDateDetail,
      weatherData,
      hours,
      clothingIcon,
      clothingLabel,
      weatherIcon,
      calculateDiscomfortIndex,
      discomfortLevel,
      errorMessage,
      hasWeatherData,
      getCurrentLocation,
      currentAddress,
      isCurrentHour,
      temperatureClass,
      locationMemories,
      showSaveDialog,
      saveLocationName,
      selectedPreset,
      saveLocationInput,
      startLongPress,
      endLongPress,
      saveLocationMemory,
      closeSaveDialog,
      loadLocationMemory,
      tableContainer,
      scrollToCurrentTime,
      getMemoryNumber,
      showContextMenu,
      contextMenuPosition,
      contextMenuIndex,
      isMemorySlotSaved,
      openSaveDialog,
      confirmDeleteMemory,
      deleteLocationMemory,
      closeContextMenu,
      showMap,
      toggleMap,
      isMobile,
      selectedMemoryIndex
    };
  }
}).mount('#app');

'serviceWorker' in navigator && ('https:' === location.protocol || 'localhost' === location.hostname) && window.addEventListener('load', () => {
  // Service Worker ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
  fetch('/sw.js', { method: 'HEAD' })
    .then(response => {
      if (response.ok) {
        return navigator.serviceWorker.register('/sw.js');
      }
      throw new Error('Service Worker file not found');
    })
    .then(r => console.log('SW registered: ', r))
    .catch(e => console.log('SW registration skipped: ', e.message));
});
</script>
</body>
</html>
