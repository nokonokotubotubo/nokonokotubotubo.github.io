<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="お気に入り記事管理 - あなたのニュース">
    <title>お気に入り - あなたのニュース</title>
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="../assets/manifest.json">
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/themes.css">
    
    <!-- お気に入り画面専用スタイル -->
    <style>
        .favorites-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #FFC107;
        }
        
        .page-title {
            color: #FFC107;
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .page-description {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .favorites-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #fff8e1;
            border-radius: 8px;
            border: 1px solid #ffecb3;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .favorites-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f57c00;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .count-badge {
            background: #FFC107;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .bulk-select-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .bulk-select-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .bulk-select-btn.active {
            background: #FF9800;
        }
        
        .bulk-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.6;
            pointer-events: none;
        }
        
        .bulk-delete-btn.enabled {
            opacity: 1;
            pointer-events: auto;
        }
        
        .bulk-delete-btn:hover {
            background: #d32f2f;
        }
        
        .export-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #45a049;
        }
        
        .favorites-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            min-width: 150px;
        }
        
        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }
        
        .filter-select {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #FFC107;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FFC107;
            box-shadow: 0 0 0 3px rgba(255,193,7,0.1);
        }
        
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .favorite-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .favorite-card:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            transform: translateY(-3px);
            border-color: #FFC107;
        }
        
        .favorite-card.selected {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        
        .card-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 20px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .bulk-mode .card-checkbox {
            opacity: 1;
        }
        
        .favorite-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .favorite-score {
            background: linear-gradient(45deg, #FFC107, #FFB300);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .favorite-date {
            color: #999;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .favorite-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 0.8rem 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .favorite-excerpt {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0 0 1rem 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .favorite-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .meta-domain {
            font-weight: 600;
            color: #666;
        }
        
        .meta-category {
            background: #e0e0e0;
            color: #666;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .favorite-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }
        
        .keyword-tag {
            background: #FFEB3B;
            color: #333;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .favorite-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .read-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .read-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
            background: white;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: #333;
        }
        
        .empty-description {
            margin: 0 0 2rem 0;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .empty-action {
            background: #FFC107;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .empty-action:hover {
            background: #FFB300;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255,193,7,0.3);
        }
        
        .stats-summary {
            background: linear-gradient(135deg, #FFC107, #FFB300);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* アニメーション */
        .favorite-card {
            animation: slideInUp 0.3s ease;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .favorites-container {
                padding: 1rem;
            }
            
            .favorites-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .bulk-actions {
                justify-content: space-between;
            }
            
            .favorites-filters {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filter-group {
                min-width: unset;
            }
            
            .favorites-grid {
                grid-template-columns: 1fr;
            }
            
            .favorite-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .favorite-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.3rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .page-title {
                font-size: 1.5rem;
            }
            
            .bulk-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .bulk-select-btn,
            .bulk-delete-btn,
            .export-btn {
                width: 100%;
            }
            
            .favorite-actions {
                flex-direction: column;
                gap: 0.8rem;
            }
            
            .remove-btn {
                width: 100%;
                height: auto;
                padding: 0.6rem;
            }
        }
        
        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            .favorites-actions {
                background: #2e2e2e;
                border-color: #444;
            }
            
            .favorites-filters {
                background: #2e2e2e;
                border-color: #444;
            }
            
            .favorite-card {
                background: #2e2e2e;
                border-color: #444;
                color: #e0e0e0;
            }
            
            .favorite-card:hover {
                border-color: #FFD54F;
            }
            
            .favorite-title {
                color: #e0e0e0;
            }
            
            .empty-state {
                background: #2e2e2e;
                border-color: #444;
                color: #b0b0b0;
            }
        }
        
        /* 印刷スタイル */
        @media print {
            .favorites-actions,
            .favorites-filters,
            .favorite-actions,
            .bulk-actions {
                display: none;
            }
            
            .favorites-grid {
                display: block;
            }
            
            .favorite-card {
                break-inside: avoid;
                margin-bottom: 1rem;
                border: 1px solid #000;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー（ナビゲーション） -->
    <header class="main-header">
        <div class="header-container">
            <h1 class="app-title">あなたのニュース - お気に入り</h1>
            <nav class="main-nav">
                <button class="nav-btn" onclick="location.href='../index.html'">記事一覧</button>
                <button class="nav-btn" onclick="location.href='rss-manager.html'">RSS管理</button>
                <button class="nav-btn active">お気に入り</button>
                <button class="nav-btn" onclick="location.href='settings.html'">設定</button>
            </nav>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="favorites-container">
        <!-- ページヘッダー -->
        <div class="page-header">
            <h1 class="page-title">
                <span>⭐</span>
                <span>お気に入り記事</span>
            </h1>
            <p class="page-description">
                保存した記事を管理・検索して、後でじっくり読むことができます
            </p>
        </div>

        <!-- 統計サマリー -->
        <section class="stats-summary" id="statsSummary">
            <h2 style="margin: 0 0 1rem 0; font-size: 1.3rem;">📊 お気に入り統計</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalFavoritesCount">0</div>
                    <div class="stat-label">保存記事数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="unreadFavoritesCount">0</div>
                    <div class="stat-label">未読記事数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="categoriesCount">0</div>
                    <div class="stat-label">カテゴリ数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgInterestScore">0</div>
                    <div class="stat-label">平均興味度</div>
                </div>
            </div>
        </section>

        <!-- お気に入り操作エリア -->
        <section class="favorites-actions">
            <div class="favorites-count">
                <span>⭐</span>
                <span id="displayCount">お気に入り記事を読み込み中...</span>
                <span class="count-badge" id="countBadge">0</span>
            </div>
            
            <div class="bulk-actions">
                <button class="bulk-select-btn" id="bulkSelectBtn">一括選択</button>
                <button class="bulk-delete-btn" id="bulkDeleteBtn">選択削除</button>
                <button class="export-btn" id="exportBtn">エクスポート</button>
            </div>
        </section>

        <!-- フィルター・検索エリア -->
        <section class="favorites-filters">
            <div class="filter-group">
                <label class="filter-label">カテゴリ</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="all">全カテゴリ</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">既読状態</label>
                <select class="filter-select" id="readStatusFilter">
                    <option value="all">全ての記事</option>
                    <option value="unread">未読のみ</option>
                    <option value="read">既読のみ</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">並び順</label>
                <select class="filter-select" id="sortFilter">
                    <option value="date_desc">保存日時（新しい順）</option>
                    <option value="date_asc">保存日時（古い順）</option>
                    <option value="interest_desc">興味度（高い順）</option>
                    <option value="interest_asc">興味度（低い順）</option>
                    <option value="title">タイトル順</option>
                </select>
            </div>
            
            <div class="search-box">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput"
                    placeholder="🔍 記事タイトル・内容で検索..."
                >
            </div>
        </section>

        <!-- お気に入り記事一覧 -->
        <section class="favorites-grid" id="favoritesGrid">
            <!-- 空の状態 -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">⭐</div>
                <h3 class="empty-title">お気に入り記事がありません</h3>
                <p class="empty-description">
                    記事一覧画面で⭐ボタンを押してお気に入りに追加してください。<br>
                    保存した記事はここで管理・検索できます。
                </p>
                <button class="empty-action" onclick="location.href='../index.html'">
                    記事一覧へ戻る
                </button>
            </div>
        </section>
    </main>

    <!-- エラー通知エリア -->
    <div class="notification-area" id="notificationArea"></div>

    <!-- スクリプト読み込み -->
    <script src="../scripts/data-manager.js"></script>
    <script src="../scripts/utils.js"></script>
    
    <!-- お気に入り画面専用スクリプト -->
    <script>
        class FavoritesManager {
            constructor() {
                this.dataManager = null;
                this.allArticles = [];
                this.favoriteArticles = [];
                this.filteredArticles = [];
                this.selectedArticles = new Set();
                this.bulkMode = false;
                this.isInitialized = false;
                
                // フィルター状態
                this.currentFilters = {
                    category: 'all',
                    readStatus: 'all',
                    sort: 'date_desc',
                    search: ''
                };
            }
            
            async initialize() {
                try {
                    console.log('Favorites Manager初期化開始');
                    
                    // 依存クラス初期化
                    this.dataManager = new DataManager();
                    await this.dataManager.initialize();
                    
                    // データ読み込み
                    await this.loadFavoriteArticles();
                    
                    // イベントリスナー設定
                    this.setupEventListeners();
                    
                    // UI更新
                    this.updateFilters();
                    this.applyFilters();
                    this.updateStats();
                    
                    this.isInitialized = true;
                    console.log('Favorites Manager初期化完了');
                    
                } catch (error) {
                    console.error('Favorites Manager初期化エラー:', error);
                    this.showNotification('お気に入り管理機能の初期化に失敗しました', 'error');
                }
            }
            
            async loadFavoriteArticles() {
                try {
                    this.allArticles = await this.dataManager.loadArticles();
                    this.favoriteArticles = this.allArticles.filter(article => article.favorited);
                    
                    console.log(`お気に入り記事読み込み完了: ${this.favoriteArticles.length}件`);
                } catch (error) {
                    console.error('お気に入り記事読み込みエラー:', error);
                    this.favoriteArticles = [];
                }
            }
            
            setupEventListeners() {
                // 検索入力
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', Utils.debounce((e) => {
                        this.currentFilters.search = e.target.value.trim();
                        this.applyFilters();
                    }, 300));
                }
                
                // フィルター変更
                ['categoryFilter', 'readStatusFilter', 'sortFilter'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', (e) => {
                            const filterType = id.replace('Filter', '');
                            this.currentFilters[filterType === 'readStatus' ? 'readStatus' : 
                                              filterType === 'sort' ? 'sort' : 'category'] = e.target.value;
                            this.applyFilters();
                        });
                    }
                });
                
                // 一括操作
                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                if (bulkSelectBtn) {
                    bulkSelectBtn.addEventListener('click', () => {
                        this.toggleBulkMode();
                    });
                }
                
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.addEventListener('click', () => {
                        this.bulkDeleteSelected();
                    });
                }
                
                // エクスポート
                const exportBtn = document.getElementById('exportBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportFavorites();
                    });
                }
            }
            
            updateFilters() {
                // カテゴリフィルター更新
                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    const categories = [...new Set(this.favoriteArticles.map(article => article.category))];
                    categoryFilter.innerHTML = '<option value="all">全カテゴリ</option>' +
                        categories.map(cat => `<option value="${cat}">${Utils.sanitizeHTML(cat)}</option>`).join('');
                }
            }
            
            applyFilters() {
                try {
                    let filtered = [...this.favoriteArticles];
                    
                    // カテゴリフィルター
                    if (this.currentFilters.category !== 'all') {
                        filtered = filtered.filter(article => article.category === this.currentFilters.category);
                    }
                    
                    // 既読状態フィルター
                    if (this.currentFilters.readStatus !== 'all') {
                        filtered = filtered.filter(article => {
                            if (this.currentFilters.readStatus === 'unread') {
                                return article.readStatus !== 'read';
                            } else if (this.currentFilters.readStatus === 'read') {
                                return article.readStatus === 'read';
                            }
                            return true;
                        });
                    }
                    
                    // 検索フィルター
                    if (this.currentFilters.search) {
                        const query = this.currentFilters.search.toLowerCase();
                        filtered = filtered.filter(article =>
                            article.title.toLowerCase().includes(query) ||
                            article.excerpt.toLowerCase().includes(query) ||
                            article.domain.toLowerCase().includes(query)
                        );
                    }
                    
                    // ソート
                    this.applySorting(filtered);
                    
                    this.filteredArticles = filtered;
                    this.updateUI();
                    this.updateDisplayCount();
                    
                } catch (error) {
                    console.error('フィルター適用エラー:', error);
                    this.filteredArticles = this.favoriteArticles;
                    this.updateUI();
                }
            }
            
            applySorting(articles) {
                articles.sort((a, b) => {
                    switch (this.currentFilters.sort) {
                        case 'date_desc':
                            return new Date(b.addedDate || b.publishDate) - new Date(a.addedDate || a.publishDate);
                        case 'date_asc':
                            return new Date(a.addedDate || a.publishDate) - new Date(b.addedDate || b.publishDate);
                        case 'interest_desc':
                            return (b.interestScore || 50) - (a.interestScore || 50);
                        case 'interest_asc':
                            return (a.interestScore || 50) - (b.interestScore || 50);
                        case 'title':
                            return a.title.localeCompare(b.title);
                        default:
                            return 0;
                    }
                });
            }
            
            updateUI() {
                const grid = document.getElementById('favoritesGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (!grid) return;
                
                if (this.filteredArticles.length === 0) {
                    if (emptyState) {
                        emptyState.style.display = 'block';
                    }
                    return;
                }
                
                if (emptyState) {
                    emptyState.style.display = 'none';
                }
                
                // お気に入り記事カード生成
                grid.innerHTML = this.filteredArticles.map(article => this.createFavoriteCardHTML(article)).join('');
                
                // イベントリスナー再設定
                this.attachCardListeners();
                
                // 一括選択モード反映
                if (this.bulkMode) {
                    document.body.classList.add('bulk-mode');
                }
            }
            
            createFavoriteCardHTML(article) {
                const formattedDate = Utils.formatDate(article.addedDate || article.publishDate, 'relative');
                const interestScore = article.interestScore || 50;
                const keywords = article.matchedKeywords || [];
                const isSelected = this.selectedArticles.has(article.articleId);
                
                return `
                    <div class="favorite-card ${isSelected ? 'selected' : ''}" data-article-id="${article.articleId}">
                        <input type="checkbox" class="card-checkbox" ${isSelected ? 'checked' : ''}>
                        
                        <div class="favorite-header">
                            <div class="favorite-score">${interestScore}点</div>
                            <div class="favorite-date">${formattedDate}</div>
                        </div>
                        
                        <h3 class="favorite-title">${Utils.sanitizeHTML(article.title)}</h3>
                        
                        <p class="favorite-excerpt">${Utils.sanitizeHTML(article.excerpt || '')}</p>
                        
                        <div class="favorite-meta">
                            <span class="meta-domain">${Utils.sanitizeHTML(article.domain)}</span>
                            <span class="meta-category">${Utils.sanitizeHTML(article.category || 'その他')}</span>
                        </div>
                        
                        ${keywords.length > 0 ? `
                        <div class="favorite-keywords">
                            ${keywords.slice(0, 5).map(keyword => 
                                `<span class="keyword-tag">${Utils.sanitizeHTML(keyword)}</span>`
                            ).join('')}
                            ${keywords.length > 5 ? `<span class="keyword-tag">+${keywords.length - 5}個</span>` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="favorite-actions">
                            <button class="read-btn" data-action="read">📖 記事を読む</button>
                            <button class="remove-btn" data-action="remove" title="お気に入りから削除">🗑️</button>
                        </div>
                    </div>
                `;
            }
            
            attachCardListeners() {
                const cards = document.querySelectorAll('.favorite-card');
                
                cards.forEach(card => {
                    const articleId = card.dataset.articleId;
                    
                    // カードクリック（一括選択モード時）
                    card.addEventListener('click', (e) => {
                        if (this.bulkMode && !e.target.closest('.favorite-actions')) {
                            this.toggleCardSelection(articleId);
                        }
                    });
                    
                    // チェックボックス
                    const checkbox = card.querySelector('.card-checkbox');
                    if (checkbox) {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            this.toggleCardSelection(articleId);
                        });
                    }
                    
                    // アクションボタン
                    const actionButtons = card.querySelectorAll('[data-action]');
                    actionButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const action = btn.dataset.action;
                            this.handleCardAction(articleId, action);
                        });
                    });
                });
            }
            
            async handleCardAction(articleId, action) {
                try {
                    const article = this.favoriteArticles.find(a => a.articleId === articleId);
                    if (!article) return;
                    
                    switch (action) {
                        case 'read':
                            await this.openArticle(article);
                            break;
                        case 'remove':
                            await this.removeFavorite(articleId);
                            break;
                    }
                } catch (error) {
                    console.error('カードアクションエラー:', error);
                    this.showNotification('操作でエラーが発生しました', 'error');
                }
            }
            
            async openArticle(article) {
                try {
                    // 既読状態に更新
                    if (article.readStatus !== 'read') {
                        await this.dataManager.updateArticle(article.articleId, { readStatus: 'read' });
                        article.readStatus = 'read';
                        this.updateStats();
                    }
                    
                    // 新しいタブで記事を開く
                    window.open(article.url, '_blank', 'noopener,noreferrer');
                    
                } catch (error) {
                    console.error('記事オープンエラー:', error);
                    this.showNotification('記事を開けませんでした', 'error');
                }
            }
            
            async removeFavorite(articleId) {
                try {
                    if (!confirm('この記事をお気に入りから削除しますか？')) {
                        return;
                    }
                    
                    // データ更新
                    await this.dataManager.updateArticle(articleId, { favorited: false });
                    
                    // ローカルデータ更新
                    this.favoriteArticles = this.favoriteArticles.filter(a => a.articleId !== articleId);
                    this.selectedArticles.delete(articleId);
                    
                    // UI更新
                    this.applyFilters();
                    this.updateStats();
                    
                    this.showNotification('お気に入りから削除しました', 'success');
                    
                } catch (error) {
                    console.error('お気に入り削除エラー:', error);
                    this.showNotification('削除に失敗しました', 'error');
                }
            }
            
            toggleBulkMode() {
                this.bulkMode = !this.bulkMode;
                const bulkSelectBtn = document.getElementById('bulkSelectBtn');
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                
                if (this.bulkMode) {
                    document.body.classList.add('bulk-mode');
                    if (bulkSelectBtn) {
                        bulkSelectBtn.textContent = '選択終了';
                        bulkSelectBtn.classList.add('active');
                    }
                } else {
                    document.body.classList.remove('bulk-mode');
                    this.selectedArticles.clear();
                    if (bulkSelectBtn) {
                        bulkSelectBtn.textContent = '一括選択';
                        bulkSelectBtn.classList.remove('active');
                    }
                    this.updateUI();
                }
                
                this.updateBulkActions();
            }
            
            toggleCardSelection(articleId) {
                if (this.selectedArticles.has(articleId)) {
                    this.selectedArticles.delete(articleId);
                } else {
                    this.selectedArticles.add(articleId);
                }
                
                this.updateUI();
                this.updateBulkActions();
            }
            
            updateBulkActions() {
                const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                if (bulkDeleteBtn) {
                    if (this.selectedArticles.size > 0) {
                        bulkDeleteBtn.classList.add('enabled');
                        bulkDeleteBtn.textContent = `選択削除 (${this.selectedArticles.size})`;
                    } else {
                        bulkDeleteBtn.classList.remove('enabled');
                        bulkDeleteBtn.textContent = '選択削除';
                    }
                }
            }
            
            async bulkDeleteSelected() {
                try {
                    if (this.selectedArticles.size === 0) return;
                    
                    const count = this.selectedArticles.size;
                    if (!confirm(`選択した${count}件の記事をお気に入りから削除しますか？`)) {
                        return;
                    }
                    
                    // 一括削除処理
                    const deletePromises = Array.from(this.selectedArticles).map(articleId =>
                        this.dataManager.updateArticle(articleId, { favorited: false })
                    );
                    
                    await Promise.all(deletePromises);
                    
                    // ローカルデータ更新
                    this.favoriteArticles = this.favoriteArticles.filter(a => !this.selectedArticles.has(a.articleId));
                    this.selectedArticles.clear();
                    
                    // UI更新
                    this.applyFilters();
                    this.updateStats();
                    this.updateBulkActions();
                    
                    this.showNotification(`${count}件の記事をお気に入りから削除しました`, 'success');
                    
                } catch (error) {
                    console.error('一括削除エラー:', error);
                    this.showNotification('一括削除に失敗しました', 'error');
                }
            }
            
            async exportFavorites() {
                try {
                    const exportData = {
                        exportDate: new Date().toISOString(),
                        totalCount: this.favoriteArticles.length,
                        favorites: this.favoriteArticles.map(article => ({
                            title: article.title,
                            url: article.url,
                            domain: article.domain,
                            category: article.category,
                            interestScore: article.interestScore,
                            publishDate: article.publishDate,
                            addedDate: article.addedDate,
                            readStatus: article.readStatus,
                            matchedKeywords: article.matchedKeywords
                        }))
                    };
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `favorites_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('お気に入りをエクスポートしました', 'success');
                    
                } catch (error) {
                    console.error('エクスポートエラー:', error);
                    this.showNotification('エクスポートに失敗しました', 'error');
                }
            }
            
            updateStats() {
                try {
                    const total = this.favoriteArticles.length;
                    const unread = this.favoriteArticles.filter(a => a.readStatus !== 'read').length;
                    const categories = new Set(this.favoriteArticles.map(a => a.category)).size;
                    const avgScore = total > 0 ? 
                        Math.round(this.favoriteArticles.reduce((sum, a) => sum + (a.interestScore || 50), 0) / total) : 0;
                    
                    // UI更新
                    const elements = {
                        totalFavoritesCount: total,
                        unreadFavoritesCount: unread,
                        categoriesCount: categories,
                        avgInterestScore: avgScore
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                    
                } catch (error) {
                    console.error('統計更新エラー:', error);
                }
            }
            
            updateDisplayCount() {
                const displayElement = document.getElementById('displayCount');
                const badgeElement = document.getElementById('countBadge');
                
                if (displayElement) {
                    const total = this.favoriteArticles.length;
                    const filtered = this.filteredArticles.length;
                    
                    if (filtered === total) {
                        displayElement.textContent = `${total}件のお気に入り記事`;
                    } else {
                        displayElement.textContent = `${filtered}件のお気に入り記事（全${total}件中）`;
                    }
                }
                
                if (badgeElement) {
                    badgeElement.textContent = this.filteredArticles.length;
                }
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                // グローバル通知関数を利用
                if (window.yourNewsApp && window.yourNewsApp.showNotification) {
                    window.yourNewsApp.showNotification(message, type, duration);
                } else {
                    // フォールバック
                    console.log(`${type.toUpperCase()}: ${message}`);
                    alert(message);
                }
            }
        }
        
        // 初期化
        let favoritesManager;
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                favoritesManager = new FavoritesManager();
                await favoritesManager.initialize();
            } catch (error) {
                console.error('お気に入り画面初期化エラー:', error);
            }
        });
        
        // グローバル公開（デバッグ用）
        window.favoritesManager = () => favoritesManager;
    </script>
</body>
</html>
