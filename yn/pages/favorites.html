<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="お気に入り画面 - あなたのニュース">
    <title>お気に入り - あなたのニュース</title>
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="../assets/manifest.json">
    
    <!-- TensorFlow.js CDN（仕様書指定v4.10.0） -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/themes.css">
    
    <!-- お気に入り画面専用スタイル -->
    <style>
        .favorites-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .favorites-header {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .favorites-title {
            color: #333;
            margin: 0 0 1rem 0;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .favorites-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            min-width: 100px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
        
        .favorites-controls {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-filter-group {
            display: flex;
            gap: 1rem;
            flex: 1;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33,150,243,0.2);
        }
        
        .filter-select {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 1rem;
            min-width: 150px;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .bulk-select-all {
            transform: scale(1.2);
            margin-right: 0.5rem;
        }
        
        .bulk-btn {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .bulk-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .bulk-remove-btn {
            background: #f44336;
            color: white;
        }
        
        .bulk-remove-btn:hover:not(:disabled) {
            background: #d32f2f;
        }
        
        .bulk-export-btn {
            background: #4CAF50;
            color: white;
        }
        
        .bulk-export-btn:hover:not(:disabled) {
            background: #388E3C;
        }
        
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .sort-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .sort-btn:hover:not(.active) {
            background: #f5f5f5;
        }
        
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .favorite-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .favorite-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .favorite-card.selected {
            border: 2px solid #2196F3;
            box-shadow: 0 0 0 2px rgba(33,150,243,0.2);
        }
        
        .card-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            transform: scale(1.2);
        }
        
        .card-added-date {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            z-index: 10;
        }
        
        .card-thumbnail {
            height: 180px;
            background: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        
        .card-image.lazy {
            opacity: 0;
        }
        
        .thumbnail-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: #ccc;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 0.8rem 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            cursor: pointer;
        }
        
        .card-title:hover {
            color: #2196F3;
        }
        
        .card-excerpt {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0 0 1rem 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #999;
        }
        
        .card-domain {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .card-publish-date {
            color: #666;
        }
        
        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        .card-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .tag {
            background: #f5f5f5;
            color: #666;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .tag.category {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .tag.interest-score {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }
        
        .card-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .card-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .read-btn {
            background: #2196F3;
            color: white;
        }
        
        .read-btn:hover {
            background: #1976D2;
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
        }
        
        .remove-btn:hover {
            background: #d32f2f;
        }
        
        .share-btn {
            background: #4CAF50;
            color: white;
        }
        
        .share-btn:hover {
            background: #388E3C;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .empty-state-icon {
            font-size: 6rem;
            margin-bottom: 2rem;
            display: block;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin: 0 0 1rem 0;
            color: #999;
        }
        
        .empty-state p {
            font-size: 1rem;
            margin: 0 0 2rem 0;
            line-height: 1.6;
        }
        
        .goto-main-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .goto-main-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            padding: 1rem;
        }
        
        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #f5f5f5;
        }
        
        .page-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            color: #666;
            font-size: 0.9rem;
            margin: 0 1rem;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            .favorites-container {
                padding: 1rem;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-filter-group {
                flex-direction: column;
            }
            
            .search-box {
                min-width: unset;
            }
            
            .favorites-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .favorites-stats {
                gap: 1rem;
                justify-content: space-between;
            }
            
            .stat-item {
                min-width: 80px;
                padding: 0.8rem;
            }
            
            .bulk-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .sort-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .card-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .card-buttons {
                justify-content: space-between;
            }
            
            .card-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー（ナビゲーション） -->
    <header class="main-header">
        <div class="header-container">
            <h1 class="app-title">あなたのニュース - お気に入り</h1>
            <nav class="main-nav">
                <button class="nav-btn" onclick="location.href='../index.html'">記事一覧</button>
                <button class="nav-btn" onclick="location.href='rss-manager.html'">RSS管理</button>
                <button class="nav-btn active">お気に入り</button>
                <button class="nav-btn" onclick="location.href='settings.html'">設定</button>
            </nav>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="favorites-container">
        <!-- お気に入り統計ヘッダー -->
        <section class="favorites-header">
            <h2 class="favorites-title">📖 保存した記事</h2>
            <div class="favorites-stats" id="favoritesStats">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">保存済み記事</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unreadCount">0</div>
                    <div class="stat-label">未読記事</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="categoryCount">0</div>
                    <div class="stat-label">カテゴリ数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="thisWeekCount">0</div>
                    <div class="stat-label">今週保存</div>
                </div>
            </div>
        </section>

        <!-- 検索・フィルター・操作パネル -->
        <section class="favorites-controls">
            <div class="controls-row">
                <div class="search-filter-group">
                    <input 
                        type="text" 
                        class="search-box" 
                        id="searchBox"
                        placeholder="記事タイトルや内容で検索..."
                    >
                    <select class="filter-select" id="categoryFilter">
                        <option value="">全カテゴリ</option>
                    </select>
                    <select class="filter-select" id="readStatusFilter">
                        <option value="">全ての記事</option>
                        <option value="unread">未読のみ</option>
                        <option value="read">既読のみ</option>
                    </select>
                </div>
                
                <div class="bulk-actions">
                    <input type="checkbox" class="bulk-select-all" id="selectAll">
                    <button class="bulk-btn bulk-remove-btn" id="bulkRemoveBtn" disabled>
                        削除
                    </button>
                    <button class="bulk-btn bulk-export-btn" id="bulkExportBtn" disabled>
                        エクスポート
                    </button>
                </div>
            </div>
            
            <div class="controls-row">
                <div class="sort-controls">
                    <span style="margin-right: 1rem; color: #666;">並び順:</span>
                    <button class="sort-btn active" data-sort="savedDate">保存日時</button>
                    <button class="sort-btn" data-sort="publishDate">公開日時</button>
                    <button class="sort-btn" data-sort="interestScore">興味度</button>
                    <button class="sort-btn" data-sort="title">タイトル</button>
                    <button class="sort-btn" data-sort="domain">ドメイン</button>
                </div>
                
                <div class="bulk-actions">
                    <span id="selectedCount">0</span>件選択中
                </div>
            </div>
        </section>

        <!-- お気に入り記事一覧 -->
        <section class="favorites-grid" id="favoritesGrid">
            <!-- 動的に生成される記事カード -->
        </section>

        <!-- 空状態表示 -->
        <section class="empty-state" id="emptyState" style="display: none;">
            <span class="empty-state-icon">⭐</span>
            <h3>保存した記事がありません</h3>
            <p>
                気になる記事を見つけたら「⭐」ボタンをクリックして保存しましょう。<br>
                保存した記事はここで後からゆっくり読むことができます。
            </p>
            <button class="goto-main-btn" onclick="location.href='../index.html'">
                記事を探しに行く
            </button>
        </section>

        <!-- ページネーション -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="prevPageBtn">‹ 前へ</button>
            <span class="page-info" id="pageInfo">1 / 1</span>
            <button class="page-btn" id="nextPageBtn">次へ ›</button>
        </div>
    </main>

    <!-- エラー通知エリア -->
    <div class="notification-area" id="notificationArea"></div>

    <!-- スクリプト読み込み -->
    <script src="../scripts/data-manager.js"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/article-card.js"></script>
    
    <!-- お気に入り画面専用スクリプト -->
    <script>
        class FavoritesManager {
            constructor() {
                this.dataManager = null;
                this.articleCard = null;
                this.currentPage = 1;
                this.itemsPerPage = 12;
                this.currentSort = 'savedDate';
                this.currentFilters = {
                    search: '',
                    category: '',
                    readStatus: ''
                };
                this.selectedItems = new Set();
                this.allFavorites = [];
                this.filteredFavorites = [];
            }
            
            async initialize() {
                try {
                    console.log('Favorites Manager初期化開始');
                    
                    // 依存クラス初期化
                    this.dataManager = new DataManager();
                    await this.dataManager.initialize();
                    
                    this.articleCard = new ArticleCard();
                    
                    // イベントリスナー設定
                    this.setupEventListeners();
                    
                    // データ読み込み・表示
                    await this.loadAndDisplayFavorites();
                    
                    console.log('Favorites Manager初期化完了');
                    
                } catch (error) {
                    console.error('Favorites Manager初期化エラー:', error);
                    this.showNotification('お気に入り画面の初期化に失敗しました', 'error');
                }
            }
            
            setupEventListeners() {
                try {
                    // 検索ボックス
                    const searchBox = document.getElementById('searchBox');
                    if (searchBox) {
                        searchBox.addEventListener('input', 
                            this.debounce(() => {
                                this.currentFilters.search = searchBox.value.trim();
                                this.applyFilters();
                            }, 300)
                        );
                    }
                    
                    // フィルター選択
                    const categoryFilter = document.getElementById('categoryFilter');
                    if (categoryFilter) {
                        categoryFilter.addEventListener('change', (e) => {
                            this.currentFilters.category = e.target.value;
                            this.applyFilters();
                        });
                    }
                    
                    const readStatusFilter = document.getElementById('readStatusFilter');
                    if (readStatusFilter) {
                        readStatusFilter.addEventListener('change', (e) => {
                            this.currentFilters.readStatus = e.target.value;
                            this.applyFilters();
                        });
                    }
                    
                    // ソートボタン
                    const sortButtons = document.querySelectorAll('.sort-btn');
                    sortButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            // アクティブ状態更新
                            sortButtons.forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            
                            this.currentSort = e.target.dataset.sort;
                            this.applySorting();
                        });
                    });
                    
                    // 全選択チェックボックス
                    const selectAll = document.getElementById('selectAll');
                    if (selectAll) {
                        selectAll.addEventListener('change', (e) => {
                            this.toggleSelectAll(e.target.checked);
                        });
                    }
                    
                    // 一括操作ボタン
                    const bulkRemoveBtn = document.getElementById('bulkRemoveBtn');
                    if (bulkRemoveBtn) {
                        bulkRemoveBtn.addEventListener('click', () => {
                            this.bulkRemoveFavorites();
                        });
                    }
                    
                    const bulkExportBtn = document.getElementById('bulkExportBtn');
                    if (bulkExportBtn) {
                        bulkExportBtn.addEventListener('click', () => {
                            this.bulkExportFavorites();
                        });
                    }
                    
                    // ページネーション
                    const prevPageBtn = document.getElementById('prevPageBtn');
                    if (prevPageBtn) {
                        prevPageBtn.addEventListener('click', () => {
                            if (this.currentPage > 1) {
                                this.currentPage--;
                                this.renderFavorites();
                                this.updatePagination();
                            }
                        });
                    }
                    
                    const nextPageBtn = document.getElementById('nextPageBtn');
                    if (nextPageBtn) {
                        nextPageBtn.addEventListener('click', () => {
                            const totalPages = Math.ceil(this.filteredFavorites.length / this.itemsPerPage);
                            if (this.currentPage < totalPages) {
                                this.currentPage++;
                                this.renderFavorites();
                                this.updatePagination();
                            }
                        });
                    }
                    
                    console.log('Favorites Manager イベントリスナー設定完了');
                    
                } catch (error) {
                    console.error('イベントリスナー設定エラー:', error);
                }
            }
            
            async loadAndDisplayFavorites() {
                try {
                    // 全記事データ読み込み
                    const allArticles = await this.dataManager.loadArticles();
                    
                    // お気に入り記事のみ抽出
                    this.allFavorites = allArticles.filter(article => article.favorited);
                    
                    // 保存日時を追加（存在しない場合は現在時刻）
                    this.allFavorites.forEach(article => {
                        if (!article.savedDate) {
                            article.savedDate = article.publishDate || new Date().toISOString();
                        }
                    });
                    
                    // カテゴリフィルター更新
                    this.updateCategoryFilter();
                    
                    // 統計情報更新
                    this.updateStats();
                    
                    // フィルタリング・表示
                    this.applyFilters();
                    
                    console.log(`お気に入り記事読み込み完了: ${this.allFavorites.length}件`);
                    
                } catch (error) {
                    console.error('お気に入り読み込みエラー:', error);
                    this.showNotification('お気に入り記事の読み込みに失敗しました', 'error');
                }
            }
            
            updateCategoryFilter() {
                const categoryFilter = document.getElementById('categoryFilter');
                if (!categoryFilter) return;
                
                // 既存オプションをクリア（最初のオプション以外）
                while (categoryFilter.children.length > 1) {
                    categoryFilter.removeChild(categoryFilter.lastChild);
                }
                
                // カテゴリ抽出
                const categories = [...new Set(
                    this.allFavorites.map(article => article.category).filter(Boolean)
                )].sort();
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }
            
            updateStats() {
                try {
                    const now = new Date();
                    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    
                    const totalCount = this.allFavorites.length;
                    const unreadCount = this.allFavorites.filter(article => 
                        article.readStatus !== 'read').length;
                    const categoryCount = new Set(
                        this.allFavorites.map(article => article.category).filter(Boolean)
                    ).size;
                    const thisWeekCount = this.allFavorites.filter(article => {
                        const savedDate = new Date(article.savedDate || article.publishDate);
                        return savedDate >= oneWeekAgo;
                    }).length;
                    
                    // DOM更新
                    const updateStat = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    };
                    
                    updateStat('totalCount', totalCount);
                    updateStat('unreadCount', unreadCount);
                    updateStat('categoryCount', categoryCount);
                    updateStat('thisWeekCount', thisWeekCount);
                    
                } catch (error) {
                    console.error('統計更新エラー:', error);
                }
            }
            
            applyFilters() {
                try {
                    let filtered = [...this.allFavorites];
                    
                    // 検索フィルター
                    if (this.currentFilters.search) {
                        const query = this.currentFilters.search.toLowerCase();
                        filtered = filtered.filter(article =>
                            article.title.toLowerCase().includes(query) ||
                            article.excerpt.toLowerCase().includes(query) ||
                            article.domain.toLowerCase().includes(query)
                        );
                    }
                    
                    // カテゴリフィルター
                    if (this.currentFilters.category) {
                        filtered = filtered.filter(article =>
                            article.category === this.currentFilters.category
                        );
                    }
                    
                    // 既読状態フィルター
                    if (this.currentFilters.readStatus) {
                        if (this.currentFilters.readStatus === 'unread') {
                            filtered = filtered.filter(article => 
                                article.readStatus !== 'read');
                        } else if (this.currentFilters.readStatus === 'read') {
                            filtered = filtered.filter(article => 
                                article.readStatus === 'read');
                        }
                    }
                    
                    this.filteredFavorites = filtered;
                    this.currentPage = 1; // フィルター適用時は1ページ目に戻る
                    
                    this.applySorting();
                    
                } catch (error) {
                    console.error('フィルター適用エラー:', error);
                }
            }
            
            applySorting() {
                try {
                    this.filteredFavorites.sort((a, b) => {
                        switch (this.currentSort) {
                            case 'savedDate':
                                return new Date(b.savedDate || b.publishDate) - 
                                       new Date(a.savedDate || a.publishDate);
                            
                            case 'publishDate':
                                return new Date(b.publishDate) - new Date(a.publishDate);
                            
                            case 'interestScore':
                                return (b.interestScore || 50) - (a.interestScore || 50);
                            
                            case 'title':
                                return a.title.localeCompare(b.title, 'ja');
                            
                            case 'domain':
                                return a.domain.localeCompare(b.domain);
                            
                            default:
                                return 0;
                        }
                    });
                    
                    this.renderFavorites();
                    this.updatePagination();
                    
                } catch (error) {
                    console.error('ソート適用エラー:', error);
                }
            }
            
            renderFavorites() {
                const grid = document.getElementById('favoritesGrid');
                const emptyState = document.getElementById('emptyState');
                
                if (!grid) return;
                
                // 空状態チェック
                if (this.filteredFavorites.length === 0) {
                    grid.style.display = 'none';
                    if (emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                grid.style.display = 'grid';
                if (emptyState) emptyState.style.display = 'none';
                
                // ページング計算
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageItems = this.filteredFavorites.slice(startIndex, endIndex);
                
                // カード生成
                grid.innerHTML = pageItems.map(article => this.createFavoriteCardHTML(article)).join('');
                
                // イベントリスナー再設定
                this.attachCardEventListeners();
            }
            
            createFavoriteCardHTML(article) {
                try {
                    const savedDate = this.formatDate(article.savedDate || article.publishDate);
                    const publishDate = this.formatDate(article.publishDate);
                    const excerpt = article.excerpt || '内容なし';
                    const interestScore = article.interestScore || 50;
                    
                    // 画像URL生成
                    const imageUrl = this.extractImageUrl(article.excerpt) || 
                                   this.createPlaceholderImage(article.domain);
                    
                    return `
                        <div class="favorite-card ${this.selectedItems.has(article.articleId) ? 'selected' : ''}" 
                             data-article-id="${article.articleId}">
                            
                            <input type="checkbox" class="card-checkbox" 
                                   data-article-id="${article.articleId}"
                                   ${this.selectedItems.has(article.articleId) ? 'checked' : ''}>
                            
                            <div class="card-added-date">${savedDate}</div>
                            
                            <div class="card-thumbnail">
                                <img class="card-image lazy" 
                                     data-src="${imageUrl}" 
                                     alt="${article.title}">
                                <div class="thumbnail-placeholder">📰</div>
                            </div>
                            
                            <div class="card-content">
                                <h3 class="card-title" onclick="favoritesManager.openArticle('${article.url}', '${article.articleId}')">
                                    ${this.sanitizeHTML(article.title)}
                                </h3>
                                
                                <p class="card-excerpt">${this.sanitizeHTML(excerpt)}</p>
                                
                                <div class="card-meta">
                                    <span class="card-domain">${article.domain}</span>
                                    <span class="card-publish-date">${publishDate}</span>
                                </div>
                                
                                <div class="card-actions">
                                    <div class="card-tags">
                                        ${article.category ? `<span class="tag category">${article.category}</span>` : ''}
                                        <span class="tag interest-score">${interestScore}点</span>
                                        ${article.readStatus === 'read' ? '<span class="tag">既読</span>' : '<span class="tag">未読</span>'}
                                    </div>
                                    
                                    <div class="card-buttons">
                                        <button class="card-btn read-btn" 
                                                onclick="favoritesManager.openArticle('${article.url}', '${article.articleId}')"
                                                title="記事を読む">
                                            📖
                                        </button>
                                        <button class="card-btn share-btn" 
                                                onclick="favoritesManager.shareArticle('${article.articleId}')"
                                                title="記事を共有">
                                            📤
                                        </button>
                                        <button class="card-btn remove-btn" 
                                                onclick="favoritesManager.removeFavorite('${article.articleId}')"
                                                title="お気に入りから削除">
                                            🗑️
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('カードHTML作成エラー:', error);
                    return '<div class="favorite-card">エラー: カード作成に失敗しました</div>';
                }
            }
            
            attachCardEventListeners() {
                try {
                    // チェックボックスイベント
                    const checkboxes = document.querySelectorAll('.card-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            const articleId = checkbox.dataset.articleId;
                            const isChecked = checkbox.checked;
                            
                            if (isChecked) {
                                this.selectedItems.add(articleId);
                            } else {
                                this.selectedItems.delete(articleId);
                            }
                            
                            this.updateSelectionUI();
                            this.updateCardSelection(articleId, isChecked);
                        });
                    });
                    
                    // 遅延画像読み込み
                    const lazyImages = document.querySelectorAll('.card-image.lazy');
                    lazyImages.forEach(img => {
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            img.onload = () => {
                                const placeholder = img.parentElement.querySelector('.thumbnail-placeholder');
                                if (placeholder) placeholder.style.display = 'none';
                            };
                        }
                    });
                    
                } catch (error) {
                    console.error('カードイベントリスナー設定エラー:', error);
                }
            }
            
            updateSelectionUI() {
                const selectedCount = document.getElementById('selectedCount');
                const bulkRemoveBtn = document.getElementById('bulkRemoveBtn');
                const bulkExportBtn = document.getElementById('bulkExportBtn');
                const selectAllCheckbox = document.getElementById('selectAll');
                
                if (selectedCount) {
                    selectedCount.textContent = this.selectedItems.size;
                }
                
                const hasSelection = this.selectedItems.size > 0;
                if (bulkRemoveBtn) bulkRemoveBtn.disabled = !hasSelection;
                if (bulkExportBtn) bulkExportBtn.disabled = !hasSelection;
                
                // 全選択チェックボックスの状態更新
                if (selectAllCheckbox) {
                    const visibleCards = document.querySelectorAll('.favorite-card');
                    const visibleCount = visibleCards.length;
                    const selectedVisibleCount = Array.from(visibleCards)
                        .filter(card => this.selectedItems.has(card.dataset.articleId)).length;
                    
                    selectAllCheckbox.checked = visibleCount > 0 && selectedVisibleCount === visibleCount;
                    selectAllCheckbox.indeterminate = selectedVisibleCount > 0 && selectedVisibleCount < visibleCount;
                }
            }
            
            updateCardSelection(articleId, isSelected) {
                const card = document.querySelector(`[data-article-id="${articleId}"]`);
                if (card) {
                    if (isSelected) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                }
            }
            
            toggleSelectAll(checked) {
                const visibleCards = document.querySelectorAll('.favorite-card');
                
                visibleCards.forEach(card => {
                    const articleId = card.dataset.articleId;
                    const checkbox = card.querySelector('.card-checkbox');
                    
                    if (checked) {
                        this.selectedItems.add(articleId);
                        if (checkbox) checkbox.checked = true;
                        card.classList.add('selected');
                    } else {
                        this.selectedItems.delete(articleId);
                        if (checkbox) checkbox.checked = false;
                        card.classList.remove('selected');
                    }
                });
                
                this.updateSelectionUI();
            }
            
            updatePagination() {
                const pagination = document.getElementById('pagination');
                const pageInfo = document.getElementById('pageInfo');
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                
                if (!pagination) return;
                
                const totalPages = Math.ceil(this.filteredFavorites.length / this.itemsPerPage);
                
                if (totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }
                
                pagination.style.display = 'flex';
                
                if (pageInfo) {
                    pageInfo.textContent = `${this.currentPage} / ${totalPages}`;
                }
                
                if (prevBtn) {
                    prevBtn.disabled = this.currentPage <= 1;
                }
                
                if (nextBtn) {
                    nextBtn.disabled = this.currentPage >= totalPages;
                }
            }
            
            async openArticle(url, articleId) {
                try {
                    // 既読状態に更新
                    if (articleId) {
                        const articles = await this.dataManager.loadArticles();
                        const articleIndex = articles.findIndex(a => a.articleId === articleId);
                        
                        if (articleIndex !== -1) {
                            articles[articleIndex].readStatus = 'read';
                            await this.dataManager.saveArticles(articles);
                            
                            // ローカルデータも更新
                            const localArticle = this.allFavorites.find(a => a.articleId === articleId);
                            if (localArticle) {
                                localArticle.readStatus = 'read';
                            }
                            
                            // 統計更新
                            this.updateStats();
                            
                            // 表示更新
                            this.renderFavorites();
                        }
                    }
                    
                    // 新しいタブで開く
                    window.open(url, '_blank', 'noopener,noreferrer');
                    
                } catch (error) {
                    console.error('記事オープンエラー:', error);
                    this.showNotification('記事を開けませんでした', 'error');
                }
            }
            
            async shareArticle(articleId) {
                try {
                    const article = this.allFavorites.find(a => a.articleId === articleId);
                    if (!article) return;
                    
                    if (navigator.share) {
                        // Web Share API利用
                        await navigator.share({
                            title: article.title,
                            text: article.excerpt,
                            url: article.url
                        });
                    } else {
                        // フォールバック: クリップボードにコピー
                        const shareText = `${article.title}\n${article.url}`;
                        await navigator.clipboard.writeText(shareText);
                        this.showNotification('記事URLをクリップボードにコピーしました', 'success');
                    }
                    
                } catch (error) {
                    console.error('記事共有エラー:', error);
                    this.showNotification('記事の共有に失敗しました', 'error');
                }
            }
            
            async removeFavorite(articleId) {
                if (!confirm('この記事をお気に入りから削除しますか？')) return;
                
                try {
                    // データ更新
                    const articles = await this.dataManager.loadArticles();
                    const articleIndex = articles.findIndex(a => a.articleId === articleId);
                    
                    if (articleIndex !== -1) {
                        articles[articleIndex].favorited = false;
                        await this.dataManager.saveArticles(articles);
                        
                        // ローカルデータからも削除
                        this.allFavorites = this.allFavorites.filter(a => a.articleId !== articleId);
                        
                        // 選択状態からも削除
                        this.selectedItems.delete(articleId);
                        
                        // 表示更新
                        this.updateStats();
                        this.applyFilters();
                        this.updateSelectionUI();
                        
                        this.showNotification('お気に入りから削除しました', 'success');
                    }
                    
                } catch (error) {
                    console.error('お気に入り削除エラー:', error);
                    this.showNotification('削除に失敗しました', 'error');
                }
            }
            
            async bulkRemoveFavorites() {
                if (this.selectedItems.size === 0) return;
                
                if (!confirm(`選択した${this.selectedItems.size}件の記事をお気に入りから削除しますか？`)) {
                    return;
                }
                
                try {
                    const articles = await this.dataManager.loadArticles();
                    let removedCount = 0;
                    
                    // 選択された記事のお気に入りを解除
                    articles.forEach(article => {
                        if (this.selectedItems.has(article.articleId)) {
                            article.favorited = false;
                            removedCount++;
                        }
                    });
                    
                    await this.dataManager.saveArticles(articles);
                    
                    // ローカルデータ更新
                    this.allFavorites = this.allFavorites.filter(a => 
                        !this.selectedItems.has(a.articleId));
                    
                    // 選択状態クリア
                    this.selectedItems.clear();
                    
                    // 表示更新
                    this.updateStats();
                    this.applyFilters();
                    this.updateSelectionUI();
                    
                    this.showNotification(`${removedCount}件の記事を削除しました`, 'success');
                    
                } catch (error) {
                    console.error('一括削除エラー:', error);
                    this.showNotification('削除に失敗しました', 'error');
                }
            }
            
            async bulkExportFavorites() {
                if (this.selectedItems.size === 0) return;
                
                try {
                    const selectedArticles = this.allFavorites.filter(article => 
                        this.selectedItems.has(article.articleId));
                    
                    const exportData = {
                        exportDate: new Date().toISOString(),
                        count: selectedArticles.length,
                        articles: selectedArticles.map(article => ({
                            title: article.title,
                            url: article.url,
                            domain: article.domain,
                            publishDate: article.publishDate,
                            savedDate: article.savedDate,
                            category: article.category,
                            excerpt: article.excerpt,
                            interestScore: article.interestScore
                        }))
                    };
                    
                    // JSON形式でダウンロード
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                        { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `favorites-export-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    this.showNotification(`${selectedArticles.length}件の記事をエクスポートしました`, 'success');
                    
                } catch (error) {
                    console.error('エクスポートエラー:', error);
                    this.showNotification('エクスポートに失敗しました', 'error');
                }
            }
            
            // ユーティリティ関数
            formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        return '今日';
                    } else if (diffDays === 1) {
                        return '昨日';
                    } else if (diffDays < 7) {
                        return `${diffDays}日前`;
                    } else {
                        return date.toLocaleDateString('ja-JP');
                    }
                } catch (error) {
                    return '不明';
                }
            }
            
            extractImageUrl(content) {
                if (!content) return null;
                
                try {
                    const imgRegex = /<img[^>]+src="([^">]+)"/i;
                    const match = content.match(imgRegex);
                    return match ? match[1] : null;
                } catch (error) {
                    return null;
                }
            }
            
            createPlaceholderImage(domain) {
                const cleanDomain = (domain || 'news').substring(0, 8);
                const svg = `
                    <svg width="350" height="180" xmlns="http://www.w3.org/2000/svg">
                        <rect width="350" height="180" fill="#f0f0f0"/>
                        <text x="175" y="90" text-anchor="middle" dominant-baseline="middle" 
                              font-family="Arial, sans-serif" font-size="16" fill="#999">
                            📰 ${cleanDomain}
                        </text>
                    </svg>
                `;
                
                return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
            }
            
            sanitizeHTML(text) {
                if (!text) return '';
                const temp = document.createElement('div');
                temp.textContent = text;
                return temp.innerHTML;
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                const notificationArea = document.getElementById('notificationArea');
                if (!notificationArea) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    ${message}
                    <button onclick="this.parentElement.remove()" 
                            style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; margin-left: 10px;">×</button>
                `;
                
                notificationArea.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }
        }
        
        // お気に入り画面初期化
        const favoritesManager = new FavoritesManager();
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await favoritesManager.initialize();
            } catch (error) {
                console.error('お気に入り画面初期化失敗:', error);
                
                // 初期化失敗時のフォールバック表示
                const grid = document.getElementById('favoritesGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #f44336;">
                            <h3>初期化エラー</h3>
                            <p>お気に入り画面の初期化に失敗しました</p>
                            <button onclick="location.reload()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">再読み込み</button>
                        </div>
                    `;
                }
            }
        });
        
        // デバッグ用関数
        window.debugFavoritesManager = function() {
            console.log('=== Favorites Manager Debug ===');
            console.log('Manager instance:', typeof favoritesManager !== 'undefined');
            console.log('All favorites count:', favoritesManager.allFavorites.length);
            console.log('Filtered favorites count:', favoritesManager.filteredFavorites.length);
            console.log('Selected items:', Array.from(favoritesManager.selectedItems));
            console.log('Current filters:', favoritesManager.currentFilters);
            console.log('Current sort:', favoritesManager.currentSort);
            console.log('Current page:', favoritesManager.currentPage);
            console.log('=== Favorites Manager Debug Complete ===');
        };
    </script>
</body>
</html>
