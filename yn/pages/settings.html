<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="設定管理 - あなたのニュース">
    <title>設定 - あなたのニュース</title>
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="../assets/manifest.json">
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/themes.css">
    
    <!-- 設定画面専用スタイル -->
    <style>
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #9C27B0;
        }
        
        .page-title {
            color: #9C27B0;
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .page-description {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .settings-sections {
            display: grid;
            gap: 2rem;
        }
        
        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .section-icon {
            font-size: 1.5rem;
        }
        
        .section-title {
            color: #333;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .section-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0.3rem 0 0 0;
            line-height: 1.4;
        }
        
        .setting-group {
            display: grid;
            gap: 1.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .setting-item:hover {
            background: #f8f9fa;
            border-color: #e0e0e0;
        }
        
        .setting-info {
            flex: 1;
            min-width: 0;
            margin-right: 1rem;
        }
        
        .setting-label {
            font-weight: 600;
            color: #333;
            margin: 0 0 0.3rem 0;
            font-size: 1rem;
        }
        
        .setting-help {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.4;
        }
        
        .setting-control {
            flex-shrink: 0;
        }
        
        /* トグルスイッチ */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ddd;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .toggle-switch.active::after {
            transform: translateX(30px);
        }
        
        /* 選択ボックス */
        .setting-select {
            padding: 0.6rem 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 150px;
        }
        
        .setting-select:focus {
            outline: none;
            border-color: #9C27B0;
        }
        
        /* 数値入力 */
        .setting-number {
            padding: 0.6rem 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            width: 100px;
            text-align: center;
        }
        
        .setting-number:focus {
            outline: none;
            border-color: #9C27B0;
        }
        
        /* テキスト入力エリア */
        .keywords-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            resize: vertical;
        }
        
        .keywords-input:focus {
            outline: none;
            border-color: #9C27B0;
        }
        
        .keywords-help {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }
        
        /* ボタン */
        .setting-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #9C27B0;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7B1FA2;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .btn-success {
            background: #4CAF50;
            color: white;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        /* アクションボタン群 */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        /* データ管理エリア */
        .data-stats {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        
        .stat-item {
            padding: 0.8rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #9C27B0;
            margin-bottom: 0.3rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* アップロード・ダウンロードエリア */
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            overflow: hidden;
        }
        
        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 0.7rem 1.5rem;
            background: #2196F3;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #1976D2;
        }
        
        /* テーマプレビュー */
        .theme-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .theme-option {
            padding: 1rem;
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }
        
        .theme-option:hover {
            border-color: #9C27B0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(156,39,176,0.2);
        }
        
        .theme-option.active {
            border-color: #9C27B0;
            background: #f3e5f5;
        }
        
        .theme-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .theme-colors {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }
        
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .theme-description {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* 確認ダイアログ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .confirm-dialog.show {
            opacity: 1;
            visibility: visible;
        }
        
        .confirm-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .confirm-dialog.show .confirm-content {
            transform: scale(1);
        }
        
        .confirm-title {
            color: #f44336;
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .confirm-message {
            margin: 0 0 2rem 0;
            line-height: 1.5;
            color: #333;
        }
        
        .confirm-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .settings-container {
                padding: 1rem;
            }
            
            .settings-section {
                padding: 1rem;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .setting-info {
                margin-right: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .theme-preview {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .page-title {
                font-size: 1.5rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .confirm-content {
                padding: 1.5rem;
            }
            
            .confirm-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            .settings-section {
                background: #2e2e2e;
                border-color: #444;
                color: #e0e0e0;
            }
            
            .setting-item {
                border-color: #444;
            }
            
            .setting-item:hover {
                background: #3a3a3a;
            }
            
            .setting-label {
                color: #e0e0e0;
            }
            
            .data-stats {
                background: #1a1a1a;
            }
            
            .stat-item {
                background: #2e2e2e;
                border-color: #444;
            }
            
            .theme-option {
                background: #2e2e2e;
                border-color: #444;
            }
            
            .theme-option.active {
                background: #3a3a3a;
                border-color: #BA68C8;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー（ナビゲーション） -->
    <header class="main-header">
        <div class="header-container">
            <h1 class="app-title">あなたのニュース - 設定</h1>
            <nav class="main-nav">
                <button class="nav-btn" onclick="location.href='../index.html'">記事一覧</button>
                <button class="nav-btn" onclick="location.href='rss-manager.html'">RSS管理</button>
                <button class="nav-btn" onclick="location.href='favorites.html'">お気に入り</button>
                <button class="nav-btn active">設定</button>
            </nav>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="settings-container">
        <!-- ページヘッダー -->
        <div class="page-header">
            <h1 class="page-title">
                <span>⚙️</span>
                <span>設定</span>
            </h1>
            <p class="page-description">
                アプリの動作設定・AI学習設定・データ管理を行います
            </p>
        </div>

        <!-- 設定セクション -->
        <div class="settings-sections">
            <!-- 基本設定 -->
            <section class="settings-section">
                <div class="section-header">
                    <span class="section-icon">📱</span>
                    <div>
                        <h2 class="section-title">基本設定</h2>
                        <p class="section-description">アプリの基本的な動作を設定します</p>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">自動更新</h3>
                            <p class="setting-help">RSS記事の自動取得機能を有効にします</p>
                        </div>
                        <div class="setting-control">
                            <div class="toggle-switch" id="autoRefreshToggle" data-setting="autoRefresh"></div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">更新間隔</h3>
                            <p class="setting-help">自動更新の間隔（分）</p>
                        </div>
                        <div class="setting-control">
                            <input type="number" class="setting-number" id="refreshInterval" 
                                   min="5" max="180" step="5" value="30">
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">1ページあたりの記事数</h3>
                            <p class="setting-help">一度に表示する記事の数</p>
                        </div>
                        <div class="setting-control">
                            <select class="setting-select" id="articlesPerPage">
                                <option value="20">20件</option>
                                <option value="50">50件</option>
                                <option value="100">100件</option>
                                <option value="200">200件</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">デフォルトソート</h3>
                            <p class="setting-help">記事一覧の初期並び順</p>
                        </div>
                        <div class="setting-control">
                            <select class="setting-select" id="defaultSort">
                                <option value="interest">AI興味度順</option>
                                <option value="date">更新日時順</option>
                                <option value="domain">ドメイン順</option>
                                <option value="keyword-match">キーワード一致度順</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">記事画像表示</h3>
                            <p class="setting-help">記事カードに画像を表示します</p>
                        </div>
                        <div class="setting-control">
                            <div class="toggle-switch" id="showImagesToggle" data-setting="showImages"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI・キーワード設定 -->
            <section class="settings-section">
                <div class="section-header">
                    <span class="section-icon">🤖</span>
                    <div>
                        <h2 class="section-title">AI・キーワード設定</h2>
                        <p class="section-description">AI学習とキーワード検出の設定を行います</p>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">気になるワード</h3>
                            <p class="setting-help">このワードが含まれる記事の興味度がアップします</p>
                            <textarea class="keywords-input" id="interestKeywords" 
                                      placeholder="例: AI, 技術, プログラミング, ニュース&#10;（1行に1つずつ入力）"></textarea>
                            <div class="keywords-help">
                                ※ 1行に1つのワードを入力。マッチした記事は+20点ボーナス
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">NGワード</h3>
                            <p class="setting-help">このワードが含まれる記事は自動的に非表示になります</p>
                            <textarea class="keywords-input" id="ngKeywords" 
                                      placeholder="例: 事故, 事件, 政治&#10;（1行に1つずつ入力）"></textarea>
                            <div class="keywords-help">
                                ※ 1行に1つのワードを入力。マッチした記事は即座に非表示
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="setting-btn btn-primary" id="saveKeywordsBtn">キーワード設定保存</button>
                        <button class="setting-btn btn-secondary" id="resetAIBtn">AI学習リセット</button>
                        <button class="setting-btn btn-success" id="retrainAIBtn">AI再学習実行</button>
                    </div>
                </div>
            </section>

            <!-- テーマ・外観設定 -->
            <section class="settings-section">
                <div class="section-header">
                    <span class="section-icon">🎨</span>
                    <div>
                        <h2 class="section-title">テーマ・外観設定</h2>
                        <p class="section-description">アプリの見た目を変更できます</p>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="theme-preview">
                        <div class="theme-option active" data-theme="light">
                            <div class="theme-name">ライトテーマ</div>
                            <div class="theme-colors">
                                <div class="color-swatch" style="background: #ffffff;"></div>
                                <div class="color-swatch" style="background: #2196F3;"></div>
                                <div class="color-swatch" style="background: #4CAF50;"></div>
                            </div>
                            <div class="theme-description">明るく見やすいデフォルトテーマ</div>
                        </div>
                        
                        <div class="theme-option" data-theme="dark">
                            <div class="theme-name">ダークテーマ</div>
                            <div class="theme-colors">
                                <div class="color-swatch" style="background: #121212;"></div>
                                <div class="color-swatch" style="background: #64B5F6;"></div>
                                <div class="color-swatch" style="background: #66BB6A;"></div>
                            </div>
                            <div class="theme-description">目に優しい暗めのテーマ</div>
                        </div>
                        
                        <div class="theme-option" data-theme="sepia">
                            <div class="theme-name">セピアテーマ</div>
                            <div class="theme-colors">
                                <div class="color-swatch" style="background: #f4f1ea;"></div>
                                <div class="color-swatch" style="background: #8b4513;"></div>
                                <div class="color-swatch" style="background: #6b8e23;"></div>
                            </div>
                            <div class="theme-description">読書に集中できる落ち着いたテーマ</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- データ管理 -->
            <section class="settings-section">
                <div class="section-header">
                    <span class="section-icon">💾</span>
                    <div>
                        <h2 class="section-title">データ管理</h2>
                        <p class="section-description">保存データの管理・バックアップを行います</p>
                    </div>
                </div>
                
                <div class="data-stats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalArticlesData">0</div>
                            <div class="stat-label">保存記事数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalRSSData">0</div>
                            <div class="stat-label">RSS数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="storageUsage">0</div>
                            <div class="stat-label">使用容量 (KB)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="lastBackup">未実行</div>
                            <div class="stat-label">最終バックアップ</div>
                        </div>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="action-buttons">
                        <button class="setting-btn btn-success" id="exportDataBtn">データエクスポート</button>
                        <div class="file-upload">
                            <input type="file" id="importDataFile" accept=".json">
                            <label for="importDataFile" class="upload-btn">データインポート</label>
                        </div>
                        <button class="setting-btn btn-secondary" id="cleanOldDataBtn">古いデータ削除</button>
                        <button class="setting-btn btn-danger" id="clearAllDataBtn">全データ削除</button>
                    </div>
                </div>
            </section>

            <!-- アプリ情報 -->
            <section class="settings-section">
                <div class="section-header">
                    <span class="section-icon">ℹ️</span>
                    <div>
                        <h2 class="section-title">アプリ情報</h2>
                        <p class="section-description">バージョン情報とシステム状態</p>
                    </div>
                </div>
                
                <div class="setting-group">
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">アプリバージョン</h3>
                            <p class="setting-help">現在のアプリケーションバージョン</p>
                        </div>
                        <div class="setting-control">
                            <span id="appVersion">1.0.0</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">AI学習状況</h3>
                            <p class="setting-help">学習済み語彙数とフィードバック数</p>
                        </div>
                        <div class="setting-control">
                            <span id="aiLearningStatus">読み込み中...</span>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <h3 class="setting-label">PWA状態</h3>
                            <p class="setting-help">オフライン機能とインストール状況</p>
                        </div>
                        <div class="setting-control">
                            <span id="pwaStatus">確認中...</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="setting-btn btn-primary" id="checkUpdateBtn">更新確認</button>
                        <button class="setting-btn btn-secondary" id="resetSettingsBtn">設定リセット</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- 確認ダイアログ -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <h3 class="confirm-title" id="confirmTitle">確認</h3>
            <p class="confirm-message" id="confirmMessage">この操作を実行しますか？</p>
            <div class="confirm-actions">
                <button class="setting-btn btn-danger" id="confirmYes">実行</button>
                <button class="setting-btn btn-secondary" id="confirmNo">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- エラー通知エリア -->
    <div class="notification-area" id="notificationArea"></div>

    <!-- スクリプト読み込み -->
    <script src="../scripts/data-manager.js"></script>
    <script src="../scripts/utils.js"></script>
    
    <!-- 設定画面専用スクリプト -->
    <script>
        class SettingsManager {
            constructor() {
                this.dataManager = null;
                this.currentSettings = {};
                this.isInitialized = false;
                
                // デフォルト設定
                this.defaultSettings = {
                    autoRefresh: false,
                    refreshInterval: 30,
                    articlesPerPage: 50,
                    defaultSort: 'interest',
                    showImages: true,
                    theme: 'light',
                    interestKeywords: [],
                    ngKeywords: []
                };
            }
            
            async initialize() {
                try {
                    console.log('Settings Manager初期化開始');
                    
                    // 依存クラス初期化
                    this.dataManager = new DataManager();
                    await this.dataManager.initialize();
                    
                    // 設定データ読み込み
                    await this.loadSettings();
                    
                    // UI初期化
                    this.setupEventListeners();
                    this.updateUI();
                    this.updateDataStats();
                    this.updateSystemInfo();
                    
                    this.isInitialized = true;
                    console.log('Settings Manager初期化完了');
                    
                } catch (error) {
                    console.error('Settings Manager初期化エラー:', error);
                    this.showNotification('設定管理機能の初期化に失敗しました', 'error');
                }
            }
            
            async loadSettings() {
                try {
                    // ユーザー設定読み込み
                    const userPrefs = await this.dataManager.loadUserPreferences();
                    
                    // キーワード設定読み込み
                    const keywords = await this.dataManager.loadData('yourNews_keywords') || 
                                   { interestWords: [], ngWords: [] };
                    
                    // 設定統合
                    this.currentSettings = {
                        ...this.defaultSettings,
                        ...userPrefs,
                        interestKeywords: keywords.interestWords || [],
                        ngKeywords: keywords.ngWords || []
                    };
                    
                    console.log('設定データ読み込み完了:', this.currentSettings);
                    
                } catch (error) {
                    console.error('設定読み込みエラー:', error);
                    this.currentSettings = { ...this.defaultSettings };
                }
            }
            
            setupEventListeners() {
                // トグルスイッチ
                document.querySelectorAll('.toggle-switch').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const setting = toggle.dataset.setting;
                        if (setting) {
                            this.toggleSetting(setting, toggle);
                        }
                    });
                });
                
                // 数値・選択入力
                ['refreshInterval', 'articlesPerPage', 'defaultSort'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', (e) => {
                            const value = e.target.type === 'number' ? parseInt(e.target.value) : e.target.value;
                            this.updateSetting(id, value);
                        });
                    }
                });
                
                // キーワード保存
                const saveKeywordsBtn = document.getElementById('saveKeywordsBtn');
                if (saveKeywordsBtn) {
                    saveKeywordsBtn.addEventListener('click', () => {
                        this.saveKeywords();
                    });
                }
                
                // AI操作ボタン
                const resetAIBtn = document.getElementById('resetAIBtn');
                if (resetAIBtn) {
                    resetAIBtn.addEventListener('click', () => {
                        this.confirmAction('AI学習データをリセット', 'AI学習データを完全に削除します。この操作は取り消せません。', () => {
                            this.resetAILearning();
                        });
                    });
                }
                
                const retrainAIBtn = document.getElementById('retrainAIBtn');
                if (retrainAIBtn) {
                    retrainAIBtn.addEventListener('click', () => {
                        this.retrainAI();
                    });
                }
                
                // テーマ選択
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        this.changeTheme(theme);
                    });
                });
                
                // データ管理ボタン
                this.setupDataManagementListeners();
                
                // システム情報ボタン
                this.setupSystemInfoListeners();
                
                // 確認ダイアログ
                this.setupConfirmDialog();
            }
            
            setupDataManagementListeners() {
                // データエクスポート
                const exportBtn = document.getElementById('exportDataBtn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportData();
                    });
                }
                
                // データインポート
                const importFile = document.getElementById('importDataFile');
                if (importFile) {
                    importFile.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            this.importData(e.target.files[0]);
                        }
                    });
                }
                
                // 古いデータ削除
                const cleanBtn = document.getElementById('cleanOldDataBtn');
                if (cleanBtn) {
                    cleanBtn.addEventListener('click', () => {
                        this.confirmAction('古いデータ削除', '7日以上前の記事データを削除します。', () => {
                            this.cleanOldData();
                        });
                    });
                }
                
                // 全データ削除
                const clearBtn = document.getElementById('clearAllDataBtn');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        this.confirmAction('全データ削除', 'すべての記事・設定データを削除します。この操作は取り消せません。', () => {
                            this.clearAllData();
                        });
                    });
                }
            }
            
            setupSystemInfoListeners() {
                // 更新確認
                const checkUpdateBtn = document.getElementById('checkUpdateBtn');
                if (checkUpdateBtn) {
                    checkUpdateBtn.addEventListener('click', () => {
                        this.checkForUpdates();
                    });
                }
                
                // 設定リセット
                const resetSettingsBtn = document.getElementById('resetSettingsBtn');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', () => {
                        this.confirmAction('設定リセット', 'すべての設定をデフォルトに戻します。', () => {
                            this.resetSettings();
                        });
                    });
                }
            }
            
            setupConfirmDialog() {
                const dialog = document.getElementById('confirmDialog');
                const yesBtn = document.getElementById('confirmYes');
                const noBtn = document.getElementById('confirmNo');
                
                if (noBtn) {
                    noBtn.addEventListener('click', () => {
                        this.hideConfirmDialog();
                    });
                }
                
                if (dialog) {
                    dialog.addEventListener('click', (e) => {
                        if (e.target === dialog) {
                            this.hideConfirmDialog();
                        }
                    });
                }
            }
            
            updateUI() {
                try {
                    // トグルスイッチ更新
                    document.querySelectorAll('.toggle-switch').forEach(toggle => {
                        const setting = toggle.dataset.setting;
                        if (setting && this.currentSettings[setting] !== undefined) {
                            toggle.classList.toggle('active', this.currentSettings[setting]);
                        }
                    });
                    
                    // 入力値更新
                    const inputMappings = {
                        refreshInterval: 'refreshInterval',
                        articlesPerPage: 'articlesPerPage',
                        defaultSort: 'defaultSort'
                    };
                    
                    Object.entries(inputMappings).forEach(([elementId, settingKey]) => {
                        const element = document.getElementById(elementId);
                        if (element && this.currentSettings[settingKey] !== undefined) {
                            element.value = this.currentSettings[settingKey];
                        }
                    });
                    
                    // キーワード更新
                    const interestInput = document.getElementById('interestKeywords');
                    if (interestInput) {
                        interestInput.value = this.currentSettings.interestKeywords.join('\n');
                    }
                    
                    const ngInput = document.getElementById('ngKeywords');
                    if (ngInput) {
                        ngInput.value = this.currentSettings.ngKeywords.join('\n');
                    }
                    
                    // テーマ更新
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.toggle('active', option.dataset.theme === this.currentSettings.theme);
                    });
                    
                    // テーマ適用
                    this.applyTheme(this.currentSettings.theme);
                    
                } catch (error) {
                    console.error('UI更新エラー:', error);
                }
            }
            
            toggleSetting(settingKey, toggleElement) {
                const newValue = !this.currentSettings[settingKey];
                this.updateSetting(settingKey, newValue);
                toggleElement.classList.toggle('active', newValue);
            }
            
            async updateSetting(settingKey, value) {
                try {
                    this.currentSettings[settingKey] = value;
                    
                    // 設定保存
                    const settingsToSave = { ...this.currentSettings };
                    delete settingsToSave.interestKeywords;
                    delete settingsToSave.ngKeywords;
                    
                    await this.dataManager.saveUserPreferences(settingsToSave);
                    
                    console.log(`設定更新: ${settingKey} = ${value}`);
                    
                } catch (error) {
                    console.error('設定更新エラー:', error);
                    this.showNotification('設定の保存に失敗しました', 'error');
                }
            }
            
            async saveKeywords() {
                try {
                    const interestInput = document.getElementById('interestKeywords');
                    const ngInput = document.getElementById('ngKeywords');
                    
                    const interestWords = interestInput.value
                        .split('\n')
                        .map(word => word.trim())
                        .filter(word => word.length > 0);
                    
                    const ngWords = ngInput.value
                        .split('\n')
                        .map(word => word.trim())
                        .filter(word => word.length > 0);
                    
                    const keywordsData = {
                        interestWords: interestWords,
                        ngWords: ngWords
                    };
                    
                    await this.dataManager.saveData('yourNews_keywords', keywordsData);
                    
                    this.currentSettings.interestKeywords = interestWords;
                    this.currentSettings.ngKeywords = ngWords;
                    
                    this.showNotification('キーワード設定を保存しました', 'success');
                    
                } catch (error) {
                    console.error('キーワード保存エラー:', error);
                    this.showNotification('キーワード設定の保存に失敗しました', 'error');
                }
            }
            
            async resetAILearning() {
                try {
                    // AI関連データ削除
                    localStorage.removeItem('yourNews_feedback');
                    localStorage.removeItem('yourNews_aiModel');
                    localStorage.removeItem('yourNews_vocabulary');
                    localStorage.removeItem('yourNews_idf');
                    
                    // AIエンジンリセット
                    if (window.yourNewsApp && window.yourNewsApp.aiEngine) {
                        await window.yourNewsApp.aiEngine.resetModel();
                    }
                    
                    this.showNotification('AI学習データをリセットしました', 'success');
                    this.updateSystemInfo();
                    
                } catch (error) {
                    console.error('AI学習リセットエラー:', error);
                    this.showNotification('AI学習リセットに失敗しました', 'error');
                }
            }
            
            async retrainAI() {
                try {
                    if (!window.yourNewsApp || !window.yourNewsApp.aiEngine) {
                        this.showNotification('AI機能が利用できません', 'warning');
                        return;
                    }
                    
                    const retrainBtn = document.getElementById('retrainAIBtn');
                    if (retrainBtn) {
                        retrainBtn.disabled = true;
                        retrainBtn.textContent = 'AI再学習中...';
                    }
                    
                    // 全記事のAI再計算
                    const articles = await this.dataManager.loadArticles();
                    const keywords = {
                        interestWords: this.currentSettings.interestKeywords,
                        ngWords: this.currentSettings.ngKeywords
                    };
                    
                    for (const article of articles) {
                        const newScore = await window.yourNewsApp.aiEngine.calculateInterestScore(article, keywords);
                        article.interestScore = newScore;
                    }
                    
                    await this.dataManager.saveArticles(articles);
                    
                    this.showNotification('AI再学習が完了しました', 'success');
                    this.updateSystemInfo();
                    
                } catch (error) {
                    console.error('AI再学習エラー:', error);
                    this.showNotification('AI再学習に失敗しました', 'error');
                } finally {
                    const retrainBtn = document.getElementById('retrainAIBtn');
                    if (retrainBtn) {
                        retrainBtn.disabled = false;
                        retrainBtn.textContent = 'AI再学習実行';
                    }
                }
            }
            
            changeTheme(theme) {
                try {
                    this.updateSetting('theme', theme);
                    this.applyTheme(theme);
                    
                    // UI更新
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.toggle('active', option.dataset.theme === theme);
                    });
                    
                    this.showNotification(`テーマを${theme}に変更しました`, 'success');
                    
                } catch (error) {
                    console.error('テーマ変更エラー:', error);
                    this.showNotification('テーマの変更に失敗しました', 'error');
                }
            }
            
            applyTheme(theme) {
                // ルート要素にテーマ属性を設定
                document.documentElement.setAttribute('data-theme', theme);
                
                // body要素にもクラス追加（互換性）
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                document.body.classList.add(`theme-${theme}`);
            }
            
            async updateDataStats() {
                try {
                    const articles = await this.dataManager.loadArticles();
                    const rssFeeds = await this.dataManager.loadRssFeeds();
                    
                    // ストレージ使用量計算
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (key.startsWith('yourNews_')) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    
                    const sizeKB = Math.round(totalSize / 1024 * 100) / 100;
                    
                    // UI更新
                    const elements = {
                        totalArticlesData: articles.length,
                        totalRSSData: rssFeeds.length,
                        storageUsage: sizeKB,
                        lastBackup: this.getLastBackupDate()
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    });
                    
                } catch (error) {
                    console.error('データ統計更新エラー:', error);
                }
            }
            
                        updateSystemInfo() {
                try {
                    // アプリバージョン
                    const versionElement = document.getElementById('appVersion');
                    if (versionElement) {
                        versionElement.textContent = '1.0.0';
                    }
                    
                    // AI学習状況
                    const aiStatusElement = document.getElementById('aiLearningStatus');
                    if (aiStatusElement) {
                        if (window.yourNewsApp && window.yourNewsApp.aiEngine) {
                            const stats = window.yourNewsApp.aiEngine.getStats();
                            aiStatusElement.textContent = `語彙: ${stats.vocabularySize}語, フィードバック: ${stats.feedbackCount}件`;
                        } else {
                            aiStatusElement.textContent = '未初期化';
                        }
                    }
                    
                    // PWA状態
                    const pwaStatusElement = document.getElementById('pwaStatus');
                    if (pwaStatusElement) {
                        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                        const isOnline = navigator.onLine;
                        const swSupported = 'serviceWorker' in navigator;
                        
                        pwaStatusElement.textContent = 
                            `${isStandalone ? 'インストール済' : 'ブラウザ版'}, ${isOnline ? 'オンライン' : 'オフライン'}, SW: ${swSupported ? '対応' : '非対応'}`;
                    }
                    
                } catch (error) {
                    console.error('システム情報更新エラー:', error);
                }
            }
            
            async exportData() {
                try {
                    const exportData = await this.dataManager.exportData();
                    if (!exportData) {
                        this.showNotification('エクスポートするデータがありません', 'warning');
                        return;
                    }
                    
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `your-news-backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // 最終バックアップ日時更新
                    localStorage.setItem('yourNews_lastBackup', new Date().toISOString());
                    this.updateDataStats();
                    
                    this.showNotification('データをエクスポートしました', 'success');
                    
                } catch (error) {
                    console.error('データエクスポートエラー:', error);
                    this.showNotification('データエクスポートに失敗しました', 'error');
                }
            }
            
            async importData(file) {
                try {
                    if (!file || file.type !== 'application/json') {
                        this.showNotification('有効なJSONファイルを選択してください', 'warning');
                        return;
                    }
                    
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    if (!importData.version || !importData.articles) {
                        this.showNotification('無効なバックアップファイルです', 'error');
                        return;
                    }
                    
                    this.confirmAction('データインポート', 
                        `${importData.articles.length}件の記事を含むバックアップをインポートします。既存のデータは上書きされます。`, 
                        async () => {
                            const success = await this.dataManager.importData(importData);
                            if (success) {
                                this.showNotification('データをインポートしました', 'success');
                                this.updateDataStats();
                                this.updateSystemInfo();
                            } else {
                                this.showNotification('データインポートに失敗しました', 'error');
                            }
                        }
                    );
                    
                } catch (error) {
                    console.error('データインポートエラー:', error);
                    this.showNotification('ファイルの読み込みに失敗しました', 'error');
                }
            }
            
            async cleanOldData() {
                try {
                    const beforeStats = await this.getDataStats();
                    
                    // 古い記事削除
                    await this.dataManager.cleanOldArticles();
                    
                    // キャッシュクリア
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(name => caches.delete(name))
                        );
                    }
                    
                    const afterStats = await this.getDataStats();
                    const deletedCount = beforeStats.totalArticles - afterStats.totalArticles;
                    
                    this.updateDataStats();
                    this.showNotification(`${deletedCount}件の古いデータを削除しました`, 'success');
                    
                } catch (error) {
                    console.error('データクリーンアップエラー:', error);
                    this.showNotification('データクリーンアップに失敗しました', 'error');
                }
            }
            
            async clearAllData() {
                try {
                    // 全データ削除
                    await this.dataManager.clearAllData();
                    
                    // AI関連データ削除
                    localStorage.removeItem('yourNews_feedback');
                    localStorage.removeItem('yourNews_aiModel');
                    localStorage.removeItem('yourNews_vocabulary');
                    localStorage.removeItem('yourNews_idf');
                    localStorage.removeItem('yourNews_keywords');
                    localStorage.removeItem('yourNews_lastBackup');
                    
                    // キャッシュクリア
                    if ('caches' in window) {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(name => caches.delete(name))
                        );
                    }
                    
                    // 設定リセット
                    this.currentSettings = { ...this.defaultSettings };
                    await this.dataManager.saveUserPreferences(this.currentSettings);
                    
                    this.updateUI();
                    this.updateDataStats();
                    this.updateSystemInfo();
                    
                    this.showNotification('すべてのデータを削除しました', 'success');
                    
                } catch (error) {
                    console.error('全データ削除エラー:', error);
                    this.showNotification('データ削除に失敗しました', 'error');
                }
            }
            
            async resetSettings() {
                try {
                    this.currentSettings = { ...this.defaultSettings };
                    await this.dataManager.saveUserPreferences(this.currentSettings);
                    
                    this.updateUI();
                    this.showNotification('設定をリセットしました', 'success');
                    
                } catch (error) {
                    console.error('設定リセットエラー:', error);
                    this.showNotification('設定リセットに失敗しました', 'error');
                }
            }
            
            async checkForUpdates() {
                try {
                    const checkBtn = document.getElementById('checkUpdateBtn');
                    if (checkBtn) {
                        checkBtn.disabled = true;
                        checkBtn.textContent = '確認中...';
                    }
                    
                    // Service Worker更新確認
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            await registration.update();
                            this.showNotification('更新を確認しました', 'info');
                        } else {
                            this.showNotification('Service Workerが登録されていません', 'warning');
                        }
                    } else {
                        this.showNotification('更新機能は利用できません', 'warning');
                    }
                    
                } catch (error) {
                    console.error('更新確認エラー:', error);
                    this.showNotification('更新確認に失敗しました', 'error');
                } finally {
                    const checkBtn = document.getElementById('checkUpdateBtn');
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.textContent = '更新確認';
                    }
                }
            }
            
            async getDataStats() {
                try {
                    const articles = await this.dataManager.loadArticles();
                    const rssFeeds = await this.dataManager.loadRssFeeds();
                    
                    return {
                        totalArticles: articles.length,
                        totalRSS: rssFeeds.length
                    };
                } catch (error) {
                    return { totalArticles: 0, totalRSS: 0 };
                }
            }
            
            getLastBackupDate() {
                try {
                    const lastBackup = localStorage.getItem('yourNews_lastBackup');
                    if (lastBackup) {
                        return Utils.formatDate(lastBackup, 'relative');
                    }
                    return '未実行';
                } catch (error) {
                    return '不明';
                }
            }
            
            confirmAction(title, message, callback) {
                const dialog = document.getElementById('confirmDialog');
                const titleElement = document.getElementById('confirmTitle');
                const messageElement = document.getElementById('confirmMessage');
                const yesBtn = document.getElementById('confirmYes');
                
                if (dialog && titleElement && messageElement && yesBtn) {
                    titleElement.textContent = title;
                    messageElement.textContent = message;
                    
                    // 既存のイベントリスナーを削除
                    const newYesBtn = yesBtn.cloneNode(true);
                    yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
                    
                    // 新しいイベントリスナーを追加
                    newYesBtn.addEventListener('click', () => {
                        this.hideConfirmDialog();
                        callback();
                    });
                    
                    this.showConfirmDialog();
                }
            }
            
            showConfirmDialog() {
                const dialog = document.getElementById('confirmDialog');
                if (dialog) {
                    dialog.classList.add('show');
                }
            }
            
            hideConfirmDialog() {
                const dialog = document.getElementById('confirmDialog');
                if (dialog) {
                    dialog.classList.remove('show');
                }
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                // グローバル通知関数を利用
                if (window.yourNewsApp && window.yourNewsApp.showNotification) {
                    window.yourNewsApp.showNotification(message, type, duration);
                } else {
                    // フォールバック
                    console.log(`${type.toUpperCase()}: ${message}`);
                    alert(message);
                }
            }
        }
        
        // 初期化
        let settingsManager;
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                settingsManager = new SettingsManager();
                await settingsManager.initialize();
            } catch (error) {
                console.error('設定画面初期化エラー:', error);
            }
        });
        
        // グローバル公開（デバッグ用）
        window.settingsManager = () => settingsManager;
    </script>
</body>
</html>
