<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="設定画面 - あなたのニュース">
    <title>設定 - あなたのニュース</title>
    
    <!-- PWA設定 -->
    <meta name="theme-color" content="#2196F3">
    <link rel="manifest" href="../assets/manifest.json">
    
    <!-- TensorFlow.js CDN（仕様書指定v4.10.0） -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/responsive.css">
    <link rel="stylesheet" href="../styles/components.css">
    <link rel="stylesheet" href="../styles/themes.css">
    
    <!-- 設定画面専用スタイル -->
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #333;
            margin: 0 0 1.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .setting-info {
            flex: 1;
            margin-right: 1rem;
        }
        
        .setting-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.3rem;
        }
        
        .setting-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }
        
        .setting-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ddd;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active::after {
            transform: translateX(25px);
        }
        
        .setting-input {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .setting-select {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            min-width: 120px;
        }
        
        .setting-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976D2;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .keyword-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .keyword-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0.5rem;
            margin: 0.2rem 0;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .keyword-text {
            flex: 1;
            color: #333;
        }
        
        .keyword-remove {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .keyword-input-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .keyword-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        
        .add-keyword-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .danger-zone {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .danger-zone .section-title {
            color: #e53e3e;
            border-bottom-color: #fed7d7;
        }
        
        .import-export-area {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            background: #607D8B;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .file-label:hover {
            background: #455A64;
        }
        
        .theme-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .theme-option {
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s ease;
        }
        
        .theme-option.active {
            border-color: #2196F3;
            background: #f0f8ff;
        }
        
        .theme-option:hover {
            border-color: #ccc;
        }
        
        .theme-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .theme-sample {
            width: 100%;
            height: 40px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .theme-light .theme-sample {
            background: linear-gradient(45deg, #fff, #f0f0f0);
        }
        
        .theme-dark .theme-sample {
            background: linear-gradient(45deg, #333, #555);
        }
        
        .theme-sepia .theme-sample {
            background: linear-gradient(45deg, #f4f1ea, #e8e2d5);
        }
        
        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }
        
        .status-indicator.active {
            background: #4CAF50;
        }
        
        .status-indicator.error {
            background: #f44336;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #2196F3;
            transition: width 0.3s ease;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            .settings-container {
                padding: 1rem;
            }
            
            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .setting-control {
                width: 100%;
                justify-content: flex-end;
            }
            
            .import-export-area {
                flex-direction: column;
                align-items: stretch;
            }
            
            .theme-preview {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .theme-preview {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- ヘッダー（ナビゲーション） -->
    <header class="main-header">
        <div class="header-container">
            <h1 class="app-title">あなたのニュース - 設定</h1>
            <nav class="main-nav">
                <button class="nav-btn" onclick="location.href='../index.html'">記事一覧</button>
                <button class="nav-btn" onclick="location.href='rss-manager.html'">RSS管理</button>
                <button class="nav-btn" onclick="location.href='favorites.html'">お気に入り</button>
                <button class="nav-btn active">設定</button>
            </nav>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="settings-container">
        <!-- AI・学習設定 -->
        <section class="settings-section">
            <h2 class="section-title">🤖 AI・学習設定</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">AI記事推薦機能</div>
                    <div class="setting-description">記事の興味度を自動で計算し、パーソナライズされた記事推薦を行います</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch active" id="aiEnabled"></div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">自動学習機能</div>
                    <div class="setting-description">フィードバックに基づいてAIモデルを自動的に更新します</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch active" id="autoLearning"></div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">学習感度</div>
                    <div class="setting-description">AIの学習速度を調整します（高感度ほど早く学習しますが、誤学習のリスクも増えます）</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="learningSensitivity">
                        <option value="low">低感度（慎重）</option>
                        <option value="medium" selected>中感度（バランス）</option>
                        <option value="high">高感度（積極的）</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">AIモデル状態</div>
                    <div class="setting-description">現在のAI学習状況と性能指標</div>
                </div>
                <div class="setting-control">
                    <div class="ai-status">
                        <div class="status-indicator active" id="aiStatusIndicator"></div>
                        <span id="aiStatusText">動作中</span>
                        <button class="setting-btn btn-secondary" id="resetAIBtn">リセット</button>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid" id="aiStats">
                <div class="stat-card">
                    <div class="stat-value" id="feedbackCount">0</div>
                    <div class="stat-label">学習済みフィードバック</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="vocabularySize">0</div>
                    <div class="stat-label">語彙数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracyScore">0%</div>
                    <div class="stat-label">予測精度</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastLearning">未実行</div>
                    <div class="stat-label">最終学習</div>
                </div>
            </div>
        </section>

        <!-- キーワード設定 -->
        <section class="settings-section">
            <h2 class="section-title">🔍 キーワード設定</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">興味のあるキーワード</div>
                    <div class="setting-description">これらのキーワードを含む記事の興味度が高くなります</div>
                    <div class="keyword-list" id="interestKeywordsList">
                        <!-- 動的に生成 -->
                    </div>
                    <div class="keyword-input-group">
                        <input type="text" class="keyword-input" id="interestKeywordInput" 
                               placeholder="興味のあるキーワードを入力">
                        <button class="add-keyword-btn" id="addInterestKeywordBtn">追加</button>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">NGキーワード</div>
                    <div class="setting-description">これらのキーワードを含む記事は自動的に非表示になります</div>
                    <div class="keyword-list" id="ngKeywordsList">
                        <!-- 動的に生成 -->
                    </div>
                    <div class="keyword-input-group">
                        <input type="text" class="keyword-input" id="ngKeywordInput" 
                               placeholder="NGキーワードを入力">
                        <button class="add-keyword-btn" id="addNgKeywordBtn">追加</button>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">キーワードハイライト</div>
                    <div class="setting-description">一致したキーワードを記事内でハイライト表示します</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch active" id="keywordHighlight"></div>
                </div>
            </div>
        </section>

        <!-- 表示設定 -->
        <section class="settings-section">
            <h2 class="section-title">🎨 表示設定</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">テーマ</div>
                    <div class="setting-description">アプリケーションの外観テーマを選択します</div>
                    <div class="theme-preview">
                        <div class="theme-option theme-light active" data-theme="light">
                            <div class="theme-name">ライト</div>
                            <div class="theme-sample"></div>
                        </div>
                        <div class="theme-option theme-dark" data-theme="dark">
                            <div class="theme-name">ダーク</div>
                            <div class="theme-sample"></div>
                        </div>
                        <div class="theme-option theme-sepia" data-theme="sepia">
                            <div class="theme-name">セピア</div>
                            <div class="theme-sample"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">記事表示件数</div>
                    <div class="setting-description">一度に表示する記事の件数</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="articlesPerPage">
                        <option value="10">10件</option>
                        <option value="20">20件</option>
                        <option value="50" selected>50件</option>
                        <option value="100">100件</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">記事カードサイズ</div>
                    <div class="setting-description">記事カードの表示サイズ</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="cardSize">
                        <option value="compact">コンパクト</option>
                        <option value="normal" selected>標準</option>
                        <option value="large">大きめ</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">画像の自動読み込み</div>
                    <div class="setting-description">記事の画像を自動的に読み込みます（データ使用量に注意）</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch active" id="autoLoadImages"></div>
                </div>
            </div>
        </section>

        <!-- データ管理設定 -->
        <section class="settings-section">
            <h2 class="section-title">💾 データ管理設定</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">自動データクリーンアップ</div>
                    <div class="setting-description">古い記事データを自動的に削除します</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch active" id="autoCleanup"></div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">データ保持期間</div>
                    <div class="setting-description">記事データを保持する期間</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="dataRetentionDays">
                        <option value="3">3日</option>
                        <option value="7" selected>1週間</option>
                        <option value="14">2週間</option>
                        <option value="30">1ヶ月</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">最大記事保存数</div>
                    <div class="setting-description">保存する記事の最大件数</div>
                </div>
                <div class="setting-control">
                    <input type="number" class="setting-input" id="maxArticles" 
                           value="1000" min="100" max="5000" step="100">
                </div>
            </div>
            
            <div class="stats-grid" id="storageStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalArticles">0</div>
                    <div class="stat-label">保存中記事数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="storageUsed">0KB</div>
                    <div class="stat-label">使用容量</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="lastCleanup">未実行</div>
                    <div class="stat-label">最終クリーンアップ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="rssCount">0</div>
                    <div class="stat-label">RSS登録数</div>
                </div>
            </div>
        </section>

        <!-- RSS更新設定 -->
        <section class="settings-section">
            <h2 class="section-title">📡 RSS更新設定</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">自動更新</div>
                    <div class="setting-description">定期的にRSSフィードを更新します</div>
                </div>
                <div class="setting-control">
                    <div class="toggle-switch" id="autoRefresh"></div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">更新間隔</div>
                    <div class="setting-description">RSS更新の実行間隔</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="refreshInterval">
                        <option value="15">15分</option>
                        <option value="30" selected>30分</option>
                        <option value="60">1時間</option>
                        <option value="180">3時間</option>
                        <option value="360">6時間</option>
                    </select>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">更新失敗時の再試行</div>
                    <div class="setting-description">RSS取得が失敗した場合の再試行回数</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" id="retryCount">
                        <option value="1">1回</option>
                        <option value="2" selected>2回</option>
                        <option value="3">3回</option>
                        <option value="5">5回</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- データインポート・エクスポート -->
        <section class="settings-section">
            <h2 class="section-title">📂 データバックアップ</h2>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">設定データのエクスポート</div>
                    <div class="setting-description">現在の設定、キーワード、学習データを出力します</div>
                </div>
                <div class="setting-control">
                    <div class="import-export-area">
                        <button class="setting-btn btn-primary" id="exportSettingsBtn">設定をエクスポート</button>
                        <button class="setting-btn btn-primary" id="exportAllDataBtn">全データをエクスポート</button>
                    </div>
                </div>
            </div>
            
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-label">データのインポート</div>
                    <div class="setting-description">バックアップファイルから設定を復元します</div>
                </div>
                <div class="setting-control">
                    <div class="import-export-area">
                        <label for="importFile" class="file-label">ファイルを選択</label>
                        <input type="file" id="importFile" class="file-input" accept=".json">
                        <button class="setting-btn btn-secondary" id="importDataBtn" disabled>インポート実行</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 詳細設定・危険操作 -->
        <section class="settings-section">
            <div class="danger-zone">
                <h2 class="section-title">⚠️ 詳細設定・リセット操作</h2>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">学習データのクリア</div>
                        <div class="setting-description">AIの学習データをすべて削除し、初期状態に戻します</div>
                    </div>
                    <div class="setting-control">
                        <button class="setting-btn btn-danger" id="clearLearningDataBtn">学習データクリア</button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">記事データのクリア</div>
                        <div class="setting-description">保存されているすべての記事データを削除します</div>
                    </div>
                    <div class="setting-control">
                        <button class="setting-btn btn-danger" id="clearArticleDataBtn">記事データクリア</button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">完全リセット</div>
                        <div class="setting-description">すべての設定・データを削除し、アプリを初期状態に戻します</div>
                    </div>
                    <div class="setting-control">
                        <button class="setting-btn btn-danger" id="fullResetBtn">完全リセット</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- エラー通知エリア -->
    <div class="notification-area" id="notificationArea"></div>

    <!-- スクリプト読み込み -->
    <script src="../scripts/data-manager.js"></script>
    <script src="../scripts/utils.js"></script>
    <script src="../scripts/ai-engine.js"></script>
    
    <!-- 設定画面専用スクリプト -->
    <script>
        class SettingsManager {
            constructor() {
                this.dataManager = null;
                this.aiEngine = null;
                this.defaultSettings = {
                    ai: {
                        enabled: true,
                        autoLearning: true,
                        learningSensitivity: 'medium'
                    },
                    keywords: {
                        interestWords: ['技術', 'AI', 'ニュース'],
                        ngWords: ['広告', 'PR', 'スポンサー'],
                        highlightEnabled: true
                    },
                    display: {
                        theme: 'light',
                        articlesPerPage: 50,
                        cardSize: 'normal',
                        autoLoadImages: true
                    },
                    data: {
                        autoCleanup: true,
                        retentionDays: 7,
                        maxArticles: 1000
                    },
                    rss: {
                        autoRefresh: false,
                        refreshInterval: 30,
                        retryCount: 2
                    }
                };
                this.currentSettings = {};
            }
            
            async initialize() {
                try {
                    console.log('Settings Manager初期化開始');
                    
                    // 依存クラス初期化
                    this.dataManager = new DataManager();
                    await this.dataManager.initialize();
                    
                    if (typeof AIEngine !== 'undefined') {
                        this.aiEngine = new AIEngine();
                        await this.aiEngine.initialize();
                    }
                    
                    // 設定読み込み
                    await this.loadSettings();
                    
                    // UI初期化
                    this.setupEventListeners();
                    this.updateUI();
                    this.updateStats();
                    
                    console.log('Settings Manager初期化完了');
                    
                } catch (error) {
                    console.error('Settings Manager初期化エラー:', error);
                    this.showNotification('設定画面の初期化に失敗しました', 'error');
                }
            }
            
            async loadSettings() {
                try {
                    const savedSettings = Utils.getStorageItem('yourNews_settings');
                    this.currentSettings = savedSettings ? 
                        this.mergeSettings(this.defaultSettings, savedSettings) : 
                        { ...this.defaultSettings };
                    
                    console.log('設定読み込み完了:', this.currentSettings);
                } catch (error) {
                    console.error('設定読み込みエラー:', error);
                    this.currentSettings = { ...this.defaultSettings };
                }
            }
            
            async saveSettings() {
                try {
                    Utils.setStorageItem('yourNews_settings', this.currentSettings);
                    console.log('設定保存完了');
                    return true;
                } catch (error) {
                    console.error('設定保存エラー:', error);
                    return false;
                }
            }
            
            mergeSettings(defaults, saved) {
                const merged = { ...defaults };
                
                Object.keys(saved).forEach(section => {
                    if (merged[section]) {
                        merged[section] = { ...merged[section], ...saved[section] };
                    } else {
                        merged[section] = saved[section];
                    }
                });
                
                return merged;
            }
            
            setupEventListeners() {
                try {
                    // トグルスイッチ
                    this.setupToggleSwitch('aiEnabled', 'ai.enabled');
                    this.setupToggleSwitch('autoLearning', 'ai.autoLearning');
                    this.setupToggleSwitch('keywordHighlight', 'keywords.highlightEnabled');
                    this.setupToggleSwitch('autoLoadImages', 'display.autoLoadImages');
                    this.setupToggleSwitch('autoCleanup', 'data.autoCleanup');
                    this.setupToggleSwitch('autoRefresh', 'rss.autoRefresh');
                    
                    // セレクトボックス
                    this.setupSelect('learningSensitivity', 'ai.learningSensitivity');
                    this.setupSelect('articlesPerPage', 'display.articlesPerPage');
                    this.setupSelect('cardSize', 'display.cardSize');
                    this.setupSelect('dataRetentionDays', 'data.retentionDays');
                    this.setupSelect('refreshInterval', 'rss.refreshInterval');
                    this.setupSelect('retryCount', 'rss.retryCount');
                    
                    // 入力フィールド
                    this.setupInput('maxArticles', 'data.maxArticles', 'number');
                    
                    // キーワード管理
                    this.setupKeywordManagement();
                    
                    // テーマ選択
                    this.setupThemeSelection();
                    
                    // ボタンイベント
                    this.setupButtonEvents();
                    
                    // ファイルインポート
                    this.setupFileImport();
                    
                    console.log('Settings Manager イベントリスナー設定完了');
                    
                } catch (error) {
                    console.error('イベントリスナー設定エラー:', error);
                }
            }
            
            setupToggleSwitch(elementId, settingPath) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.addEventListener('click', () => {
                    const currentValue = this.getSetting(settingPath);
                    const newValue = !currentValue;
                    this.setSetting(settingPath, newValue);
                    this.updateToggleUI(element, newValue);
                    this.saveSettings();
                });
            }
            
            setupSelect(elementId, settingPath) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.addEventListener('change', (e) => {
                    let value = e.target.value;
                    
                    // 数値の場合は変換
                    if (!isNaN(value) && value !== '') {
                        value = parseInt(value);
                    }
                    
                    this.setSetting(settingPath, value);
                    this.saveSettings();
                });
            }
            
            setupInput(elementId, settingPath, type = 'text') {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.addEventListener('change', (e) => {
                    let value = e.target.value;
                    
                    if (type === 'number') {
                        value = parseInt(value) || 0;
                    }
                    
                    this.setSetting(settingPath, value);
                    this.saveSettings();
                });
            }
            
            setupKeywordManagement() {
                // 興味キーワード追加
                const addInterestBtn = document.getElementById('addInterestKeywordBtn');
                const interestInput = document.getElementById('interestKeywordInput');
                
                if (addInterestBtn && interestInput) {
                    addInterestBtn.addEventListener('click', () => {
                        this.addKeyword('interestWords', interestInput.value.trim());
                        interestInput.value = '';
                    });
                    
                    interestInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.addKeyword('interestWords', interestInput.value.trim());
                            interestInput.value = '';
                        }
                    });
                }
                
                // NGキーワード追加
                const addNgBtn = document.getElementById('addNgKeywordBtn');
                const ngInput = document.getElementById('ngKeywordInput');
                
                if (addNgBtn && ngInput) {
                    addNgBtn.addEventListener('click', () => {
                        this.addKeyword('ngWords', ngInput.value.trim());
                        ngInput.value = '';
                    });
                    
                    ngInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.addKeyword('ngWords', ngInput.value.trim());
                            ngInput.value = '';
                        }
                    });
                }
            }
            
            setupThemeSelection() {
                const themeOptions = document.querySelectorAll('.theme-option');
                
                themeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        
                        // UI更新
                        themeOptions.forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                        
                        // 設定保存
                        this.setSetting('display.theme', theme);
                        this.saveSettings();
                        
                        // テーマ適用
                        this.applyTheme(theme);
                    });
                });
            }
            
            setupButtonEvents() {
                // AIリセット
                const resetAIBtn = document.getElementById('resetAIBtn');
                if (resetAIBtn) {
                    resetAIBtn.addEventListener('click', () => this.resetAIModel());
                }
                
                // データエクスポート
                const exportSettingsBtn = document.getElementById('exportSettingsBtn');
                if (exportSettingsBtn) {
                    exportSettingsBtn.addEventListener('click', () => this.exportSettings());
                }
                
                const exportAllDataBtn = document.getElementById('exportAllDataBtn');
                if (exportAllDataBtn) {
                    exportAllDataBtn.addEventListener('click', () => this.exportAllData());
                }
                
                // 危険操作
                const clearLearningDataBtn = document.getElementById('clearLearningDataBtn');
                if (clearLearningDataBtn) {
                    clearLearningDataBtn.addEventListener('click', () => this.clearLearningData());
                }
                
                const clearArticleDataBtn = document.getElementById('clearArticleDataBtn');
                if (clearArticleDataBtn) {
                    clearArticleDataBtn.addEventListener('click', () => this.clearArticleData());
                }
                
                const fullResetBtn = document.getElementById('fullResetBtn');
                if (fullResetBtn) {
                    fullResetBtn.addEventListener('click', () => this.fullReset());
                }
            }
            
            setupFileImport() {
                const fileInput = document.getElementById('importFile');
                const importBtn = document.getElementById('importDataBtn');
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (importBtn) {
                            importBtn.disabled = !file;
                        }
                    });
                }
                
                if (importBtn) {
                    importBtn.addEventListener('click', () => this.importData());
                }
            }
            
            updateUI() {
                try {
                    // トグルスイッチ更新
                    this.updateToggleUI(document.getElementById('aiEnabled'), this.getSetting('ai.enabled'));
                    this.updateToggleUI(document.getElementById('autoLearning'), this.getSetting('ai.autoLearning'));
                    this.updateToggleUI(document.getElementById('keywordHighlight'), this.getSetting('keywords.highlightEnabled'));
                    this.updateToggleUI(document.getElementById('autoLoadImages'), this.getSetting('display.autoLoadImages'));
                    this.updateToggleUI(document.getElementById('autoCleanup'), this.getSetting('data.autoCleanup'));
                    this.updateToggleUI(document.getElementById('autoRefresh'), this.getSetting('rss.autoRefresh'));
                    
                    // セレクトボックス更新
                    this.updateSelectUI('learningSensitivity', this.getSetting('ai.learningSensitivity'));
                    this.updateSelectUI('articlesPerPage', this.getSetting('display.articlesPerPage'));
                    this.updateSelectUI('cardSize', this.getSetting('display.cardSize'));
                    this.updateSelectUI('dataRetentionDays', this.getSetting('data.retentionDays'));
                    this.updateSelectUI('refreshInterval', this.getSetting('rss.refreshInterval'));
                    this.updateSelectUI('retryCount', this.getSetting('rss.retryCount'));
                    
                    // 入力フィールド更新
                    this.updateInputUI('maxArticles', this.getSetting('data.maxArticles'));
                    
                    // キーワード表示更新
                    this.updateKeywordLists();
                    
                    // テーマ選択更新
                    this.updateThemeUI();
                    
                    // AI状態更新
                    this.updateAIStatus();
                    
                } catch (error) {
                    console.error('UI更新エラー:', error);
                }
            }
            
            updateToggleUI(element, value) {
                if (!element) return;
                
                if (value) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
            }
            
            updateSelectUI(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            }
            
            updateInputUI(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            }
            
            updateKeywordLists() {
                this.renderKeywordList('interestKeywordsList', this.getSetting('keywords.interestWords'), 'interestWords');
                this.renderKeywordList('ngKeywordsList', this.getSetting('keywords.ngWords'), 'ngWords');
            }
            
            renderKeywordList(containerId, keywords, type) {
                const container = document.getElementById(containerId);
                if (!container || !Array.isArray(keywords)) return;
                
                container.innerHTML = keywords.map(keyword => `
                    <div class="keyword-item">
                        <span class="keyword-text">${Utils.sanitizeHTML(keyword)}</span>
                        <button class="keyword-remove" onclick="settingsManager.removeKeyword('${type}', '${keyword}')">削除</button>
                    </div>
                `).join('');
            }
            
            updateThemeUI() {
                const currentTheme = this.getSetting('display.theme');
                const themeOptions = document.querySelectorAll('.theme-option');
                
                themeOptions.forEach(option => {
                    if (option.dataset.theme === currentTheme) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            updateAIStatus() {
                const statusIndicator = document.getElementById('aiStatusIndicator');
                const statusText = document.getElementById('aiStatusText');
                
                if (this.aiEngine && this.getSetting('ai.enabled')) {
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator active';
                    }
                    if (statusText) {
                        statusText.textContent = '動作中';
                    }
                } else {
                    if (statusIndicator) {
                        statusIndicator.className = 'status-indicator';
                    }
                    if (statusText) {
                        statusText.textContent = '無効';
                    }
                }
            }
            
            async updateStats() {
                try {
                    // AI統計
                    if (this.aiEngine) {
                        const aiStats = this.aiEngine.getStats();
                        this.updateStatValue('feedbackCount', aiStats.feedbackCount || 0);
                        this.updateStatValue('vocabularySize', aiStats.vocabularySize || 0);
                        this.updateStatValue('accuracyScore', '推定中');
                        this.updateStatValue('lastLearning', aiStats.feedbackCount > 0 ? '実行済み' : '未実行');
                    }
                    
                    // ストレージ統計
                    const storageStats = this.dataManager.getStorageStats();
                    this.updateStatValue('totalArticles', storageStats.totalArticles || 0);
                    this.updateStatValue('storageUsed', this.formatBytes(storageStats.usedBytes || 0));
                    this.updateStatValue('lastCleanup', storageStats.lastCleanup || '未実行');
                    this.updateStatValue('rssCount', storageStats.rssCount || 0);
                    
                } catch (error) {
                    console.error('統計更新エラー:', error);
                }
            }
            
            updateStatValue(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            }
            
            // 設定値取得・設定
            getSetting(path) {
                const keys = path.split('.');
                let value = this.currentSettings;
                
                for (const key of keys) {
                    if (value && typeof value === 'object' && key in value) {
                        value = value[key];
                    } else {
                        return undefined;
                    }
                }
                
                return value;
            }
            
            setSetting(path, value) {
                const keys = path.split('.');
                let target = this.currentSettings;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    const key = keys[i];
                    if (!(key in target) || typeof target[key] !== 'object') {
                        target[key] = {};
                    }
                    target = target[key];
                }
                
                target[keys[keys.length - 1]] = value;
            }
            
            // キーワード管理
            addKeyword(type, keyword) {
                if (!keyword) return;
                
                const keywords = this.getSetting(`keywords.${type}`) || [];
                
                if (!keywords.includes(keyword)) {
                    keywords.push(keyword);
                    this.setSetting(`keywords.${type}`, keywords);
                    this.saveSettings();
                    this.updateKeywordLists();
                    this.showNotification('キーワードを追加しました', 'success');
                } else {
                    this.showNotification('このキーワードは既に登録されています', 'warning');
                }
            }
            
            removeKeyword(type, keyword) {
                const keywords = this.getSetting(`keywords.${type}`) || [];
                const index = keywords.indexOf(keyword);
                
                if (index > -1) {
                    keywords.splice(index, 1);
                    this.setSetting(`keywords.${type}`, keywords);
                    this.saveSettings();
                    this.updateKeywordLists();
                    this.showNotification('キーワードを削除しました', 'success');
                }
            }
            
            // テーマ適用
            applyTheme(theme) {
                document.documentElement.className = `theme-${theme}`;
                this.showNotification(`テーマを「${theme}」に変更しました`, 'success');
            }
            
            // AI関連操作
            async resetAIModel() {
                if (!confirm('AIの学習データをすべてリセットしますか？この操作は取り消せません。')) {
                    return;
                }
                
                try {
                    if (this.aiEngine) {
                        await this.aiEngine.resetModel();
                    }
                    
                    this.updateStats();
                    this.showNotification('AI学習データをリセットしました', 'success');
                    
                } catch (error) {
                    console.error('AIリセットエラー:', error);
                    this.showNotification('AIリセットに失敗しました', 'error');
                }
            }
            
            // データエクスポート
            async exportSettings() {
                try {
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        settings: this.currentSettings,
                        type: 'settings'
                    };
                    
                    this.downloadJSON(exportData, `settings-backup-${new Date().toISOString().split('T')[0]}.json`);
                    this.showNotification('設定データをエクスポートしました', 'success');
                    
                } catch (error) {
                    console.error('設定エクスポートエラー:', error);
                    this.showNotification('エクスポートに失敗しました', 'error');
                }
            }
            
            async exportAllData() {
                try {
                    const articles = await this.dataManager.loadArticles();
                    const rssFeeds = await this.dataManager.loadRssFeeds();
                    
                    const exportData = {
                        version: '1.0',
                        exportDate: new Date().toISOString(),
                        settings: this.currentSettings,
                        articles: articles,
                        rssFeeds: rssFeeds,
                        type: 'full'
                    };
                    
                    this.downloadJSON(exportData, `full-backup-${new Date().toISOString().split('T')[0]}.json`);
                    this.showNotification('全データをエクスポートしました', 'success');
                    
                } catch (error) {
                    console.error('全データエクスポートエラー:', error);
                    this.showNotification('エクスポートに失敗しました', 'error');
                }
            }
            
            // データインポート
            async importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!data.version || !data.type) {
                        throw new Error('無効なバックアップファイルです');
                    }
                    
                    if (!confirm('データをインポートしますか？現在の設定は上書きされます。')) {
                        return;
                    }
                    
                    // 設定復元
                    if (data.settings) {
                        this.currentSettings = this.mergeSettings(this.defaultSettings, data.settings);
                        await this.saveSettings();
                    }
                    
                    // 記事データ復元（full backupの場合）
                    if (data.type === 'full') {
                        if (data.articles) {
                            await this.dataManager.saveArticles(data.articles);
                        }
                        if (data.rssFeeds) {
                            await this.dataManager.saveRssFeeds(data.rssFeeds);
                        }
                    }
                    
                    // UI更新
                    this.updateUI();
                    this.updateStats();
                    
                    this.showNotification('データをインポートしました', 'success');
                    
                    // ファイル選択をリセット
                    fileInput.value = '';
                    document.getElementById('importDataBtn').disabled = true;
                    
                } catch (error) {
                    console.error('インポートエラー:', error);
                    this.showNotification('インポートに失敗しました: ' + error.message, 'error');
                }
            }
            
            // 危険操作
            async clearLearningData() {
                if (!confirm('AI学習データをすべて削除しますか？この操作は取り消せません。')) {
                    return;
                }
                
                try {
                    // AI学習データ削除
                    const keysToRemove = ['yourNews_vocabulary', 'yourNews_idf', 'yourNews_feedback', 'yourNews_aiModel'];
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    // AIエンジン再初期化
                    if (this.aiEngine) {
                        await this.aiEngine.resetModel();
                    }
                    
                    this.updateStats();
                    this.showNotification('学習データを削除しました', 'success');
                    
                } catch (error) {
                    console.error('学習データ削除エラー:', error);
                    this.showNotification('削除に失敗しました', 'error');
                }
            }
            
            async clearArticleData() {
                if (!confirm('保存されているすべての記事データを削除しますか？この操作は取り消せません。')) {
                    return;
                }
                
                try {
                    await this.dataManager.saveArticles([]);
                    this.updateStats();
                    this.showNotification('記事データを削除しました', 'success');
                    
                } catch (error) {
                    console.error('記事データ削除エラー:', error);
                    this.showNotification('削除に失敗しました', 'error');
                }
            }
            
            async fullReset() {
                if (!confirm('すべてのデータと設定を削除し、アプリを初期状態に戻しますか？この操作は取り消せません。')) {
                    return;
                }
                
                if (!confirm('本当によろしいですか？すべてのデータが失われます。')) {
                    return;
                }
                
                try {
                    // localStorage完全クリア
                    const keysToRemove = Object.keys(localStorage).filter(key => key.startsWith('yourNews_'));
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                    
                    this.showNotification('完全リセットを実行しました。ページを再読み込みします。', 'success');
                    
                    // 3秒後にページリロード
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                    
                } catch (error) {
                    console.error('完全リセットエラー:', error);
                    this.showNotification('リセットに失敗しました', 'error');
                }
            }
            
            // ユーティリティ関数
            formatBytes(bytes) {
                if (bytes === 0) return '0KB';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
            }
            
            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                const notificationArea = document.getElementById('notificationArea');
                if (!notificationArea) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    ${message}
                    <button onclick="this.parentElement.remove()" 
                            style="float: right; background: none; border: none; color: white; cursor: pointer; font-size: 1.2em; margin-left: 10px;">×</button>
                `;
                
                notificationArea.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            }
        }
        
        // 設定画面初期化
        const settingsManager = new SettingsManager();
        
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await settingsManager.initialize();
            } catch (error) {
                console.error('設定画面初期化失敗:', error);
                
                // 初期化失敗時のフォールバック表示
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #f44336;">
                        <h2>設定画面エラー</h2>
                        <p>設定画面の初期化に失敗しました</p>
                        <button onclick="location.reload()" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">再読み込み</button>
                    </div>
                `;
            }
        });
        
        // デバッグ用関数
        window.debugSettingsManager = function() {
            console.log('=== Settings Manager Debug ===');
            console.log('Manager instance:', typeof settingsManager !== 'undefined');
            console.log('Current settings:', settingsManager.currentSettings);
            console.log('AI Engine available:', !!settingsManager.aiEngine);
            console.log('Data Manager available:', !!settingsManager.dataManager);
            console.log('=== Settings Manager Debug Complete ===');
        };
    </script>
</body>
</html>
