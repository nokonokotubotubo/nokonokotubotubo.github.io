name: Fetch RSS Feeds and Deploy

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main ]
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“ï¼‰
    - cron: '0 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# å¿…è¦ãªæ¨©é™è¨­å®š
permissions:
  contents: write    # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™
  pages: write      # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
  id-token: write   # GitHub Pages èªè¨¼ç”¨

jobs:
  # Job 1: RSSå–å¾—ã¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
  fetch-rss:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # rssãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
    - name: Create RSS directory
      run: |
        mkdir -p rss
        echo "âœ… rssãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    # Qiita RSSå–å¾—
    - name: Fetch Qiita RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://qiita.com/tags/%E7%94%9F%E6%88%90ai/feed'
        file_path: './temp-qiita-feed.json'
    
    # Zenn RSSå–å¾—
    - name: Fetch Zenn RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://zenn.dev/topics/%E7%94%9F%E6%88%90ai/feed'
        file_path: './temp-zenn-feed.json'
    
    # CNET RSSå–å¾—
    - name: Fetch CNET RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'http://feeds.japan.cnet.com/cnet/rss'
        file_path: './temp-cnet-feed.json'
    
    # ãƒ‡ãƒ¼ã‚¿çµ±åˆã¨JSONç”Ÿæˆ
    - name: Merge RSS Feeds and Generate JSON
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        console.log('ğŸš€ RSSçµ±åˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰å®šç¾©
        const feeds = [
          { 
            name: 'Qiita', 
            file: './temp-qiita-feed.json', 
            color: '#55C500',
            description: 'Qiita ç”ŸæˆAIè¨˜äº‹'
          },
          { 
            name: 'Zenn', 
            file: './temp-zenn-feed.json', 
            color: '#3EA8FF',
            description: 'Zenn ç”ŸæˆAIè¨˜äº‹'
          },
          { 
            name: 'CNET', 
            file: './temp-cnet-feed.json', 
            color: '#C41E3A',
            description: 'CNET Japan ãƒ‹ãƒ¥ãƒ¼ã‚¹'
          }
        ];
        
        let allEntries = [];
        let processedFeeds = [];
        
        // å„ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å‡¦ç†
        feeds.forEach(feed => {
          try {
            console.log(`ğŸ“– ${feed.name} ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å‡¦ç†ä¸­...`);
            
            if (!fs.existsSync(feed.file)) {
              console.log(`âš ï¸  ${feed.file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
              return;
            }
            
            const rawData = fs.readFileSync(feed.file, 'utf8');
            const data = JSON.parse(rawData);
            
            if (data.entries && Array.isArray(data.entries)) {
              // æœ€æ–°5ä»¶ã‚’å–å¾—ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
              const feedEntries = data.entries.slice(0, 5).map(entry => ({
                ...entry,
                source: feed.name,
                sourceColor: feed.color,
                sourceFeed: feed.name.toLowerCase(),
                // æ—¥ä»˜æ­£è¦åŒ–
                published: entry.published || entry.pubDate || new Date().toISOString(),
                // ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
                summary: (entry.description || entry.summary || '').replace(/<[^>]*>/g, '').substring(0, 150),
                // ã‚µãƒ ãƒã‚¤ãƒ«æŠ½å‡ºè©¦è¡Œ
                thumbnail: extractThumbnail(entry)
              }));
              
              allEntries = allEntries.concat(feedEntries);
              processedFeeds.push({
                name: feed.name,
                color: feed.color,
                description: feed.description,
                count: feedEntries.length
              });
              
              console.log(`âœ… ${feed.name}: ${feedEntries.length}ä»¶ã®è¨˜äº‹ã‚’è¿½åŠ `);
            } else {
              console.log(`âš ï¸  ${feed.name}: entriesãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
            }
            
          } catch (error) {
            console.error(`âŒ ${feed.name} å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error.message);
          }
        });
        
        // ã‚µãƒ ãƒã‚¤ãƒ«æŠ½å‡ºé–¢æ•°
        function extractThumbnail(entry) {
          // enclosures ã‹ã‚‰ç”»åƒã‚’æŠ½å‡º
          if (entry.enclosures && Array.isArray(entry.enclosures)) {
            const imageEnclosure = entry.enclosures.find(enc => 
              enc.type && enc.type.startsWith('image/')
            );
            if (imageEnclosure && imageEnclosure.url) {
              return imageEnclosure.url;
            }
          }
          
          // media:content ã‹ã‚‰æŠ½å‡º
          if (entry['media:content'] && entry['media:content'].url) {
            return entry['media:content'].url;
          }
          
          // descriptionå†…ã®imgè¦ç´ ã‹ã‚‰æŠ½å‡º
          if (entry.description) {
            const imgMatch = entry.description.match(/<img[^>]+src=["']([^"']+)["']/i);
            if (imgMatch && imgMatch[1]) {
              return imgMatch[1];
            }
          }
          
          return null;
        }
        
        // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        allEntries.sort((a, b) => new Date(b.published) - new Date(a.published));
        
        // æœ€çµ‚çš„ã«15ä»¶ã«åˆ¶é™
        allEntries = allEntries.slice(0, 15);
        
        // çµ±åˆçµæœã®JSONã‚’ç”Ÿæˆ
        const result = {
          title: 'RSS Reader - ç”ŸæˆAIè¨˜äº‹ãƒ•ã‚£ãƒ¼ãƒ‰',
          description: 'æœ€æ–°ã®ç”ŸæˆAIé–¢é€£è¨˜äº‹ã‚’ã¾ã¨ã‚ã¦é…ä¿¡',
          updated: new Date().toISOString(),
          totalEntries: allEntries.length,
          feeds: processedFeeds,
          entries: allEntries
        };
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›
        const outputPath = './rss/feeds.json';
        fs.writeFileSync(outputPath, JSON.stringify(result, null, 2), 'utf8');
        
        console.log(`ğŸ‰ çµ±åˆå®Œäº†: ${allEntries.length}ä»¶ã®è¨˜äº‹ã‚’ ${outputPath} ã«å‡ºåŠ›ã—ã¾ã—ãŸ`);
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        processedFeeds.forEach(feed => {
          console.log(`   ğŸ“° ${feed.name}: ${feed.count}ä»¶`);
        });
        
        // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        feeds.forEach(feed => {
          if (fs.existsSync(feed.file)) {
            fs.unlinkSync(feed.file);
            console.log(`ğŸ—‘ï¸  ${feed.file} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
          }
        });
        
        EOF
    
    # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'ğŸ¤– RSS feeds updated - ${{ steps.date.outputs.date }}'
        file_pattern: 'rss/feeds.json'
        commit_user_name: 'RSS Bot'
        commit_user_email: 'rss-bot@github-actions.local'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # æ—¥ä»˜æƒ…å ±ã‚’å‡ºåŠ›
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

  # Job 2: GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    needs: fetch-rss  # fetch-rssã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './'  # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Display deployment URL
      run: |
        echo "ğŸš€ ã‚µã‚¤ãƒˆãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ!"
        echo "ğŸ“± ã‚¢ã‚¯ã‚»ã‚¹URL: ${{ steps.deployment.outputs.page_url }}rss/"
        echo "ğŸ“Š GitHub Pagesè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
