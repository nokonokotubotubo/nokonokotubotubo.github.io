name: Fetch RSS Feeds and Deploy

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆUTCæ™‚é–“ï¼‰
    - cron: '0 * * * *'
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# å¿…è¦ãªæ¨©é™è¨­å®š
permissions:
  contents: write    # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™
  pages: write      # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™
  id-token: write   # GitHub Pages èªè¨¼ç”¨

jobs:
  # Job 1: RSSå–å¾—ã¨ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
  fetch-rss:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # rssãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
    - name: Create RSS directory
      run: |
        mkdir -p rss
        echo "âœ… rssãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
    
    # Qiita RSSå–å¾—
    - name: Fetch Qiita RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://qiita.com/tags/%E7%94%9F%E6%88%90ai/feed'
        file_path: './temp-qiita-feed.json'
    
    # Zenn RSSå–å¾—
    - name: Fetch Zenn RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://zenn.dev/topics/%E7%94%9F%E6%88%90ai/feed'
        file_path: './temp-zenn-feed.json'
    
    # CNET RSSå–å¾—
    - name: Fetch CNET RSS Feed
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'http://feeds.japan.cnet.com/cnet/rss'
        file_path: './temp-cnet-feed.json'
    
    # ãƒ‡ãƒ¼ã‚¿çµ±åˆã¨JSONç”Ÿæˆ
    - name: Merge RSS Feeds and Generate JSON
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        console.log('ğŸš€ RSSçµ±åˆå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...');
        
        // ãƒ•ã‚£ãƒ¼ãƒ‰å®šç¾©
        const feeds = [
          { 
            name: 'Qiita', 
            file: './temp-qiita-feed.json', 
            color: '#55C500',
            description: 'Qiita ç”ŸæˆAIè¨˜äº‹'
          },
          { 
            name: 'Zenn', 
            file: './temp-zenn-feed.json', 
            color: '#3EA8FF',
            description: 'Zenn ç”ŸæˆAIè¨˜äº‹'
          },
          { 
            name: 'CNET', 
            file: './temp-cnet-feed.json', 
            color: '#C41E3A',
            description: 'CNET Japan ãƒ‹ãƒ¥ãƒ¼ã‚¹'
          }
        ];
        
        let allEntries = [];
        let processedFeeds = [];
        
        // å„ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å‡¦ç†
        feeds.forEach(feed => {
          try {
            console.log(`ğŸ“– ${feed.name} ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’å‡¦ç†ä¸­...`);
            
            if (!fs.existsSync(feed.file)) {
              console.log(`âš ï¸  ${feed.file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
              return;
            }
            
            const rawData = fs.readFileSync(feed.file, 'utf8');
            const data = JSON.parse(rawData);
            
            if (data.entries && Array.isArray(data.entries)) {
              // æœ€æ–°5ä»¶ã‚’å–å¾—ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
              const feedEntries = data.entries.slice(0, 5).map(entry => ({
                ...entry,
                source: feed.name,
                sourceColor: feed.color,
                sourceFeed: feed.name.toLowerCase(),
                // æ—¥ä»˜æ­£è¦åŒ–
                published: entry.published || entry.pubDate || new Date().toISOString(),
                // ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
                summary: (entry.description || entry.summary || '').replace(/<[^>]*>/g, '').substring(0, 150),
                // ã‚µãƒ ãƒã‚¤ãƒ«æŠ½å‡ºè©¦è¡Œ
                thumbnail: extractThumbnail(entry)
              }));
              
              allEntries = allEntries.concat(feedEntries);
              processedFeeds.push({
                name: feed.name,
                color: feed.color,
                description: feed.description,
                count: feedEntries.length
              });
              
              console.log(`âœ… ${feed.name}: ${feedEntries.length}ä»¶ã®è¨˜äº‹ã‚’è¿½åŠ `);
            } else {
              console.log(`âš ï¸  ${feed.name}: entriesãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
            }
            
          } catch (error) {
            console.error(`âŒ ${feed.name} å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error.message);
          }
        });
        
        // ã‚µãƒ ãƒã‚¤ãƒ«æŠ½å‡ºé–¢æ•°ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function extractThumbnail(entry) {
          // 1. enclosures ã‹ã‚‰ç”»åƒã‚’æŠ½å‡ºï¼ˆurl ã¨ href ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
          if (entry.enclosures && Array.isArray(entry.enclosures)) {
            for (const enclosure of entry.enclosures) {
              if (enclosure.type && enclosure.type.startsWith('image/')) {
                return enclosure.url || enclosure.href;
              }
            }
          }
          
          // 2. media:content ã‹ã‚‰æŠ½å‡ºï¼ˆé…åˆ—å¯¾å¿œï¼‰
          if (entry['media:content']) {
            const mediaContent = Array.isArray(entry['media:content']) 
              ? entry['media:content'] 
              : [entry['media:content']];
            
            for (const media of mediaContent) {
              if (media.url && (media.medium === 'image' || (media.type && media.type.startsWith('image/')))) {
                return media.url;
              }
            }
          }
          
          // 3. media:thumbnail ã‹ã‚‰æŠ½å‡º
          if (entry['media:thumbnail']) {
            if (typeof entry['media:thumbnail'] === 'string') {
              return entry['media:thumbnail'];
            } else if (entry['media:thumbnail'].url) {
              return entry['media:thumbnail'].url;
            }
          }
          
          // 4. thumbnail è¦ç´ ã‹ã‚‰æŠ½å‡º
          if (entry.thumbnail) {
            if (typeof entry.thumbnail === 'string') {
              return entry.thumbnail;
            } else if (entry.thumbnail.url) {
              return entry.thumbnail.url;
            }
          }
          
          // 5. contentè¦ç´ ã‹ã‚‰imgæŠ½å‡º
          if (entry.content) {
            const contentText = typeof entry.content === 'object' ? 
              (entry.content.value || entry.content['#text'] || '') : 
              entry.content;
            const imgMatch = contentText.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/i);
            if (imgMatch && imgMatch[1]) {
              return imgMatch[1];
            }
          }
          
          // 6. descriptionå†…ã®imgè¦ç´ ã‹ã‚‰æŠ½å‡ºï¼ˆæ”¹è‰¯ç‰ˆï¼‰
          if (entry.description) {
            const imgMatch = entry.description.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/i);
            if (imgMatch && imgMatch[1]) {
              return imgMatch[1];
            }
          }
          
          // 7. summaryå†…ã®imgè¦ç´ ã‹ã‚‰æŠ½å‡º
          if (entry.summary) {
            const summaryText = typeof entry.summary === 'object' ? 
              (entry.summary.value || entry.summary['#text'] || '') : 
              entry.summary;
            const imgMatch = summaryText.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/i);
            if (imgMatch && imgMatch[1]) {
              return imgMatch[1];
            }
          }
          
          // 8. Qiita/Zennç‰¹æœ‰ã®ç”»åƒæŠ½å‡º
          if (entry.link) {
            // Qiitaã®Open Graphç”»åƒã‚’æ¨æ¸¬
            if (entry.link.includes('qiita.com')) {
              const match = entry.link.match(/qiita\.com\/[^\/]+\/items\/([^\/\?]+)/);
              if (match) {
                return `https://qiita-user-contents.imgix.net/https%3A%2F%2Fcdn.qiita.com%2Fassets%2Fpublic%2Farticle-ogp-background-9f5428127621718a910c8b63951390ad.png?ixlib=rb-4.0.0&w=1200&mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTkxNiZ0eHQ9JUU3JTk0JTlGJUU2JTg4JTkwYUkmY29sb3I9JTIzMjEzYTQwJnR4dC1zaXplPTU2JnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2Jmg9MzM2JnR4dC1hbGlnbj1sZWZ0JTJDbWlkZGxl&mark-x=142&mark-y=112&blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTYxNiZ0eHQ9JUU3JTk0JTlGJUU2JTg4JTkwQUkmY29sb3I9JTIzMmU0MDRiJnR4dC1zaXplPTQ4JnR4dC1mb250PUhpcmFnaW5vJTIwU2FucyUyMFc2JnR4dC1hbGlnbj1sZWZ0JTJDbWlkZGxl&blend-x=142&blend-y=491&blend-mode=normal&s=951e07b616e45674290e6b0bdebe357b`;
              }
            }
            
            // Zennã®å ´åˆã¯å°‚ç”¨ã®OGPç”»åƒã‚’æ¨æ¸¬
            if (entry.link.includes('zenn.dev')) {
              const match = entry.link.match(/zenn\.dev\/[^\/]+\/articles\/([^\/\?]+)/);
              if (match) {
                return `https://res.cloudinary.com/zenn/image/fetch/s--xkALKaFj--/c_fit,g_north_west,l_text:notosanscjkjp-medium.otf_55_bold:${encodeURIComponent(entry.title || '')},w_1010,h_380,c_fit/g_south_west,l_text:notosanscjkjp-medium.otf_37:${encodeURIComponent(entry.author || '')},x_203,y_121/g_south_west,w_203,h_121,x_0,y_0,c_fit/v1627283836/default/ogp.png`;
              }
            }
          }
          
          return null;
        }
        
        // æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        allEntries.sort((a, b) => new Date(b.published) - new Date(a.published));
        
        // æœ€çµ‚çš„ã«15ä»¶ã«åˆ¶é™
        allEntries = allEntries.slice(0, 15);
        
        // çµ±åˆçµæœã®JSONã‚’ç”Ÿæˆ
        const result = {
          title: 'RSS Reader - ç”ŸæˆAIè¨˜äº‹ãƒ•ã‚£ãƒ¼ãƒ‰',
          description: 'æœ€æ–°ã®ç”ŸæˆAIé–¢é€£è¨˜äº‹ã‚’ã¾ã¨ã‚ã¦é…ä¿¡',
          updated: new Date().toISOString(),
          totalEntries: allEntries.length,
          feeds: processedFeeds,
          entries: allEntries
        };
        
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›
        const outputPath = './rss/feeds.json';
        fs.writeFileSync(outputPath, JSON.stringify(result, null, 2), 'utf8');
        
        console.log(`ğŸ‰ çµ±åˆå®Œäº†: ${allEntries.length}ä»¶ã®è¨˜äº‹ã‚’ ${outputPath} ã«å‡ºåŠ›ã—ã¾ã—ãŸ`);
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        processedFeeds.forEach(feed => {
          console.log(`   ğŸ“° ${feed.name}: ${feed.count}ä»¶`);
        });
        
        // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        feeds.forEach(feed => {
          if (fs.existsSync(feed.file)) {
            fs.unlinkSync(feed.file);
            console.log(`ğŸ—‘ï¸  ${feed.file} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
          }
        });
        
        EOF
    
    # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'ğŸ¤– RSS feeds updated - ${{ steps.date.outputs.date }}'
        file_pattern: 'rss/feeds.json'
        commit_user_name: 'RSS Bot'
        commit_user_email: 'rss-bot@github-actions.local'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # æ—¥ä»˜æƒ…å ±ã‚’å‡ºåŠ›
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

  # Job 2: GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    needs: fetch-rss  # fetch-rssã‚¸ãƒ§ãƒ–ã®å®Œäº†ã‚’å¾…ã¤
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './'  # ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Display deployment URL
      run: |
        echo "ğŸš€ ã‚µã‚¤ãƒˆãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ!"
        echo "ğŸ“± ã‚¢ã‚¯ã‚»ã‚¹URL: ${{ steps.deployment.outputs.page_url }}rss/"
        echo "ğŸ“Š GitHub Pagesè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
