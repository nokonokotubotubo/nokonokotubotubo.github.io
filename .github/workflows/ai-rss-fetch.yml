name: AI RSS Feed Processing

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ai-rss-processing:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser
        
    - name: Create output directories
      run: |
        mkdir -p ai-rss-temp/data
        mkdir -p ai-rss
        
    - name: Process RSS feeds
      run: node src/ai-rss-processor.js
        
    - name: Analyze articles with AI
      run: node src/ai-analyzer.js
        
    - name: Generate HTML dashboard
      run: |
        node src/ai-data-generator.js
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "HTML generated: $(wc -c < ai-rss-temp/dashboard.html) bytes"
        else
          echo "HTML generation failed"
          exit 1
        fi
        
    # âœ… ä¿®æ­£ï¼šStaticCryptè©³ç´°è¨ºæ–­ç‰ˆ
    - name: Encrypt with StaticCrypt (Detailed Debug)
      run: |
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "ğŸ”’ StaticCryptæš—å·åŒ–é–‹å§‹ï¼ˆè©³ç´°è¨ºæ–­ç‰ˆï¼‰"
          
          # StaticCryptã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g staticrypt
          
          # ç’°å¢ƒç¢ºèª
          echo "ğŸ“¦ StaticCrypt version: $(staticrypt --version)"
          echo "ğŸ“¦ Node.js version: $(node --version)"
          echo "ğŸ“¦ npm version: $(npm --version)"
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
          PASSWORD_LENGTH=${#STATICCRYPT_PASSWORD}
          echo "ğŸ”‘ Password length: $PASSWORD_LENGTH characters"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°ç¢ºèª
          echo "ğŸ“„ Input file details:"
          ls -la ai-rss-temp/dashboard.html
          echo "ğŸ“Š Input file size: $(wc -c < ai-rss-temp/dashboard.html) bytes"
          echo "ğŸ“ Input file first 100 chars:"
          head -c 100 ai-rss-temp/dashboard.html
          echo ""
          
          # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          echo "ğŸ“ Output directory before:"
          ls -la ai-rss/
          echo "ğŸ” Output directory permissions:"
          ls -ld ai-rss/
          
          # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          echo "ğŸ“ Working directory: $(pwd)"
          echo "ğŸ“ Full paths:"
          echo "  Input:  $(realpath ai-rss-temp/dashboard.html)"
          echo "  Output: $(realpath ai-rss/)"
          
          # StaticCryptå®Ÿè¡Œå‰ãƒ†ã‚¹ãƒˆ
          echo "ğŸ§ª StaticCrypt command test:"
          staticrypt --help | head -5
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ã«ã‚ˆã‚‹å®Ÿè¡Œ
          if [ $PASSWORD_LENGTH -lt 8 ]; then
            echo "âŒ Error: Password must be 8+ characters"
            exit 1
          elif [ $PASSWORD_LENGTH -lt 14 ]; then
            echo "âš ï¸ Using --short flag for password under 14 chars"
            
            # è©³ç´°å®Ÿè¡Œãƒ­ã‚°ä»˜ãStaticCrypt
            echo "ğŸ”„ StaticCrypt execution with detailed logging:"
            echo "Command: staticrypt ai-rss-temp/dashboard.html -p [HIDDEN] --short -o ai-rss/index.html"
            
            # å®Ÿè¡Œ + æ¨™æº–å‡ºåŠ›ãƒ»æ¨™æº–ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
            set -x  # ã‚³ãƒãƒ³ãƒ‰ãƒˆãƒ¬ãƒ¼ã‚¹é–‹å§‹
            staticrypt ai-rss-temp/dashboard.html -p "$STATICCRYPT_PASSWORD" --short -o ai-rss/index.html 2>&1 | tee staticrypt_full_log.txt
            STATICCRYPT_EXIT_CODE=${PIPESTATUS[0]}
            set +x  # ã‚³ãƒãƒ³ãƒ‰ãƒˆãƒ¬ãƒ¼ã‚¹çµ‚äº†
            
            echo "ğŸ“Š StaticCrypt exit code: $STATICCRYPT_EXIT_CODE"
            
            # å®Ÿè¡Œãƒ­ã‚°è¡¨ç¤º
            echo "ğŸ“„ StaticCrypt full output:"
            cat staticrypt_full_log.txt || echo "No log file created"
            
          else
            echo "âœ… Using normal execution for 14+ char password"
            
            set -x
            staticrypt ai-rss-temp/dashboard.html -p "$STATICCRYPT_PASSWORD" -o ai-rss/index.html 2>&1 | tee staticrypt_full_log.txt
            STATICCRYPT_EXIT_CODE=${PIPESTATUS[0]}
            set +x
            
            echo "ğŸ“Š StaticCrypt exit code: $STATICCRYPT_EXIT_CODE"
            echo "ğŸ“„ StaticCrypt full output:"
            cat staticrypt_full_log.txt || echo "No log file created"
          fi
          
          # å®Ÿè¡Œå¾Œè©³ç´°ç¢ºèª
          echo "ğŸ” Post-execution analysis:"
          echo "ğŸ“ Output directory after:"
          ls -la ai-rss/
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆç¢ºèª
          if [ -f ai-rss/index.html ]; then
            FILE_SIZE=$(wc -c < ai-rss/index.html)
            echo "âœ… Encryption successful: $FILE_SIZE bytes"
            
            if [ $FILE_SIZE -gt 1000 ]; then
              echo "âœ… File size appropriate"
              echo "ğŸ“„ Output file first 200 chars:"
              head -c 200 ai-rss/index.html
              echo ""
            else
              echo "âš ï¸ File size too small: $FILE_SIZE bytes"
              echo "ğŸ“„ Complete file content:"
              cat ai-rss/index.html
            fi
            
            # StaticCrypt signature check
            if grep -q "StaticCrypt" ai-rss/index.html; then
              echo "âœ… StaticCrypt signature found"
            else
              echo "âš ï¸ StaticCrypt signature not found"
            fi
            
          else
            echo "âŒ Encryption failed - file not created"
            
            # å¤±æ•—æ™‚ã®è©³ç´°è¨ºæ–­
            echo "ğŸ” Failure analysis:"
            echo "ğŸ“Š StaticCrypt exit code was: $STATICCRYPT_EXIT_CODE"
            echo "ğŸ“ Current directory contents:"
            find . -name "*.html" -o -name "*.log" -o -name "index.*" | sort
            echo "ğŸ“ ai-rss directory contents:"
            find ai-rss -type f 2>/dev/null || echo "No files in ai-rss"
            echo "ğŸ“„ Any error logs:"
            find . -name "*error*" -o -name "*log*" | head -5
            
            # æ¨©é™ãƒã‚§ãƒƒã‚¯
            echo "ğŸ” Permission check:"
            touch ai-rss/test_write.tmp && echo "âœ… Write permission OK" || echo "âŒ Write permission failed"
            rm -f ai-rss/test_write.tmp
            
            # æ‰‹å‹•ä½œæˆãƒ†ã‚¹ãƒˆ
            echo "ğŸ§ª Manual file creation test:"
            echo "Test content" > ai-rss/manual_test.html && echo "âœ… Manual creation OK" || echo "âŒ Manual creation failed"
            ls -la ai-rss/manual_test.html 2>/dev/null || echo "Manual test file not found"
            rm -f ai-rss/manual_test.html
            
            exit 1
          fi
        else
          echo "âŒ Input file not found"
          exit 1
        fi
      env:
        STATICCRYPT_PASSWORD: ${{ secrets.STATICCRYPT_PASSWORD }}
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./ai-rss
        force_orphan: true
        enable_jekyll: false
        
    - name: Deployment complete
      run: |
        echo "Dashboard deployed successfully!"
        echo "Access: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
