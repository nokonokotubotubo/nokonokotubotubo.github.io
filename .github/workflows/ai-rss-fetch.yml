name: AI RSS Feed Processing with Debug

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ai-rss-processing:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    # ğŸ“Š å®Ÿè¡Œç’°å¢ƒã®è©³ç´°ç¢ºèª
    - name: Debug - Environment check
      run: |
        echo "ğŸ” å®Ÿè¡Œç’°å¢ƒç¢ºèª:"
        echo "PWD: $(pwd)"
        echo "HOME: $HOME"
        echo "USER: $USER"
        echo "ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
        ls -la
        echo "ğŸ“ ãƒªãƒã‚¸ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«:"
        find . -type f -name "*.js" -o -name "*.json" | head -20
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser
        
    # ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    - name: Debug - Project files check
      run: |
        echo "ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        echo "src/ exists: $([ -d src ] && echo 'YES' || echo 'NO')"
        echo "config/ exists: $([ -d config ] && echo 'YES' || echo 'NO')"
        if [ -d src ]; then
          echo "ğŸ“„ src/ contents:"
          ls -la src/
        fi
        if [ -d config ]; then
          echo "ğŸ“„ config/ contents:"
          ls -la config/
        fi
        
    - name: Create output directories
      run: |
        mkdir -p ai-rss-temp/data
        mkdir -p ai-rss
        echo "ğŸ“ å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå®Œäº†"
        ls -la ai-rss-temp/
        
    - name: Process RSS feeds
      run: |
        echo "ğŸš€ RSSå‡¦ç†é–‹å§‹ - PWD: $(pwd)"
        node src/ai-rss-processor.js
        echo "ğŸ“„ RSSå‡¦ç†å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        ls -la ai-rss-temp/data/ || echo "ai-rss-temp/data/ ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        
    - name: Analyze articles with AI
      run: |
        echo "ğŸ¤– AIåˆ†æé–‹å§‹ - PWD: $(pwd)"
        node src/ai-analyzer.js
        echo "ğŸ“„ AIåˆ†æå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        ls -la ai-rss-temp/data/ || echo "ai-rss-temp/data/ ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        
    - name: Generate HTML dashboard
      run: |
        echo "ğŸ¨ HTMLç”Ÿæˆé–‹å§‹ - PWD: $(pwd)"
        node src/ai-data-generator.js
        echo "ğŸ“„ HTMLç”Ÿæˆå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        ls -la ai-rss-temp/ || echo "ai-rss-temp/ ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "âœ… dashboard.html ç”ŸæˆæˆåŠŸ ($(wc -c < ai-rss-temp/dashboard.html) bytes)"
        else
          echo "âŒ dashboard.html ç”Ÿæˆå¤±æ•—"
        fi
        
    # ğŸ“Š æš—å·åŒ–å‰ã®æœ€çµ‚ç¢ºèª
    - name: Debug - Pre-encryption check
      run: |
        echo "ğŸ” æš—å·åŒ–å‰ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
        echo "ğŸ“ å…¨ä½“æ§‹é€ :"
        find . -name "*.html" -o -name "*.json" | grep -E "(ai-rss|dashboard)" || echo "é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "ğŸ“Š ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡:"
        du -sh ai-rss-temp/ ai-rss/ 2>/dev/null || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        
    - name: Encrypt with StaticCrypt
      run: |
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "ğŸ”’ StaticCryptæš—å·åŒ–é–‹å§‹"
          npm install -g staticrypt
          staticrypt ai-rss-temp/dashboard.html -p "${{ secrets.STATICCRYPT_PASSWORD }}" -o ai-rss/index.html
          echo "âœ… æš—å·åŒ–å®Œäº†"
          ls -la ai-rss/
        else
          echo "âŒ dashboard.html ãŒå­˜åœ¨ã—ãªã„ãŸã‚æš—å·åŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          exit 1
        fi
      env:
        STATICCRYPT_PASSWORD: ${{ secrets.STATICCRYPT_PASSWORD }}
        
    # ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚ç¢ºèª
    - name: Debug - Pre-deploy check
      run: |
        echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å‰æœ€çµ‚ç¢ºèª:"
        if [ -f ai-rss/index.html ]; then
          echo "âœ… index.html exists ($(wc -c < ai-rss/index.html) bytes)"
          echo "ğŸ“„ ai-rss/ contents:"
          ls -la ai-rss/
        else
          echo "âŒ index.html ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ğŸ“ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
          find . -type f | grep -v node_modules | sort
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./ai-rss
        force_orphan: true
        enable_jekyll: false
        
    - name: Deployment complete
      run: |
        echo "ğŸ‰ AI RSS Dashboard deployed successfully!"
        echo "ğŸ”— Access: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
