name: AI RSS Feed Processing - Module Execution Fix

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ai-rss-processing:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser
        
    - name: Create output directories
      run: |
        mkdir -p ai-rss-temp/data
        mkdir -p ai-rss
        
    - name: Process RSS feeds
      run: |
        echo "🚀 RSS処理開始"
        node src/ai-rss-processor.js
        
    - name: Analyze articles with AI
      run: |
        echo "🤖 AI分析開始"
        node src/ai-analyzer.js
        
    # ✅ 修正：直接実行でメインモジュールとして認識
    - name: Generate HTML dashboard
      run: |
        echo "🎨 HTML生成開始"
        node src/ai-data-generator.js
        echo "📊 HTML生成後の確認:"
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "✅ dashboard.html 生成成功 ($(wc -c < ai-rss-temp/dashboard.html) bytes)"
        else
          echo "❌ dashboard.html 生成失敗"
          echo "📁 ai-rss-temp 内容:"
          find ai-rss-temp -type f 2>/dev/null || echo "ai-rss-temp が空"
        fi
        
    - name: Encrypt with StaticCrypt
      run: |
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "🔒 StaticCrypt暗号化開始"
          npm install -g staticrypt
          staticrypt ai-rss-temp/dashboard.html -p "${{ secrets.STATICCRYPT_PASSWORD }}" -o ai-rss/index.html
          echo "✅ 暗号化完了 ($(wc -c < ai-rss/index.html) bytes)"
          ls -la ai-rss/
        else
          echo "❌ dashboard.html が存在しないため暗号化失敗"
          exit 1
        fi
      env:
        STATICCRYPT_PASSWORD: ${{ secrets.STATICCRYPT_PASSWORD }}
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./ai-rss
        force_orphan: true
        enable_jekyll: false
        
    - name: Deployment complete
      run: |
        echo "🎉 AI RSS Dashboard deployed successfully!"
        echo "🔗 Access: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
