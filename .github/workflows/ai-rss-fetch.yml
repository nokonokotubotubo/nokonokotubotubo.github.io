name: AI RSS Feed Processing - 8+ Char Password

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  ai-rss-processing:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser
        
    - name: Create output directories
      run: |
        mkdir -p ai-rss-temp/data
        mkdir -p ai-rss
        
    - name: Process RSS feeds
      run: |
        echo "ğŸš€ RSSå‡¦ç†é–‹å§‹"
        node src/ai-rss-processor.js
        
    - name: Analyze articles with AI
      run: |
        echo "ğŸ¤– AIåˆ†æé–‹å§‹"
        node src/ai-analyzer.js
        
    - name: Generate HTML dashboard
      run: |
        echo "ğŸ¨ HTMLç”Ÿæˆé–‹å§‹"
        node src/ai-data-generator.js
        echo "ğŸ“Š HTMLç”Ÿæˆå¾Œã®ç¢ºèª:"
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "âœ… dashboard.html ç”ŸæˆæˆåŠŸ ($(wc -c < ai-rss-temp/dashboard.html) bytes)"
        else
          echo "âŒ dashboard.html ç”Ÿæˆå¤±æ•—"
          exit 1
        fi
        
    # âœ… ä¿®æ­£ï¼š8æ–‡å­—ä»¥ä¸Šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œç‰ˆStaticCryptæš—å·åŒ–
    - name: Encrypt with StaticCrypt (8+ chars password)
      run: |
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "ğŸ”’ StaticCryptæš—å·åŒ–é–‹å§‹"
          npm install -g staticrypt
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ãƒã‚§ãƒƒã‚¯
          PASSWORD_LENGTH=${#STATICCRYPT_PASSWORD}
          echo "ğŸ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·: $PASSWORD_LENGTH æ–‡å­—"
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ã«ã‚ˆã‚‹å‡¦ç†åˆ†å²
          if [ $PASSWORD_LENGTH -lt 8 ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
            echo "ğŸ’¡ ç¾åœ¨: $PASSWORD_LENGTH æ–‡å­— (æœ€å°è¦ä»¶: 8æ–‡å­—)"
            exit 1
          elif [ $PASSWORD_LENGTH -lt 14 ]; then
            echo "âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ14æ–‡å­—æœªæº€ã§ã™ ($PASSWORD_LENGTH æ–‡å­—)"
            echo "ğŸ’¡ StaticCryptã®è­¦å‘Šã‚’--shortãƒ•ãƒ©ã‚°ã§ç„¡åŠ¹åŒ–ã—ã¾ã™"
            # 8-13æ–‡å­—: --shortãƒ•ãƒ©ã‚°ã§è­¦å‘Šç„¡åŠ¹åŒ– + éå¯¾è©±çš„å®Ÿè¡Œ
            echo "y" | staticrypt ai-rss-temp/dashboard.html -p "$STATICCRYPT_PASSWORD" --short -o ai-rss/index.html
          else
            echo "âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ãŒæ¨å¥¨å€¤ã§ã™ ($PASSWORD_LENGTH æ–‡å­—)"
            # 14æ–‡å­—ä»¥ä¸Š: é€šå¸¸å®Ÿè¡Œ
            staticrypt ai-rss-temp/dashboard.html -p "$STATICCRYPT_PASSWORD" -o ai-rss/index.html
          fi
          
          # æš—å·åŒ–çµæœã®è©³ç´°æ¤œè¨¼
          if [ -f ai-rss/index.html ]; then
            FILE_SIZE=$(wc -c < ai-rss/index.html)
            echo "âœ… æš—å·åŒ–å®Œäº† ($FILE_SIZE bytes)"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
            if [ $FILE_SIZE -gt 1000 ]; then
              echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºé©åˆ‡ ($FILE_SIZE bytes)"
            else
              echo "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™ ($FILE_SIZE bytes)"
              echo "ğŸ’¡ æš—å·åŒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              exit 1
            fi
            
            echo "ğŸ“„ ai-rss/ å†…å®¹:"
            ls -la ai-rss/
            
            # æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèªï¼ˆå…ˆé ­éƒ¨åˆ†ï¼‰
            echo "ğŸ“„ æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­100æ–‡å­—:"
            head -c 100 ai-rss/index.html
            echo ""
            
            # StaticCryptã®æš—å·åŒ–ãƒãƒ¼ã‚«ãƒ¼ç¢ºèª
            if grep -q "StaticCrypt" ai-rss/index.html; then
              echo "âœ… StaticCryptæš—å·åŒ–ãƒãƒ¼ã‚«ãƒ¼ç¢ºèª"
            else
              echo "âš ï¸ StaticCryptæš—å·åŒ–ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
            
          else
            echo "âŒ æš—å·åŒ–å¤±æ•—: ai-rss/index.html ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "ğŸ” StaticCryptå®Ÿè¡Œãƒ­ã‚°:"
            echo "ğŸ” ai-rss/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la ai-rss/ || echo "ai-rss/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ğŸ” ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la . | grep -E "(ai-rss|dashboard)"
            exit 1
          fi
        else
          echo "âŒ dashboard.html ãŒå­˜åœ¨ã—ãªã„ãŸã‚æš—å·åŒ–å¤±æ•—"
          exit 1
        fi
      env:
        STATICCRYPT_PASSWORD: ${{ secrets.STATICCRYPT_PASSWORD }}
        
    # âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æœ€çµ‚æ¤œè¨¼
    - name: Pre-deploy verification
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å‰æœ€çµ‚æ¤œè¨¼:"
        if [ -f ai-rss/index.html ]; then
          FILE_SIZE=$(wc -c < ai-rss/index.html)
          echo "âœ… index.html å­˜åœ¨ç¢ºèª ($FILE_SIZE bytes)"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
          if [ $FILE_SIZE -gt 1000 ]; then
            echo "âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºé©åˆ‡"
          else
            echo "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™ ($FILE_SIZE bytes)"
            exit 1
          fi
          
          # æš—å·åŒ–ã•ã‚ŒãŸHTMLã®åŸºæœ¬æ§‹é€ ç¢ºèª
          if grep -q "<!DOCTYPE html>" ai-rss/index.html && grep -q "StaticCrypt" ai-rss/index.html; then
            echo "âœ… æš—å·åŒ–HTMLæ§‹é€ ç¢ºèªå®Œäº†"
          else
            echo "âš ï¸ HTMLæ§‹é€ ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚µãƒ³ãƒ—ãƒ«:"
            head -n 5 ai-rss/index.html
          fi
        else
          echo "âŒ index.html ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          echo "ğŸ“ ai-rss/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
          ls -la ai-rss/ || echo "ai-rss/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./ai-rss
        force_orphan: true
        enable_jekyll: false
        
    - name: Deployment complete
      run: |
        echo "ğŸ‰ AI RSS Dashboard deployed successfully!"
        echo "ğŸ”— Access: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ” Password protected by StaticCrypt"
