name: AI RSS Debug - HTML Generation Issue

on:
  workflow_dispatch:

jobs:
  debug-html-generation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install rss-parser
        
    - name: Create output directories
      run: |
        mkdir -p ai-rss-temp/data
        mkdir -p ai-rss
        
    - name: Process RSS feeds
      run: |
        echo "ğŸš€ RSSå‡¦ç†é–‹å§‹"
        node src/ai-rss-processor.js
        
    # ğŸ” RSSå‡¦ç†å¾Œã®è©³ç´°ç¢ºèª
    - name: Debug - Post RSS processing
      run: |
        echo "ğŸ“Š RSSå‡¦ç†å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³:"
        if [ -f ai-rss-temp/data/articles.json ]; then
          echo "âœ… articles.json å­˜åœ¨ ($(wc -c < ai-rss-temp/data/articles.json) bytes)"
          echo "ğŸ“„ è¨˜äº‹æ•°: $(jq length ai-rss-temp/data/articles.json)"
          echo "ğŸ“‹ æœ€åˆã®è¨˜äº‹ã‚µãƒ³ãƒ—ãƒ«:"
          jq '.[0] | {title, category, preference}' ai-rss-temp/data/articles.json || echo "JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼"
        else
          echo "âŒ articles.json ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          ls -la ai-rss-temp/data/ || echo "ai-rss-temp/data/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸å­˜åœ¨"
        fi
        
    - name: Analyze articles with AI
      run: |
        echo "ğŸ¤– AIåˆ†æé–‹å§‹"
        node src/ai-analyzer.js
        
    # ğŸ” AIåˆ†æå¾Œã®è©³ç´°ç¢ºèª
    - name: Debug - Post AI analysis
      run: |
        echo "ğŸ“Š AIåˆ†æå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³:"
        if [ -f ai-rss-temp/data/articles.json ]; then
          echo "âœ… articles.json æ›´æ–°ç¢ºèª ($(wc -c < ai-rss-temp/data/articles.json) bytes)"
          echo "ğŸ“„ preferenceåˆ†å¸ƒ:"
          jq 'group_by(.preference) | map({preference: .[0].preference, count: length})' ai-rss-temp/data/articles.json || echo "JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼"
          
          echo "ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«è¨˜äº‹ï¼ˆå—œå¥½ä»˜ãï¼‰:"
          jq '.[0] | {title, preference, preferenceScore}' ai-rss-temp/data/articles.json || echo "JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼"
        else
          echo "âŒ articles.json ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
        fi
        
        echo "ğŸ“ ai-rss-temp/data/ å…¨ä½“:"
        ls -la ai-rss-temp/data/ || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸å­˜åœ¨"
        
    # ğŸ” HTMLç”Ÿæˆå‰ã®äº‹å‰ãƒã‚§ãƒƒã‚¯
    - name: Debug - Pre HTML generation check
      run: |
        echo "ğŸ” HTMLç”Ÿæˆå‰ãƒã‚§ãƒƒã‚¯:"
        echo "ğŸ“„ Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(node --version)"
        echo "ğŸ“„ åˆ©ç”¨å¯èƒ½ãƒ¡ãƒ¢ãƒª: $(free -h)"
        echo "ğŸ“„ ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡: $(df -h .)"
        
        # JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        if [ -f ai-rss-temp/data/articles.json ]; then
          echo "ğŸ” JSONæ§‹æ–‡ãƒã‚§ãƒƒã‚¯:"
          jq empty ai-rss-temp/data/articles.json && echo "âœ… JSONæ§‹æ–‡æ­£å¸¸" || echo "âŒ JSONæ§‹æ–‡ã‚¨ãƒ©ãƒ¼"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          SIZE=$(wc -c < ai-rss-temp/data/articles.json)
          echo "ğŸ“Š articles.json ã‚µã‚¤ã‚º: $SIZE bytes"
          if [ $SIZE -gt 1000000 ]; then
            echo "âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„å¯èƒ½æ€§"
          fi
        fi
        
    # ğŸ” HTMLç”Ÿæˆã‚’try-catchã§å®Ÿè¡Œ
    - name: Generate HTML dashboard with error handling
      run: |
        echo "ğŸ¨ HTMLç”Ÿæˆé–‹å§‹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ç‰ˆï¼‰"
        
        # JavaScriptå®Ÿè¡Œå‰ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
        echo "ğŸ“Š å®Ÿè¡Œå‰ãƒ¡ãƒ¢ãƒª: $(free -h | grep Mem)"
        
        # Node.jsã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ
        node -e "
        try {
          console.log('ğŸ”„ HTMLç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œé–‹å§‹');
          require('./src/ai-data-generator.js');
          console.log('âœ… HTMLç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆæ­£å¸¸çµ‚äº†');
        } catch (error) {
          console.error('âŒ HTMLç”Ÿæˆã‚¨ãƒ©ãƒ¼è©³ç´°:');
          console.error('Error name:', error.name);
          console.error('Error message:', error.message);
          console.error('Error stack:', error.stack);
          process.exit(1);
        }
        " 2>&1 | tee html_generation.log
        
        # å®Ÿè¡Œå¾Œã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
        echo "ğŸ“Š å®Ÿè¡Œå¾Œãƒ¡ãƒ¢ãƒª: $(free -h | grep Mem)"
        
    # ğŸ” HTMLç”Ÿæˆå¾Œã®è©³ç´°ç¢ºèª
    - name: Debug - Post HTML generation
      run: |
        echo "ğŸ“Š HTMLç”Ÿæˆå¾Œã®çŠ¶æ³:"
        
        # ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "âœ… dashboard.html ç”ŸæˆæˆåŠŸ ($(wc -c < ai-rss-temp/dashboard.html) bytes)"
          echo "ğŸ“„ HTMLãƒ•ã‚¡ã‚¤ãƒ«å…ˆé ­100æ–‡å­—:"
          head -c 100 ai-rss-temp/dashboard.html
          echo ""
          echo "ğŸ“„ HTMLãƒ•ã‚¡ã‚¤ãƒ«æœ«å°¾100æ–‡å­—:"
          tail -c 100 ai-rss-temp/dashboard.html
        else
          echo "âŒ dashboard.html ç”Ÿæˆå¤±æ•—"
        fi
        
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ç¢ºèª
        echo "ğŸ“ ai-rss-temp/ å…¨ä½“æ§‹é€ :"
        find ai-rss-temp -type f -exec ls -lh {} \; 2>/dev/null || echo "ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨"
        
        # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
        if [ -f html_generation.log ]; then
          echo "ğŸ“„ ç”Ÿæˆãƒ­ã‚°:"
          cat html_generation.log
        fi
        
    - name: Test encryption (conditional)
      run: |
        if [ -f ai-rss-temp/dashboard.html ]; then
          echo "ğŸ”’ æš—å·åŒ–ãƒ†ã‚¹ãƒˆ"
          npm install -g staticrypt
          staticrypt ai-rss-temp/dashboard.html -p "test123" -o ai-rss/index.html
          echo "âœ… æš—å·åŒ–ãƒ†ã‚¹ãƒˆæˆåŠŸ"
          ls -la ai-rss/
        else
          echo "â­ï¸ dashboard.htmlä¸å­˜åœ¨ã®ãŸã‚æš—å·åŒ–ã‚¹ã‚­ãƒƒãƒ—"
        fi
