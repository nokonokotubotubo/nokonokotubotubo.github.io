# .github/workflows/rss-fetcher.yml (ã‚¨ãƒ©ãƒ¼ä¿®æ­£ç‰ˆ)
name: RSS Feed Fetcher

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create data directory
      run: mkdir -p data

    # ä¿®æ­£1: remove_publishedãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    # ä¿®æ­£2: User-Agentè¨­å®šã‚’è¿½åŠ [4][5]
    - name: Fetch Tech News RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://feeds.feedburner.com/oreilly/radar'
        file_path: './data/tech-news.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}'
        parser_options: '{"useISODateFormat": false}'

    # ã‚ˆã‚Šå®‰å®šã—ãŸNHKãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰
    - name: Fetch NHK News RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://www3.nhk.or.jp/rss/news/cat0.xml'
        file_path: './data/nhk-news.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (compatible; RSS Reader Bot)"}}'

    # GIGAZINEï¼ˆé«˜ã„å®‰å®šæ€§ï¼‰
    - name: Fetch GIGAZINE RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://gigazine.net/news/rss_2.0/'
        file_path: './data/gigazine.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (compatible; RSS Reader Bot)"}}'

    # ITãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆã‚ˆã‚Šå®‰å®šã—ãŸURLï¼‰
    - name: Fetch IT Media RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://rss.itmedia.co.jp/rss/2.0/topstory.xml'
        file_path: './data/it-media.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}}'
      continue-on-error: true

    # ä»£æ›¿ãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆç¢ºå®Ÿã«å‹•ä½œã™ã‚‹ã‚‚ã®ï¼‰
    - name: Fetch Alternative Stable RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://news.yahoo.co.jp/rss/topics/top-picks.xml'
        file_path: './data/yahoo-news.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (compatible; RSS Reader Bot)"}}'
      continue-on-error: true

    # RSS URLäº‹å‰æ¤œè¨¼ï¼ˆæ¤œç´¢çµæœ[4]ã®æ‰‹æ³•ï¼‰
    - name: Validate RSS URLs before processing
      run: |
        echo "ğŸ“¡ RSSãƒ•ã‚£ãƒ¼ãƒ‰URLã®äº‹å‰æ¤œè¨¼..."
        
        urls=(
          "https://feeds.feedburner.com/oreilly/radar"
          "https://www3.nhk.or.jp/rss/news/cat0.xml" 
          "https://gigazine.net/news/rss_2.0/"
          "https://rss.itmedia.co.jp/rss/2.0/topstory.xml"
          "https://news.yahoo.co.jp/rss/topics/top-picks.xml"
        )
        
        user_agent="Mozilla/5.0 (compatible; RSS Reader Bot)"
        
        for url in "${urls[@]}"; do
          echo "æ¤œè¨¼ä¸­: $url"
          
          # HEAD ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ç¢ºèª
          response=$(curl -s -I -H "User-Agent: $user_agent" "$url" | head -1)
          status_code=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: $user_agent" "$url")
          
          if [ "$status_code" = "200" ]; then
            echo "âœ… $url: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ (HTTP $status_code)"
          else
            echo "âŒ $url: ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ (HTTP $status_code)"
            echo "   ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $response"
          fi
        done

    # å‹•çš„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆæˆåŠŸã—ãŸãƒ•ã‚£ãƒ¼ãƒ‰ã®ã¿ï¼‰
    - name: Generate feed metadata
      run: |
        echo "ğŸ“Š ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­..."
        
        # åŸºæœ¬ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        cat > data/feeds-meta.json << 'EOF'
        {
          "lastUpdated": "",
          "totalFeeds": 0,
          "feeds": []
        }
        EOF
        
        # å®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        feeds_array="["
        total_feeds=0
        first=true
        
        # å„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨è¿½åŠ 
        declare -A feed_configs
        feed_configs[tech-news.json]='{"id":"tech-news","name":"Tech News","description":"O'\''Reilly Radar","color":"#FF6B35"}'
        feed_configs[nhk-news.json]='{"id":"nhk-news","name":"NHKãƒ‹ãƒ¥ãƒ¼ã‚¹","description":"NHK ä¸»è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹","color":"#2E7D32"}'
        feed_configs[gigazine.json]='{"id":"gigazine","name":"GIGAZINE","description":"GIGAZINE ãƒ†ãƒƒã‚¯è¨˜äº‹","color":"#FF4081"}'
        feed_configs[it-media.json]='{"id":"it-media","name":"ITãƒ¡ãƒ‡ã‚£ã‚¢","description":"ITmedia ãƒ‹ãƒ¥ãƒ¼ã‚¹","color":"#4A90E2"}'
        feed_configs[yahoo-news.json]='{"id":"yahoo-news","name":"Yahoo!ãƒ‹ãƒ¥ãƒ¼ã‚¹","description":"Yahoo! ä¸»è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹","color":"#6F42C1"}'
        
        for filename in "${!feed_configs[@]}"; do
          if [ -f "data/$filename" ] && jq empty "data/$filename" 2>/dev/null; then
            entries=$(jq '.entries | length' "data/$filename" 2>/dev/null || echo "0")
            if [ "$entries" -gt 0 ]; then
              [ "$first" = false ] && feeds_array+=","
              
              # JSONè¨­å®šã« file ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
              feed_json=$(echo "${feed_configs[$filename]}" | jq --arg file "$filename" '. + {file: $file}')
              feeds_array+="$feed_json"
              
              ((total_feeds++))
              first=false
              echo "âœ… $filename: ${entries}ä»¶ã®è¨˜äº‹ã‚’æ¤œå‡º"
            fi
          fi
        done
        
        feeds_array+="]"
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        jq --argjson feeds "$feeds_array" \
           --arg updated "$current_time" \
           --argjson total "$total_feeds" \
           '.feeds = $feeds | .lastUpdated = $updated | .totalFeeds = $total' \
           data/feeds-meta.json > data/feeds-meta-tmp.json
        
        mv data/feeds-meta-tmp.json data/feeds-meta.json
        
        echo "ğŸ“Š ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†: ${total_feeds}å€‹ã®ãƒ•ã‚£ãƒ¼ãƒ‰"

    # è©³ç´°ãªæ¤œè¨¼ã¨ãƒ¬ãƒãƒ¼ãƒˆ
    - name: Comprehensive Validation and Report
      run: |
        echo "=== RSSå–å¾—çµæœè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ ==="
        success_count=0
        error_count=0
        total_articles=0
        
        for file in data/*.json; do
          if [ -f "$file" ] && [ "$(basename "$file")" != "feeds-meta.json" ]; then
            filename=$(basename "$file")
            
            if jq empty "$file" 2>/dev/null; then
              entries=$(jq '.entries | length' "$file" 2>/dev/null || echo "0")
              title=$(jq -r '.title // "Unknown"' "$file" 2>/dev/null)
              
              if [ "$entries" -gt 0 ]; then
                echo "âœ… $filename: ${entries}ä»¶ - $title"
                ((success_count++))
                ((total_articles += entries))
              else
                echo "âš ï¸ $filename: è¨˜äº‹ãªã— - $title"
                ((error_count++))
              fi
            else
              echo "âŒ $filename: JSONè§£æã‚¨ãƒ©ãƒ¼"
              echo "   ã‚¨ãƒ©ãƒ¼å†…å®¹ï¼ˆæœ€åˆã®3è¡Œï¼‰:"
              head -3 "$file" | sed 's/^/   /'
              ((error_count++))
            fi
          fi
        done
        
        echo ""
        echo "ğŸ“Š æœ€çµ‚å–å¾—çµæœ:"
        echo "   âœ… æˆåŠŸ: ${success_count}ãƒ•ã‚£ãƒ¼ãƒ‰"
        echo "   âŒ ã‚¨ãƒ©ãƒ¼: ${error_count}ãƒ•ã‚£ãƒ¼ãƒ‰" 
        echo "   ğŸ“° ç·è¨˜äº‹æ•°: ${total_articles}ä»¶"
        echo "   ğŸ“… å®Ÿè¡Œæ™‚åˆ»: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
        # æœ€å°é™ã®æˆåŠŸæ¡ä»¶ãƒã‚§ãƒƒã‚¯
        if [ $success_count -gt 0 ]; then
          echo ""
          echo "ğŸ‰ å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã¾ã—ãŸ"
        else
          echo ""
          echo "ğŸ’¥ å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¤±æ•—ã¨ã—ã¦çµ‚äº†ã—ã¾ã™"
          exit 1
        fi

    # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆæ¤œç´¢çµæœ[1][5]ã®æ‰‹æ³•ï¼‰
    - name: Commit and push RSS data
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'RSS feeds updated - $(date -u +"%Y-%m-%d %H:%M UTC")'
        file_pattern: 'data/*.json'
        commit_user_name: 'RSS Fetcher Bot'
        commit_user_email: 'action@github.com'

    # å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
    - name: Execution Summary
      if: always()
      run: |
        echo "=== å®Ÿè¡Œã‚µãƒãƒªãƒ¼ ==="
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒæˆåŠŸ"
          echo "ğŸ“‚ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la data/ || echo "dataãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        else
          echo "âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå¤±æ•—"
          echo "ğŸ’¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
          echo "   1. RSSãƒ•ã‚£ãƒ¼ãƒ‰URLãŒæœ‰åŠ¹ã‹ç¢ºèª"
          echo "   2. ã‚µãƒ¼ãƒãƒ¼ãŒUser-Agentã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ãªã„ã‹ç¢ºèª"
          echo "   3. ä¸€æ™‚çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œã®å¯èƒ½æ€§"
        fi
