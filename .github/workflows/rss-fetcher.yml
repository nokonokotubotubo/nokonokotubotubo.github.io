# .github/workflows/rss-fetcher.yml (404ã‚¨ãƒ©ãƒ¼å¯¾å¿œç‰ˆ)
name: RSS Feed Fetcher

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create data directory
      run: mkdir -p data

    # æ¤œç´¢çµæœ[1][2]ã«åŸºã¥ãä¿®æ­£ç‰ˆ
    - name: Fetch Tech News RSS (with User-Agent)
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://feeds.feedburner.com/oreilly/radar'
        file_path: './data/tech-news.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}'
        parser_options: '{"useISODateFormat": false}'
        remove_published: true

    # å‹•ä½œç¢ºèªæ¸ˆã¿RSSãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆ404ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    - name: Fetch NHK News RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://www3.nhk.or.jp/rss/news/cat0.xml'
        file_path: './data/nhk-news.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (compatible; RSS Reader Bot)"}}'

    # GIGAZINEï¼ˆå®‰å®šã—ãŸãƒ•ã‚£ãƒ¼ãƒ‰ï¼‰
    - name: Fetch GIGAZINE RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://gigazine.net/news/rss_2.0/'
        file_path: './data/gigazine.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (compatible; RSS Reader Bot)"}}'

    # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã®ITmediaï¼ˆä»£æ›¿URLï¼‰
    - name: Fetch IT Media RSS (with fallback)
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://rss.itmedia.co.jp/rss/2.0/topstory.xml'  # ã‚ˆã‚Šå®‰å®šã—ãŸURL
        file_path: './data/it-media.json'
        fetch_options: '{"headers": {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}}'
      continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ

    # ãƒ•ã‚£ãƒ¼ãƒ‰URLã®äº‹å‰æ¤œè¨¼
    - name: Validate RSS URLs
      run: |
        echo "ğŸ“¡ RSSãƒ•ã‚£ãƒ¼ãƒ‰URLã®æ¤œè¨¼..."
        
        urls=(
          "https://feeds.feedburner.com/oreilly/radar"
          "https://www3.nhk.or.jp/rss/news/cat0.xml"
          "https://gigazine.net/news/rss_2.0/"
          "https://rss.itmedia.co.jp/rss/2.0/topstory.xml"
        )
        
        for url in "${urls[@]}"; do
          echo "æ¤œè¨¼ä¸­: $url"
          
          # User-Agentä»˜ãã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ[2]
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: Mozilla/5.0 (compatible; RSS Reader Bot)" \
            "$url")
          
          if [ "$response" = "200" ]; then
            echo "âœ… $url: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ (HTTP $response)"
          else
            echo "âŒ $url: ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ (HTTP $response)"
          fi
        done

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆæˆåŠŸã—ãŸãƒ•ã‚£ãƒ¼ãƒ‰ã®ã¿ï¼‰
    - name: Generate feed metadata
      run: |
        cat > data/feeds-meta.json << 'EOF'
        {
          "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "feeds": []
        }
        EOF
        
        # å®Ÿéš›ã«ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
        feeds_array="["
        first=true
        
        if [ -f "data/tech-news.json" ]; then
          [ "$first" = false ] && feeds_array+=","
          feeds_array+='{
            "id": "tech-news",
            "name": "Tech News", 
            "description": "O'\''Reilly Radar",
            "file": "tech-news.json",
            "color": "#FF6B35"
          }'
          first=false
        fi
        
        if [ -f "data/nhk-news.json" ]; then
          [ "$first" = false ] && feeds_array+=","
          feeds_array+='{
            "id": "nhk-news",
            "name": "NHKãƒ‹ãƒ¥ãƒ¼ã‚¹",
            "description": "NHK ä¸»è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹", 
            "file": "nhk-news.json",
            "color": "#2E7D32"
          }'
          first=false
        fi
        
        if [ -f "data/gigazine.json" ]; then
          [ "$first" = false ] && feeds_array+=","
          feeds_array+='{
            "id": "gigazine",
            "name": "GIGAZINE",
            "description": "GIGAZINE ãƒ†ãƒƒã‚¯è¨˜äº‹",
            "file": "gigazine.json", 
            "color": "#FF4081"
          }'
          first=false
        fi
        
        if [ -f "data/it-media.json" ]; then
          [ "$first" = false ] && feeds_array+=","
          feeds_array+='{
            "id": "it-media",
            "name": "ITãƒ¡ãƒ‡ã‚£ã‚¢",
            "description": "ITmedia ãƒ‹ãƒ¥ãƒ¼ã‚¹",
            "file": "it-media.json",
            "color": "#4A90E2"
          }'
          first=false
        fi
        
        feeds_array+="]"
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        jq --argjson feeds "$feeds_array" \
           --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
           '.feeds = $feeds | .lastUpdated = $updated' \
           data/feeds-meta.json > data/feeds-meta-tmp.json
        
        mv data/feeds-meta-tmp.json data/feeds-meta.json

    # è©³ç´°ãªæ¤œè¨¼ã¨ãƒ­ã‚°å‡ºåŠ›
    - name: Validate and Report
      run: |
        echo "=== RSSå–å¾—çµæœãƒ¬ãƒãƒ¼ãƒˆ ==="
        success_count=0
        error_count=0
        
        for file in data/*.json; do
          if [ -f "$file" ] && [ "$(basename "$file")" != "feeds-meta.json" ]; then
            if jq empty "$file" 2>/dev/null; then
              entries=$(jq '.entries | length' "$file" 2>/dev/null || echo "0")
              title=$(jq -r '.title // "Unknown"' "$file" 2>/dev/null)
              echo "âœ… $(basename "$file"): ${entries}ä»¶ - ${title}"
              ((success_count++))
            else
              echo "âŒ $(basename "$file"): JSONè§£æã‚¨ãƒ©ãƒ¼"
              ((error_count++))
            fi
          fi
        done
        
        echo ""
        echo "ğŸ“Š å–å¾—çµæœã‚µãƒãƒªãƒ¼:"
        echo "   æˆåŠŸ: ${success_count}ãƒ•ã‚£ãƒ¼ãƒ‰"
        echo "   ã‚¨ãƒ©ãƒ¼: ${error_count}ãƒ•ã‚£ãƒ¼ãƒ‰"
        
        if [ $success_count -gt 0 ]; then
          echo "âœ… å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å–å¾—ã•ã‚Œã¾ã—ãŸ"
        else
          echo "âŒ å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi

    # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
    - name: Commit and push RSS data
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'RSS feeds updated - $(date -u +"%Y-%m-%d %H:%M UTC")'
        file_pattern: 'data/*.json'
