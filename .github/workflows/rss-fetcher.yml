# .github/workflows/rss-fetcher.yml (å®Œå…¨ä¿®æ­£ç‰ˆ)
name: RSS Feed Fetcher

on:
  schedule:
    # 1æ™‚é–“ã”ã¨ã«å®Ÿè¡Œï¼ˆæ¯æ™‚0åˆ†ï¼‰
    - cron: '0 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create data directory
      run: mkdir -p data

    # ãƒ•ã‚£ãƒ¼ãƒ‰1: ãƒ†ãƒƒã‚¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆæ¤œç´¢çµæœ[1]ã®å½¢å¼ã«æº–æ‹ ï¼‰
    - name: Fetch Tech News RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://feeds.feedburner.com/oreilly/radar'
        file_path: './data/tech-news.json'

    # ãƒ•ã‚£ãƒ¼ãƒ‰2: ITãƒ¡ãƒ‡ã‚£ã‚¢
    - name: Fetch IT Media RSS  
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml'
        file_path: './data/it-media.json'

    # ãƒ•ã‚£ãƒ¼ãƒ‰3: GIGAZINE
    - name: Fetch GIGAZINE RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://gigazine.net/news/rss_2.0/'
        file_path: './data/gigazine.json'

    # ãƒ•ã‚£ãƒ¼ãƒ‰4: NHKãƒ‹ãƒ¥ãƒ¼ã‚¹
    - name: Fetch NHK News RSS
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://www3.nhk.or.jp/rss/news/cat0.xml'
        file_path: './data/nhk-news.json'

    # é«˜åº¦ãªè¨­å®šä¾‹ï¼ˆæ¤œç´¢çµæœ[1][2]ã®è©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³é©ç”¨ï¼‰
    - name: Fetch RSS with Advanced Options
      uses: Promptly-Technologies-LLC/rss-fetch-action@v2
      with:
        feed_url: 'https://feeds.feedburner.com/oreilly/radar'
        file_path: './data/tech-advanced.json'
        parser_options: '{"useISODateFormat": false, "getExtraEntryFields": "(feedEntry) => { return { \"content:encoded\": feedEntry[\"content:encoded\"] || \"\" }; }"}'
        fetch_options: '{}'
        remove_published: true

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    - name: Generate feed metadata
      run: |
        cat > data/feeds-meta.json << EOF
        {
          "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "feeds": [
            {
              "id": "tech-news",
              "name": "Tech News",
              "description": "O'Reilly Radar - æœ€æ–°æŠ€è¡“å‹•å‘",
              "file": "tech-news.json",
              "color": "#FF6B35"
            },
            {
              "id": "it-media",
              "name": "ITãƒ¡ãƒ‡ã‚£ã‚¢",
              "description": "ITmedia ãƒ‹ãƒ¥ãƒ¼ã‚¹",
              "file": "it-media.json", 
              "color": "#4A90E2"
            },
            {
              "id": "gigazine",
              "name": "GIGAZINE",
              "description": "GIGAZINE ãƒ†ãƒƒã‚¯è¨˜äº‹",
              "file": "gigazine.json",
              "color": "#FF4081"
            },
            {
              "id": "nhk-news", 
              "name": "NHKãƒ‹ãƒ¥ãƒ¼ã‚¹",
              "description": "NHK ä¸»è¦ãƒ‹ãƒ¥ãƒ¼ã‚¹",
              "file": "nhk-news.json",
              "color": "#2E7D32"
            }
          ]
        }
        EOF

    # ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæ¤œç´¢çµæœ[1]ã®å‡ºåŠ›å½¢å¼ã«å¯¾å¿œï¼‰
    - name: Validate JSON files
      run: |
        echo "ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼..."
        for file in data/*.json; do
          if [ -f "$file" ]; then
            if jq empty "$file" 2>/dev/null; then
              # æ¤œç´¢çµæœ[1]ã®å‡ºåŠ›å½¢å¼ã«åˆã‚ã›ãŸæ¤œè¨¼
              entries=$(jq '.entries | length' "$file" 2>/dev/null || echo "0")
              title=$(jq -r '.title // "Unknown"' "$file" 2>/dev/null)
              echo "âœ… $(basename "$file"): ${entries}ä»¶ã®ã‚¨ãƒ³ãƒˆãƒª (${title})"
              
              # å‡ºåŠ›å½¢å¼ã®ç¢ºèª
              if jq -e '.entries[0].id and .entries[0].title and .entries[0].link' "$file" >/dev/null 2>&1; then
                echo "   âœ“ æ­£ã—ã„å‡ºåŠ›å½¢å¼ã‚’ç¢ºèª"
              else
                echo "   âš ï¸ å‡ºåŠ›å½¢å¼ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              fi
            else
              echo "âŒ $(basename "$file"): ç„¡åŠ¹ãªJSON"
              echo "   ã‚¨ãƒ©ãƒ¼å†…å®¹:"
              cat "$file" | head -5
            fi
          fi
        done

    # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆæ¤œç´¢çµæœ[1][2]ã®æ‰‹æ³•ã«æº–æ‹ ï¼‰
    - name: Commit and push RSS data
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: 'Update RSS feed'
        file_pattern: '*.json'

    # å®Ÿè¡Œçµæœãƒ¬ãƒãƒ¼ãƒˆ
    - name: Report execution status
      if: always()
      run: |
        echo "=== RSSå–å¾—å®Ÿè¡Œçµæœ ==="
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… RSSå–å¾—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la data/
        else
          echo "âŒ RSSå–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
        fi
